---
layout: posts
title: T4模板应用-第一节
date: 2021-11-26 15:50:06
tags: [T4]
excerpt: 记录T4模板的应用
categories: C#
index_img: https://gitee.com/xlzf/blog-image/raw/master/Gongsi/Csharp.jpeg
---

# `T4`模板应用（一）

之前在搭建系统框架的过程中用到的功能点，功效就是模板的功能。

个人是用`T4`模板批量生产到系统中的`CRUD`中，现在记录一下，不记录具体基础语法，只记录大概过程。

## 前提

###  `ModelAuto.ttinclude`

``` csharp
<#@ assembly name="System.Core"#>
<#@ assembly name="EnvDTE"#>
<#@ import namespace="System.Collections.Generic"#>
<#@ import namespace="System.IO"#>
<#@ import namespace="System.Text"#>
<#@ import namespace="Microsoft.VisualStudio.TextTemplating"#>

<#+

class Manager
{
    public struct Block {
        public String Name;
        public int Start, Length;
    }

    public List<Block> blocks = new List<Block>();
    public Block currentBlock;
    public Block footerBlock = new Block();
    public Block headerBlock = new Block();
    public ITextTemplatingEngineHost host;
    public ManagementStrategy strategy;
    public StringBuilder template;
    public String OutputPath { get; set; }

    public Manager(ITextTemplatingEngineHost host, StringBuilder template, bool commonHeader) {
        this.host = host;
        this.template = template;
        OutputPath = String.Empty;
        strategy = ManagementStrategy.Create(host);
    }

    public void StartBlock(String name) {
        currentBlock = new Block { Name = name, Start = template.Length };
    }

    public void StartFooter() {
        footerBlock.Start = template.Length;
    }

    public void EndFooter() {
        footerBlock.Length = template.Length - footerBlock.Start;
    }

    public void StartHeader() {
        headerBlock.Start = template.Length;
    }

    public void EndHeader() {
        headerBlock.Length = template.Length - headerBlock.Start;
    }    

    public void EndBlock() {
        currentBlock.Length = template.Length - currentBlock.Start;
        blocks.Add(currentBlock);
    }

    public void Process(bool split) {
        String header = template.ToString(headerBlock.Start, headerBlock.Length);
        String footer = template.ToString(footerBlock.Start, footerBlock.Length);
        blocks.Reverse();
        foreach(Block block in blocks) {
            String fileName = Path.Combine(OutputPath, block.Name);
            if (split) {
                String content = header + template.ToString(block.Start, block.Length) + footer;
                strategy.CreateFile(fileName, content);
                template.Remove(block.Start, block.Length);
            } else {
                strategy.DeleteFile(fileName);
            }
        }
    }
}

class ManagementStrategy
{
    internal static ManagementStrategy Create(ITextTemplatingEngineHost host) {
        return (host is IServiceProvider) ? new VSManagementStrategy(host) : new ManagementStrategy(host);
    }

    internal ManagementStrategy(ITextTemplatingEngineHost host) { }

    internal virtual void CreateFile(String fileName, String content) {
        File.WriteAllText(fileName, content);
    }

    internal virtual void DeleteFile(String fileName) {
        if (File.Exists(fileName))
            File.Delete(fileName);
    }
}

class VSManagementStrategy : ManagementStrategy
{
    private EnvDTE.ProjectItem templateProjectItem;

    internal VSManagementStrategy(ITextTemplatingEngineHost host) : base(host) {
        IServiceProvider hostServiceProvider = (IServiceProvider)host;
        if (hostServiceProvider == null)
            throw new ArgumentNullException("Could not obtain hostServiceProvider");

        EnvDTE.DTE dte = (EnvDTE.DTE)hostServiceProvider.GetService(typeof(EnvDTE.DTE));
        if (dte == null)
            throw new ArgumentNullException("Could not obtain DTE from host");

        templateProjectItem = dte.Solution.FindProjectItem(host.TemplateFile);
    }

    internal override void CreateFile(String fileName, String content) {
        base.CreateFile(fileName, content);
        ((EventHandler)delegate { templateProjectItem.ProjectItems.AddFromFile(fileName); }).BeginInvoke(null, null, null, null);
    }

    internal override void DeleteFile(String fileName) {
        ((EventHandler)delegate { FindAndDeleteFile(fileName); }).BeginInvoke(null, null, null, null);
    }

    private void FindAndDeleteFile(String fileName) {
        foreach(EnvDTE.ProjectItem projectItem in templateProjectItem.ProjectItems) {
            if (projectItem.get_FileNames(0) == fileName) {
                projectItem.Delete();
                return;
            }
        }
    }
}#>
```

### `AllModelTemplate.tt`

```csharp
<#@ template debug="true" hostspecific="true" language="C#" #>
<#@ output extension=".cs" #>
<#@ assembly name="System.Data" #>
<#@ assembly name="$(TargetDir)Oracle.ManagedDataAccess.dll" #>
<#@ assembly name="System.Xml" #>
<#@ import namespace="System" #>
<#@ import namespace="System.Xml" #>
<#@ import namespace="System.Data" #>
<#@ import namespace="Oracle.ManagedDataAccess" #>
<#@ import namespace="System.Collections.Generic"#>
<#@ include file="ModelAuto.ttinclude"#>
<# var manager2 = new Manager(Host, GenerationEnvironment, true) { OutputPath = Path.GetDirectoryName(Host.TemplateFile)}; #>
<# 
ModelManager manager = new ModelManager();
List<string> list=manager.GetTableList();
#>

<# 
    foreach (var item in list)
    {
		string tableName=item;
        DataTable table= manager.GetTableSchema(tableName);
 #>

 <# 
		manager2.StartBlock(tableName+".cs");
 #>
using System;
using System.Data;
using Oracle.ManagedDataAccess.Client;
namespace Model
{
    /// <summary>
    /// 数据表实体类：<#= tableName #> 
    /// </summary>
    [Serializable()]
	public class <#= tableName #>
	{
<#
foreach(DataRow row in table.Rows)
{
#>
	   /// <summary>
	   /// <#=row["备注"]#>
	   /// </summary>     
	   public <#= manager.TransFromSqlType(row["数据类型"].ToString())#> <#=row["字段名"]#>{ get; set; }
<#}
#>
	}
}

<# manager2.EndBlock(); #>

<#
    }  
 #>	 
   
<# manager2.Process(true); #>

<#+
    public class ModelManager
    {
        /// <summary>
        /// 数据库连接字符串
        /// </summary> 
        private const string CONNECTION_STRING = "User ID=XLZF;Password=XLZF;Data Source=127.0.0.1/XE;";
        /// <summary>
        /// 用户信息表名
        /// </summary>
        private const string PERSONINFO_TABLE_NAME = "XLZF_USERS";
        /// <summary>
        /// 根据表名查询表结构信息
        /// </summary>
        private const string SELECT_SCHEMA_BY_TABLE_NAME = @"SELECT A.column_name    字段名,                                                                                           A.data_type      数据类型,
                                                                    A.data_length    长度,
                                                                    A.data_precision 整数位,
                                                                    A.Data_Scale     小数位,
                                                                    A.nullable       允许空值,
                                                                    A.Data_default   缺省值,
                                                                    B.comments       备注,
                                                                    A.TABLE_NAME     表名
                                                                    FROM user_tab_columns A, user_col_comments B
                                                                    WHERE a.COLUMN_NAME = b.column_name
                                                                    AND A.Table_Name = B.Table_Name
                                                                    AND A.Table_Name = '{0}'";

        /// <summary>
        /// 获得数据连接
        /// </summary>
        /// <returns></returns>
        private Oracle.ManagedDataAccess.Client.OracleConnection GetConnection()
        {
            return new Oracle.ManagedDataAccess.Client.OracleConnection(CONNECTION_STRING);
        }

		
        /// <summary>
        /// 得到当前用户的所有表名
        /// </summary>
        /// <returns></returns>
        public List<string> GetTableList()
        {
            string sql = "SELECT * FROM USER_TABLES";
            DataTable dt = OracleHelper.ExecuteDataTable(sql);
            List<string> list = new List<string>();
            if (dt!=null&&dt.Rows.Count>0)
            {
                for (int i = 0; i < dt.Rows.Count; i++)
                {
                    list.Add(dt.Rows[i]["TABLE_NAME"].ToString());
                } 
            }
            return list;
         }

        /// <summary>
        /// 释放连接
        /// </summary>
        /// <param name="con"></param>
        private void ReleaseConnection(Oracle.ManagedDataAccess.Client.OracleConnection con)
        {
            if (con != null)
            {
                if (con.State == ConnectionState.Open)
                {
                    con.Close();
                }
            }
        }

        /// <summary>
        /// 获取表内字段及字段其他信息
        /// </summary>
        /// <param name="tableName"></param>
        public DataTable GetTableSchema(string tableName)
        {
            DataTable dt;

            using (Oracle.ManagedDataAccess.Client.OracleConnection con = GetConnection())
            {
                con.Open();

                Oracle.ManagedDataAccess.Client.OracleCommand cmd = con.CreateCommand();

                cmd.CommandText = string.Format(SELECT_SCHEMA_BY_TABLE_NAME,tableName);

                cmd.CommandType = CommandType.Text;

                Oracle.ManagedDataAccess.Client.OracleDataAdapter adapter = new Oracle.ManagedDataAccess.Client.OracleDataAdapter(cmd);

                DataSet ds = new DataSet(); 

                adapter.Fill(ds);

                dt = ds.Tables[0];
            }
            return dt;
        }

        /// <summary>
        /// SQL
        /// </summary>
        /// <param name="type"></param>
        /// <returns></returns>
        public string TransFromSqlType(string type)
        {
            if (string.IsNullOrEmpty(type))
            {
                return string.Empty;
            }
			
            if (string.Equals(type, "number", StringComparison.OrdinalIgnoreCase))
            {
                return "int";
            }
			if (string.Equals(type, "date", StringComparison.OrdinalIgnoreCase))
            {
                return "DateTime";
            }
            else if (string.Equals(type, "nvarchar2", StringComparison.OrdinalIgnoreCase))
            {
                return "string";
            }
			
            return "string";
        } 

    }
#>

<#+ 
public class OracleHelper
    {

        private static string oracleConnectionStr = "User ID=XLZF;Password=XLZF;Data Source=127.0.0.1/XE;";


        public static DataTable ExecuteDataTable(string sql, params Oracle.ManagedDataAccess.Client.OracleParameter[] paramList)
        {
            using (Oracle.ManagedDataAccess.Client.OracleConnection conn = new Oracle.ManagedDataAccess.Client.OracleConnection(oracleConnectionStr))
            { 
                conn.Open();

                using (Oracle.ManagedDataAccess.Client.OracleCommand command = conn.CreateCommand())
                {
                    command.CommandText = sql;

                    command.Parameters.AddRange(paramList);

                    DataTable dt = new DataTable();

                    Oracle.ManagedDataAccess.Client.OracleDataAdapter adapter = new Oracle.ManagedDataAccess.Client.OracleDataAdapter(command);

                    adapter.Fill(dt);

                    return dt;
                }
            }
        }

        public static int ExecuteNonQuery(string sql, params Oracle.ManagedDataAccess.Client.OracleParameter[] paramList)
        {
            using (Oracle.ManagedDataAccess.Client.OracleConnection conn = new Oracle.ManagedDataAccess.Client.OracleConnection(oracleConnectionStr))
            {
                conn.Open();
                using (Oracle.ManagedDataAccess.Client.OracleCommand command = conn.CreateCommand())
                {
                    command.CommandText = sql;
                    command.Parameters.AddRange(paramList);

                    return command.ExecuteNonQuery();
                }
            }
        }

        public static object ExecuteScalar(string sql, params Oracle.ManagedDataAccess.Client.OracleParameter[] paramList)
        {
            using (Oracle.ManagedDataAccess.Client.OracleConnection conn = new Oracle.ManagedDataAccess.Client.OracleConnection(oracleConnectionStr))
            {
                conn.Open();
                using (Oracle.ManagedDataAccess.Client.OracleCommand command = conn.CreateCommand())
                {
                    command.CommandText = sql;
                    command.Parameters.AddRange(paramList);

                    return command.ExecuteScalar();
                }
            }
        }
    }
 #>
```

## 运行

右键运行T4模板

![image-20211205210429402](https://gitee.com/xlzf/blog-image/raw/master/Home/20211205210438.png)

![image-20211205210452146](https://gitee.com/xlzf/blog-image/raw/master/Home/20211205210454.png)

## 结果

![image-20211205210516763](https://gitee.com/xlzf/blog-image/raw/master/Home/20211205210522.png)

![image-20211205210543104](https://gitee.com/xlzf/blog-image/raw/master/Home/20211205210544.png)
