---
title: 微服务之负载均衡示例
date: 2022-01-01 21:23:15
tags: [Nginx]
excerpt: Nginx+Consul 负载均衡示例
categories: Nginx
index_img: https://gitee.com/xlzf/blog-image/raw/master/Home/20220101213220.jpeg
---

# Nginx

![](https://gitee.com/xlzf/blog-image/raw/master/Home/20220101213220.jpeg)

## 下载 [nginx: download](http://nginx.org/en/download.html)

![image-20220101205520096](https://gitee.com/xlzf/blog-image/raw/master/Home/20220101205536.png)

## 配置Conf

``` sh

#user  nobody;
worker_processes  1;

#error_log  logs/error.log;
#error_log  logs/error.log  notice;
#error_log  logs/error.log  info;

#pid        logs/nginx.pid;


events {
    worker_connections  1024;
}


http {
    include       mime.types;
    default_type  application/octet-stream;

    #log_format  main  '$remote_addr - $remote_user [$time_local] "$request" '
    #                  '$status $body_bytes_sent "$http_referer" '
    #                  '"$http_user_agent" "$http_x_forwarded_for"';

    #access_log  logs/access.log  main;

    sendfile        on;
    #tcp_nopush     on;

    #keepalive_timeout  0;
    keepalive_timeout  65;

    #gzip  on;
	
	# 配置多个地址
    upstream ServiceInstance{
        server localhost:5726;
        server localhost:5727;
        server localhost:5728;
    }

    server {
    	# 监听端口 8080
        listen       8080;
        
        # 监听本地 可替换成IP
        server_name  localhost;

        #charset koi8-r;

        #access_log  logs/host.access.log  main;

        location / {
            # root   html;
            # index  index.html index.htm;
            
            # 指向配置
            proxy_pass http://ServiceInstance;
        }

        #error_page  404              /404.html;

        # redirect server error pages to the static page /50x.html
        #
        error_page   500 502 503 504  /50x.html;
        location = /50x.html {
            root   html;
        }

        # proxy the PHP scripts to Apache listening on 127.0.0.1:80
        #
        #location ~ \.php$ {
        #    proxy_pass   http://127.0.0.1;
        #}

        # pass the PHP scripts to FastCGI server listening on 127.0.0.1:9000
        #
        #location ~ \.php$ {
        #    root           html;
        #    fastcgi_pass   127.0.0.1:9000;
        #    fastcgi_index  index.php;
        #    fastcgi_param  SCRIPT_FILENAME  /scripts$fastcgi_script_name;
        #    include        fastcgi_params;
        #}

        # deny access to .htaccess files, if Apache's document root
        # concurs with nginx's one
        #
        #location ~ /\.ht {
        #    deny  all;
        #}
    }


    # another virtual host using mix of IP-, name-, and port-based configuration
    #
    #server {
    #    listen       8000;
    #    listen       somename:8080;
    #    server_name  somename  alias  another.alias;

    #    location / {
    #        root   html;
    #        index  index.html index.htm;
    #    }
    #}


    # HTTPS server
    #
    #server {
    #    listen       443 ssl;
    #    server_name  localhost;

    #    ssl_certificate      cert.pem;
    #    ssl_certificate_key  cert.key;

    #    ssl_session_cache    shared:SSL:1m;
    #    ssl_session_timeout  5m;

    #    ssl_ciphers  HIGH:!aNULL:!MD5;
    #    ssl_prefer_server_ciphers  on;

    #    location / {
    #        root   html;
    #        index  index.html index.htm;
    #    }
    #}

}
```



## 创建应用



![image-20220101205640901](https://gitee.com/xlzf/blog-image/raw/master/Home/20220101205643.png)

![image-20220101205703680](https://gitee.com/xlzf/blog-image/raw/master/Home/20220101205705.png)

![image-20220101205718852](https://gitee.com/xlzf/blog-image/raw/master/Home/20220101205720.png)

![image-20220101205813853](https://gitee.com/xlzf/blog-image/raw/master/Home/20220101205815.png)

## 执行多个应用

![image-20220101210214117](https://gitee.com/xlzf/blog-image/raw/master/Home/20220101210216.png)

执行:

``` shell
dotnet run urls="http://*:5726"
dotnet run urls="http://*:5727"
dotnet run urls="http://*:5728"
```



## 启动Nginx

``` shell
D:\nginx-1.18.0\nginx-1.18.0>start nginx
```



## 停止Nginx

``` shell
D:\nginx-1.18.0\nginx-1.18.0>nginx.exe -s stop
```



## 重启Nginx

``` shell
nginx -s reload
```



## 访问流程

![访问流程](https://gitee.com/xlzf/blog-image/raw/master/Home/20220101211445.png)

## 访问结果

![image-20220101211704858](https://gitee.com/xlzf/blog-image/raw/master/Home/20220101211706.png)

## 最后

Nginx 不能伸缩

也就是再加一个端口，要把端口加进来让Nginx发现，需要修改配置并且重启Nginx，做不到热处理

看下面的Consul吧





# Consul

![Consul](https://gitee.com/xlzf/blog-image/raw/master/Home/20220102220532.jpeg)

## Consul 服务注册

参考：[.NET 5.0实现Consul服务注册 - 半山上的人 - 博客园 (cnblogs.com)](https://www.cnblogs.com/pudefu/p/15034011.html)

## Consul 1.7.2

http://localhost:8500 1.7.2 长这样

![image-20220102201451530](https://gitee.com/xlzf/blog-image/raw/master/Home/20220102201501.png)

## consul 1.11.1 

http://localhost:8500 1.11.1 长这样

![image-20220102211045421](https://gitee.com/xlzf/blog-image/raw/master/Home/20220102211047.png)

## API

### appsetting.json 配置文件

``` json
{
  "Logging": {
    "LogLevel": {
      "Default": "Information",
      "Microsoft": "Warning",
      "Microsoft.Hosting.Lifetime": "Information"
    }
  },
  "AllowedHosts": "*",
  "ConsulConfig": {
    "ServiceId": "d72e7de8b01a43acac640b1a00b26c81",//可以换成Guid
    "ServiceName": "HarrisService",
    "ServiceIP": "127.0.0.1", //当前应用部署的服务器IP地址
    "ServicePort": 5726, //当前应用部署的服务器端口  可以去参数传来得Port
    "ConsulIP": "127.0.0.1", //Consul部署的服务器IP地址
    "ConsulPort": 8500 //Consul端口
  }
}
```

### Model 实体类

``` csharp
namespace ConsulTest.Models
{
    public class ServiceConfig
    {
        /// <summary>
        /// 服务唯一ID
        /// </summary>
        public string ServiceId { get; set; }
        /// <summary>
        /// 服务部署的IP
        /// </summary>
        public string ServiceIP { get; set; }
        /// <summary>
        /// 服务部署的端口
        /// </summary>
        public int ServicePort { get; set; }
        /// <summary>
        /// 服务名称
        /// </summary>
        public string ServiceName { get; set; }
        /// <summary>
        /// consul部署的IP
        /// </summary>
        public string ConsulIP { get; set; }
        /// <summary>
        /// consul端口
        /// </summary>
        public int ConsulPort { get; set; }
    }
}
```

### AppBuilderExtensions 帮助类

``` csharp
using Consul;
using ConsulTest.Models;
using Microsoft.AspNetCore.Builder;
using Microsoft.Extensions.Hosting;
using System;

namespace ConsulTest.Untiy
{
    public static class AppBuilderExtensions
    {
        public static IApplicationBuilder RegisterConsul(this IApplicationBuilder app, IHostApplicationLifetime lifetime, ServiceConfig serviceConfig)
        {
            var consulClient = new ConsulClient(x => x.Address = new Uri($"http://{serviceConfig.ConsulIP}:{serviceConfig.ConsulPort}"));
            var httpCheck = new AgentServiceCheck()
            {
                DeregisterCriticalServiceAfter = TimeSpan.FromSeconds(5),//服务器启动5秒后注册
                Interval = TimeSpan.FromMinutes(1),//每分钟检测一次（健康检查间隔时间）
                HTTP = $"http://{serviceConfig.ServiceIP}:{serviceConfig.ServicePort}/api/health",//本服务健康检查地址
                Timeout = TimeSpan.FromSeconds(20),
            };
            var registerAgent = new AgentServiceRegistration()
            {
                Check = httpCheck,
                Checks = new[] { httpCheck },
                ID = serviceConfig.ServiceId,//一定要指定服务ID，否则每次都会创建一个新的服务节点
                Name = serviceConfig.ServiceName,
                Address = serviceConfig.ServiceIP,
                Port = serviceConfig.ServicePort,
                Tags = new[] { $"urlprefix-/{serviceConfig.ServiceName}" }//添加 urlprefix-/servicename 格式的tag标签，以便Fabio识别
            };
            consulClient.Agent.ServiceRegister(registerAgent).Wait();//服务启动时注册，使用Consul API进行注册（HttpClient发起）
            lifetime.ApplicationStopped.Register(() =>
            {
                consulClient.Agent.ServiceDeregister(registerAgent.ID).Wait();//服务器停止时取消注册
            });
            return app;
        }
    }
}

```

### Startup 注册Consul

``` csharp
using ConsulTest.Models;
using ConsulTest.Untiy;
using Microsoft.AspNetCore.Builder;
using Microsoft.AspNetCore.Hosting;
using Microsoft.AspNetCore.Mvc;
using Microsoft.Extensions.Configuration;
using Microsoft.Extensions.DependencyInjection;
using Microsoft.Extensions.Hosting;
using Microsoft.Extensions.Logging;
using Microsoft.OpenApi.Models;
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;

namespace ConsulTest
{
    public class Startup
    {
        public Startup(IConfiguration configuration)
        {
            Configuration = configuration;
        }

        public IConfiguration Configuration { get; }

        // This method gets called by the runtime. Use this method to add services to the container.
        public void ConfigureServices(IServiceCollection services)
        {

            services.AddControllers();
            services.AddSwaggerGen(c =>
            {
                c.SwaggerDoc("v1", new OpenApiInfo { Title = "ConsulTest", Version = "v1" });
            });
        }

        // This method gets called by the runtime. Use this method to configure the HTTP request pipeline.
        public void Configure(IApplicationBuilder app, IWebHostEnvironment env, IHostApplicationLifetime lifetime,IConfiguration configuration)
        {
            if (env.IsDevelopment())
            {
                app.UseDeveloperExceptionPage();
                app.UseSwagger();
                app.UseSwaggerUI(c => c.SwaggerEndpoint("/swagger/v1/swagger.json", "ConsulTest v1"));
            }

            app.UseRouting();

            app.UseAuthorization();

            #region 注册Consul服务
			
            //取参数 【port】 dotnet run --urls="http://*:5726" --ip=127.0.0.1 --port=5726 
            int port = int.Parse(configuration["port"]);

            var serviceConfig = Configuration.GetSection("ConsulConfig").Get<ServiceConfig>();
			
            //为方便测试，serviceId 给 guid
            serviceConfig.ServiceId = "Service" + Guid.NewGuid().ToString();

            serviceConfig.ServicePort = port;

            Console.WriteLine(port);

            app.RegisterConsul(lifetime, serviceConfig);

            #endregion

            app.UseEndpoints(endpoints =>
            {
                endpoints.MapControllers();
            });
        }
    }
}
```



## 启动Consul

consul agent -dev（如果需要其他机器访问，命令为consul agent -dev -client 0.0.0.0 -ui）

![image-20220102215459287](https://gitee.com/xlzf/blog-image/raw/master/Home/20220102215501.png)

## 启动API应用

``` shell
dotnet run --urls="http://*:5726" --ip=127.0.0.1 --port=5726
dotnet run --urls="http://*:5727" --ip=127.0.0.1 --port=5727
dotnet run --urls="http://*:5728" --ip=127.0.0.1 --port=5728
dotnet run --urls="http://*:5729" --ip=127.0.0.1 --port=5729
```

![image-20220102215640307](https://gitee.com/xlzf/blog-image/raw/master/Home/20220102221132.png)

## Consul 应用界面

![image-20220102211045421](https://gitee.com/xlzf/blog-image/raw/master/Home/20220102211047.png)

![image-20220102215804743](https://gitee.com/xlzf/blog-image/raw/master/Home/20220102221139.png)

## Consul 服务发现

![image-20220102220005859](https://gitee.com/xlzf/blog-image/raw/master/Home/20220102220007.png)

![image-20220102220034369](https://gitee.com/xlzf/blog-image/raw/master/Home/20220102220043.png)

### 代码

``` csharp
using Consul;
using CustomerDemo.Models;
using Microsoft.AspNetCore.Mvc;
using Microsoft.Extensions.Logging;
using System;
using System.Collections.Generic;
using System.Diagnostics;
using System.Linq;
using System.Threading.Tasks;

namespace CustomerDemo.Controllers
{
    public class HomeController : Controller
    {
        private readonly ILogger<HomeController> _logger;

        public HomeController(ILogger<HomeController> logger)
        {
            _logger = logger;
        }

        public IActionResult Index()
        {
            #region Consul 服务发现

            ConsulClient client = new ConsulClient(c =>
            {
                c.Address = new Uri("http://localhost:8500");
                c.Datacenter = "dc1";
            });

            var response = client.Agent.Services().Result.Response;
			
            //consul 提供：Ip+Port  HarrisService Host = Ip+Port
            string url = "http://HarrisService/WeatherForecast";

            Uri uri = new Uri(url);

            string groupName = uri.Host;

            AgentService service = null;

            var serviceDictionary = response.Where(s=>s.Value.Service.Equals(groupName, StringComparison.OrdinalIgnoreCase)).ToList();
			
            //serviceDic 中是所有应用实例 这里取第一个，回头做策略就这做
            service = serviceDictionary[0].Value;

            url = $"{uri.Scheme}://{service.Address}:{service.Port}{uri.PathAndQuery}";

            //string content = Invoke(url);

            #endregion

            return View();
        }

        public IActionResult Privacy()
        {
            return View();
        }

        [ResponseCache(Duration = 0, Location = ResponseCacheLocation.None, NoStore = true)]
        public IActionResult Error()
        {
            return View(new ErrorViewModel { RequestId = Activity.Current?.Id ?? HttpContext.TraceIdentifier });
        }
    }
}
```

