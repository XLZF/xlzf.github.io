<!DOCTYPE html><html lang="en" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"><title>DotNet Core Note | Harris Blog</title><meta name="keywords" content=".net core,IOC,JWT"><meta name="author" content="Harris"><meta name="copyright" content="Harris"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="把之前学习.net core的笔记同步到此博客上，慢慢完善吧。">
<meta property="og:type" content="article">
<meta property="og:title" content="DotNet Core Note">
<meta property="og:url" content="http://example.com/2021/10/31/Net-Core-Note/index.html">
<meta property="og:site_name" content="Harris Blog">
<meta property="og:description" content="把之前学习.net core的笔记同步到此博客上，慢慢完善吧。">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7">
<meta property="article:published_time" content="2021-10-31T11:24:17.000Z">
<meta property="article:modified_time" content="2022-03-31T01:47:44.874Z">
<meta property="article:author" content="Harris">
<meta property="article:tag" content=".net core">
<meta property="article:tag" content="IOC">
<meta property="article:tag" content="JWT">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7"><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="http://example.com/2021/10/31/Net-Core-Note/"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: 'Copy successfully',
    error: 'Copy error',
    noSupport: 'The browser does not support'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  date_suffix: {
    just: 'Just',
    min: 'minutes ago',
    hour: 'hours ago',
    day: 'days ago',
    month: 'months ago'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery@2/dist/fjGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery@2/dist/fjGallery.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'DotNet Core Note',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2022-03-31 09:47:44'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><meta name="generator" content="Hexo 6.1.0"><link rel="alternate" href="/atom.xml" title="Harris Blog" type="application/atom+xml">
</head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="https://i.loli.net/2021/02/24/5O1day2nriDzjSu.png" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">Articles</div><div class="length-num">50</div></a><a href="/tags/"><div class="headline">Tags</div><div class="length-num">35</div></a><a href="/categories/"><div class="headline">Categories</div><div class="length-num">13</div></a></div><hr/></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7')"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">Harris Blog</a></span><div id="menus"><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">DotNet Core Note</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">Created</span><time class="post-meta-date-created" datetime="2021-10-31T11:24:17.000Z" title="Created 2021-10-31 19:24:17">2021-10-31</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">Updated</span><time class="post-meta-date-updated" datetime="2022-03-31T01:47:44.874Z" title="Updated 2022-03-31 09:47:44">2022-03-31</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/C/">C#</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="DotNet Core Note"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">Post View:</span><span id="busuanzi_value_page_pv"></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h1 id="Note-Dot-Net-Core"><a href="#Note-Dot-Net-Core" class="headerlink" title="Note Dot Net Core"></a>Note Dot Net Core</h1><h2 id="发布"><a href="#发布" class="headerlink" title="发布"></a>发布</h2><p>环境用的是Dot Net 5 SDK</p>
<h3 id="问题1"><a href="#问题1" class="headerlink" title="问题1"></a>问题1</h3><p>每次运行生成到 <code>\bin\Debug\net5.0</code> 下的文件 对比 发布之后的文件，多的一个 <code>web.config</code></p>
<p>生成文件</p>
<p><img src="https://blogimage-1255495010.cos.ap-beijing.myqcloud.com/image-20210817220618980.png" alt="image-20210817220618980"></p>
<p><img src="https://blogimage-1255495010.cos.ap-beijing.myqcloud.com/image-20210817220659934.png" alt="image-20210817220659934"></p>
<p>如果把<code>web.config</code>文件复制到生成文件夹中，照样可以通过<code>IIS</code>发布</p>
<h3 id="问题2"><a href="#问题2" class="headerlink" title="问题2"></a>问题2</h3><p>当<code>IIS</code> 安装完毕之后，该设置的都设置了，但是访问直接</p>
<p><img src="https://blogimage-1255495010.cos.ap-beijing.myqcloud.com/image-20210817221100914.png" alt="image-20210817221100914"></p>
<p>如果之前玩过<code>IIS</code>的话，就会有点懵圈，我之前玩就是这么玩的，为毛现在不行了，答案是，这样真不行。</p>
<p>首先，需要访问 <a target="_blank" rel="noopener" href="https://dotnet.microsoft.com/download/dotnet">.NET Downloads (Linux, macOS, and Windows) (microsoft.com)</a></p>
<p><img src="https://blogimage-1255495010.cos.ap-beijing.myqcloud.com/image-20210817221438691.png" alt="image-20210817221438691"></p>
<p>根据自己的环境下载对应的Host 和 SDK</p>
<p><img src="https://blogimage-1255495010.cos.ap-beijing.myqcloud.com/image-20210817221551567.png" alt="image-20210817221551567"></p>
<p>上面这安装完毕后，重启<code>IIS</code>服务</p>
<p><img src="https://blogimage-1255495010.cos.ap-beijing.myqcloud.com/image-20210817221946942.png" alt="image-20210817221946942"></p>
<p><img src="https://blogimage-1255495010.cos.ap-beijing.myqcloud.com/image-20210817222017718.png" alt="image-20210817222017718"></p>
<p><img src="https://blogimage-1255495010.cos.ap-beijing.myqcloud.com/image-20210817222055216.png" alt="image-20210817222055216"></p>
<p>在模块中多俩这玩意，没有这俩玩意的，再找资源下载，都在刚才那个网址里，然 就没有那个500的毛病了。</p>
<p>其实最主要的是依赖 <code>AspNetCoreModuleV2</code>,具体可以看问题1里说的那个<code>web.config</code>中。</p>
<p><img src="https://blogimage-1255495010.cos.ap-beijing.myqcloud.com/image-20210817222624896.png" alt="image-20210817222624896"></p>
<p>你悟了吗？</p>
<h2 id="CMD启动"><a href="#CMD启动" class="headerlink" title="CMD启动"></a>CMD启动</h2><ol>
<li><p>通过CMD 去启动 cd 到发布目录 执行</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dotnet DotNetCoreDemo.dll</span><br></pre></td></tr></table></figure>

<p><img src="https://blogimage-1255495010.cos.ap-beijing.myqcloud.com/image-20210817224246940.png" alt="image-20210817224246940"></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dotnet DotNetCoreDemo.dll --urls &quot;http://*:8888&quot;</span><br></pre></td></tr></table></figure>

<p><img src="https://blogimage-1255495010.cos.ap-beijing.myqcloud.com/image-20210817224330676.png" alt="image-20210817224330676"></p>
</li>
</ol>
<p><img src="https://blogimage-1255495010.cos.ap-beijing.myqcloud.com/image-20210817224503747.png" alt="image-20210817224503747"></p>
<p>由于DotNetCore 有跨平台的优势，一般生产环境基本是不用<code>IIS</code></p>
<p>执行的命令在<code>web.config</code>中可以看到，仔细观察</p>
<p><img src="https://blogimage-1255495010.cos.ap-beijing.myqcloud.com/image-20210817224712705.png" alt="image-20210817224712705"></p>
<p>在 DotNetCore 中，<code>IIS</code> 其实充当的角色是转发请求，与之前的发布网站的用法不一样了，有点怀念之前<code>webform</code>的青涩。</p>
<h2 id="读取静态文件-配置中间件"><a href="#读取静态文件-配置中间件" class="headerlink" title="读取静态文件+配置中间件"></a>读取静态文件+配置中间件</h2><ol>
<li><p>引入命名空间</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> Microsoft.Extensions.FileProviders;</span><br><span class="line"><span class="keyword">using</span> System.IO;</span><br></pre></td></tr></table></figure></li>
<li><p>配置读取静态文件中间件</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//获取相对路径</span></span><br><span class="line"><span class="built_in">string</span> path = Path.Combine(Directory.GetCurrentDirectory(), <span class="string">&quot;wwwroot&quot;</span>);</span><br><span class="line"></span><br><span class="line">app.UseStaticFiles(<span class="keyword">new</span> StaticFileOptions()</span><br><span class="line">&#123;</span><br><span class="line">	<span class="comment">//从物理路径指向wwwroot</span></span><br><span class="line">	FileProvider = <span class="keyword">new</span> PhysicalFileProvider(path)</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure></li>
</ol>
<h2 id="CMD-参数"><a href="#CMD-参数" class="headerlink" title="CMD 参数"></a>CMD 参数</h2><ol>
<li><p>cmd 执行</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dotnet DotNetCoreDemo.dll --urls &quot;http://*:8080&quot; -- Parame=&quot;Harris&quot; </span><br></pre></td></tr></table></figure>

<p>格式 – [参数名称] = [参数]</p>
</li>
<li><p>控制器注入</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> Microsoft.Extensions.Configuration;</span><br></pre></td></tr></table></figure>

<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">readonly</span> IConfiguration _iconfiguration;</span><br></pre></td></tr></table></figure>

<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">HomeController</span>(<span class="params">ILogger&lt;HomeController&gt; logger, IConfiguration configuration</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    _logger = logger;</span><br><span class="line">    _logger.LogWarning(<span class="string">&quot;HomeController 被构造..&quot;</span>);</span><br><span class="line"></span><br><span class="line">    _iconfiguration = configuration; <span class="comment">//注入</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">string</span> Parame = _iconfiguration[<span class="string">&quot;Parame&quot;</span>];<span class="comment">//参数名称</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">base</span>.ViewBag.User1 = <span class="string">&quot;张三&quot;</span> + <span class="string">&quot; -- 参数：&quot;</span> + Parame; <span class="comment">//使用</span></span><br></pre></td></tr></table></figure>

<p><img src="https://blogimage-1255495010.cos.ap-beijing.myqcloud.com/image-20210819222204161.png" alt="image-20210819222204161"></p>
</li>
</ol>
<h2 id="控制器读取配置"><a href="#控制器读取配置" class="headerlink" title="控制器读取配置"></a>控制器读取配置</h2><h3 id="方式1"><a href="#方式1" class="headerlink" title="方式1"></a>方式1</h3><p><img src="https://blogimage-1255495010.cos.ap-beijing.myqcloud.com/image-20210819224059065.png" alt="image-20210819224059065"></p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">&quot;TESTID&quot;</span><span class="punctuation">:</span> <span class="string">&quot;1111&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;TESTNAME&quot;</span><span class="punctuation">:</span> <span class="string">&quot;HARRIS&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;TESTAdress&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;sheng&quot;</span><span class="punctuation">:</span> <span class="string">&quot;SHANXI&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;shi&quot;</span><span class="punctuation">:</span> <span class="string">&quot;XINZHOU&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;Family&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">    <span class="string">&quot;baba&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="string">&quot;mama&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="string">&quot;son&quot;</span></span><br><span class="line">  <span class="punctuation">]</span></span><br></pre></td></tr></table></figure>

<p>同样需要注入:</p>
<p><img src="https://blogimage-1255495010.cos.ap-beijing.myqcloud.com/image-20210819224219428.png" alt="image-20210819224219428"></p>
<p>应用：</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">ViewBag.Setting1 = _iconfiguration[<span class="string">&quot;TESTID&quot;</span>];</span><br><span class="line"></span><br><span class="line">ViewBag.Setting2 = _iconfiguration[<span class="string">&quot;TESTNAME&quot;</span>];</span><br><span class="line"></span><br><span class="line">ViewBag.Setting3 = _iconfiguration[<span class="string">&quot;TESTAdress:sheng&quot;</span>];</span><br><span class="line"></span><br><span class="line">ViewBag.Setting4 = _iconfiguration[<span class="string">&quot;Family:1&quot;</span>];</span><br></pre></td></tr></table></figure>

<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">ul</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">li</span>&gt;</span>@ViewBag.Setting1<span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">li</span>&gt;</span>@ViewBag.Setting2<span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">li</span>&gt;</span>@ViewBag.Setting3<span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">li</span>&gt;</span>@ViewBag.Setting4<span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">ul</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p><img src="https://blogimage-1255495010.cos.ap-beijing.myqcloud.com/image-20210819224316517.png" alt="image-20210819224316517"></p>
<h3 id="方式2"><a href="#方式2" class="headerlink" title="方式2"></a>方式2</h3><p>先修改一下appsetting.json</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">&quot;TEST&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;TESTID&quot;</span><span class="punctuation">:</span> <span class="string">&quot;1111&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;TESTNAME&quot;</span><span class="punctuation">:</span> <span class="string">&quot;HARRIS&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;TESTAdress&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;sheng&quot;</span><span class="punctuation">:</span> <span class="string">&quot;SHANXI&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;shi&quot;</span><span class="punctuation">:</span> <span class="string">&quot;XINZHOU&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;Family&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">      <span class="string">&quot;baba&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="string">&quot;mama&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="string">&quot;son&quot;</span></span><br><span class="line">    <span class="punctuation">]</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p>实例化一个实体</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">TESTMODEL</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">string</span> TESTID &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">string</span> TESTNAME &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> TESTAdress TESTAdress &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> List&lt;<span class="built_in">string</span>&gt; Family &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">TESTAdress</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">string</span> sheng &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">string</span> shi &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>让实体与需要的json节点相互对应。</p>
<p>然后 Startup.cs</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">ConfigureServices</span>(<span class="params">IServiceCollection services</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    services.AddControllersWithViews();</span><br><span class="line"></span><br><span class="line">    services.AddSession();</span><br><span class="line"></span><br><span class="line">    <span class="comment">//取配置文件中的TEST节点，映射到 TESTMODEL 实体</span></span><br><span class="line">    services.Configure&lt;TESTMODEL&gt;(Configuration.GetSection(<span class="string">&quot;TEST&quot;</span>));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>接着控制器注入</p>
<p><img src="https://blogimage-1255495010.cos.ap-beijing.myqcloud.com/image-20210819230720154.png" alt="image-20210819230720154"></p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">HomeController</span>(<span class="params">ILogger&lt;HomeController&gt; logger, IConfiguration configuration,IOptions&lt;TESTMODEL&gt; options</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    _logger = logger;</span><br><span class="line">    _logger.LogWarning(<span class="string">&quot;HomeController 被构造..&quot;</span>);</span><br><span class="line"></span><br><span class="line">    _iconfiguration = configuration;</span><br><span class="line"></span><br><span class="line">    _tESTMODEL = options.Value;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>应用：</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">object</span> parame = Newtonsoft.Json.JsonConvert.SerializeObject(_tESTMODEL);</span><br><span class="line"><span class="comment">//然后返回给视图</span></span><br><span class="line"><span class="keyword">return</span> View(parame);</span><br></pre></td></tr></table></figure>

<p><img src="https://blogimage-1255495010.cos.ap-beijing.myqcloud.com/image-20210819230859533.png" alt="image-20210819230859533"></p>
<h2 id="Razor-混编"><a href="#Razor-混编" class="headerlink" title="Razor 混编"></a>Razor 混编</h2><h3 id="index-cshtml"><a href="#index-cshtml" class="headerlink" title="index.cshtml"></a>index.cshtml</h3><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line">@using DotNetCoreDemo.Interface;</span><br><span class="line">@using Microsoft.AspNetCore.Authorization;</span><br><span class="line">@&#123;</span><br><span class="line">    ViewData[&quot;Title&quot;] = &quot;Index&quot;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">h1</span>&gt;</span>This is Second Index<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line"></span><br><span class="line">@*测试 runtimecompilation*@</span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">h2</span>&gt;</span>Test Razor runtimecompilation!<span class="tag">&lt;/<span class="name">h2</span>&gt;</span></span><br><span class="line"></span><br><span class="line">@*实现接口*@</span><br><span class="line"></span><br><span class="line">@implements ICoustomInterface</span><br><span class="line"></span><br><span class="line">@functions&#123;</span><br><span class="line">    //实现接口</span><br><span class="line">    public string Show()</span><br><span class="line">    &#123;</span><br><span class="line">        return &quot;Hello World&quot;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">h2</span>&gt;</span>实现接口：@Show()<span class="tag">&lt;/<span class="name">h2</span>&gt;</span></span><br><span class="line"></span><br><span class="line">@*服务注入*@</span><br><span class="line"></span><br><span class="line">@inject ICoustomInterface coustomservice</span><br><span class="line">@&#123;</span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">h2</span>&gt;</span>前台服务注入：@coustomservice.Show()<span class="tag">&lt;/<span class="name">h2</span>&gt;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">h2</span>&gt;</span>后台注册服务：@base.ViewBag.ServiceText<span class="tag">&lt;/<span class="name">h2</span>&gt;</span></span><br><span class="line"></span><br><span class="line">@*标记特性*@</span><br><span class="line">@*给当前类新增特性，cshtml 可以把它当成一个类*@</span><br><span class="line">@attribute [Authorize];</span><br><span class="line"></span><br><span class="line">@functions&#123;</span><br><span class="line">    public string GetStr()</span><br><span class="line">    &#123;</span><br><span class="line">        return &quot;Hello world&quot;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">h2</span>&gt;</span>调用方法 : @GetStr()<span class="tag">&lt;/<span class="name">h2</span>&gt;</span></span><br><span class="line"></span><br><span class="line">@*单行*@</span><br><span class="line"></span><br><span class="line">@&#123; <span class="tag">&lt;<span class="name">h3</span> <span class="attr">style</span>=<span class="string">&quot;color:darkcyan&quot;</span>&gt;</span>单行输出：@GetStr()<span class="tag">&lt;/<span class="name">h3</span>&gt;</span>&#125;</span><br><span class="line"></span><br><span class="line">@*多行*@</span><br><span class="line">@*<span class="tag">&lt;<span class="name">text</span>&gt;</span>@i<span class="tag">&lt;/<span class="name">text</span>&gt;</span> 标识为字符串显示文本 不能像后台代码那样用加号连接*@</span><br><span class="line"></span><br><span class="line">@&#123;</span><br><span class="line">    for (int i = 0; i &lt; 3; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="tag">&lt;<span class="name">h3</span> <span class="attr">style</span>=<span class="string">&quot;color:yellowgreen&quot;</span>&gt;</span>多行输出：@GetStr()<span class="tag">&lt;<span class="name">text</span>&gt;</span>@i<span class="tag">&lt;/<span class="name">text</span>&gt;</span><span class="tag">&lt;/<span class="name">h3</span>&gt;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">@*输出html标签*@</span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">h3</span>&gt;</span>输出HTML标签：@(&quot;<span class="tag">&lt;<span class="name">strong</span>&gt;</span>输出HTML标签：Hello world <span class="tag">&lt;/<span class="name">strong</span>&gt;</span>&quot;)<span class="tag">&lt;/<span class="name">h3</span>&gt;</span></span><br><span class="line"></span><br><span class="line">@*模板化方法*@</span><br><span class="line"></span><br><span class="line">@&#123; </span><br><span class="line">    void ReturnName(string name)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="tag">&lt;<span class="name">h3</span> <span class="attr">style</span>=<span class="string">&quot;color:brown&quot;</span>&gt;</span>模板化输出：@name<span class="tag">&lt;/<span class="name">h3</span>&gt;</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ReturnName(&quot;Harris&quot;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Startup"><a href="#Startup" class="headerlink" title="Startup"></a>Startup</h3><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> Microsoft.AspNetCore.Builder;</span><br><span class="line"><span class="keyword">using</span> Microsoft.AspNetCore.Hosting;</span><br><span class="line"><span class="keyword">using</span> Microsoft.Extensions.Configuration;</span><br><span class="line"><span class="keyword">using</span> Microsoft.Extensions.DependencyInjection;</span><br><span class="line"><span class="keyword">using</span> Microsoft.Extensions.Hosting;</span><br><span class="line"><span class="keyword">using</span> Microsoft.Extensions.Logging;</span><br><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> System.Linq;</span><br><span class="line"><span class="keyword">using</span> System.Threading.Tasks;</span><br><span class="line"><span class="keyword">using</span> Microsoft.Extensions.FileProviders;</span><br><span class="line"><span class="keyword">using</span> System.IO;</span><br><span class="line"><span class="keyword">using</span> DotNetCoreDemo.Models;</span><br><span class="line"><span class="keyword">using</span> DotNetCoreDemo.Interface;</span><br><span class="line"><span class="keyword">using</span> DotNetCoreDemo.Service;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">DotNetCoreDemo</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">Startup</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">Startup</span>(<span class="params">IConfiguration configuration</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            Configuration = configuration;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> IConfiguration Configuration &#123; <span class="keyword">get</span>; &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// This method gets called by the runtime. Use this method to add services to the container.</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">ConfigureServices</span>(<span class="params">IServiceCollection services</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            services.AddControllersWithViews();</span><br><span class="line"></span><br><span class="line">            services.AddSession();</span><br><span class="line">			</span><br><span class="line">            <span class="comment">//加入中间件，方便实时调试HTML</span></span><br><span class="line">            services.AddRazorPages().AddRazorRuntimeCompilation();</span><br><span class="line"></span><br><span class="line">            <span class="comment">//注入服务</span></span><br><span class="line">            services.AddTransient&lt;ICoustomInterface, CoustomService&gt;();</span><br><span class="line"></span><br><span class="line">            <span class="comment">//取配置文件中的TEST节点，映射到 TESTMODEL 实体</span></span><br><span class="line">            services.Configure&lt;TESTMODEL&gt;(Configuration.GetSection(<span class="string">&quot;TEST&quot;</span>));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// This method gets called by the runtime. Use this method to configure the HTTP request pipeline.</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Configure</span>(<span class="params">IApplicationBuilder app, IWebHostEnvironment env, ILoggerFactory loggerFactory</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (env.IsDevelopment())</span><br><span class="line">            &#123;</span><br><span class="line">                app.UseDeveloperExceptionPage();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            &#123;</span><br><span class="line">                app.UseExceptionHandler(<span class="string">&quot;/Home/Error&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">//可以参考Program 中的配置，二选一</span></span><br><span class="line">            loggerFactory.AddLog4Net(<span class="string">&quot;CfgFile/Log4Net.Config&quot;</span>);</span><br><span class="line"></span><br><span class="line">            <span class="comment">//app.UseStaticFiles();</span></span><br><span class="line"></span><br><span class="line">            <span class="comment">//获取相对路径</span></span><br><span class="line">            <span class="built_in">string</span> path = Path.Combine(Directory.GetCurrentDirectory(), <span class="string">&quot;wwwroot&quot;</span>);</span><br><span class="line"></span><br><span class="line">            app.UseStaticFiles(<span class="keyword">new</span> StaticFileOptions()</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">//从物理路径指向wwwroot</span></span><br><span class="line">                FileProvider = <span class="keyword">new</span> PhysicalFileProvider(path)</span><br><span class="line">            &#125;);</span><br><span class="line"></span><br><span class="line">            app.UseSession();</span><br><span class="line"></span><br><span class="line">            app.UseRouting();</span><br><span class="line"></span><br><span class="line">            app.UseAuthorization();</span><br><span class="line"></span><br><span class="line">            app.UseEndpoints(endpoints =&gt;</span><br><span class="line">            &#123;</span><br><span class="line">                endpoints.MapControllerRoute(</span><br><span class="line">                    name: <span class="string">&quot;default&quot;</span>,</span><br><span class="line">                    pattern: <span class="string">&quot;&#123;controller=Home&#125;/&#123;action=Index&#125;/&#123;id?&#125;&quot;</span>);</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="Interface-层"><a href="#Interface-层" class="headerlink" title="Interface 层"></a>Interface 层</h3><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> <span class="title">DotNetCoreDemo.Interface</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">interface</span> <span class="title">ICoustomInterface</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="built_in">string</span> <span class="title">Show</span>()</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Service-层"><a href="#Service-层" class="headerlink" title="Service 层"></a>Service 层</h3><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">CoustomService</span> : <span class="title">Interface.ICoustomInterface</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="built_in">string</span> <span class="title">Show</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;Hello world&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Nuget-包"><a href="#Nuget-包" class="headerlink" title="Nuget 包"></a>Nuget 包</h3><p><code>Microsoft.AspNetCore.Mvc.Razor.RuntimeCompilation</code></p>
<h2 id="Razor-布局"><a href="#Razor-布局" class="headerlink" title="Razor 布局"></a>Razor 布局</h2><h3 id="开始"><a href="#开始" class="headerlink" title="开始"></a>开始</h3><ul>
<li>在<code>_ViewStart.cshtml</code> 中设置母版页；</li>
</ul>
<p><img src="https://blogimage-1255495010.cos.ap-beijing.myqcloud.com/image-20210822120532857.png" alt="image-20210822120532857"></p>
<ul>
<li><p>如果不想要模板页，想单页面展示也可以，可以在<code>_ViewStart.cshtml</code>中 注释 layout = “_Layout”; 或者 修改 layout = null;</p>
<p><img src="https://blogimage-1255495010.cos.ap-beijing.myqcloud.com/image-20210822122832247.png" alt="image-20210822122832247"></p>
</li>
</ul>
<h3 id="母版页"><a href="#母版页" class="headerlink" title="母版页"></a>母版页</h3><p><img src="https://blogimage-1255495010.cos.ap-beijing.myqcloud.com/image-20210822120844118.png" alt="image-20210822120844118"></p>
<ol>
<li><p>可以设置一些测试的菜单。</p>
</li>
<li><p><code>@RenderBody()</code> 相当于一个占位符，菜单中路由的界面都会在这里进行替换。</p>
</li>
<li><p><code>@await RenderSectionAsync(&quot;Scripts&quot;,required:false)</code> 应用场景：</p>
<p>当子页面不手动引用 <code>Scripts</code>类库的时候，可以和上述这行代码配套使用。</p>
<p><img src="https://blogimage-1255495010.cos.ap-beijing.myqcloud.com/image-20210822121926617.png" alt="image-20210822121926617"></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//这个是不行的，除非手动引入js文件</span></span><br><span class="line">&lt;script type=<span class="string">&quot;text/javascript&quot;</span>&gt;</span><br><span class="line">    $(<span class="variable language_">document</span>).<span class="title function_">ready</span>(<span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;Hello Harris&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="title function_">alert</span>(<span class="string">&quot;Hello Harris&quot;</span>);</span><br><span class="line">    &#125;);</span><br><span class="line">&lt;/script&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment">//这个可以，他使用的是模板页中的js文件，相当于把下述js脚本拿到模板页中，然后执行</span></span><br><span class="line">@section <span class="title class_">Scripts</span>&#123; </span><br><span class="line"></span><br><span class="line">    <span class="language-xml"><span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">&quot;text/javascript&quot;</span>&gt;</span><span class="language-javascript"></span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">        $(<span class="variable language_">document</span>).<span class="title function_">ready</span>(<span class="keyword">function</span> (<span class="params"></span>) &#123;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml"></span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;Hello Harris&quot;</span>);</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml"></span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">            <span class="title function_">alert</span>(<span class="string">&quot;Hello Harris&quot;</span>);</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">        &#125;);</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">    </span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://blogimage-1255495010.cos.ap-beijing.myqcloud.com/image-20210822122520500.png" alt="image-20210822122520500"></p>
</li>
<li><p><strong>结合上一点说的，如果不使用母版页，如果注释掉或者等于null的话，使用母版页js库的代码就废了。</strong></p>
</li>
</ol>
<h2 id="Razor-扩展"><a href="#Razor-扩展" class="headerlink" title="Razor 扩展"></a>Razor 扩展</h2><h3 id="扩展控件（1）"><a href="#扩展控件（1）" class="headerlink" title="扩展控件（1）"></a>扩展控件（1）</h3><ol>
<li><p>@html.ActionLink 问题。</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">@&#123;</span><br><span class="line">    ViewData[&quot;Title&quot;] = &quot;RazorControl Page&quot;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">ActionLink:@Html.ActionLink(&quot;当前控制器Index&quot;, &quot;index&quot;)</span><br><span class="line"></span><br><span class="line">ActionLink:@Html.ActionLink(&quot;Home控制器Index&quot;, &quot;index&quot;, &quot;Home&quot;);</span><br><span class="line"></span><br><span class="line">@&#123;</span><br><span class="line">    TESTAdress testaddress_ = new TESTAdress();</span><br><span class="line"></span><br><span class="line">    testaddress_.Sheng = &quot;a&quot;;</span><br><span class="line"></span><br><span class="line">    testaddress_.Shi = &quot;b&quot;;</span><br><span class="line"></span><br><span class="line">    TESTMODEL tESTMODEL = new TESTMODEL</span><br><span class="line">    &#123;</span><br><span class="line">        TESTID = &quot;1&quot;,</span><br><span class="line">        TESTNAME = &quot;Harris&quot;,</span><br><span class="line">        _TESTAdress = testaddress_,</span><br><span class="line">        Family = new List<span class="tag">&lt;<span class="name">string</span>&gt;</span> &#123; &quot;1&quot;, &quot;2&quot;, &quot;3&quot; &#125;,</span><br><span class="line">        names = new Name &#123; Xing = &quot;a&quot;,Ming = &quot;b&quot;&#125;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">ActionLink:@Html.ActionLink(&quot;带路由信息&quot;, &quot;index&quot;, &quot;Home&quot;, tESTMODEL);</span><br></pre></td></tr></table></figure>

<p>上述方法中有个错误的地方：就是最后一行，传的实体相对复杂，导致浏览器解析不了</p>
<p><img src="https://blogimage-1255495010.cos.ap-beijing.myqcloud.com/image-20210822195432996.png" alt="image-20210822195432996"></p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;/?TESTID=1<span class="symbol">&amp;amp;</span>TESTNAME=Harris<span class="symbol">&amp;amp;</span>_TESTAdress=DotNetCoreDemo.Models.TESTAdress<span class="symbol">&amp;amp;</span>Family=1<span class="symbol">&amp;amp;</span>Family=2<span class="symbol">&amp;amp;</span>Family=3<span class="symbol">&amp;amp;</span>names=DotNetCoreDemo.Models.Name&quot;</span>&gt;</span>带路由信息<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>再结合下图：</p>
<p><img src="https://blogimage-1255495010.cos.ap-beijing.myqcloud.com/image-20210822195931807.png" alt="image-20210822195931807"></p>
<p><img src="https://blogimage-1255495010.cos.ap-beijing.myqcloud.com/image-20210822195634650.png" alt="image-20210822195634650"></p>
<p><code>routeValues</code> 这个才是为了给浏览器解析作为页面参数传递的，所以这里不支持复杂实体应该是这个原因。</p>
</li>
<li><p>新建一个静态方法 </p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> Microsoft.AspNetCore.Html;</span><br><span class="line"><span class="keyword">using</span> Microsoft.AspNetCore.Mvc.Rendering;</span><br><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> System.Linq;</span><br><span class="line"><span class="keyword">using</span> System.Threading.Tasks;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">DotNetCoreDemo.Utility</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title">HtmlHelperLinkExtensions</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> IHtmlContent <span class="title">ActionImage</span>(<span class="params"><span class="keyword">this</span> IHtmlHelper helper,<span class="built_in">string</span> src</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> HtmlString(<span class="string">$&quot;&lt;IMG src=&#x27;<span class="subst">&#123;src&#125;</span>&#x27; alt=&#x27;扩展控件IMAGE&#x27; style=&#x27;width:100px;height:20px&#x27;/&gt;&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>视图</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">@*扩展控件*@</span><br><span class="line">@Html.ActionImage(&quot;http://mmmp3.com/skin/default/images/logo.png&quot;)</span><br></pre></td></tr></table></figure>

<p><img src="https://blogimage-1255495010.cos.ap-beijing.myqcloud.com/image-20210822202647528.png" alt="image-20210822202647528"></p>
</li>
</ol>
<h3 id="扩展控件（2）"><a href="#扩展控件（2）" class="headerlink" title="扩展控件（2）"></a>扩展控件（2）</h3><p>此扩展方法旨在扩展html体系中不存在得html 标签。</p>
<ol>
<li><p>新建一个类 CustomTagHelper</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> Microsoft.AspNetCore.Razor.TagHelpers;</span><br><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> System.Linq;</span><br><span class="line"><span class="keyword">using</span> System.Threading.Tasks;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">DotNetCoreDemo.Utility</span></span><br><span class="line">&#123;</span><br><span class="line">    [<span class="meta">HtmlTargetElement(<span class="string">&quot;Harris&quot;</span>)</span>]</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">CustomTagHelper</span> : <span class="title">TagHelper</span>   <span class="comment">//,ITagHelper</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">Process</span>(<span class="params">TagHelperContext context, TagHelperOutput output</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            output.TagName = <span class="string">&quot;div&quot;</span>;</span><br><span class="line">            output.Attributes.Add(<span class="string">&quot;xing&quot;</span>, <span class="string">&quot;No.1&quot;</span>);</span><br><span class="line">            output.Attributes.Add(<span class="string">&quot;ming&quot;</span>, <span class="string">&quot;No.2&quot;</span>);</span><br><span class="line">            output.PreContent.SetContent(<span class="string">&quot;Hello ,My name is Harris&quot;</span>);</span><br><span class="line">            output.Attributes.Add(<span class="string">&quot;style&quot;</span>, <span class="string">&quot;color:red&quot;</span>);</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>标记 <code>HtmlTargeElement()</code> 特性</li>
<li>继承 <code>Taghelper</code> 或者实现 <code>ITaghelper</code> 接口</li>
<li>重写 <code>Process</code> 方法</li>
<li>定义标签</li>
<li>指定属性、内容</li>
</ul>
</li>
<li><p>声明 在 <code>_ViewImports.cshtml</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">@using DotNetCoreDemo</span><br><span class="line">@using DotNetCoreDemo.Models</span><br><span class="line">@addTagHelper *, Microsoft.AspNetCore.Mvc.TagHelpers</span><br><span class="line">@addTagHelper *,DotNetCoreDemo //* 代表当前命名空间下都可使用</span><br></pre></td></tr></table></figure></li>
<li><p>应用</p>
<p><img src="https://blogimage-1255495010.cos.ap-beijing.myqcloud.com/image-20210822210047680.png" alt="image-20210822210047680"></p>
<p><img src="https://blogimage-1255495010.cos.ap-beijing.myqcloud.com/image-20210822210156272.png" alt="image-20210822210156272"></p>
<ol start="4">
<li><p>传参</p>
<p>设置好对象</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> Microsoft.AspNetCore.Razor.TagHelpers;</span><br><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> System.Linq;</span><br><span class="line"><span class="keyword">using</span> System.Threading.Tasks;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">DotNetCoreDemo.Utility</span></span><br><span class="line">&#123;</span><br><span class="line">    [<span class="meta">HtmlTargetElement(<span class="string">&quot;Harris&quot;</span>)</span>]</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">CustomTagHelper</span> : <span class="title">TagHelper</span>   <span class="comment">//,ITagHelper</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">string</span> Id &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">string</span> Name &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">string</span> Age &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">string</span> Shengshi &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">CustomTagHelper</span>()</span></span><br><span class="line">        &#123;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">Process</span>(<span class="params">TagHelperContext context, TagHelperOutput output</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">//接收参数</span></span><br><span class="line">            <span class="built_in">string</span> _id = <span class="keyword">this</span>.Id;</span><br><span class="line"></span><br><span class="line">            <span class="built_in">string</span> _name = <span class="keyword">this</span>.Name;</span><br><span class="line"></span><br><span class="line">            <span class="built_in">string</span> _age = <span class="keyword">this</span>.Age;</span><br><span class="line"></span><br><span class="line">            <span class="built_in">string</span> _shengshi = <span class="keyword">this</span>.Shengshi;</span><br><span class="line"></span><br><span class="line">            output.TagName = <span class="string">&quot;div&quot;</span>;</span><br><span class="line">            output.Attributes.Add(<span class="string">&quot;xing&quot;</span>, <span class="string">&quot;No.1&quot;</span>);</span><br><span class="line">            output.Attributes.Add(<span class="string">&quot;ming&quot;</span>, <span class="string">&quot;No.2&quot;</span>);</span><br><span class="line"></span><br><span class="line">            <span class="comment">//output.PreContent.SetContent(&quot;Hello ,My name is Harris&quot;);</span></span><br><span class="line">            <span class="comment">//使用参数</span></span><br><span class="line">            output.PreContent.SetHtmlContent(<span class="string">&quot;&lt;h2&gt;Hello ,My name is Harris&lt;/h2&gt;&lt;ul&gt;&lt;li&gt;ID:&quot;</span> + _id + <span class="string">&quot;&lt;/li&gt;&lt;li&gt;NAME:&quot;</span> + _name + <span class="string">&quot;&lt;/li&gt;&lt;li&gt;Age:&quot;</span> + _age + <span class="string">&quot;&lt;/li&gt;&lt;li&gt;Shengshi:&quot;</span> + _shengshi + <span class="string">&quot;&lt;/li&gt;&lt;/ul&gt;&quot;</span>);</span><br><span class="line"></span><br><span class="line">            output.Attributes.Add(<span class="string">&quot;style&quot;</span>, <span class="string">&quot;color:red&quot;</span>);</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>标签属性传值</p>
<p><img src="https://blogimage-1255495010.cos.ap-beijing.myqcloud.com/image-20210822212634256.png" alt="image-20210822212634256"></p>
<p>效果</p>
<p><img src="https://blogimage-1255495010.cos.ap-beijing.myqcloud.com/image-20210822212831324.png" alt="image-20210822212831324"></p>
</li>
</ol>
</li>
</ol>
<h3 id="局部视图"><a href="#局部视图" class="headerlink" title="局部视图"></a>局部视图</h3><ol>
<li><p>添加局部视图，其实就是在对应的view层添加一个cshtml文件</p>
<p><img src="https://blogimage-1255495010.cos.ap-beijing.myqcloud.com/image-20210823212950311.png" alt="image-20210823212950311"></p>
</li>
<li><p>编辑 PartialView.cshtml ,相当于定义好局部视图，就长这个样子，Harris标签应用与上一节扩展控件内容。</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">@model string</span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">Harris</span> <span class="attr">id</span>=<span class="string">&quot;@Model&quot;</span> <span class="attr">name</span>=<span class="string">&quot;@Model&quot;</span> <span class="attr">age</span>=<span class="string">&quot;@Model&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">Harris</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">Harris</span> <span class="attr">id</span>=<span class="string">&quot;@Model&quot;</span> <span class="attr">name</span>=<span class="string">&quot;@Model&quot;</span> <span class="attr">age</span>=<span class="string">&quot;@Model&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">Harris</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">Harris</span> <span class="attr">id</span>=<span class="string">&quot;@Model&quot;</span> <span class="attr">name</span>=<span class="string">&quot;@Model&quot;</span> <span class="attr">age</span>=<span class="string">&quot;@Model&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">Harris</span>&gt;</span></span><br></pre></td></tr></table></figure></li>
<li><p>应用 <code>@Html.Partial</code></p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">@*局部视图*@</span><br><span class="line">@Html.Partial(&quot;PartialView&quot;, &quot;123&quot;)// 123 是参数，也就是说，在调用局部视图得时候，其实可以间接设置其内容</span><br></pre></td></tr></table></figure></li>
<li><p>呈现</p>
<p><img src="https://blogimage-1255495010.cos.ap-beijing.myqcloud.com/image-20210823213304825.png" alt="image-20210823213304825"></p>
</li>
</ol>
<h3 id="视图组件"><a href="#视图组件" class="headerlink" title="视图组件"></a>视图组件</h3><ol>
<li><p>新建视图组件扩展类</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> Microsoft.AspNetCore.Mvc;</span><br><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> System.Linq;</span><br><span class="line"><span class="keyword">using</span> System.Threading.Tasks;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">DotNetCoreDemo.Utility</span></span><br><span class="line">&#123;</span><br><span class="line">    [<span class="meta">ViewComponent(Name = <span class="string">&quot;CustomList&quot;</span>)</span>]</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">ListViewComponent</span> : <span class="title">ViewComponent</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">async</span> Task&lt;IViewComponentResult&gt; <span class="title">InvokeAsync</span>(<span class="params"><span class="built_in">string</span> SeachVal</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">var</span> list = <span class="keyword">await</span> GetStudents(SeachVal);</span><br><span class="line"></span><br><span class="line">            ViewBag.User = <span class="string">&quot;Harris&quot;</span>;<span class="comment">//可以用这个，等等...</span></span><br><span class="line"></span><br><span class="line">            <span class="comment">//return View(list);// 默认找得是~/Views/Shared/CustomList/Default.cshtml</span></span><br><span class="line"></span><br><span class="line">            <span class="comment">//这里可以指定视图组件的路径</span></span><br><span class="line">            <span class="keyword">return</span> View(<span class="string">&quot;~/Views/Shared/Components/Test/DefaultTest.cshtml&quot;</span>, list);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> Task&lt;List&lt;Student&gt;&gt; GetStudents(<span class="built_in">string</span> SeachVal)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> Task.Run(() =&gt;</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">new</span> List&lt;Student&gt;()</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="keyword">new</span> Student &#123; ID=<span class="number">1</span>,NAME = <span class="string">&quot;Harris&quot;</span>&#125;,</span><br><span class="line">                    <span class="keyword">new</span> Student &#123; ID=<span class="number">2</span>,NAME = <span class="string">&quot;Make&quot;</span>&#125;,</span><br><span class="line">                    <span class="keyword">new</span> Student &#123; ID=<span class="number">3</span>,NAME = <span class="string">&quot;Ped&quot;</span>&#125;,</span><br><span class="line">                    <span class="keyword">new</span> Student &#123; ID=<span class="number">4</span>,NAME = <span class="string">&quot;Henry&quot;</span>&#125;</span><br><span class="line">                &#125;;</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">Student</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">int</span> ID &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">string</span> NAME &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>主要是继承 <code>ViewComponent</code></p>
</li>
<li><p>新建视图组件视图</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">@using DotNetCoreDemo.Utility</span><br><span class="line"></span><br><span class="line">@model List<span class="tag">&lt;<span class="name">Student</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">ul</span>&gt;</span></span><br><span class="line">    @foreach (var item in Model)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="tag">&lt;<span class="name">li</span>&gt;</span>@item.NAME<span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">    &#125;</span><br><span class="line"><span class="tag">&lt;/<span class="name">ul</span>&gt;</span></span><br></pre></td></tr></table></figure></li>
<li><p>应用</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">@*视图组件*@</span><br><span class="line"><span class="tag">&lt;<span class="name">h2</span>&gt;</span>视图组件<span class="tag">&lt;/<span class="name">h2</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">table</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">tr</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">td</span>&gt;</span>@await Component.InvokeAsync(&quot;CustomList&quot;, new &#123; SeachVal = &quot;123456&quot; &#125;)<span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">td</span>&gt;</span>@await Component.InvokeAsync(&quot;CustomList&quot;, new &#123; SeachVal = &quot;321321&quot; &#125;)<span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">td</span>&gt;</span>@await Component.InvokeAsync(&quot;CustomList&quot;, new &#123; SeachVal = &quot;321321&quot; &#125;)<span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">td</span>&gt;</span>@await Component.InvokeAsync(&quot;CustomList&quot;, new &#123; SeachVal = &quot;321321&quot; &#125;)<span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">td</span>&gt;</span>@await Component.InvokeAsync(&quot;CustomList&quot;, new &#123; SeachVal = &quot;321321&quot; &#125;)<span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">tr</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">table</span>&gt;</span></span><br></pre></td></tr></table></figure></li>
<li><p>项目列表</p>
<p><img src="https://blogimage-1255495010.cos.ap-beijing.myqcloud.com/image-20210824222129039.png" alt="image-20210824222129039"></p>
<ol>
<li><p><code>Components/CustomList/Default.cshtml</code> 与 <code>Components/Test/DefaultTest.cshtml</code> 中间的区别就是上面第一点中所说的，在返回View()的时候，要不要传具体路径的区别。</p>
<p><img src="https://blogimage-1255495010.cos.ap-beijing.myqcloud.com/image-20210824222356654.png" alt="image-20210824222356654"></p>
</li>
<li><p>还得关心一下这个类里的异步结构。</p>
</li>
</ol>
</li>
<li><p>结果</p>
<p><img src="https://blogimage-1255495010.cos.ap-beijing.myqcloud.com/image-20210824222521682.png" alt="image-20210824222521682"></p>
<ol>
<li>这地方主要是用的DefaultTest.cshtml,Harris 就是从 ViewBag.User 传过来滴。</li>
</ol>
</li>
</ol>
<h2 id="IOC"><a href="#IOC" class="headerlink" title="IOC"></a>IOC</h2><h3 id="IOC出现的背景"><a href="#IOC出现的背景" class="headerlink" title="IOC出现的背景"></a>IOC出现的背景</h3><p>我们知道，软件开发领域有句著名的论断：不要重复发明轮子！因为软件开发讲求复用，所以，对于应用频繁的需求，总是有人设计各种通用框架和类库以减轻人们的开发负担。例如，数据持久化是非常频繁的需求，于是各种ORM框架应运而生；再如，对MVC的需求催生了Struts等一批用来实现MVC的框架。</p>
<p>随着面向对象分析与设计的发展和成熟，OOA&amp;D被越来越广泛应用于各种项目中，然而，我们知道，用OO就不可能不用多态性，用多态性就不可能不用依赖注入，所以，依赖注入变成了非常频繁的需求，而如果全部手工完成，不但负担太重，而且还容易出错。再加上反射机制的发明，于是，自然有人开始设计开发各种用于依赖注入的专用框架。这些专门用于实现依赖注入功能的组件或框架，就是IoC Container。从这点看，IoC Container的出现有其历史必然性。目前，最著名的IoC也许就是Java平台上的Spring框架的IoC组件，而.NET平台上也有Spring.NET和Unity等。 </p>
<h3 id="IOC是什么"><a href="#IOC是什么" class="headerlink" title="IOC是什么"></a>IOC是什么</h3><p>IOC（Inversion of Control），即<strong>“控制反转”</strong>，不是什么技术，而是一种设计思想。在Java开发中，IOC意味着将你设计好的对象交给容器控制，而不是传统的在你的对象内部直接控制。如何理解好Ioc呢？理解好Ioc的关键是要明确“谁控制谁，控制什么，为何是反转（有反转就应该有正转了），哪些方面反转了”，那我们来深入分析一下： </p>
<ul>
<li><strong>谁控制谁，控制什么：</strong>传统Java SE程序设计，我们直接在对象内部通过new进行创建对象，是程序主动去创建依赖对象；而IOC是有专门一个容器来创建这些对象，即由IOC容器来控制对象的创建；谁控制谁？当然是IOC容器控制了对象；控制什么？那就是主要控制了外部资源获取</li>
<li><strong>为何是反转，哪些方面反转了：</strong>有反转就有正转，传统应用程序是由我们自己在对象中主动控制去直接获取依赖对象，也就是正转；而反转则是由容器来帮忙创建及注入依赖对象；为何是反转？因为由容器帮我们查找及注入依赖对象，对象只是被动的接受依赖对象，所以是反转；哪些方面反转了？依赖对象的获取被反转了。</li>
</ul>
<p><img src="https://blogimage-1255495010.cos.ap-beijing.myqcloud.com/983950-20200828140652970-543560967.png" alt="img"></p>
<p><img src="https://blogimage-1255495010.cos.ap-beijing.myqcloud.com/983950-20200828141239801-1102376797.png" alt="img"></p>
<h3 id="IOC能做什么"><a href="#IOC能做什么" class="headerlink" title="IOC能做什么"></a>IOC能做什么</h3><p>IoC不是一种技术，只是一种思想，一个重要的面向对象编程的法则，它能指导我们如何设计出松耦合、更优良的程序。传统应用程序都是由我们在类内部主动创建依赖对象，从而导致类与类之间高耦合，难于测试；有了IoC容器后，把创建和查找依赖对象的控制权交给了容器，由容器进行注入组合对象，所以对象与对象之间是松散耦合，这样也方便测试，利于功能复用，更重要的是使得程序的整个体系结构变得非常灵活。</p>
<p>其实IoC对编程带来的最大改变不是从代码上，而是从思想上，发生了“主从换位”的变化。应用程序原本是老大，要获取什么资源都是主动出击，但是在IoC/DI思想中，应用程序就变成被动的了，被动的等待IoC容器来创建并注入它所需要的资源了。</p>
<p>IoC很好的体现了面向对象设计法则之一—— 好莱坞法则：“别找我们，我们找你”；即由IoC容器帮对象找相应的依赖对象并注入，而不是由对象主动去找。 </p>
<h3 id="IOC和DI"><a href="#IOC和DI" class="headerlink" title="IOC和DI"></a>IOC和DI</h3><p>DI—Dependency Injection，即“依赖注入”：是组件之间依赖关系由容器在运行期决定，形象的说，即由容器动态的将某个依赖关系注入到组件之中。依赖注入的目的并非为软件系统带来更多功能，而是为了提升组件重用的频率，并为系统搭建一个灵活、可扩展的平台。通过依赖注入机制，我们只需要通过简单的配置，而无需任何代码就可指定目标需要的资源，完成自身的业务逻辑，而不需要关心具体的资源来自何处，由谁实现。 </p>
<p>理解DI的关键是：“谁依赖谁，为什么需要依赖，谁注入谁，注入了什么”，那我们来深入分析一下： </p>
<ul>
<li><strong>谁依赖于谁：</strong>当然是应用程序依赖于IoC容器</li>
<li><strong>为什么需要依赖：</strong>应用程序需要IoC容器来提供对象需要的外部资源</li>
<li><strong>谁注入谁：</strong>很明显是IoC容器注入应用程序某个对象，应用程序依赖的对象</li>
<li><strong>注入了什么：</strong>就是注入某个对象所需要的外部资源（包括对象、资源、常量数据） </li>
</ul>
<p><strong>IOC和DI有什么关系呢？</strong>其实它们是同一个概念的不同角度描述，由于控制反转概念比较含糊（可能只是理解为容器控制对象这一个层面，很难让人想到谁来维护对象关系），所以2004年大师级人物Martin Fowler又给出了一个新的名字：“依赖注入”，相对IoC 而言，<strong>“依赖注入”明确描述了“被注入对象依赖IoC容器配置依赖对象”。</strong></p>
<h3 id="Dl-注入方式"><a href="#Dl-注入方式" class="headerlink" title="Dl 注入方式"></a>Dl 注入方式</h3><p>交代一下服务和接口</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//InterFace</span></span><br><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> System.Linq;</span><br><span class="line"><span class="keyword">using</span> System.Text;</span><br><span class="line"><span class="keyword">using</span> System.Threading.Tasks;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">DotNetCoreDemo.Interface</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">interface</span> <span class="title">ITestServiceA</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="function"><span class="keyword">void</span> <span class="title">Show</span>()</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//Service</span></span><br><span class="line"><span class="keyword">using</span> DotNetCoreDemo.Interface;</span><br><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> System.Linq;</span><br><span class="line"><span class="keyword">using</span> System.Text;</span><br><span class="line"><span class="keyword">using</span> System.Threading.Tasks;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">DotNetCoreDemo.Service</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">TestServiceA</span> : <span class="title">ITestServiceA</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">TestServiceA</span>()</span></span><br><span class="line">        &#123;</span><br><span class="line">            Console.WriteLine(<span class="keyword">this</span>.GetType().Name + <span class="string">&quot;构造了&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Show</span>()</span></span><br><span class="line">        &#123;</span><br><span class="line">            Console.WriteLine(<span class="keyword">this</span>.GetType().Name + <span class="string">&quot;Show&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<ol>
<li><p>第一种</p>
<ol>
<li><p>在 <code>Startup</code> 中的 <code>ConfigureServices</code> 中注册。</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">services.AddTransient&lt;ITestServiceA, TestServiceA&gt;();</span><br></pre></td></tr></table></figure></li>
<li><p>在控制器中先实例化一个私有只读的<code>ITestServiceA</code> 对象，然后新建构造函数，构造函数的入参也是<code>ITestServiceA</code> 对象。在构造函数中，将入参的<code>ITestServiceA</code>对象赋值给实例化好的<code>ITestServiceA</code> 对象，然后就可以在方法中使用。</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line">      <span class="keyword">using</span> DotNetCoreDemo.Interface;</span><br><span class="line">      <span class="keyword">using</span> Microsoft.AspNetCore.Mvc;</span><br><span class="line">      <span class="keyword">using</span> System;</span><br><span class="line">      <span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line">      <span class="keyword">using</span> System.Linq;</span><br><span class="line">      <span class="keyword">using</span> System.Threading.Tasks;</span><br><span class="line">      </span><br><span class="line">      <span class="keyword">namespace</span> <span class="title">DotNetCoreDemo.Controllers</span></span><br><span class="line">      &#123;</span><br><span class="line">          <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">IOCController</span> : <span class="title">Controller</span></span><br><span class="line">          &#123;</span><br><span class="line">              <span class="comment">//实例化一个私有只读的`ITestServiceA` 对象</span></span><br><span class="line">              <span class="keyword">private</span> <span class="keyword">readonly</span> ITestServiceA _ItestServiceA = <span class="literal">null</span>;<span class="comment">//</span></span><br><span class="line">      		</span><br><span class="line">              <span class="comment">//构造函数</span></span><br><span class="line">              <span class="function"><span class="keyword">public</span> <span class="title">IOCController</span>(<span class="params">ITestServiceA itestserviceA</span>)</span></span><br><span class="line">              &#123;</span><br><span class="line">                  _ItestServiceA = itestserviceA;</span><br><span class="line">              &#125;</span><br><span class="line">      </span><br><span class="line">              <span class="function"><span class="keyword">public</span> IActionResult <span class="title">Index</span>()</span></span><br><span class="line">              &#123;</span><br><span class="line">                  <span class="comment">//应用</span></span><br><span class="line">                  _ItestServiceA.Show();</span><br><span class="line">      </span><br><span class="line">                  <span class="keyword">return</span> View();</span><br><span class="line">              &#125;</span><br><span class="line">          &#125;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line"><span class="number">2.</span> 第二种</span><br><span class="line"></span><br><span class="line">   <span class="number">1.</span> 同第一种一样，同样也得先在Startup中注册。</span><br><span class="line"></span><br><span class="line">   <span class="number">2.</span> 在控制器中先实例化一个私有只读的`IServiceProvider` 对象，然后新建构造函数，构造函数的入参也是`IServiceProvider` 对象。在构造函数中，将入参的`IServiceProvider`对象赋值给实例化好的`IServiceProvider` 对象。但是在使用的时候有差异。</span><br><span class="line"></span><br><span class="line">      ``` CSharp</span><br><span class="line">      <span class="keyword">using</span> DotNetCoreDemo.Interface;</span><br><span class="line">      <span class="keyword">using</span> Microsoft.AspNetCore.Mvc;</span><br><span class="line">      <span class="keyword">using</span> System;</span><br><span class="line">      <span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line">      <span class="keyword">using</span> System.Linq;</span><br><span class="line">      <span class="keyword">using</span> System.Threading.Tasks;</span><br><span class="line">      </span><br><span class="line">      <span class="keyword">namespace</span> <span class="title">DotNetCoreDemo.Controllers</span></span><br><span class="line">      &#123;</span><br><span class="line">          <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">IOCController</span> : <span class="title">Controller</span></span><br><span class="line">          &#123;</span><br><span class="line">              <span class="keyword">private</span> <span class="keyword">readonly</span> ITestServiceA _ItestServiceA = <span class="literal">null</span>;</span><br><span class="line">      </span><br><span class="line">              <span class="keyword">private</span> <span class="keyword">readonly</span> IServiceProvider _serviceProvider = <span class="literal">null</span>;</span><br><span class="line">      </span><br><span class="line">              <span class="function"><span class="keyword">public</span> <span class="title">IOCController</span>(<span class="params">ITestServiceA itestserviceA, IServiceProvider serviceProvider</span>)</span></span><br><span class="line">              &#123;</span><br><span class="line">                  _ItestServiceA = itestserviceA;</span><br><span class="line">      </span><br><span class="line">                  _serviceProvider = serviceProvider;</span><br><span class="line">              &#125;</span><br><span class="line">      </span><br><span class="line">              <span class="function"><span class="keyword">public</span> IActionResult <span class="title">Index</span>()</span></span><br><span class="line">              &#123;</span><br><span class="line">                  _ItestServiceA.Show();</span><br><span class="line">      </span><br><span class="line">                  ITestServiceA testServiceA = (ITestServiceA)_serviceProvider.GetService(<span class="keyword">typeof</span>(ITestServiceA));</span><br><span class="line">      </span><br><span class="line">                  testServiceA.Show();</span><br><span class="line">      </span><br><span class="line">                  <span class="keyword">return</span> View();</span><br><span class="line">              &#125;</span><br><span class="line">          &#125;</span><br><span class="line">      &#125;</span><br></pre></td></tr></table></figure></li>
</ol>
</li>
<li><p>第三种</p>
<p>在视图中注册</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">@inject DotNetCoreDemo.Interface.ITestServiceA testServiceA</span><br><span class="line"></span><br><span class="line">@&#123; </span><br><span class="line">    testServiceA.Show();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ol>
<h3 id="Dl-依赖注入"><a href="#Dl-依赖注入" class="headerlink" title="Dl 依赖注入"></a>Dl 依赖注入</h3><p>如果对象B依赖与对象A，就可以先构造A传递给B,然后得到对应得B得对象实力。</p>
<p>依赖注入可以无限层级的注入，前提是先注入服务。</p>
<p>ServiceA 层</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> DotNetCoreDemo.Interface;</span><br><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> System.Linq;</span><br><span class="line"><span class="keyword">using</span> System.Text;</span><br><span class="line"><span class="keyword">using</span> System.Threading.Tasks;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">DotNetCoreDemo.Service</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">TestServiceA</span> : <span class="title">ITestServiceA</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">TestServiceA</span>()</span></span><br><span class="line">        &#123;</span><br><span class="line">            Console.WriteLine(<span class="keyword">this</span>.GetType().Name + <span class="string">&quot;构造了&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">		</span><br><span class="line">        <span class="comment">//拓展方法</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="built_in">string</span> <span class="title">ReturnStr</span>(<span class="params"><span class="built_in">string</span> str</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> str + GetType().Name.ToString();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Show</span>()</span></span><br><span class="line">        &#123;</span><br><span class="line">            Console.WriteLine(GetType().Name + <span class="string">&quot;Show&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>InterfaceA 层</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> <span class="title">DotNetCoreDemo.Interface</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">interface</span> <span class="title">ITestServiceA</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="function"><span class="keyword">void</span> <span class="title">Show</span>()</span>;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="built_in">string</span> <span class="title">ReturnStr</span>(<span class="params"><span class="built_in">string</span> str</span>)</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ServiceB层</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> DotNetCoreDemo.Interface;</span><br><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> System.Linq;</span><br><span class="line"><span class="keyword">using</span> System.Text;</span><br><span class="line"><span class="keyword">using</span> System.Threading.Tasks;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">DotNetCoreDemo.Service</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">TestServiceB</span> : <span class="title">ITestServiceB</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">readonly</span> ITestServiceA _testServiceA = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> TestServiceB 依赖于 TestServiceA</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;testServiceA&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 到这，testServiceA 已经传递过来了。这个时候，TestServiceB 的方法中就可以使用TestServerA中的内容</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">TestServiceB</span>(<span class="params">ITestServiceA testServiceA</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            _testServiceA = testServiceA;</span><br><span class="line"></span><br><span class="line">            Console.WriteLine(<span class="keyword">this</span>.GetType().Name + <span class="string">&quot;构造了&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Show</span>()</span></span><br><span class="line">        &#123;</span><br><span class="line">            _testServiceA.Show();</span><br><span class="line"></span><br><span class="line">            Console.WriteLine(<span class="keyword">this</span>.GetType().Name + <span class="string">&quot;Show&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="built_in">string</span> <span class="title">ReturnStr</span>()</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">//获取接口方法A的值</span></span><br><span class="line">            <span class="built_in">string</span> str = _testServiceA.ReturnStr(<span class="string">&quot;123&quot;</span>);</span><br><span class="line">			</span><br><span class="line">            <span class="built_in">string</span> str_ = str + <span class="keyword">this</span>.GetType().Name.ToString();</span><br><span class="line">			<span class="comment">//返回</span></span><br><span class="line">            <span class="keyword">return</span> str_;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>InterfaceB层</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> System.Linq;</span><br><span class="line"><span class="keyword">using</span> System.Text;</span><br><span class="line"><span class="keyword">using</span> System.Threading.Tasks;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">DotNetCoreDemo.Interface</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">interface</span> <span class="title">ITestServiceB</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="function"><span class="keyword">void</span> <span class="title">Show</span>()</span>;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="built_in">string</span> <span class="title">ReturnStr</span>()</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Startup 注入</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">ConfigureServices</span>(<span class="params">IServiceCollection services</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="meta">#<span class="keyword">region</span> IOC注册服务</span></span><br><span class="line"></span><br><span class="line">    services.AddTransient&lt;ITestServiceA, TestServiceA&gt;();</span><br><span class="line">    services.AddTransient&lt;ITestServiceB, TestServiceB&gt;();<span class="comment">//注入 TestServiceB</span></span><br><span class="line"></span><br><span class="line">    <span class="meta">#<span class="keyword">endregion</span></span></span><br><span class="line"></span><br><span class="line">    services.AddControllersWithViews();</span><br><span class="line"></span><br><span class="line">    services.AddSession();</span><br><span class="line"></span><br><span class="line">    <span class="comment">//加入中间件，方便实时调试HTML</span></span><br><span class="line">    services.AddRazorPages().AddRazorRuntimeCompilation();</span><br><span class="line"></span><br><span class="line">    <span class="comment">//注入服务</span></span><br><span class="line">    services.AddTransient&lt;ICoustomInterface, CoustomService&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="comment">//取配置文件中的TEST节点，映射到 TESTMODEL 实体</span></span><br><span class="line">    services.Configure&lt;TESTMODEL&gt;(Configuration.GetSection(<span class="string">&quot;TEST&quot;</span>));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<pre><code>    上述，呈现出的，就是ServiceB 依赖 ServiceA ,在 ServiceB 的构造方法中，传入 ServiceA ,然后再 ServiceB 中，调用 ServiceA 的方法，构成了ServiceB ReturnStr 方法结果的呈现。应该能诠释 依赖注入的概念了，以此类推，可以衍生出 各种依赖。不怕注册的多服务，尽管上。
</code></pre>
<h3 id="IServiceCollection-生命周期"><a href="#IServiceCollection-生命周期" class="headerlink" title="IServiceCollection 生命周期"></a>IServiceCollection 生命周期</h3><ol>
<li><p>瞬时生命周期 Addtransient 注册的生命周期：每次都实例化一个新的。<strong>正常瞬时生命周期使用的多，每次一个对象</strong></p>
<p><img src="https://blogimage-1255495010.cos.ap-beijing.myqcloud.com/image-20210828145713938.png" alt="image-20210828145713938"></p>
</li>
<li><p>单例生命周期：AddSingleton 注册的生命周期：serviceA2_1 走过一遍后，serviceA2_2 直接就过去了，所以这玩意注册，一直玩的就一个。</p>
<p><img src="https://blogimage-1255495010.cos.ap-beijing.myqcloud.com/image-20210828145845491.png" alt="image-20210828145845491"></p>
</li>
<li><p>作用域生命周期</p>
<p>同一个IServiceCollection ，不同的ServiceProvider 实例化出来的对象，在每个ServiceProvider 内实例化的对象相当于单例，但是不同的 ServiceProvider 之间 是不一样的。</p>
<p><img src="https://blogimage-1255495010.cos.ap-beijing.myqcloud.com/image-20210828151007374.png" alt="image-20210828151007374"></p>
</li>
<li><p>Code</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">ConfigureServices</span>(<span class="params">IServiceCollection services</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">            <span class="meta">#<span class="keyword">region</span> IOC注册服务</span></span><br><span class="line"></span><br><span class="line">            services.AddTransient&lt;ITestServiceA, TestServiceA&gt;();</span><br><span class="line">            services.AddTransient&lt;ITestServiceB, TestServiceB&gt;();</span><br><span class="line"></span><br><span class="line">            <span class="meta">#<span class="keyword">endregion</span></span></span><br><span class="line"></span><br><span class="line">            <span class="meta">#<span class="keyword">region</span> 服务控制器 生命周期</span></span><br><span class="line"></span><br><span class="line">            <span class="meta">#<span class="keyword">region</span> 瞬时生命周期 每次获取的实例都是不同的实例</span></span><br><span class="line"></span><br><span class="line">            IServiceCollection services1 = <span class="keyword">new</span> ServiceCollection();</span><br><span class="line"></span><br><span class="line">            services1.AddTransient&lt;ITestServiceA, TestServiceA&gt;();</span><br><span class="line"></span><br><span class="line">            ServiceProvider serviceProvider = services1.BuildServiceProvider();</span><br><span class="line"></span><br><span class="line">            ITestServiceA serviceA1_1 = serviceProvider.GetService&lt;ITestServiceA&gt;();</span><br><span class="line"></span><br><span class="line">            ITestServiceA serviceA1_2 = serviceProvider.GetService&lt;ITestServiceA&gt;();</span><br><span class="line">            <span class="comment">//比较上述这俩实例是不是同一个</span></span><br><span class="line">            <span class="built_in">bool</span> IsOk1 = <span class="built_in">object</span>.ReferenceEquals(serviceA1_1, serviceA1_2);</span><br><span class="line"></span><br><span class="line">            <span class="meta">#<span class="keyword">endregion</span></span></span><br><span class="line"></span><br><span class="line">            <span class="meta">#<span class="keyword">region</span> 单例生命周期 每次获取的时候都是同一个实例</span></span><br><span class="line"></span><br><span class="line">            IServiceCollection services2 = <span class="keyword">new</span> ServiceCollection();</span><br><span class="line"></span><br><span class="line">            services2.AddSingleton&lt;ITestServiceA, TestServiceA&gt;();</span><br><span class="line"></span><br><span class="line">            ServiceProvider serviceProvider2 = services2.BuildServiceProvider();</span><br><span class="line"></span><br><span class="line">            ITestServiceA serviceA2_1 = serviceProvider2.GetService&lt;ITestServiceA&gt;();</span><br><span class="line"></span><br><span class="line">            ITestServiceA serviceA2_2 = serviceProvider2.GetService&lt;ITestServiceA&gt;();</span><br><span class="line">            <span class="comment">//比较上述这俩实例是不是同一个</span></span><br><span class="line">            <span class="built_in">bool</span> IsOk2 = <span class="built_in">object</span>.ReferenceEquals(serviceA2_1, serviceA2_2);</span><br><span class="line"></span><br><span class="line">            <span class="meta">#<span class="keyword">endregion</span></span></span><br><span class="line"></span><br><span class="line">            <span class="meta">#<span class="keyword">region</span> 作用域生命周期</span></span><br><span class="line"></span><br><span class="line">            IServiceCollection services3 = <span class="keyword">new</span> ServiceCollection();</span><br><span class="line"></span><br><span class="line">            services3.AddScoped&lt;ITestServiceA, TestServiceA&gt;();</span><br><span class="line"></span><br><span class="line">            ServiceProvider serviceProvider3_1 = services3.BuildServiceProvider();</span><br><span class="line"></span><br><span class="line">            ITestServiceA serviceA3_1 = serviceProvider3_1.GetService&lt;ITestServiceA&gt;();</span><br><span class="line"></span><br><span class="line">            ITestServiceA serviceA3_2 = serviceProvider3_1.GetService&lt;ITestServiceA&gt;();</span><br><span class="line">            <span class="comment">//比较上述这俩实例是不是同一个</span></span><br><span class="line">            <span class="built_in">bool</span> IsOk3 = <span class="built_in">object</span>.ReferenceEquals(serviceA3_1, serviceA3_2);</span><br><span class="line"></span><br><span class="line">            ServiceProvider serviceProvider3_2 = services3.BuildServiceProvider();</span><br><span class="line"></span><br><span class="line">            ITestServiceA serviceA3_3 = serviceProvider3_2.GetService&lt;ITestServiceA&gt;();</span><br><span class="line"></span><br><span class="line">            ITestServiceA serviceA3_4 = serviceProvider3_2.GetService&lt;ITestServiceA&gt;();</span><br><span class="line"></span><br><span class="line">            <span class="built_in">bool</span> IsOk4 = <span class="built_in">object</span>.ReferenceEquals(serviceA3_3, serviceA3_4);</span><br><span class="line"></span><br><span class="line">            <span class="built_in">bool</span> IsOk5 = <span class="built_in">object</span>.ReferenceEquals(serviceA3_1, serviceA3_3);</span><br><span class="line"></span><br><span class="line">            <span class="meta">#<span class="keyword">endregion</span></span></span><br><span class="line"></span><br><span class="line">            <span class="meta">#<span class="keyword">endregion</span></span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">            services.AddControllersWithViews();</span><br><span class="line"></span><br><span class="line">            services.AddSession();</span><br><span class="line"></span><br><span class="line">            <span class="comment">//加入中间件，方便实时调试HTML</span></span><br><span class="line">            services.AddRazorPages().AddRazorRuntimeCompilation();</span><br><span class="line"></span><br><span class="line">            <span class="comment">//注入服务</span></span><br><span class="line">            services.AddTransient&lt;ICoustomInterface, CoustomService&gt;();</span><br><span class="line"></span><br><span class="line">            <span class="comment">//取配置文件中的TEST节点，映射到 TESTMODEL 实体</span></span><br><span class="line">            services.Configure&lt;TESTMODEL&gt;(Configuration.GetSection(<span class="string">&quot;TEST&quot;</span>));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ol>
<h2 id="Autofac-应用"><a href="#Autofac-应用" class="headerlink" title="Autofac 应用"></a>Autofac 应用</h2><h3 id="初识-Autofac"><a href="#初识-Autofac" class="headerlink" title="初识 Autofac"></a>初识 Autofac</h3><p><strong>Autofac 是一款第三方，很流行的 IOC容器，应用方法如下：</strong></p>
<ol>
<li>Nuget 获取 Autofac 组件。</li>
<li>创建一个ContainerBuilder 对象</li>
<li>注册抽象和实现方法 格式：builder.RegisterType&lt;实现方法&gt;().As&lt;抽象接口&gt;();</li>
<li>Build 得到 container 容器</li>
<li>管 container 容器 要 ITestServiceA 服务</li>
<li>应用 要到的 ITestServiceA 服务</li>
</ol>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">region</span> Autofac 应用</span></span><br><span class="line"><span class="comment">//1. Nuget Autofac </span></span><br><span class="line"><span class="comment">//2. 创建一个ContainerBuilder 对象 </span></span><br><span class="line">ContainerBuilder builder = <span class="keyword">new</span> ContainerBuilder();</span><br><span class="line"><span class="comment">//3. 注册抽象和实现方法 格式：builder.RegisterType&lt;实现方法&gt;().As&lt;ITestServiceA&gt;();</span></span><br><span class="line">builder.RegisterType&lt;TestServiceA&gt;().As&lt;ITestServiceA&gt;();</span><br><span class="line"><span class="comment">//4. Build 得到 container 容器</span></span><br><span class="line">IContainer container = builder.Build();</span><br><span class="line"><span class="comment">//5. 管 container 容器 要 ITestServiceA 服务</span></span><br><span class="line">ITestServiceA testServiceA = container.Resolve&lt;ITestServiceA&gt;();<span class="comment">//获取服务</span></span><br><span class="line"><span class="comment">//6. 应用 要到的 ITestServiceA 服务</span></span><br><span class="line">testServiceA.Show();</span><br><span class="line"><span class="meta">#<span class="keyword">endregion</span></span></span><br></pre></td></tr></table></figure>

<h3 id="Autofac-多种注册方式"><a href="#Autofac-多种注册方式" class="headerlink" title="Autofac 多种注册方式"></a>Autofac 多种注册方式</h3><p><strong>第一种：构造函数注入</strong> </p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">ContainerBuilder builder1 = <span class="keyword">new</span> ContainerBuilder();</span><br><span class="line">builder1.RegisterType&lt;TestServiceA&gt;().As&lt;ITestServiceA&gt;();</span><br><span class="line">builder1.RegisterType&lt;TestServiceB&gt;().As&lt;ITestServiceB&gt;();</span><br><span class="line">builder1.RegisterType&lt;TestServiceC&gt;().As&lt;ITestServiceC&gt;();</span><br><span class="line">IContainer container1 = builder1.Build();</span><br><span class="line">ITestServiceC testServiceC1 = container1.Resolve&lt;ITestServiceC&gt;();</span><br><span class="line">testServiceC1.Show();</span><br></pre></td></tr></table></figure>

<p>这没啥说的，基本操作。</p>
<p><strong>第二种：属性注入</strong></p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">ContainerBuilder builder2 = <span class="keyword">new</span> ContainerBuilder();</span><br><span class="line">builder2.RegisterType&lt;TestServiceA&gt;().As&lt;ITestServiceA&gt;();</span><br><span class="line">builder2.RegisterType&lt;TestServiceB&gt;().As&lt;ITestServiceB&gt;();</span><br><span class="line">builder2.RegisterType&lt;TestServiceC&gt;().As&lt;ITestServiceC&gt;();</span><br><span class="line">builder2.RegisterType&lt;TestServiceD&gt;().As&lt;ITestServiceD&gt;().PropertiesAutowired();</span><br><span class="line">IContainer container2 = builder2.Build();</span><br><span class="line">ITestServiceD testServiceD = container2.Resolve&lt;ITestServiceD&gt;();</span><br><span class="line">testServiceD.Show();</span><br></pre></td></tr></table></figure>

<p>关注一下<code>TestServiceD</code> 里，还有 <code>PropertiesAutowired()</code></p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> DotNetCoreDemo.Interface;</span><br><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> System.Linq;</span><br><span class="line"><span class="keyword">using</span> System.Text;</span><br><span class="line"><span class="keyword">using</span> System.Threading.Tasks;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">DotNetCoreDemo.Service</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">TestServiceD</span> : <span class="title">ITestServiceD</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">public</span> ITestServiceA testServiceA &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">        <span class="keyword">public</span> ITestServiceB testServiceB &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">        <span class="keyword">public</span> ITestServiceC testServiceC &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">TestServiceD</span>()</span></span><br><span class="line">        &#123;</span><br><span class="line">            Console.WriteLine(<span class="keyword">this</span>.GetType().Name + <span class="string">&quot;构造了&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Show</span>()</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">//基于TestService ABC 都注册了，在执行下面这行代码的时候 才会去Set属性值，会挨个都执行ABC的构造函数。</span></span><br><span class="line">            testServiceA.Show();</span><br><span class="line">            Console.WriteLine(<span class="keyword">this</span>.GetType().Name + <span class="string">&quot;Show&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><strong>第三种：方法注入</strong></p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">ContainerBuilder builder3 = <span class="keyword">new</span> ContainerBuilder();</span><br><span class="line">builder3.RegisterType&lt;TestServiceA&gt;().As&lt;ITestServiceA&gt;();</span><br><span class="line">builder3.RegisterType&lt;TestServiceB&gt;().As&lt;ITestServiceB&gt;();</span><br><span class="line">builder3.RegisterType&lt;TestServiceC&gt;().OnActivated(e =&gt; e.Instance.SetService(e.Context.Resolve&lt;ITestServiceA&gt;())).As&lt;ITestServiceC&gt;();</span><br><span class="line">builder3.RegisterType&lt;TestServiceD&gt;().As&lt;ITestServiceD&gt;().PropertiesAutowired();</span><br><span class="line">IContainer container3 = builder3.Build();</span><br><span class="line">ITestServiceC testServiceC = container3.Resolve&lt;ITestServiceC&gt;();</span><br><span class="line">testServiceC.Show();</span><br></pre></td></tr></table></figure>

<p>这个地方需要关注两点：</p>
<ol>
<li><p>方法注入种 <code>TestServiceC</code>的注入方式与AB注入方式的差异<code>OnActivated</code></p>
</li>
<li><p>上述不同的注册方式是需要结合下面的代码使用,注意 <code>SetService</code>方法</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> DotNetCoreDemo.Interface;</span><br><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> System.Linq;</span><br><span class="line"><span class="keyword">using</span> System.Text;</span><br><span class="line"><span class="keyword">using</span> System.Threading.Tasks;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">DotNetCoreDemo.Service</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">TestServiceC</span> : <span class="title">ITestServiceC</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">private</span> ITestServiceA _testServiceA = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">SetService</span>(<span class="params">ITestServiceA testServiceA</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            _testServiceA = testServiceA;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">TestServiceC</span>(<span class="params">ITestServiceA serviceA</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            _testServiceA = serviceA;</span><br><span class="line"></span><br><span class="line">            Console.WriteLine(<span class="keyword">this</span>.GetType().Name + <span class="string">&quot;构造了&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Show</span>()</span></span><br><span class="line">        &#123;</span><br><span class="line">            _testServiceA.Show();</span><br><span class="line"></span><br><span class="line">            Console.WriteLine(<span class="keyword">this</span>.GetType().Name + <span class="string">&quot;Show&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ol>
<h3 id="Autofac-生命周期"><a href="#Autofac-生命周期" class="headerlink" title="Autofac 生命周期"></a>Autofac 生命周期</h3><p>第一种：瞬时生命周期（InstancePerDependency）</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">region</span> 瞬时生命周期 (InstancePerDependency)</span></span><br><span class="line">&#123;</span><br><span class="line">    ContainerBuilder builder4 = <span class="keyword">new</span> ContainerBuilder();</span><br><span class="line"></span><br><span class="line">    builder4.RegisterType&lt;TestServiceA&gt;().As&lt;ITestServiceA&gt;().InstancePerDependency();</span><br><span class="line"></span><br><span class="line">    IContainer container4 = builder4.Build();</span><br><span class="line"></span><br><span class="line">    ITestServiceA testServiceA1 = container4.Resolve&lt;ITestServiceA&gt;();</span><br><span class="line">    ITestServiceA testServiceA2 = container4.Resolve&lt;ITestServiceA&gt;();</span><br><span class="line"></span><br><span class="line">    Console.WriteLine(<span class="string">&quot;Autofac 生命周期-瞬时：&quot;</span> + <span class="built_in">object</span>.ReferenceEquals(testServiceA1, testServiceA2));</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">#<span class="keyword">endregion</span></span></span><br></pre></td></tr></table></figure>

<p>第二种：单例生命周期（SingleInstance）</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">region</span> 单例生命周期（SingleInstance）</span></span><br><span class="line">&#123;</span><br><span class="line">    ContainerBuilder builder4 = <span class="keyword">new</span> ContainerBuilder();</span><br><span class="line"></span><br><span class="line">    builder4.RegisterType&lt;TestServiceA&gt;().As&lt;ITestServiceA&gt;().SingleInstance();</span><br><span class="line"></span><br><span class="line">    IContainer container4 = builder4.Build();</span><br><span class="line"></span><br><span class="line">    ITestServiceA testServiceA1 = container4.Resolve&lt;ITestServiceA&gt;();</span><br><span class="line">    ITestServiceA testServiceA2 = container4.Resolve&lt;ITestServiceA&gt;();</span><br><span class="line"></span><br><span class="line">    Console.WriteLine(<span class="string">&quot;Autofac 生命周期-单例：&quot;</span> + <span class="built_in">object</span>.ReferenceEquals(testServiceA1, testServiceA2));</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">#<span class="keyword">endregion</span></span></span><br></pre></td></tr></table></figure>

<p>第三种：作用域生命周期（InstancePerLifetimeScope）</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">region</span> 作用域生命周期（InstancePerLifetimeScope）</span></span><br><span class="line">&#123;</span><br><span class="line">    ContainerBuilder builder4 = <span class="keyword">new</span> ContainerBuilder();</span><br><span class="line"></span><br><span class="line">    builder4.RegisterType&lt;TestServiceA&gt;().As&lt;ITestServiceA&gt;().InstancePerLifetimeScope();</span><br><span class="line"></span><br><span class="line">    IContainer container4 = builder4.Build();</span><br><span class="line"></span><br><span class="line">    ITestServiceA testServiceA5 = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">    ITestServiceA testServiceA6 = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">using</span> (<span class="keyword">var</span> Scope = container4.BeginLifetimeScope())</span><br><span class="line">    &#123;</span><br><span class="line">        ITestServiceA testServiceA1 = Scope.Resolve&lt;ITestServiceA&gt;();</span><br><span class="line"></span><br><span class="line">        ITestServiceA testServiceA2 = Scope.Resolve&lt;ITestServiceA&gt;();</span><br><span class="line"></span><br><span class="line">        Console.WriteLine(<span class="string">&quot;Autofac 生命周期-作用域1-1：&quot;</span> + <span class="built_in">object</span>.ReferenceEquals(testServiceA1, testServiceA2));<span class="comment">//True</span></span><br><span class="line"></span><br><span class="line">        testServiceA5 = testServiceA2;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">using</span> (<span class="keyword">var</span> Scope = container4.BeginLifetimeScope())</span><br><span class="line">    &#123;</span><br><span class="line">        ITestServiceA testServiceA3 = Scope.Resolve&lt;ITestServiceA&gt;();</span><br><span class="line"></span><br><span class="line">        ITestServiceA testServiceA4 = Scope.Resolve&lt;ITestServiceA&gt;();</span><br><span class="line"></span><br><span class="line">        Console.WriteLine(<span class="string">&quot;Autofac 生命周期-作用域2-2：&quot;</span> + <span class="built_in">object</span>.ReferenceEquals(testServiceA3, testServiceA4));<span class="comment">//True</span></span><br><span class="line"></span><br><span class="line">        testServiceA6 = testServiceA4;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    Console.WriteLine(<span class="string">&quot;Autofac 生命周期-作用域1-2：&quot;</span> + <span class="built_in">object</span>.ReferenceEquals(testServiceA5, testServiceA6));<span class="comment">//False</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">#<span class="keyword">endregion</span></span></span><br></pre></td></tr></table></figure>

<p>第三种扩展：加参数标记 </p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">region</span> 作用域生命周期-扩展（InstancePerLifetimeScope+参数标记）</span></span><br><span class="line">&#123;</span><br><span class="line">    ContainerBuilder builder4 = <span class="keyword">new</span> ContainerBuilder();</span><br><span class="line"></span><br><span class="line">    builder4.RegisterType&lt;TestServiceA&gt;().As&lt;ITestServiceA&gt;().InstancePerLifetimeScope();</span><br><span class="line"></span><br><span class="line">    IContainer container4 = builder4.Build();</span><br><span class="line"></span><br><span class="line">    ITestServiceA testServiceA5 = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">    ITestServiceA testServiceA6 = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">using</span> (<span class="keyword">var</span> Scope = container4.BeginLifetimeScope(<span class="string">&quot;Harris&quot;</span>))</span><br><span class="line">    &#123;</span><br><span class="line">        ITestServiceA testServiceA1 = Scope.Resolve&lt;ITestServiceA&gt;();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">using</span> (<span class="keyword">var</span> Scope1 = container4.BeginLifetimeScope())</span><br><span class="line">        &#123;</span><br><span class="line">            ITestServiceA testServiceA2 = Scope.Resolve&lt;ITestServiceA&gt;();</span><br><span class="line"></span><br><span class="line">            Console.WriteLine(<span class="string">&quot;Autofac 生命周期-作用域扩展1：&quot;</span> + <span class="built_in">object</span>.ReferenceEquals(testServiceA1, testServiceA2));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        testServiceA5 = testServiceA1;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">using</span> (<span class="keyword">var</span> Scope = container4.BeginLifetimeScope(<span class="string">&quot;Harris&quot;</span>))</span><br><span class="line">    &#123;</span><br><span class="line">        ITestServiceA testServiceA1 = Scope.Resolve&lt;ITestServiceA&gt;();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">using</span> (<span class="keyword">var</span> Scope1 = container4.BeginLifetimeScope())</span><br><span class="line">        &#123;</span><br><span class="line">            ITestServiceA testServiceA2 = Scope.Resolve&lt;ITestServiceA&gt;();</span><br><span class="line"></span><br><span class="line">            Console.WriteLine(<span class="string">&quot;Autofac 生命周期-作用域扩展2：&quot;</span> + <span class="built_in">object</span>.ReferenceEquals(testServiceA1, testServiceA2));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        testServiceA6 = testServiceA1;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    Console.WriteLine(<span class="string">&quot;Autofac 生命周期-作用域扩展3：&quot;</span> + <span class="built_in">object</span>.ReferenceEquals(testServiceA5, testServiceA6));</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">#<span class="keyword">endregion</span></span></span><br></pre></td></tr></table></figure>

<p><img src="https://blogimage-1255495010.cos.ap-beijing.myqcloud.com/image-20210829154658355.png" alt="image-20210829154658355"></p>
<h3 id="Autofac-读取配置文件注册"><a href="#Autofac-读取配置文件注册" class="headerlink" title="Autofac 读取配置文件注册"></a>Autofac 读取配置文件注册</h3><ol>
<li><p>Nuget 获取</p>
<ul>
<li>Autofac.Extensions.DependencyInjection</li>
<li>Autofac.Configuration</li>
</ul>
</li>
<li><p>准备配置文件</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;components&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;DotNetCoreDemo.Service.TestServiceA,DotNetCoreDemo.Service&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;services&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;DotNetCoreDemo.Interface.ITestServiceA,DotNetCoreDemo.Interface&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;instanceScope&quot;</span><span class="punctuation">:</span> <span class="string">&quot;single-instance&quot;</span><span class="punctuation">,</span> <span class="comment">//生命周期</span></span><br><span class="line">      <span class="attr">&quot;injectProperties&quot;</span><span class="punctuation">:</span> <span class="keyword">true</span> <span class="comment">// 是否支持属性注入</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;DotNetCoreDemo.Service.TestServiceB,DotNetCoreDemo.Service&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;services&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;DotNetCoreDemo.Interface.ITestServiceB,DotNetCoreDemo.Interface&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;instanceScope&quot;</span><span class="punctuation">:</span> <span class="string">&quot;single-instance&quot;</span><span class="punctuation">,</span> <span class="comment">//生命周期</span></span><br><span class="line">      <span class="attr">&quot;injectProperties&quot;</span><span class="punctuation">:</span> <span class="keyword">true</span> <span class="comment">// 是否支持属性注入</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;DotNetCoreDemo.Service.TestServiceC,DotNetCoreDemo.Service&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;services&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;DotNetCoreDemo.Interface.ITestServiceC,DotNetCoreDemo.Interface&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;instanceScope&quot;</span><span class="punctuation">:</span> <span class="string">&quot;single-instance&quot;</span><span class="punctuation">,</span> <span class="comment">//生命周期</span></span><br><span class="line">      <span class="attr">&quot;injectProperties&quot;</span><span class="punctuation">:</span> <span class="keyword">true</span> <span class="comment">// 是否支持属性注入</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;DotNetCoreDemo.Service.TestServiceD,DotNetCoreDemo.Service&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;services&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;DotNetCoreDemo.Interface.ITestServiceD,DotNetCoreDemo.Interface&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;instanceScope&quot;</span><span class="punctuation">:</span> <span class="string">&quot;single-instance&quot;</span><span class="punctuation">,</span> <span class="comment">//生命周期</span></span><br><span class="line">      <span class="attr">&quot;injectProperties&quot;</span><span class="punctuation">:</span> <span class="keyword">true</span> <span class="comment">// 是否支持属性注入</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure></li>
<li><p>读取配置文件，通过Autofac 配置文件实现注册抽象服务和具体方法。</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">region</span> Autofac 读取配置文件注册服务</span></span><br><span class="line">&#123;</span><br><span class="line">    ContainerBuilder builder = <span class="keyword">new</span> ContainerBuilder();</span><br><span class="line"></span><br><span class="line">    IConfigurationBuilder config = <span class="keyword">new</span> ConfigurationBuilder();</span><br><span class="line"></span><br><span class="line">    IConfigurationSource source = <span class="keyword">new</span> JsonConfigurationSource()</span><br><span class="line">    &#123;</span><br><span class="line">        Path = <span class="string">&quot;CfgFile/Autofac.json&quot;</span>,</span><br><span class="line">        Optional = <span class="literal">false</span>,<span class="comment">//默认是false ,可以不写</span></span><br><span class="line">        ReloadOnChange = <span class="literal">true</span><span class="comment">//默认是true，可不写</span></span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    config.Add(source);</span><br><span class="line"></span><br><span class="line">    ConfigurationModule module = <span class="keyword">new</span> ConfigurationModule(config.Build());</span><br><span class="line"></span><br><span class="line">    builder.RegisterModule(module);</span><br><span class="line"></span><br><span class="line">    IContainer container = builder.Build();</span><br><span class="line"></span><br><span class="line">    ITestServiceA testServiceA = container.Resolve&lt;ITestServiceA&gt;();</span><br><span class="line"></span><br><span class="line">    testServiceA.Show();</span><br><span class="line"></span><br><span class="line">    ITestServiceD testServiceD = container.Resolve&lt;ITestServiceD&gt;();</span><br><span class="line"></span><br><span class="line">    testServiceD.Show();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">endregion</span></span></span><br></pre></td></tr></table></figure></li>
<li><p>有了Autofac 配置文件就可以灵活的调整服务（interface）与服务本身（Service）中的关系。</p>
<p>举个例子：如果现在有个<code>TestServiceE</code>,依赖于<code>ItestServiceA</code></p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> DotNetCoreDemo.Interface;</span><br><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> System.Linq;</span><br><span class="line"><span class="keyword">using</span> System.Text;</span><br><span class="line"><span class="keyword">using</span> System.Threading.Tasks;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">DotNetCoreDemo.Service</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">TestServiceE</span> : <span class="title">ITestServiceA</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">TestServiceE</span>()</span></span><br><span class="line">        &#123;</span><br><span class="line">            Console.WriteLine(<span class="keyword">this</span>.GetType().Name + <span class="string">&quot;构造了&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="built_in">string</span> <span class="title">ReturnStr</span>(<span class="params"><span class="built_in">string</span> str</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> str + GetType().Name.ToString();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Show</span>()</span></span><br><span class="line">        &#123;</span><br><span class="line">            Console.WriteLine(GetType().Name + <span class="string">&quot;Show&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>然后刚才实现读取配置的代码中，ItestServiceA 想用的是 TestServiceE 的实现方法。只需要修改配置文件即可。</p>
<p>修改前：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;DotNetCoreDemo.Service.TestServiceA,DotNetCoreDemo.Service&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;services&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;DotNetCoreDemo.Interface.ITestServiceA,DotNetCoreDemo.Interface&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;instanceScope&quot;</span><span class="punctuation">:</span> <span class="string">&quot;single-instance&quot;</span><span class="punctuation">,</span> <span class="comment">//生命周期</span></span><br><span class="line">      <span class="attr">&quot;injectProperties&quot;</span><span class="punctuation">:</span> <span class="keyword">true</span> <span class="comment">// 是否支持属性注入</span></span><br><span class="line"><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br></pre></td></tr></table></figure>

<p>修改后：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;DotNetCoreDemo.Service.TestServiceE,DotNetCoreDemo.Service&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;services&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;DotNetCoreDemo.Interface.ITestServiceA,DotNetCoreDemo.Interface&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;instanceScope&quot;</span><span class="punctuation">:</span> <span class="string">&quot;single-instance&quot;</span><span class="punctuation">,</span> <span class="comment">//生命周期</span></span><br><span class="line">      <span class="attr">&quot;injectProperties&quot;</span><span class="punctuation">:</span> <span class="keyword">true</span> <span class="comment">// 是否支持属性注入</span></span><br><span class="line"><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br></pre></td></tr></table></figure>

<p><img src="https://blogimage-1255495010.cos.ap-beijing.myqcloud.com/image-20210829182152021.png" alt="image-20210829182152021"></p>
</li>
</ol>
<h3 id="Autofac-整合到MVC"><a href="#Autofac-整合到MVC" class="headerlink" title="Autofac 整合到MVC"></a>Autofac 整合到MVC</h3><ol>
<li><p>Autofac 是一个第三方容器，需要在Program 中告诉框架，要是使用哪个IOC工厂。(AutofacServiceProviderFactory)</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> IHostBuilder <span class="title">CreateHostBuilder</span>(<span class="params"><span class="built_in">string</span>[] args</span>)</span> =&gt;</span><br><span class="line">            Host.CreateDefaultBuilder(args)</span><br><span class="line">            .ConfigureWebHostDefaults(webBuilder =&gt;</span><br><span class="line">            &#123;</span><br><span class="line">                webBuilder.UseStartup&lt;Startup&gt;();</span><br><span class="line">            &#125;)</span><br><span class="line">            .UseServiceProviderFactory(<span class="keyword">new</span> AutofacServiceProviderFactory());</span><br></pre></td></tr></table></figure></li>
<li><p>Startup 文件中新增方法，这个方法被 Autofac 承包了，是个默认执行的方法</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> Autofac 此方法会在加载的时候默认执行</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> </span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 有了此方法，不意味着原生的注册方法不灵了，原生的注册方法照样好使</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> </span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 注意：在Autofac注册的时候，会将原生的注册方法都接管过来。</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;container&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">ConfigureContainer</span>(<span class="params">ContainerBuilder container</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">//前三个注册服务交给原生注册方法</span></span><br><span class="line">    <span class="comment">//container.RegisterType&lt;TestServiceA&gt;().As&lt;ITestServiceA&gt;();</span></span><br><span class="line">    <span class="comment">//container.RegisterType&lt;TestServiceB&gt;().As&lt;ITestServiceB&gt;();</span></span><br><span class="line">    <span class="comment">//container.RegisterType&lt;TestServiceC&gt;().As&lt;ITestServiceC&gt;();</span></span><br><span class="line">    <span class="comment">//这个给Autofac注册，关注AutofaCollection 知否正常执行</span></span><br><span class="line">    container.RegisterType&lt;TestServiceD&gt;().As&lt;ITestServiceD&gt;().PropertiesAutowired();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li><p>需要注意：</p>
<ol>
<li>ConfigureContainer() 方法是默认执行的；</li>
<li>有了此方法，不意味着原生的注册方法不灵了，原生的注册方法照样好使；</li>
<li>在Autofac注册的时候，会将原生的注册方法都接管过来，这样在使用时候就连贯了。</li>
</ol>
</li>
</ol>
<h3 id="Autofac-支持控制器属性注入"><a href="#Autofac-支持控制器属性注入" class="headerlink" title="Autofac 支持控制器属性注入"></a>Autofac 支持控制器属性注入</h3><ol>
<li><p>指定控制器的实例让容器来创建 – Startup ConfigureServices()</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">region</span> 指定控制器的实例让容器来创建,告诉框架，要使用Autofac容器来创建控制器的实例。</span></span><br><span class="line"></span><br><span class="line">services.Replace(ServiceDescriptor.Transient&lt;IControllerActivator, ServiceBasedControllerActivator&gt;());</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">endregion</span></span></span><br></pre></td></tr></table></figure></li>
<li><p>注册所有控制器的关系+控制器实例化所需要的所有组件 – Startup ConfigureContainer()</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">region</span> 注册所有控制器的关系+控制器实例化所需要的所有组件</span></span><br><span class="line"></span><br><span class="line">Type[] controllerTypesInAssmbly = <span class="keyword">typeof</span>(Startup).Assembly.GetExportedTypes().Where(type =&gt; <span class="keyword">typeof</span>(ControllerBase).IsAssignableFrom(type)).ToArray();</span><br><span class="line"></span><br><span class="line"><span class="comment">//注册属性，具体注册哪些属性，交给 CustomPropertySelector()</span></span><br><span class="line"><span class="comment">//CustomPropertySelector()方法会通过CustomPropertyAttribute这个特性去查找、返回</span></span><br><span class="line">container.RegisterTypes(controllerTypesInAssmbly).PropertiesAutowired(<span class="keyword">new</span> CustomPropertySelector());</span><br></pre></td></tr></table></figure></li>
<li><p><code>CustomPropertySelector</code> 帮助框架去查找符合条件的属性</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> Autofac.Core;</span><br><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> System.Linq;</span><br><span class="line"><span class="keyword">using</span> System.Reflection;</span><br><span class="line"><span class="keyword">using</span> System.Threading.Tasks;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">DotNetCoreDemo.Utility</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">CustomPropertySelector</span> : <span class="title">IPropertySelector</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="built_in">bool</span> <span class="title">InjectProperty</span>(<span class="params">PropertyInfo propertyInfo, <span class="built_in">object</span> instance</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">//需要一个判断维度,只有满足属性是CustomPropertyAttribute的才能返回 true</span></span><br><span class="line">            <span class="keyword">return</span> propertyInfo.CustomAttributes.Any(it =&gt; it.AttributeType == <span class="keyword">typeof</span>(CustomPropertyAttribute));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li><p><code>CustomPropertyAttribute</code> 自定义特性</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> System.Linq;</span><br><span class="line"><span class="keyword">using</span> System.Threading.Tasks;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">DotNetCoreDemo.Utility</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">//添加特性类，并且标注这个是专门用在属性上的</span></span><br><span class="line">    [<span class="meta">AttributeUsage(AttributeTargets.Property)</span>]</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">CustomPropertyAttribute</span> : <span class="title">Attribute</span></span><br><span class="line">    &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li><p>监控判断属性</p>
<p><img src="https://blogimage-1255495010.cos.ap-beijing.myqcloud.com/image-20210829200529269.png" alt="image-20210829200529269"></p>
<p>判断 _ItestServiceAA 结果为 true ，因为它标注属性了</p>
<p><img src="https://blogimage-1255495010.cos.ap-beijing.myqcloud.com/image-20210829201047537.png" alt="image-20210829201047537"></p>
<p>反之 _ItestServiceBB 返回 false </p>
<p><img src="https://blogimage-1255495010.cos.ap-beijing.myqcloud.com/image-20210829200904042.png" alt="image-20210829200904042"></p>
</li>
</ol>
<h3 id="Autofac-抽象多实现的问题1"><a href="#Autofac-抽象多实现的问题1" class="headerlink" title="Autofac 抽象多实现的问题1"></a>Autofac 抽象多实现的问题1</h3><p>例如：一个Interface 多个服务实现 ，一对多。</p>
<p><img src="https://blogimage-1255495010.cos.ap-beijing.myqcloud.com/image-20210830232226520.png" alt="image-20210830232226520"></p>
<p>遇到这种情况，在注册的时候就会有问题，尤其是在注册完应用的时候。</p>
<p><strong>第一种：</strong></p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">region</span> 抽象多实现问题</span></span><br><span class="line"></span><br><span class="line">container.RegisterType&lt;TestServiceA&gt;().As&lt;ITestServiceA&gt;();</span><br><span class="line">container.RegisterType&lt;TestServiceE&gt;().As&lt;ITestServiceA&gt;();</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">endregion</span></span></span><br></pre></td></tr></table></figure>

<p>结果就是</p>
<p><img src="https://blogimage-1255495010.cos.ap-beijing.myqcloud.com/image-20210830232929753.png" alt="image-20210830232929753"></p>
<p>结论就是：</p>
<p>在同一个接口下多个对象的时候，最后注册的那个对象才会生效。</p>
<p><strong>第二种：</strong></p>
<p>使用 <code>IEnumerable&lt;ITestServiceA&gt;</code> 方式，返回多个。</p>
<p><img src="https://blogimage-1255495010.cos.ap-beijing.myqcloud.com/image-20210830233558148.png" alt="image-20210830233558148"></p>
<p><strong>第三种：</strong></p>
<p>Startup 中注册所有与<code>ItestServiceA</code>相关的对象</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">container.RegisterSource(<span class="keyword">new</span> AnyConcreteTypeNotAlreadyRegisteredSource(t =&gt; t.IsAssignableTo&lt;ITestServiceA&gt;()));</span><br></pre></td></tr></table></figure>

<p>然后如下图：直接实例化对象（不是Interface），然后通过构造函数接下来使用。</p>
<p><img src="https://blogimage-1255495010.cos.ap-beijing.myqcloud.com/image-20210830234629332.png" alt="image-20210830234629332"></p>
<p>扩展一下：</p>
<p>新建 AutofacModule.cs</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> Autofac;</span><br><span class="line"><span class="keyword">using</span> Autofac.Features.ResolveAnything;</span><br><span class="line"><span class="keyword">using</span> DotNetCoreDemo.Interface;</span><br><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> System.Linq;</span><br><span class="line"><span class="keyword">using</span> System.Threading.Tasks;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">DotNetCoreDemo.Utility</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">AutofacModule</span> : <span class="title">Module</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="function"><span class="keyword">protected</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">Load</span>(<span class="params">ContainerBuilder builder</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            builder.RegisterSource(<span class="keyword">new</span> AnyConcreteTypeNotAlreadyRegisteredSource(t =&gt; t.IsAssignableTo&lt;ITestServiceA&gt;()));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>然后修改 Startup <code>container.RegisterModule(new AutofacModule());</code></p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">region</span> 抽象多实现问题</span></span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span>/1. 正常操作 在同一个接口下多个对象的时候，最后注册的那个对象才会生效。</span></span><br><span class="line">container.RegisterType&lt;TestServiceA&gt;().As&lt;ITestServiceA&gt;();</span><br><span class="line">container.RegisterType&lt;TestServiceE&gt;().As&lt;ITestServiceA&gt;();</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span>/2. 使用 `IEnumerable<span class="doctag">&lt;ITestServiceA&gt;</span>` 方式，返回多个。</span></span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span>/3. 第三种方式如下，需要在控制器中构造函数承接对象。</span></span><br><span class="line"><span class="comment">//container.RegisterSource(new AnyConcreteTypeNotAlreadyRegisteredSource(t =&gt; t.IsAssignableTo&lt;ITestServiceA&gt;()));</span></span><br><span class="line"></span><br><span class="line">container.RegisterModule(<span class="keyword">new</span> AutofacModule());</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">endregion</span></span></span><br></pre></td></tr></table></figure>

<p>这样的好处，就是可以分模块注册服务。</p>
<h3 id="Autofac-支持-AOP"><a href="#Autofac-支持-AOP" class="headerlink" title="Autofac 支持 AOP"></a>Autofac 支持 AOP</h3><p><strong>AOP 面向切片编程：在不修改原来代码逻辑的基础上，可以动态的在某个动作之前或者之后执行某些方法。</strong></p>
<ol>
<li><p>主程序 Nugget 引入 <code>Castle.Core</code>  and  <code>Castle.DynamicProxy</code></p>
</li>
<li><p>新建AutoAop 扩展类，建议这个类不要新建在主程序中，可能会引起服务互相依赖的后果。</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> Castle.DynamicProxy;</span><br><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> System.Linq;</span><br><span class="line"><span class="keyword">using</span> System.Text;</span><br><span class="line"><span class="keyword">using</span> System.Threading.Tasks;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">DotNetCoreDemo.Common.AutofacExtension</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">CustomAutofacAOP</span> : <span class="title">IInterceptor</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Intercept</span>(<span class="params">IInvocation invocation</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            Console.WriteLine(<span class="string">&quot;执行Show前干点事&quot;</span>);</span><br><span class="line"></span><br><span class="line">            invocation.Proceed();</span><br><span class="line"></span><br><span class="line">            Console.WriteLine(<span class="string">&quot;执行Show后干点事&quot;</span>);</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li><p>在Interface 层想管的类上添加特性 <code>[Intercept(typeof(CustomAutofacAOP))]</code>，为了AOP能在当前接口生效。<em>也得引入 Castle.DynamicProxy</em></p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> Autofac.Extras.DynamicProxy;</span><br><span class="line"><span class="keyword">using</span> DotNetCoreDemo.Common.AutofacExtension;</span><br><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> System.Linq;</span><br><span class="line"><span class="keyword">using</span> System.Text;</span><br><span class="line"><span class="keyword">using</span> System.Threading.Tasks;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">DotNetCoreDemo.Interface</span></span><br><span class="line">&#123;</span><br><span class="line">    [<span class="meta">Intercept(typeof(CustomAutofacAOP))</span>]<span class="comment">//为了AOP能在当前接口生效</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">interface</span> <span class="title">ITestServiceA</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="function"><span class="keyword">void</span> <span class="title">Show</span>()</span>;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="built_in">string</span> <span class="title">ReturnStr</span>(<span class="params"><span class="built_in">string</span> str</span>)</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li><p>需要在 Startup.cs 中注册 <code>container.RegisterType(typeof(CustomAutofacAOP));</code></p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">region</span> Autofac 支持 AOP</span></span><br><span class="line">container.RegisterType(<span class="keyword">typeof</span>(CustomAutofacAOP));<span class="comment">//注册</span></span><br><span class="line"><span class="comment">//EnableInterfaceInterceptors() 告诉框架这个要支持AOP</span></span><br><span class="line">container.RegisterType&lt;TestServiceA&gt;().As&lt;ITestServiceA&gt;().EnableInterfaceInterceptors();<span class="comment">//接口式支持AOP</span></span><br><span class="line"><span class="meta">#<span class="keyword">endregion</span></span></span><br></pre></td></tr></table></figure></li>
<li><p>应用</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> DotNetCoreDemo.Interface;</span><br><span class="line"><span class="keyword">using</span> DotNetCoreDemo.Utility;</span><br><span class="line"><span class="keyword">using</span> Microsoft.AspNetCore.Mvc;</span><br><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> System.Linq;</span><br><span class="line"><span class="keyword">using</span> System.Threading.Tasks;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">DotNetCoreDemo.Controllers</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">FourController</span> : <span class="title">Controller</span></span><br><span class="line">    &#123;</span><br><span class="line">        [<span class="meta">CustomProperty</span>]</span><br><span class="line">        <span class="keyword">private</span> ITestServiceA _ItestServiceAA &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">readonly</span> ITestServiceA _ItestServiceA = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">FourController</span>(<span class="params">ITestServiceA ItestServiceA, ITestServiceA testServiceA</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            _ItestServiceAA = testServiceA;</span><br><span class="line"></span><br><span class="line">            _ItestServiceA = ItestServiceA;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> IActionResult <span class="title">Index</span>()</span></span><br><span class="line">        &#123;</span><br><span class="line">            _ItestServiceAA.Show();</span><br><span class="line"></span><br><span class="line">            _ItestServiceA.Show();</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> View();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li><p>结果</p>
<p><img src="https://blogimage-1255495010.cos.ap-beijing.myqcloud.com/image-20210901221357225.png" alt="image-20210901221357225"></p>
</li>
</ol>
<h3 id="Autofac-支持-AOP2"><a href="#Autofac-支持-AOP2" class="headerlink" title="Autofac 支持 AOP2"></a>Autofac 支持 AOP2</h3><p><code>EnableInterfaceInterceptors</code> 支持 <code>Interface</code>中标记<code>[Intercept(typeof(CustomAutofacAOP))]</code>，只要实现这个就可以实现AOP</p>
<p><code>EnableClassInterceptors</code> 支持 <code>Service</code> 中标记 <code>[Intercept(typeof(CustomAutofacAOP))]</code> ,只有标记这个特性，才能支持AOP。</p>
<p><code>EnableClassInterceptors</code>  还需要 设置 虚方法 <code>virtual</code></p>
<p>注意：如果同时使用<code>EnableInterfaceInterceptors</code> 就会重复执行AOP.</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> Autofac.Extras.DynamicProxy;</span><br><span class="line"><span class="keyword">using</span> DotNetCoreDemo.Common.AutofacExtension;</span><br><span class="line"><span class="keyword">using</span> DotNetCoreDemo.Interface;</span><br><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> System.Linq;</span><br><span class="line"><span class="keyword">using</span> System.Text;</span><br><span class="line"><span class="keyword">using</span> System.Threading.Tasks;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">DotNetCoreDemo.Service</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">//标记特性</span></span><br><span class="line">    [<span class="meta">Intercept(typeof(CustomAutofacAOP))</span>]<span class="comment">//为了AOP能在当前接口生效</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">TestServiceA</span> : <span class="title">ITestServiceA</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">TestServiceA</span>()</span></span><br><span class="line">        &#123;</span><br><span class="line">            Console.WriteLine(<span class="keyword">this</span>.GetType().Name + <span class="string">&quot;构造了&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="built_in">string</span> <span class="title">ReturnStr</span>(<span class="params"><span class="built_in">string</span> str</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> str + GetType().Name.ToString();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 标记虚方法</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">Show</span>()</span></span><br><span class="line">        &#123;</span><br><span class="line">            Console.WriteLine(GetType().Name + <span class="string">&quot;Show&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://blogimage-1255495010.cos.ap-beijing.myqcloud.com/image-20210902225117135.png" alt="image-20210902225117135"></p>
<h3 id="Autofac-抽象多个实现构造函数注入"><a href="#Autofac-抽象多个实现构造函数注入" class="headerlink" title="Autofac 抽象多个实现构造函数注入"></a>Autofac 抽象多个实现构造函数注入</h3><ol>
<li><p>先上一波传统手艺</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//在 方法 ：ConfigureServices 中</span></span><br><span class="line"><span class="meta">#<span class="keyword">region</span> 一抽象多个实现问题</span></span><br><span class="line">&#123;</span><br><span class="line">    ContainerBuilder builder = <span class="keyword">new</span> ContainerBuilder();</span><br><span class="line"></span><br><span class="line">    builder.RegisterType&lt;TestServiceA&gt;().Named&lt;ITestServiceA&gt;(<span class="string">&quot;TestServiceA&quot;</span>);</span><br><span class="line">    builder.RegisterType&lt;TestServiceE&gt;().Named&lt;ITestServiceA&gt;(<span class="string">&quot;TestServiceE&quot;</span>);</span><br><span class="line"></span><br><span class="line">    IContainer container = builder.Build();</span><br><span class="line"></span><br><span class="line">    ITestServiceA testServiceA1 = container.ResolveKeyed&lt;ITestServiceA&gt;(<span class="string">&quot;TestServiceA&quot;</span>);</span><br><span class="line">    ITestServiceA testServiceA2 = container.ResolveKeyed&lt;ITestServiceA&gt;(<span class="string">&quot;TestServiceE&quot;</span>);</span><br><span class="line"></span><br><span class="line">    Console.WriteLine(<span class="string">&quot;一抽象多个实现问题：&quot;</span> + <span class="built_in">object</span>.ReferenceEquals(testServiceA1, testServiceA2));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>注意 <code>Named</code> 和 <code>ResolveKeyed</code> 搭配使用更丝滑。</strong></p>
<p><img src="https://blogimage-1255495010.cos.ap-beijing.myqcloud.com/image-20210903214211926.png" alt="image-20210903214211926"></p>
</li>
<li><p>在通过AutofacIOC 实现一波</p>
<p>Startup.cs  - ConfigureContainer 注册 ，注意 <code>Named</code> ，同时实现AOP</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">region</span> 一抽象多实现问题2</span></span><br><span class="line">&#123;</span><br><span class="line">container.RegisterType&lt;TestServiceA&gt;().Named&lt;ITestServiceA&gt;(<span class="string">&quot;TestServiceA&quot;</span>).EnableClassInterceptors();</span><br><span class="line">container.RegisterType&lt;TestServiceE&gt;().Named&lt;ITestServiceA&gt;(<span class="string">&quot;TestServiceE&quot;</span>).EnableClassInterceptors();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>应用：</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ITestServiceA obja = _componentContext.ResolveNamed&lt;ITestServiceA&gt;(<span class="string">&quot;TestServiceA&quot;</span>);</span><br><span class="line">ITestServiceA objb = _componentContext.ResolveNamed&lt;ITestServiceA&gt;(<span class="string">&quot;TestServiceE&quot;</span>);</span><br></pre></td></tr></table></figure>

<p>全文：需要注意注册 Autofac 上下文</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> Autofac;</span><br><span class="line"><span class="keyword">using</span> DotNetCoreDemo.Interface;</span><br><span class="line"><span class="keyword">using</span> DotNetCoreDemo.Utility;</span><br><span class="line"><span class="keyword">using</span> Microsoft.AspNetCore.Mvc;</span><br><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> System.Linq;</span><br><span class="line"><span class="keyword">using</span> System.Threading.Tasks;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">DotNetCoreDemo.Controllers</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">FourController</span> : <span class="title">Controller</span></span><br><span class="line">    &#123;</span><br><span class="line">        [<span class="meta">CustomProperty</span>]</span><br><span class="line">        <span class="keyword">private</span> ITestServiceA _ItestServiceAA &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> Autofac 上下文</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="keyword">private</span> IComponentContext _componentContext = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">FourController</span>(<span class="params">IComponentContext componentContext</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            _componentContext = componentContext;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> IActionResult <span class="title">Index</span>()</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (_ItestServiceAA != <span class="literal">null</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                _ItestServiceAA.Show();</span><br><span class="line">            &#125;</span><br><span class="line">           </span><br><span class="line">            ITestServiceA obja = _componentContext.ResolveNamed&lt;ITestServiceA&gt;(<span class="string">&quot;TestServiceA&quot;</span>);</span><br><span class="line">            ITestServiceA objb = _componentContext.ResolveNamed&lt;ITestServiceA&gt;(<span class="string">&quot;TestServiceE&quot;</span>);</span><br><span class="line"></span><br><span class="line">            obja.Show();</span><br><span class="line">            objb.Show();</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> View();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<p><img src="https://blogimage-1255495010.cos.ap-beijing.myqcloud.com/image-20210904135936278.png" alt="image-20210904135936278"></p>
<p><img src="https://blogimage-1255495010.cos.ap-beijing.myqcloud.com/image-20210904140002918.png" alt="image-20210904140002918"></p>
</li>
</ol>
<h3 id="Autofac-抽象多个实现属性注入"><a href="#Autofac-抽象多个实现属性注入" class="headerlink" title="Autofac 抽象多个实现属性注入"></a>Autofac 抽象多个实现属性注入</h3><p>其他与一个抽象多个实现构造函数注入一样</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//首先，把属性注入</span></span><br><span class="line">[<span class="meta">CustomProperty</span>]</span><br><span class="line"><span class="keyword">private</span> IComponentContext componentContextprop &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line"></span><br><span class="line">ITestServiceA objc = componentContextprop.ResolveNamed&lt;ITestServiceA&gt;(<span class="string">&quot;TestServiceA&quot;</span>);</span><br><span class="line">ITestServiceA objd = componentContextprop.ResolveNamed&lt;ITestServiceA&gt;(<span class="string">&quot;TestServiceE&quot;</span>);</span><br></pre></td></tr></table></figure>

<p>全文：</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> Autofac;</span><br><span class="line"><span class="keyword">using</span> DotNetCoreDemo.Interface;</span><br><span class="line"><span class="keyword">using</span> DotNetCoreDemo.Utility;</span><br><span class="line"><span class="keyword">using</span> Microsoft.AspNetCore.Mvc;</span><br><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> System.Linq;</span><br><span class="line"><span class="keyword">using</span> System.Threading.Tasks;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">DotNetCoreDemo.Controllers</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">FourController</span> : <span class="title">Controller</span></span><br><span class="line">    &#123;</span><br><span class="line">        [<span class="meta">CustomProperty</span>]</span><br><span class="line">        <span class="keyword">private</span> ITestServiceA _ItestServiceAA &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line"></span><br><span class="line">        [<span class="meta">CustomProperty</span>]</span><br><span class="line">        <span class="keyword">private</span> IComponentContext componentContextprop &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> Autofac 上下文</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="keyword">private</span> IComponentContext _componentContext = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">FourController</span>(<span class="params">IComponentContext componentContext</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            _componentContext = componentContext;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> IActionResult <span class="title">Index</span>()</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (_ItestServiceAA != <span class="literal">null</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                _ItestServiceAA.Show();</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            ITestServiceA obja = _componentContext.ResolveNamed&lt;ITestServiceA&gt;(<span class="string">&quot;TestServiceA&quot;</span>);</span><br><span class="line">            ITestServiceA objb = _componentContext.ResolveNamed&lt;ITestServiceA&gt;(<span class="string">&quot;TestServiceE&quot;</span>);</span><br><span class="line"></span><br><span class="line">            obja.Show();</span><br><span class="line">            objb.Show();</span><br><span class="line"></span><br><span class="line">            ITestServiceA objc = componentContextprop.ResolveNamed&lt;ITestServiceA&gt;(<span class="string">&quot;TestServiceA&quot;</span>);</span><br><span class="line">            ITestServiceA objd = componentContextprop.ResolveNamed&lt;ITestServiceA&gt;(<span class="string">&quot;TestServiceE&quot;</span>);</span><br><span class="line"></span><br><span class="line">            objc.Show();</span><br><span class="line">            objd.Show();</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> View();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Filter"><a href="#Filter" class="headerlink" title="Filter"></a>Filter</h2><p>AOP ：可以在不修改之前的代码的情况下动态增加新的功能。</p>
<p>Filter : 过滤器 ActionFilter 即动作过滤器</p>
<h3 id="ActionFilter-AOP"><a href="#ActionFilter-AOP" class="headerlink" title="ActionFilter+AOP"></a>ActionFilter+AOP</h3><ol>
<li><p>新建 CustomActionFilterAttrubute.cs <strong>特性</strong>，并且继承 IActionFilter 接口 和实现 IActionFilter 接口</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> Microsoft.AspNetCore.Mvc.Filters;</span><br><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> System.Linq;</span><br><span class="line"><span class="keyword">using</span> System.Threading.Tasks;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">DotNetCoreDemo.Utility</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">CustomActionFilterAttribute</span> : <span class="title">Attribute</span>, <span class="title">IActionFilter</span></span><br><span class="line">    &#123;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">OnActionExecuting</span>(<span class="params">ActionExecutingContext context</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            Console.WriteLine(<span class="string">&quot;OnActionExecuting 执行&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">OnActionExecuted</span>(<span class="params">ActionExecutedContext context</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            Console.WriteLine(<span class="string">&quot;OnActionExecuted 执行&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li><p>控制器类 需要在对应的Action 方法上标记 <code>[CustomActionFilterAttribute]</code>特性</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> DotNetCoreDemo.Utility;</span><br><span class="line"><span class="keyword">using</span> Microsoft.AspNetCore.Mvc;</span><br><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> System.Linq;</span><br><span class="line"><span class="keyword">using</span> System.Threading.Tasks;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">DotNetCoreDemo.Controllers</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">FiveController</span> : <span class="title">Controller</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">FiveController</span>()</span></span><br><span class="line">        &#123;</span><br><span class="line">            Console.WriteLine(<span class="string">&quot;FiveController 被构造&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        [<span class="meta">CustomActionFilterAttribute</span>]</span><br><span class="line">        <span class="function"><span class="keyword">public</span> IActionResult <span class="title">Index</span>()</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> View();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>如下图，执行顺序为：</p>
<ol>
<li>CustomActionFilterAttribute - OnActionExecuting</li>
<li>Action</li>
<li>CustomActionFilterAttribute - OnActionExecuted</li>
</ol>
<p><img src="https://blogimage-1255495010.cos.ap-beijing.myqcloud.com/image-20210904154410691.png" alt="image-20210904154410691"></p>
</li>
</ol>
<h3 id="ActionFilter-多种实现"><a href="#ActionFilter-多种实现" class="headerlink" title="ActionFilter 多种实现"></a>ActionFilter 多种实现</h3><ol>
<li>通过继承 <code>IActionFilter</code> 实现接口来实现具体前后的功能。</li>
<li>通过继承 <code>ActionFilterAttribute</code> 通过override 重写方法。（系统框架提供）</li>
<li>通过继承 <code>IAnsyncActionFilter</code> 实现接口实现，此为异步版本。</li>
</ol>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> Microsoft.AspNetCore.Mvc.Filters;</span><br><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> System.Linq;</span><br><span class="line"><span class="keyword">using</span> System.Threading.Tasks;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">DotNetCoreDemo.Utility</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 自定义版本</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">CustomActionFilterAttribute</span> : <span class="title">Attribute</span>, <span class="title">IActionFilter</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">OnActionExecuting</span>(<span class="params">ActionExecutingContext context</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            Console.WriteLine(<span class="string">&quot;OnActionExecuting 执行&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">OnActionExecuted</span>(<span class="params">ActionExecutedContext context</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            Console.WriteLine(<span class="string">&quot;OnActionExecuted 执行&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 提供提供版本</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">CustomActionFilterChildeAttribute</span> : <span class="title">ActionFilterAttribute</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">OnActionExecuting</span>(<span class="params">ActionExecutingContext context</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            Console.WriteLine(<span class="string">&quot; OnActionExecuting 执行&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">OnActionExecuted</span>(<span class="params">ActionExecutedContext context</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            Console.WriteLine(<span class="string">&quot;OnActionExecuted 执行&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 异步版本 这个后面再研究</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">CustomActionFilterAsyncAttribute</span> : <span class="title">IAsyncActionFilter</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> Task <span class="title">OnActionExecutionAsync</span>(<span class="params">ActionExecutingContext context, ActionExecutionDelegate next</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> Task.Run(() =&gt;</span><br><span class="line">            &#123;</span><br><span class="line"></span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="ActionFilter-做日志"><a href="#ActionFilter-做日志" class="headerlink" title="ActionFilter 做日志"></a>ActionFilter 做日志</h3><ol>
<li><p>先上结果。</p>
<ol>
<li>先写构造方法</li>
<li>执行Action-Index 之前执行操作</li>
<li>执行Action-Index</li>
<li>执行Action-Index 之后执行操作</li>
</ol>
<p><img src="https://blogimage-1255495010.cos.ap-beijing.myqcloud.com/image-20210904204835244.png" alt="image-20210904204835244"></p>
</li>
<li><p>自定义版本中写的，需要注意Ilogger 的注册，还有就是context的各种扩展功能。</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 自定义版本</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">CustomActionFilterAttribute</span> : <span class="title">Attribute</span>, <span class="title">IActionFilter</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">readonly</span> ILogger&lt;CustomActionFilterAttribute&gt; _logger = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">CustomActionFilterAttribute</span>(<span class="params">ILogger&lt;CustomActionFilterAttribute&gt; logger</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        Console.WriteLine(<span class="string">&quot;CustomActionFilterAttribute 构造&quot;</span>);</span><br><span class="line"></span><br><span class="line">        _logger = logger;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">OnActionExecuting</span>(<span class="params">ActionExecutingContext context</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        _logger.LogInformation(<span class="string">&quot;OnActionExecuting 开始&quot;</span>);</span><br><span class="line"></span><br><span class="line">  _logger.LogInformation(Newtonsoft.Json.JsonConvert.SerializeObject(context.HttpContext.Request.Query));</span><br><span class="line"></span><br><span class="line">        _logger.LogInformation(<span class="string">&quot;OnActionExecuting 结束&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">OnActionExecuted</span>(<span class="params">ActionExecutedContext context</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        _logger.LogInformation(<span class="string">&quot;OnActionExecuted 开始&quot;</span>);</span><br><span class="line"></span><br><span class="line">        _logger.LogInformation(Newtonsoft.Json.JsonConvert.SerializeObject(context.Result));</span><br><span class="line"></span><br><span class="line">        _logger.LogInformation(<span class="string">&quot;OnActionExecuted 结束&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li><p>控制器代码</p>
<p>这里需要注意的是，由于修改了上述的代码，导致给Action特性<code>[CustomActionFilterAttribute]</code>会报错，所以将Action特性修改为<code>[TypeFilter(typeof(CustomActionFilterAttribute))]</code> 为的是让<code>CustomActionFilterAttribute</code> 可以支持依赖注入。</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> DotNetCoreDemo.Utility;</span><br><span class="line"><span class="keyword">using</span> Microsoft.AspNetCore.Mvc;</span><br><span class="line"><span class="keyword">using</span> Microsoft.Extensions.Logging;</span><br><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> System.Linq;</span><br><span class="line"><span class="keyword">using</span> System.Threading.Tasks;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">DotNetCoreDemo.Controllers</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">FiveController</span> : <span class="title">Controller</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">private</span> ILogger&lt;FiveController&gt; _ilogger = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">FiveController</span>(<span class="params">ILogger&lt;FiveController&gt; logger</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            _ilogger = logger;</span><br><span class="line"></span><br><span class="line">            _ilogger.LogInformation(<span class="string">&quot;FiveController 被构造&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//[CustomActionFilterAttribute]</span></span><br><span class="line">        <span class="comment">//[CustomActionFilterChildeAttribute]</span></span><br><span class="line"></span><br><span class="line">        [<span class="meta">TypeFilter(typeof(CustomActionFilterAttribute))</span>]</span><br><span class="line">        <span class="function"><span class="keyword">public</span> IActionResult <span class="title">Index</span>()</span></span><br><span class="line">        &#123;</span><br><span class="line">            _ilogger.LogInformation(<span class="string">&quot;执行FiveController Index Action&quot;</span>);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> View();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ol>
<h3 id="Filter-多种注册"><a href="#Filter-多种注册" class="headerlink" title="Filter 多种注册"></a>Filter 多种注册</h3><ol>
<li><p>CustomActionFilterAttribute]  必须是无参构造函数才行，可以结合上一节内容</p>
</li>
<li><p>[TypeFilter(typeof(CustomActionFilterAttribute))] 可以无参构造函数，可以支持依赖注入</p>
</li>
<li><p>[ServiceFilter(typeof(CustomActionFilterAttribute))] 可以无参构造函数，可以支持依赖注入，但是必须注册服务</p>
<p>Startup.cs</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//注册自定义Filter扩展，且支持属性注入（PropertiesAutowired）</span></span><br><span class="line">container.RegisterType(<span class="keyword">typeof</span>(CustomActionFilterAttribute)).PropertiesAutowired();</span><br></pre></td></tr></table></figure>

<p>CustomActionFilterAttribute</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//属性</span></span><br><span class="line"><span class="keyword">public</span> ILogger&lt;CustomActionFilterAttribute&gt; loggerProp &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//应用，别写在构造函数里</span></span><br><span class="line">loggerProp.LogInformation(<span class="string">&quot;CustomActionFilterAttribute 支持属性注入&quot;</span>);</span><br></pre></td></tr></table></figure></li>
</ol>
<h3 id="FilterFactory-扩展"><a href="#FilterFactory-扩展" class="headerlink" title="FilterFactory 扩展"></a>FilterFactory 扩展</h3><p>本节相当于是对 Filter 多种注册中 TypeFilter 与 ServiceFilter 为什么可以支持依赖注册的递进理解，因为一定是IOC在后面站台。</p>
<p>把 TypeFilter 与 ServiceFilter 后面的大哥 <code>IFilterFactory</code> 提溜出来盘盘。</p>
<ol>
<li><p>首先先创建一个自定义的类 <code>CustomActionFilterFactory</code>, 继承<code>Attribute</code> 实现 <code>IFilterFactory</code> 接口</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> Microsoft.AspNetCore.Mvc.Filters;</span><br><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> System.Linq;</span><br><span class="line"><span class="keyword">using</span> System.Threading.Tasks;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">DotNetCoreDemo.Utility.Filter</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">CustomActionFilterFactory</span> : <span class="title">Attribute</span>, <span class="title">IFilterFactory</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">readonly</span> Type _type = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">CustomActionFilterFactory</span>(<span class="params">Type type</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            _type = type;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">bool</span> IsReusable =&gt; <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> IFilterMetadata <span class="title">CreateInstance</span>(<span class="params">IServiceProvider serviceProvider</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">object</span> oInstance = serviceProvider.GetService(_type);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> (IFilterMetadata)oInstance;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li><p>然后，替换 TypeFilter 和 ServiceFilter 的地位，将 <code>CustomActionFilterFactory</code> 特性用上。</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> DotNetCoreDemo.Utility;</span><br><span class="line"><span class="keyword">using</span> DotNetCoreDemo.Utility.Filter;</span><br><span class="line"><span class="keyword">using</span> Microsoft.AspNetCore.Mvc;</span><br><span class="line"><span class="keyword">using</span> Microsoft.Extensions.Logging;</span><br><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> System.Linq;</span><br><span class="line"><span class="keyword">using</span> System.Threading.Tasks;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">DotNetCoreDemo.Controllers</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">FiveController</span> : <span class="title">Controller</span></span><br><span class="line">    &#123;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">private</span> ILogger&lt;FiveController&gt; _ilogger = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">FiveController</span>(<span class="params">ILogger&lt;FiveController&gt; logger</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            _ilogger = logger;</span><br><span class="line"></span><br><span class="line">            _ilogger.LogInformation(<span class="string">&quot;FiveController 被构造&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//[CustomActionFilterAttribute]</span></span><br><span class="line">        <span class="comment">//[CustomActionFilterChildeAttribute]</span></span><br><span class="line">        <span class="comment">//[TypeFilter(typeof(CustomActionFilterAttribute))]</span></span><br><span class="line">        <span class="comment">//[ServiceFilter(typeof(CustomActionFilterAttribute))]</span></span><br><span class="line">        [<span class="meta">CustomActionFilterFactory(typeof(CustomActionFilterAttribute))</span>]</span><br><span class="line">        <span class="function"><span class="keyword">public</span> IActionResult <span class="title">Index</span>()</span></span><br><span class="line">        &#123;</span><br><span class="line">            _ilogger.LogInformation(<span class="string">&quot;执行FiveController Index Action&quot;</span>);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> View();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li><p>结果完美，复盘一下就是CustomActionFilterFactory 实现了 IFilterFactory 接口的功。</p>
</li>
</ol>
<h3 id="Filter-生效范围与执行顺序"><a href="#Filter-生效范围与执行顺序" class="headerlink" title="Filter 生效范围与执行顺序"></a>Filter 生效范围与执行顺序</h3><pre><code>`[CustomActionFilterFactory(typeof(CustomActionFilterAttribute))]`
</code></pre>
<ol>
<li><p>标记在Action 上只对当前 Action 生效</p>
</li>
<li><p>标记在Controller 上，对 当前Controller 中所有Action 生效</p>
</li>
<li><p>全局注册，对当前整个项目所有 Action生效。</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Startup.cs - ConfigureServices</span></span><br><span class="line"><span class="meta">#<span class="keyword">region</span> 全局注册 Filter </span></span><br><span class="line"></span><br><span class="line">    services.AddMvc(option =&gt;</span><br><span class="line">    &#123;</span><br><span class="line">        option.Filters.Add&lt;CustomActionFilterAttribute&gt;();</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">endregion</span></span></span><br></pre></td></tr></table></figure></li>
<li><p>如果有三个Filter注册在全局、标记在Controller、标记在 Action 上，执行顺序</p>
<p>如果按照默认（不注入Order的前提）</p>
<ol>
<li>全局 OnActionExecuting</li>
<li>控制器 OnActionExecuting</li>
<li>Action OnActionExecuting</li>
<li>正方法</li>
<li>Action OnActionExecuted</li>
<li>控制器  OnActionExecuted</li>
<li>全局 OnActionExecuted</li>
</ol>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> Microsoft.AspNetCore.Mvc.Filters;</span><br><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> System.Linq;</span><br><span class="line"><span class="keyword">using</span> System.Threading.Tasks;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">DotNetCoreDemo.Utility.Filter</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 用来注册全局的</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">TestGlobalActionFilterAttribute</span> : <span class="title">ActionFilterAttribute</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">OnActionExecuting</span>(<span class="params">ActionExecutingContext context</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            Console.WriteLine(<span class="string">&quot;TestGlobalActionFilterAttribute OnActionExecuting&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">OnActionExecuted</span>(<span class="params">ActionExecutedContext context</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            Console.WriteLine(<span class="string">&quot;TestGlobalActionFilterAttribute OnActionExecuted&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 用来标记控制器的</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">TestControllerActionFilterAttribute</span> : <span class="title">ActionFilterAttribute</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">OnActionExecuting</span>(<span class="params">ActionExecutingContext context</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            Console.WriteLine(<span class="string">&quot;TestControllerActionFilterAttribute OnActionExecuting&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">OnActionExecuted</span>(<span class="params">ActionExecutedContext context</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            Console.WriteLine(<span class="string">&quot;TestControllerActionFilterAttribute OnActionExecuted&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 用来标记Action的</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">TestAction_ActionFilterAttribute</span> : <span class="title">ActionFilterAttribute</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">OnActionExecuting</span>(<span class="params">ActionExecutingContext context</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            Console.WriteLine(<span class="string">&quot;TestAction_ActionFilterAttribute OnActionExecuting&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">OnActionExecuted</span>(<span class="params">ActionExecutedContext context</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            Console.WriteLine(<span class="string">&quot;TestAction_ActionFilterAttribute OnActionExecuted&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>如果想修改执行顺序</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> DotNetCoreDemo.Utility;</span><br><span class="line"><span class="keyword">using</span> DotNetCoreDemo.Utility.Filter;</span><br><span class="line"><span class="keyword">using</span> Microsoft.AspNetCore.Mvc;</span><br><span class="line"><span class="keyword">using</span> Microsoft.Extensions.Logging;</span><br><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> System.Linq;</span><br><span class="line"><span class="keyword">using</span> System.Threading.Tasks;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">DotNetCoreDemo.Controllers</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">//标记测试Filter</span></span><br><span class="line">    [<span class="meta">TestControllerActionFilterAttribute(Order =-1)</span>]</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">FiveController</span> : <span class="title">Controller</span></span><br><span class="line">    &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> ILogger&lt;FiveController&gt; _ilogger = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">FiveController</span>(<span class="params">ILogger&lt;FiveController&gt; logger</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            _ilogger = logger;</span><br><span class="line"></span><br><span class="line">            _ilogger.LogInformation(<span class="string">&quot;FiveController 被构造&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//[CustomActionFilterAttribute]</span></span><br><span class="line">        <span class="comment">//[CustomActionFilterChildeAttribute]</span></span><br><span class="line">        <span class="comment">//[TypeFilter(typeof(CustomActionFilterAttribute))]</span></span><br><span class="line">        <span class="comment">//[ServiceFilter(typeof(CustomActionFilterAttribute))]</span></span><br><span class="line">        <span class="comment">//[CustomActionFilterFactory(typeof(CustomActionFilterAttribute))]</span></span><br><span class="line">        <span class="comment">//标记测试Filter</span></span><br><span class="line">        [<span class="meta">TestAction_ActionFilterAttribute(Order =-2)</span>]</span><br><span class="line">        <span class="function"><span class="keyword">public</span> IActionResult <span class="title">Index</span>()</span></span><br><span class="line">        &#123;</span><br><span class="line">            _ilogger.LogInformation(<span class="string">&quot;执行FiveController Index Action&quot;</span>);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> View();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>上述代码得出的执行顺序就是</p>
<ol>
<li>Action OnActionExecuting</li>
<li>控制器 OnActionExecuting</li>
<li>全局 OnActionExecuting</li>
<li>正方法</li>
<li>全局 OnActionExecuted</li>
<li>控制器  OnActionExecuted</li>
<li>Action OnActionExecuted</li>
</ol>
</li>
</ol>
<h3 id="ResourceFilter-扩展定制-支持缓存"><a href="#ResourceFilter-扩展定制-支持缓存" class="headerlink" title="ResourceFilter 扩展定制-支持缓存"></a>ResourceFilter 扩展定制-支持缓存</h3><p>新建自定义ResourceFilter 扩展类</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> Microsoft.AspNetCore.Mvc;</span><br><span class="line"><span class="keyword">using</span> Microsoft.AspNetCore.Mvc.Filters;</span><br><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> System.Linq;</span><br><span class="line"><span class="keyword">using</span> System.Threading.Tasks;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">DotNetCoreDemo.Utility.Filter</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">CustomResourceFilterAttribute</span> : <span class="title">Attribute</span>, <span class="title">IResourceFilter</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">static</span> Dictionary&lt;<span class="built_in">string</span>, <span class="built_in">object</span>&gt; CacheDic = <span class="keyword">new</span> Dictionary&lt;<span class="built_in">string</span>, <span class="built_in">object</span>&gt;();</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">OnResourceExecuting</span>(<span class="params">ResourceExecutingContext context</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">var</span> key = context.HttpContext.Request.Path;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (CacheDic.Any(item =&gt; item.Key == key))</span><br><span class="line">            &#123;</span><br><span class="line">                context.Result = CacheDic[key] <span class="keyword">as</span> IActionResult;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">OnResourceExecuted</span>(<span class="params">ResourceExecutedContext context</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">var</span> key = context.HttpContext.Request.Path;</span><br><span class="line"></span><br><span class="line">            CacheDic[key] = context.Result;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>控制器应用</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[<span class="meta">CustomResourceFilterAttribute</span>]</span><br><span class="line"><span class="function"><span class="keyword">public</span> IActionResult <span class="title">IndexTestResource</span>()</span></span><br><span class="line">&#123;</span><br><span class="line">    ViewBag.Date = DateTime.Now;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> View();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>IndexTestResource.cshtml</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">@&#123;</span><br><span class="line">    ViewData[<span class="string">&quot;Title&quot;</span>] = <span class="string">&quot;IndexTestResource&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&lt;h1&gt;IndexTestResource&lt;/h1&gt;</span><br><span class="line"></span><br><span class="line">&lt;h3&gt;缓存时间：@ViewBag.Date&lt;/h3&gt;</span><br><span class="line"></span><br><span class="line">&lt;h3&gt;页面时间：@DateTime.Now&lt;/h3&gt;</span><br></pre></td></tr></table></figure>

<p>上述主要功能是：新建ResourceFilter扩展特性类，并且在控制器FiveController 中 <code>IndexTestResource</code> Action 标记应用。应用扩展标记的作用是为了建立缓存。相比较ActionFilter ，<strong>ResourceFilter 更适合做缓存</strong>，参考下图</p>
<img src="https://blogimage-1255495010.cos.ap-beijing.myqcloud.com/image-20210905121153341.png" alt="image-20210905121153341" style="zoom: 40%;" />

<h3 id="Filter-匿名"><a href="#Filter-匿名" class="headerlink" title="Filter 匿名"></a>Filter 匿名</h3><p>结合 Filter 生效范围与执行顺序来看，如果全局注册 Filter 的话，那么所有Action都会生效，如果这个时候，不想某个Action被生效，那么匿名的作用就来咯。</p>
<p>现在全局注册：<code> TestGlobalActionFilterAttribute</code> </p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">region</span> 全局注册 Filter </span></span><br><span class="line">services.AddMvc(option =&gt;</span><br><span class="line">                    &#123;</span><br><span class="line">                        <span class="comment">//option.Filters.Add&lt;CustomActionFilterAttribute&gt;();</span></span><br><span class="line">                        <span class="comment">//注册全局 测试执行顺序</span></span><br><span class="line">                        option.Filters.Add&lt;TestGlobalActionFilterAttribute&gt;();</span><br><span class="line">                    &#125;);</span><br><span class="line"><span class="meta">#<span class="keyword">endregion</span></span></span><br></pre></td></tr></table></figure>

<p>现在需要跳过的Action上标注特性：<code>[AllowAnonymousAttribute]</code></p>
<p>然后再去 <code> TestGlobalActionFilterAttribute</code> 添加判断就OK了，不走这玩意<code>TestGlobalActionFilterAttribute</code>了。</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 用来注册全局的</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">TestGlobalActionFilterAttribute</span> : <span class="title">ActionFilterAttribute</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">OnActionExecuting</span>(<span class="params">ActionExecutingContext context</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">//判断执行到这的Action有没有标记AllowAnonymousAttribute 特性</span></span><br><span class="line">        <span class="keyword">if</span> (context.ActionDescriptor.EndpointMetadata.Any(item =&gt; item.GetType() == <span class="keyword">typeof</span>(AllowAnonymousAttribute)))</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        Console.WriteLine(<span class="string">&quot;TestGlobalActionFilterAttribute OnActionExecuting&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">OnActionExecuted</span>(<span class="params">ActionExecutedContext context</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment"><span class="doctag">///</span>/判断执行到这的Action有没有标记AllowAnonymousAttribute 特性</span></span><br><span class="line">        <span class="keyword">if</span> (context.ActionDescriptor.EndpointMetadata.Any(item =&gt; item.GetType() == <span class="keyword">typeof</span>(AllowAnonymousAttribute)))</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        Console.WriteLine(<span class="string">&quot;TestGlobalActionFilterAttribute OnActionExecuted&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>上面这这个 AllowAnonymousAttribute 也可以自定写个特性，到时候在Action和判断中替换一下特性名称即可。</p>
<p>通过查询资料，这个匿名一般用于授权<code>AuthorizeAttribute</code>。</p>
<h3 id="ExceptionFilter"><a href="#ExceptionFilter" class="headerlink" title="ExceptionFilter"></a>ExceptionFilter</h3><p>这个过滤器就是为了处理异常。</p>
<ol>
<li>首先创建<code>CustomExceptionFilterAttribute</code> 特性，实现<code>IExceptionFilter</code>接口</li>
<li>实现方法中需要判断执行到这的异常有没有被处理</li>
<li>如果没有被处理，那么需要判断异常的源头，如果是<code>ajax</code>请求的异常，返回 Jsonresult，否则，跳转到Error页面显示异常信息。</li>
<li>上述如果没有毛病的话，那就进行全局注册</li>
</ol>
<p><img src="https://blogimage-1255495010.cos.ap-beijing.myqcloud.com/image-20210905161745655.png" alt="image-20210905161745655"></p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> Microsoft.AspNetCore.Http;</span><br><span class="line"><span class="keyword">using</span> Microsoft.AspNetCore.Mvc;</span><br><span class="line"><span class="keyword">using</span> Microsoft.AspNetCore.Mvc.Filters;</span><br><span class="line"><span class="keyword">using</span> Microsoft.AspNetCore.Mvc.ModelBinding;</span><br><span class="line"><span class="keyword">using</span> Microsoft.AspNetCore.Mvc.ViewFeatures;</span><br><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> System.Linq;</span><br><span class="line"><span class="keyword">using</span> System.Threading.Tasks;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">DotNetCoreDemo.Utility.Filter</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">CustomExceptionFilterAttribute</span> : <span class="title">Attribute</span>, <span class="title">IExceptionFilter</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">private</span> IModelMetadataProvider _modelmetadataProvider = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">CustomExceptionFilterAttribute</span>(<span class="params">IModelMetadataProvider modelmetadataProvider</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            _modelmetadataProvider = modelmetadataProvider;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">OnException</span>(<span class="params">ExceptionContext context</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (!context.ExceptionHandled)<span class="comment">//如果有异常未被处理</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">if</span> (IsAjaxRequest(context.HttpContext.Request))</span><br><span class="line">                &#123;</span><br><span class="line">                    context.Result = <span class="keyword">new</span> JsonResult(<span class="keyword">new</span> &#123; Result = <span class="literal">false</span>, Msg = context.Exception.Message &#125;);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="keyword">var</span> result = <span class="keyword">new</span> ViewResult &#123; ViewName = <span class="string">&quot;~/Views/Shared/Error.cshtml&quot;</span> &#125;;</span><br><span class="line"></span><br><span class="line">                    result.ViewData = <span class="keyword">new</span> ViewDataDictionary(_modelmetadataProvider, context.ModelState);</span><br><span class="line"></span><br><span class="line">                    result.ViewData.Add(<span class="string">&quot;Exception&quot;</span>, context.Exception);</span><br><span class="line"></span><br><span class="line">                    context.Result = result;<span class="comment">//断路器</span></span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="comment">//处理完给个True</span></span><br><span class="line">                context.ExceptionHandled = <span class="literal">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">private</span> <span class="built_in">bool</span> <span class="title">IsAjaxRequest</span>(<span class="params">HttpRequest request</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">string</span> header = request.Headers[<span class="string">&quot;X-Requested-With&quot;</span>];</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;XMLHttpRequest&quot;</span>.Equals(header);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Controller </p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[<span class="meta">TypeFilter(typeof(CustomExceptionFilterAttribute))</span>] <span class="comment">// 带参的就得这么标记哦</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> IActionResult <span class="title">IndexException</span>()</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">int</span> i = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">int</span> j = <span class="number">5</span>;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">int</span> k = j / i;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> View();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Error.cshtml</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">@&#123; </span><br><span class="line">    ViewData[<span class="string">&quot;Title&quot;</span>] = <span class="string">&quot;Error&quot;</span>;</span><br><span class="line">    Exception exception = <span class="keyword">base</span>.ViewData[<span class="string">&quot;Exception&quot;</span>] <span class="keyword">as</span> Exception;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&lt;h1 <span class="keyword">class</span>=<span class="string">&quot;text-danger&quot;</span>&gt;Error.&lt;/h1&gt;</span><br><span class="line">&lt;h2 <span class="keyword">class</span>=<span class="string">&quot;text-danger&quot;</span>&gt;An error occurred <span class="keyword">while</span> processing your request.&lt;/h2&gt;</span><br><span class="line"></span><br><span class="line">&lt;h3&gt;Context Exception : @exception.Message&lt;/h3&gt;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>上述是在Action上标记CustomExceptionFilterAttribute ,最后，再加上全局注册。</p>
<h3 id="ExceptionFilter-能捕捉到的异常"><a href="#ExceptionFilter-能捕捉到的异常" class="headerlink" title="ExceptionFilter 能捕捉到的异常"></a>ExceptionFilter 能捕捉到的异常</h3><table>
<thead>
<tr>
<th>异常分类</th>
<th>可否捕捉</th>
</tr>
</thead>
<tbody><tr>
<td>控制器实例化异常</td>
<td>true</td>
</tr>
<tr>
<td>异常发生在Try Cache中</td>
<td>false（TryCache默认是已经处理过的异常）</td>
</tr>
<tr>
<td>在视图中发生异常</td>
<td>false（会直接体现在页面上）</td>
</tr>
<tr>
<td>Service层发生异常</td>
<td>true</td>
</tr>
<tr>
<td>在Action 中发生异常</td>
<td>true</td>
</tr>
<tr>
<td>请求路径错误异常</td>
<td>true （需要中间件来完成）</td>
</tr>
</tbody></table>
<p>主要阐述下 如果请求路径错误异常需要如何处理</p>
<ol>
<li><p>Startup.cs 中的 Configure 方法中添加中间件，记得放前面点，放最后不管用。</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">region</span> 捕捉异常补充</span></span><br><span class="line"></span><br><span class="line">app.UseStatusCodePagesWithReExecute(<span class="string">&quot;/Home/Error/&#123;0&#125;&quot;</span>);<span class="comment">//只要不是状态200的请求，都能进来</span></span><br><span class="line"></span><br><span class="line">app.UseExceptionHandler(errorapp =&gt;</span><br><span class="line">&#123;</span><br><span class="line">      errorapp.Run(<span class="keyword">async</span> context =&gt;</span><br><span class="line">      &#123;</span><br><span class="line">          context.Response.StatusCode = <span class="number">200</span>;</span><br><span class="line">          context.Response.ContentType = <span class="string">&quot;text/html&quot;</span>;</span><br><span class="line">          <span class="keyword">await</span> context.Response.WriteAsync(<span class="string">&quot;&lt;html lang=\&quot;en\&quot;&gt;&lt;body&gt;\r\n&quot;</span>);</span><br><span class="line">          <span class="keyword">await</span> context.Response.WriteAsync(<span class="string">&quot;Error! &lt;br&gt;&lt;br&gt;\r\n&quot;</span>);</span><br><span class="line">          <span class="keyword">var</span> exceptionHandlePathFeature = context.Features.Get&lt;IExceptionHandlerPathFeature&gt;();</span><br><span class="line">                                             				                                                       Console.WriteLine(<span class="string">&quot;**********************************************&quot;</span>);            </span><br><span class="line">          Console.WriteLine(<span class="string">$&quot;<span class="subst">&#123; exceptionHandlePathFeature?.Error.Message&#125;</span>&quot;</span>);</span><br><span class="line">          Console.WriteLine(<span class="string">&quot;**********************************************&quot;</span>);</span><br><span class="line"></span><br><span class="line">          <span class="keyword">if</span> (exceptionHandlePathFeature?.Error <span class="keyword">is</span> FileNotFoundException)</span><br><span class="line">          &#123;</span><br><span class="line">               <span class="keyword">await</span> context.Response.WriteAsync(<span class="string">&quot;File Error throw! &lt;br&gt;&lt;br&gt;\r\n&quot;</span>);</span><br><span class="line">          &#125;</span><br><span class="line"></span><br><span class="line">          <span class="keyword">await</span> context.Response.WriteAsync(<span class="string">&quot;&lt;a href =\&quot;Home/Index\&quot;&gt;Home&lt;/a&gt;&lt;br&gt;&lt;br&gt;\r\n&quot;</span>);</span><br><span class="line">          <span class="keyword">await</span> context.Response.WriteAsync(<span class="string">&quot;&lt;/body&gt;&lt;/html&gt;&lt;br&gt;&lt;br&gt;\r\n&quot;</span>);</span><br><span class="line">          <span class="keyword">await</span> context.Response.WriteAsync(<span class="keyword">new</span> <span class="built_in">string</span>(<span class="string">&#x27; &#x27;</span>, <span class="number">512</span>));</span><br><span class="line">       &#125;);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">endregion</span></span></span><br></pre></td></tr></table></figure>

<img src="https://blogimage-1255495010.cos.ap-beijing.myqcloud.com/image-20210905170801999.png" alt="image-20210905170801999" style="zoom:50%;" /></li>
</ol>
<h3 id="ResultFilter"><a href="#ResultFilter" class="headerlink" title="ResultFilter"></a>ResultFilter</h3><p>这个过滤器是为了Action 方法里 return view() 服务的，类似AOP这种写法。</p>
<p>下面代码综合之前的Filter的磨砺，路子都差不多，新建一个自定义特性类，继承 Attribute 实现 IResultFilter 方法。</p>
<ol>
<li>IModeIMetadataProvider 是为了接受参数的</li>
<li>通过接收的参数在Controller 标记 <code>[TypeFilter(typeof(CustomResultFilterAttribute))] </code> Action 方法中，在return View() 这个操作时，判断参数跳转不同的cshtml页。</li>
</ol>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> Microsoft.AspNetCore.Mvc;</span><br><span class="line"><span class="keyword">using</span> Microsoft.AspNetCore.Mvc.Filters;</span><br><span class="line"><span class="keyword">using</span> Microsoft.AspNetCore.Mvc.ModelBinding;</span><br><span class="line"><span class="keyword">using</span> Microsoft.AspNetCore.Mvc.ViewFeatures;</span><br><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> System.Linq;</span><br><span class="line"><span class="keyword">using</span> System.Threading.Tasks;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">DotNetCoreDemo.Utility.Filter</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">CustomResultFilterAttribute</span> : <span class="title">Attribute</span>, <span class="title">IResultFilter</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">private</span> IModelMetadataProvider _modelmetadataProvider = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">CustomResultFilterAttribute</span>(<span class="params">IModelMetadataProvider modelmetadataProvider</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            _modelmetadataProvider = modelmetadataProvider;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 执行视图之前</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;context&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">OnResultExecuting</span>(<span class="params">ResultExecutingContext context</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            Console.WriteLine(<span class="string">&quot;执行视图之前&quot;</span>);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">var</span> view = context.HttpContext.Request.Query[<span class="string">&quot;View&quot;</span>];</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (view == <span class="string">&quot;1&quot;</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">var</span> result = <span class="keyword">new</span> ViewResult &#123; ViewName = <span class="string">&quot;~/Views/Five/IndexResult.cshtml&quot;</span> &#125;;</span><br><span class="line">                result.ViewData = <span class="keyword">new</span> ViewDataDictionary(_modelmetadataProvider, context.ModelState);</span><br><span class="line">                context.Result = result;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">var</span> result = <span class="keyword">new</span> ViewResult &#123; ViewName = <span class="string">&quot;~/Views/Five/IndexResult_EN.cshtml&quot;</span> &#125;;</span><br><span class="line">                result.ViewData = <span class="keyword">new</span> ViewDataDictionary(_modelmetadataProvider, context.ModelState);</span><br><span class="line">                context.Result = result;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 执行视图之后</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;context&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">OnResultExecuted</span>(<span class="params">ResultExecutedContext context</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            Console.WriteLine(<span class="string">&quot;执行视图之后&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://blogimage-1255495010.cos.ap-beijing.myqcloud.com/image-20210905185056411.png" alt="image-20210905185056411"></p>
<h2 id="鉴权授权方式"><a href="#鉴权授权方式" class="headerlink" title="鉴权授权方式"></a>鉴权授权方式</h2><h3 id="Cookie"><a href="#Cookie" class="headerlink" title="Cookie"></a><strong>Cookie</strong></h3><p>代码：<code>SevenController</code></p>
<p>基础授权</p>
<ol>
<li><p>使用鉴权 <code>app.UseAuthentication()</code> 必须放在 <code>app.UseRouting();</code> 后面</p>
</li>
<li><p>Startup.cs - ConfigureServices</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">region</span> Auth-cookie-验证</span></span><br><span class="line"></span><br><span class="line">services.AddAuthentication(<span class="string">&quot;Cookies&quot;</span>).AddCookie(option =&gt;</span><br><span class="line">&#123;</span><br><span class="line">    option.LoginPath = <span class="keyword">new</span> Microsoft.AspNetCore.Http.PathString(<span class="string">&quot;/Seven/LoginOut&quot;</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">endregion</span></span></span><br></pre></td></tr></table></figure></li>
<li><p>正文</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> Microsoft.AspNetCore.Authentication;</span><br><span class="line"><span class="keyword">using</span> Microsoft.AspNetCore.Authorization;</span><br><span class="line"><span class="keyword">using</span> Microsoft.AspNetCore.Mvc;</span><br><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> System.Linq;</span><br><span class="line"><span class="keyword">using</span> System.Security.Claims;</span><br><span class="line"><span class="keyword">using</span> System.Threading.Tasks;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">DotNetCoreDemo.Controllers</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> Auth Cookie</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">SevenController</span> : <span class="title">Controller</span></span><br><span class="line">    &#123;</span><br><span class="line">        [<span class="meta">Authorize</span>]</span><br><span class="line">        <span class="function"><span class="keyword">public</span> IActionResult <span class="title">Index</span>()</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> View();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> IActionResult <span class="title">Login</span>()</span></span><br><span class="line">        &#123;</span><br><span class="line">            List&lt;Claim&gt; Claims = <span class="keyword">new</span> List&lt;Claim&gt;</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">new</span> Claim(ClaimTypes.Name,<span class="string">&quot;Harris&quot;</span>),</span><br><span class="line">                <span class="keyword">new</span> Claim(ClaimTypes.Email,<span class="string">&quot;hou3125378@126.com&quot;</span>),</span><br><span class="line">                <span class="keyword">new</span> Claim(<span class="string">&quot;Xing&quot;</span>,<span class="string">&quot;Hou&quot;</span>)</span><br><span class="line">            &#125;;</span><br><span class="line"></span><br><span class="line">            ClaimsIdentity identity = <span class="keyword">new</span> ClaimsIdentity(Claims, <span class="string">&quot;HarrisIdentity&quot;</span>);</span><br><span class="line"></span><br><span class="line">            HttpContext.SignInAsync(<span class="keyword">new</span> ClaimsPrincipal(identity));</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> View();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> IActionResult <span class="title">LoginOut</span>()</span></span><br><span class="line">        &#123;</span><br><span class="line">            HttpContext.SignOutAsync();</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> View();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>上述代码：可以打开F12，Application-Cookie，观察Cookie的变化。</p>
<p>如果没有Cookie 去访问Index的时候，就会自动跳转到LoginOut，这时候访问Login，记录下Cookie之后，再访问Index就可以了，最后，访问LoginOut,清除Cookie.</p>
</li>
</ol>
<h3 id="JWT"><a href="#JWT" class="headerlink" title="JWT"></a><strong>JWT</strong></h3><p><img src="https://blogimage-1255495010.cos.ap-beijing.myqcloud.com/Token%E9%89%B4%E6%9D%83%E6%8E%88%E6%9D%83.png" alt="Token鉴权授权"></p>
<p>上图是访问的过程。</p>
<h4 id="搭建授权中心（WEBAPI）"><a href="#搭建授权中心（WEBAPI）" class="headerlink" title="搭建授权中心（WEBAPI）"></a>搭建授权中心（<code>WEBAPI</code>）</h4><ol>
<li><p>Nugget</p>
<p><img src="https://blogimage-1255495010.cos.ap-beijing.myqcloud.com/image-20211001192934524.png" alt="image-20211001192934524"></p>
</li>
<li><p><code>appsettings.json</code> 主要关注 <code>JWTTokenOptions</code></p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;Logging&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;LogLevel&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;Default&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Information&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;Microsoft&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Warning&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;Microsoft.Hosting.Lifetime&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Information&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;AllowedHosts&quot;</span><span class="punctuation">:</span> <span class="string">&quot;*&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;JWTTokenOptions&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;Audience&quot;</span><span class="punctuation">:</span> <span class="string">&quot;http://localhost:5200&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;Issuer&quot;</span><span class="punctuation">:</span> <span class="string">&quot;http://localhost:5200&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;SecurityKey&quot;</span><span class="punctuation">:</span> <span class="string">&quot;MIGfMA0GCSqGSIb3DQEBAQUAA4GNADCBiQKBgQDI2a2EJ7m872v0afyoSDJT2o1+SitIeJSWtLJU8/Wz2m7gStexajkeD+Lka6DSTy8gt9UwfgVQo6uKjVLG5Ex7PiGOODVqAEghBuS7JzIYU5RvI543nNDAPfnJsas96mSA7L/mD7RTE2drj6hf3oZjJpMPZUQI/B1Qjb5H3K3PNwIDAQAB&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure></li>
<li><p>注册</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> DotNetCoreDemo.AuthenticationCenter.Utility;</span><br><span class="line"><span class="keyword">using</span> Microsoft.AspNetCore.Builder;</span><br><span class="line"><span class="keyword">using</span> Microsoft.AspNetCore.Hosting;</span><br><span class="line"><span class="keyword">using</span> Microsoft.AspNetCore.HttpsPolicy;</span><br><span class="line"><span class="keyword">using</span> Microsoft.AspNetCore.Mvc;</span><br><span class="line"><span class="keyword">using</span> Microsoft.Extensions.Configuration;</span><br><span class="line"><span class="keyword">using</span> Microsoft.Extensions.DependencyInjection;</span><br><span class="line"><span class="keyword">using</span> Microsoft.Extensions.Hosting;</span><br><span class="line"><span class="keyword">using</span> Microsoft.Extensions.Logging;</span><br><span class="line"><span class="keyword">using</span> Microsoft.OpenApi.Models;</span><br><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> System.Linq;</span><br><span class="line"><span class="keyword">using</span> System.Threading.Tasks;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">DotNetCoreDemo.AuthenticationCenter</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">Startup</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">Startup</span>(<span class="params">IConfiguration configuration</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            Configuration = configuration;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> IConfiguration Configuration &#123; <span class="keyword">get</span>; &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// This method gets called by the runtime. Use this method to add services to the container.</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">ConfigureServices</span>(<span class="params">IServiceCollection services</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">//HS加密方式</span></span><br><span class="line">            <span class="comment">//services.AddTransient&lt;ICustomJWTService, CustomHSJWTService&gt;();</span></span><br><span class="line">            <span class="comment">//RSS加密方式</span></span><br><span class="line">            services.AddTransient&lt;ICustomJWTService, CustomRSSJWTervice&gt;();</span><br><span class="line">            services.Configure&lt;JWTTokenOptions&gt;(<span class="keyword">this</span>.Configuration.GetSection(<span class="string">&quot;JWTTokenOptions&quot;</span>));</span><br><span class="line">            services.AddControllers();</span><br><span class="line">            services.AddSwaggerGen(c =&gt;</span><br><span class="line">            &#123;</span><br><span class="line">                c.SwaggerDoc(<span class="string">&quot;v1&quot;</span>, <span class="keyword">new</span> OpenApiInfo &#123; Title = <span class="string">&quot;DotNetCoreDemo.AuthenticationCenter&quot;</span>, Version = <span class="string">&quot;v1&quot;</span> &#125;);</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// This method gets called by the runtime. Use this method to configure the HTTP request pipeline.</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Configure</span>(<span class="params">IApplicationBuilder app, IWebHostEnvironment env</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (env.IsDevelopment())</span><br><span class="line">            &#123;</span><br><span class="line">                app.UseDeveloperExceptionPage();</span><br><span class="line">                app.UseSwagger();</span><br><span class="line">                app.UseSwaggerUI(c =&gt; c.SwaggerEndpoint(<span class="string">&quot;/swagger/v1/swagger.json&quot;</span>, <span class="string">&quot;DotNetCoreDemo.AuthenticationCenter v1&quot;</span>));</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            app.UseHttpsRedirection();</span><br><span class="line"></span><br><span class="line">            app.UseRouting();</span><br><span class="line"></span><br><span class="line">            app.UseAuthorization();</span><br><span class="line"></span><br><span class="line">            app.UseEndpoints(endpoints =&gt;</span><br><span class="line">            &#123;</span><br><span class="line">                endpoints.MapControllers();</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li><p>入口</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> DotNetCoreDemo.AuthenticationCenter.Utility;</span><br><span class="line"><span class="keyword">using</span> Microsoft.AspNetCore.Mvc;</span><br><span class="line"><span class="keyword">using</span> Newtonsoft.Json;</span><br><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> System.Linq;</span><br><span class="line"><span class="keyword">using</span> System.Threading.Tasks;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">DotNetCoreDemo.AuthenticationCenter.Controllers</span></span><br><span class="line">&#123;</span><br><span class="line">    [<span class="meta">Route(<span class="string">&quot;api/[controller]&quot;</span>)</span>]</span><br><span class="line">    [<span class="meta">ApiController</span>]</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">AuthenticationController</span> : <span class="title">Controller</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">//构造函数注入</span></span><br><span class="line">        <span class="keyword">private</span> ICustomJWTService _iJWTService = <span class="literal">null</span>;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">AuthenticationController</span>(<span class="params">ICustomJWTService customJWTService</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            _iJWTService = customJWTService;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//[Route(&quot;Get&quot;)]</span></span><br><span class="line">        <span class="comment">//[HttpGet]</span></span><br><span class="line">        <span class="comment">//public IEnumerable&lt;int&gt; Get()</span></span><br><span class="line">        <span class="comment">//&#123;</span></span><br><span class="line">        <span class="comment">//    return new List&lt;int&gt;() &#123; 1, 2, 3, 4, 6, 7 &#125;;</span></span><br><span class="line">        <span class="comment">//&#125;</span></span><br><span class="line"></span><br><span class="line">        [<span class="meta">Route(<span class="string">&quot;Login&quot;</span>)</span>]</span><br><span class="line">        [<span class="meta">HttpPost</span>]</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="built_in">string</span> <span class="title">Login</span>(<span class="params"><span class="built_in">string</span> name, <span class="built_in">string</span> password</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">//在这里需要去数据库中做数据验证</span></span><br><span class="line">            <span class="keyword">if</span> (<span class="string">&quot;Harris&quot;</span>.Equals(name) &amp;&amp; <span class="string">&quot;123456&quot;</span>.Equals(password))</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">//就应该生成Token </span></span><br><span class="line">                <span class="built_in">string</span> token = <span class="keyword">this</span>._iJWTService.GetToken(name, password);</span><br><span class="line">                <span class="keyword">return</span> JsonConvert.SerializeObject(<span class="keyword">new</span></span><br><span class="line">                &#123;</span><br><span class="line">                    result = <span class="literal">true</span>,</span><br><span class="line">                    token</span><br><span class="line">                &#125;);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">return</span> JsonConvert.SerializeObject(<span class="keyword">new</span></span><br><span class="line">                &#123;</span><br><span class="line">                    result = <span class="literal">false</span>,</span><br><span class="line">                    token = <span class="string">&quot;&quot;</span></span><br><span class="line">                &#125;);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li><p>抽象类</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title">ICustomJWTService</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="built_in">string</span> <span class="title">GetToken</span>(<span class="params"><span class="built_in">string</span> UserName, <span class="built_in">string</span> password</span>)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li><p>HS JWT</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> Microsoft.Extensions.Options;</span><br><span class="line"><span class="keyword">using</span> Microsoft.IdentityModel.Tokens;</span><br><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> System.IdentityModel.Tokens.Jwt;</span><br><span class="line"><span class="keyword">using</span> System.Linq;</span><br><span class="line"><span class="keyword">using</span> System.Security.Claims;</span><br><span class="line"><span class="keyword">using</span> System.Text;</span><br><span class="line"><span class="keyword">using</span> System.Threading.Tasks;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">DotNetCoreDemo.AuthenticationCenter.Utility</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">CustomHSJWTService</span> : <span class="title">ICustomJWTService</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">readonly</span> JWTTokenOptions _JWTTokenOptions;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">CustomHSJWTService</span>(<span class="params">IOptionsMonitor&lt;JWTTokenOptions&gt; jwtTokenOptions</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">this</span>._JWTTokenOptions = jwtTokenOptions.CurrentValue;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="built_in">string</span> <span class="title">GetToken</span>(<span class="params"><span class="built_in">string</span> UserName, <span class="built_in">string</span> password</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="meta">#<span class="keyword">region</span> 有效载荷，大家可以自己写，爱写多少写多少；尽量避免敏感信息</span></span><br><span class="line">            <span class="keyword">var</span> claims = <span class="keyword">new</span>[]</span><br><span class="line">            &#123;</span><br><span class="line">               <span class="keyword">new</span> Claim(ClaimTypes.Name, UserName),</span><br><span class="line">               <span class="keyword">new</span> Claim(<span class="string">&quot;NickName&quot;</span>,UserName),</span><br><span class="line">               <span class="keyword">new</span> Claim(<span class="string">&quot;Role&quot;</span>,<span class="string">&quot;Administrator&quot;</span>),<span class="comment">//传递其他信息   </span></span><br><span class="line">               <span class="keyword">new</span> Claim(<span class="string">&quot;ABCC&quot;</span>,<span class="string">&quot;ABCC&quot;</span>),</span><br><span class="line">               <span class="keyword">new</span> Claim(<span class="string">&quot;Student&quot;</span>,<span class="string">&quot;甜酱油&quot;</span>)</span><br><span class="line">            &#125;;</span><br><span class="line"></span><br><span class="line">            <span class="comment">//需要加密：需要加密key:</span></span><br><span class="line">            <span class="comment">//Nuget引入：Microsoft.IdentityModel.Tokens</span></span><br><span class="line">            SymmetricSecurityKey key = <span class="keyword">new</span> SymmetricSecurityKey(Encoding.UTF8.GetBytes(_JWTTokenOptions.SecurityKey));</span><br><span class="line"></span><br><span class="line">            SigningCredentials creds = <span class="keyword">new</span> SigningCredentials(key, SecurityAlgorithms.HmacSha256);</span><br><span class="line"></span><br><span class="line">            <span class="comment">//Nuget引入：System.IdentityModel.Tokens.Jwt</span></span><br><span class="line">            JwtSecurityToken token = <span class="keyword">new</span> JwtSecurityToken(</span><br><span class="line">             issuer: _JWTTokenOptions.Issuer,</span><br><span class="line">             audience: _JWTTokenOptions.Audience,</span><br><span class="line">             claims: claims,</span><br><span class="line">             expires: DateTime.Now.AddMinutes(<span class="number">5</span>),<span class="comment">//5分钟有效期</span></span><br><span class="line">             signingCredentials: creds);</span><br><span class="line"></span><br><span class="line">            <span class="built_in">string</span> returnToken = <span class="keyword">new</span> JwtSecurityTokenHandler().WriteToken(token);</span><br><span class="line">            <span class="keyword">return</span> returnToken;</span><br><span class="line">            <span class="meta">#<span class="keyword">endregion</span></span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li><p>RSA JWT</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> Microsoft.Extensions.Options;</span><br><span class="line"><span class="keyword">using</span> Microsoft.IdentityModel.Tokens;</span><br><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> System.IdentityModel.Tokens.Jwt;</span><br><span class="line"><span class="keyword">using</span> System.IO;</span><br><span class="line"><span class="keyword">using</span> System.Linq;</span><br><span class="line"><span class="keyword">using</span> System.Security.Claims;</span><br><span class="line"><span class="keyword">using</span> System.Security.Cryptography;</span><br><span class="line"><span class="keyword">using</span> System.Threading.Tasks;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">DotNetCoreDemo.AuthenticationCenter.Utility</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">CustomRSSJWTervice</span> : <span class="title">ICustomJWTService</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="meta">#<span class="keyword">region</span> Option注入</span></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">readonly</span> JWTTokenOptions _JWTTokenOptions;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">CustomRSSJWTervice</span>(<span class="params">IOptionsMonitor&lt;JWTTokenOptions&gt; jwtTokenOptions</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            _JWTTokenOptions = jwtTokenOptions.CurrentValue;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="meta">#<span class="keyword">endregion</span></span></span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="built_in">string</span> <span class="title">GetToken</span>(<span class="params"><span class="built_in">string</span> UserName, <span class="built_in">string</span> password</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="meta">#<span class="keyword">region</span> 使用加密解密Key  非对称 </span></span><br><span class="line">            <span class="built_in">string</span> keyDir = Directory.GetCurrentDirectory();</span><br><span class="line">            <span class="keyword">if</span> (RSAHelper.TryGetKeyParameters(keyDir, <span class="literal">true</span>, <span class="keyword">out</span> RSAParameters keyParams) == <span class="literal">false</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                keyParams = RSAHelper.GenerateAndSaveKey(keyDir);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="meta">#<span class="keyword">endregion</span></span></span><br><span class="line"></span><br><span class="line">            <span class="comment">//string jtiCustom = Guid.NewGuid().ToString();//用来标识 Token</span></span><br><span class="line">            Claim[] claims = <span class="keyword">new</span>[]</span><br><span class="line">            &#123;</span><br><span class="line">                   <span class="keyword">new</span> Claim(ClaimTypes.Name, UserName),</span><br><span class="line">                   <span class="keyword">new</span> Claim(ClaimTypes.Role,<span class="string">&quot;admin&quot;</span>),</span><br><span class="line">                   <span class="keyword">new</span> Claim(<span class="string">&quot;password&quot;</span>,password)</span><br><span class="line">            &#125;;</span><br><span class="line"></span><br><span class="line">            SigningCredentials credentials = <span class="keyword">new</span> SigningCredentials(<span class="keyword">new</span> RsaSecurityKey(keyParams), SecurityAlgorithms.RsaSha256Signature);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">var</span> token = <span class="keyword">new</span> JwtSecurityToken(</span><br><span class="line">               issuer: <span class="keyword">this</span>._JWTTokenOptions.Issuer,</span><br><span class="line">               audience: <span class="keyword">this</span>._JWTTokenOptions.Audience,</span><br><span class="line">               claims: claims,</span><br><span class="line">               expires: DateTime.Now.AddMinutes(<span class="number">60</span>),<span class="comment">//5分钟有效期</span></span><br><span class="line">               signingCredentials: credentials);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">var</span> handler = <span class="keyword">new</span> JwtSecurityTokenHandler();</span><br><span class="line">            <span class="built_in">string</span> tokenString = handler.WriteToken(token);</span><br><span class="line">            <span class="keyword">return</span> tokenString;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
<li><p><code>JWTTokenOptions</code></p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> System.Linq;</span><br><span class="line"><span class="keyword">using</span> System.Threading.Tasks;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">DotNetCoreDemo.AuthenticationCenter.Utility</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">JWTTokenOptions</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">string</span> Audience</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">get</span>;</span><br><span class="line">            <span class="keyword">set</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">string</span> SecurityKey</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">get</span>;</span><br><span class="line">            <span class="keyword">set</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//public SigningCredentials Credentials</span></span><br><span class="line">        <span class="comment">//&#123;</span></span><br><span class="line">        <span class="comment">//    get;</span></span><br><span class="line">        <span class="comment">//    set;</span></span><br><span class="line">        <span class="comment">//&#125;</span></span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">string</span> Issuer</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">get</span>;</span><br><span class="line">            <span class="keyword">set</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li><p>RSA Helper</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> Newtonsoft.Json;</span><br><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> System.IO;</span><br><span class="line"><span class="keyword">using</span> System.Linq;</span><br><span class="line"><span class="keyword">using</span> System.Security.Cryptography;</span><br><span class="line"><span class="keyword">using</span> System.Threading.Tasks;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">DotNetCoreDemo.AuthenticationCenter.Utility</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">RSAHelper</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 从本地文件中读取用来签发 Token 的 RSA Key</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;filePath&quot;&gt;</span>存放密钥的文件夹路径<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;withPrivate&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;keyParameters&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="built_in">bool</span> <span class="title">TryGetKeyParameters</span>(<span class="params"><span class="built_in">string</span> filePath, <span class="built_in">bool</span> withPrivate, <span class="keyword">out</span> RSAParameters keyParameters</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">string</span> filename = withPrivate ? <span class="string">&quot;key.json&quot;</span> : <span class="string">&quot;key.public.json&quot;</span>;</span><br><span class="line">            <span class="built_in">string</span> fileTotalPath = Path.Combine(filePath, filename);</span><br><span class="line">            keyParameters = <span class="literal">default</span>(RSAParameters);</span><br><span class="line">            <span class="keyword">if</span> (!File.Exists(fileTotalPath))</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            &#123;</span><br><span class="line">                keyParameters = JsonConvert.DeserializeObject&lt;RSAParameters&gt;(File.ReadAllText(fileTotalPath));</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 生成并保存 RSA 公钥与私钥</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;filePath&quot;&gt;</span>存放密钥的文件夹路径<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> RSAParameters <span class="title">GenerateAndSaveKey</span>(<span class="params"><span class="built_in">string</span> filePath, <span class="built_in">bool</span> withPrivate = <span class="literal">true</span></span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            RSAParameters publicKeys, privateKeys;</span><br><span class="line">            <span class="keyword">using</span> (<span class="keyword">var</span> rsa = <span class="keyword">new</span> RSACryptoServiceProvider(<span class="number">2048</span>))<span class="comment">//即时生成</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">try</span></span><br><span class="line">                &#123;</span><br><span class="line">                    privateKeys = rsa.ExportParameters(<span class="literal">true</span>);</span><br><span class="line">                    publicKeys = rsa.ExportParameters(<span class="literal">false</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">finally</span></span><br><span class="line">                &#123;</span><br><span class="line">                    rsa.PersistKeyInCsp = <span class="literal">false</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            File.WriteAllText(Path.Combine(filePath, <span class="string">&quot;key.json&quot;</span>), JsonConvert.SerializeObject(privateKeys));</span><br><span class="line">            File.WriteAllText(Path.Combine(filePath, <span class="string">&quot;key.public.json&quot;</span>), JsonConvert.SerializeObject(publicKeys));</span><br><span class="line">            <span class="keyword">return</span> withPrivate ? privateKeys : publicKeys;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ol>
<h4 id="权限消费端"><a href="#权限消费端" class="headerlink" title="权限消费端"></a>权限消费端</h4><ol>
<li><p><code>appsetting.json</code>  主要关注 <code>JWTTokenOptions</code></p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;Logging&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;LogLevel&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;Default&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Information&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;Microsoft&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Warning&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;Microsoft.Hosting.Lifetime&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Information&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;AllowedHosts&quot;</span><span class="punctuation">:</span> <span class="string">&quot;*&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;TEST&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;TESTID&quot;</span><span class="punctuation">:</span> <span class="string">&quot;1111&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;TESTNAME&quot;</span><span class="punctuation">:</span> <span class="string">&quot;HARRIS&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;_TESTAdress&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;Sheng&quot;</span><span class="punctuation">:</span> <span class="string">&quot;SHANXI&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;Shi&quot;</span><span class="punctuation">:</span> <span class="string">&quot;XINZHOU&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;Family&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">      <span class="string">&quot;baba&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="string">&quot;mama&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="string">&quot;son&quot;</span></span><br><span class="line">    <span class="punctuation">]</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;JWTTokenOptions&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;Audience&quot;</span><span class="punctuation">:</span> <span class="string">&quot;http://localhost:5200&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;Issuer&quot;</span><span class="punctuation">:</span> <span class="string">&quot;http://localhost:5200&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;SecurityKey&quot;</span><span class="punctuation">:</span> <span class="string">&quot;MIGfMA0GCSqGSIb3DQEBAQUAA4GNADCBiQKBgQDI2a2EJ7m872v0afyoSDJT2o1+SitIeJSWtLJU8/Wz2m7gStexajkeD+Lka6DSTy8gt9UwfgVQo6uKjVLG5Ex7PiGOODVqAEghBuS7JzIYU5RvI543nNDAPfnJsas96mSA7L/mD7RTE2drj6hf3oZjJpMPZUQI/B1Qjb5H3K3PNwIDAQAB&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure></li>
<li><p><code>Startup.cs</code>  中 <code>ConfigureServices</code> 方法，先把之前测试<code>Cookie</code>的方法注释掉。</p>
 <figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">region</span> RSA</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// 读取公钥</span></span><br><span class="line">    <span class="built_in">string</span> path = Path.Combine(Directory.GetCurrentDirectory(), <span class="string">&quot;key.public.json&quot;</span>);</span><br><span class="line">    <span class="built_in">string</span> key = File.ReadAllText(path);<span class="comment">//this.Configuration[&quot;SecurityKey&quot;];</span></span><br><span class="line">    Console.WriteLine(<span class="string">$&quot;KeyPath:<span class="subst">&#123;path&#125;</span>&quot;</span>);</span><br><span class="line">    <span class="keyword">var</span> keyParams = JsonConvert.DeserializeObject&lt;RSAParameters&gt;(key);</span><br><span class="line">    <span class="comment">//SigningCredentials credentials = new SigningCredentials(new RsaSecurityKey(keyParams), SecurityAlgorithms.RsaSha256Signature);</span></span><br><span class="line"></span><br><span class="line">    JWTTokenOptions tokenOptions = <span class="keyword">new</span> JWTTokenOptions();</span><br><span class="line">    Configuration.Bind(<span class="string">&quot;JWTTokenOptions&quot;</span>, tokenOptions);</span><br><span class="line"></span><br><span class="line">    services.AddAuthentication(JwtBearerDefaults.AuthenticationScheme)</span><br><span class="line">        .AddJwtBearer(options =&gt;</span><br><span class="line">                      &#123;</span><br><span class="line">                          options.TokenValidationParameters = <span class="keyword">new</span> TokenValidationParameters</span><br><span class="line">                          &#123;</span><br><span class="line">                              ValidateIssuer = <span class="literal">true</span>,<span class="comment">//是否验证Issuer</span></span><br><span class="line">                              ValidateAudience = <span class="literal">true</span>,<span class="comment">//是否验证Audience</span></span><br><span class="line">                              ValidateLifetime = <span class="literal">true</span>,<span class="comment">//是否验证失效时间</span></span><br><span class="line">                              ValidateIssuerSigningKey = <span class="literal">true</span>,<span class="comment">//是否验证SecurityKey</span></span><br><span class="line">                              ValidAudience = tokenOptions.Audience,<span class="comment">//Audience</span></span><br><span class="line">                              ValidIssuer = tokenOptions.Issuer,<span class="comment">//Issuer，这两项和前面签发jwt的设置一致</span></span><br><span class="line">                              IssuerSigningKey = <span class="keyword">new</span> RsaSecurityKey(keyParams),</span><br><span class="line">                              <span class="comment">//IssuerSigningKeyValidator = (m, n, z) =&gt;</span></span><br><span class="line">                              <span class="comment">// &#123;</span></span><br><span class="line">                              <span class="comment">//     Console.WriteLine(&quot;This is IssuerValidator&quot;);</span></span><br><span class="line">                              <span class="comment">//     return true;</span></span><br><span class="line">                              <span class="comment">// &#125;,</span></span><br><span class="line">                              <span class="comment">//IssuerValidator = (m, n, z) =&gt;</span></span><br><span class="line">                              <span class="comment">// &#123;</span></span><br><span class="line">                              <span class="comment">//     Console.WriteLine(&quot;This is IssuerValidator&quot;);</span></span><br><span class="line">                              <span class="comment">//     return &quot;http://localhost:5726&quot;;</span></span><br><span class="line">                              <span class="comment">// &#125;,</span></span><br><span class="line">                              <span class="comment">//AudienceValidator = (m, n, z) =&gt;</span></span><br><span class="line">                              <span class="comment">//&#123;</span></span><br><span class="line">                              <span class="comment">//    Console.WriteLine(&quot;This is AudienceValidator&quot;);</span></span><br><span class="line">                              <span class="comment">//    return true;</span></span><br><span class="line">                              <span class="comment">//    //return m != null &amp;&amp; m.FirstOrDefault().Equals(this.Configuration[&quot;Audience&quot;]);</span></span><br><span class="line">                              <span class="comment">//&#125;,//自定义校验规则，可以新登录后将之前的无效</span></span><br><span class="line">                          &#125;;</span><br><span class="line">                      &#125;);</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">#<span class="keyword">endregion</span></span></span><br><span class="line"></span><br><span class="line"><span class="number">3.</span> 具体入口 `SixController` 特性 `[Authorize]`</span><br><span class="line"></span><br><span class="line">   ``` CSharp</span><br><span class="line">   <span class="keyword">using</span> Microsoft.AspNetCore.Authorization;</span><br><span class="line">   <span class="keyword">using</span> Microsoft.AspNetCore.Mvc;</span><br><span class="line">   <span class="keyword">using</span> System;</span><br><span class="line">   <span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line">   <span class="keyword">using</span> System.Linq;</span><br><span class="line">   <span class="keyword">using</span> System.Threading.Tasks;</span><br><span class="line">   </span><br><span class="line">   <span class="keyword">namespace</span> <span class="title">DotNetCoreDemo.Controllers</span></span><br><span class="line">   &#123;</span><br><span class="line">       <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">SixController</span> : <span class="title">Controller</span></span><br><span class="line">       &#123;</span><br><span class="line">           [<span class="meta">Authorize</span>] <span class="comment">//2.第二部：标记特性，表示Privacy 可以支持验证</span></span><br><span class="line">           <span class="function"><span class="keyword">public</span> IActionResult <span class="title">Index</span>()</span></span><br><span class="line">           &#123;</span><br><span class="line">               <span class="keyword">var</span> user = HttpContext.User;</span><br><span class="line">   </span><br><span class="line">               <span class="keyword">return</span> View();</span><br><span class="line">           &#125;</span><br><span class="line">   </span><br><span class="line">           <span class="function"><span class="keyword">public</span> IActionResult <span class="title">Login</span>()</span></span><br><span class="line">           &#123;</span><br><span class="line">               <span class="keyword">return</span> View();</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure></li>
<li><p>View</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">@&#123;</span><br><span class="line">    ViewData[&quot;Title&quot;] = &quot;Index&quot;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">h1</span>&gt;</span>Six Index<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">h3</span>&gt;</span>HS 授权完毕<span class="tag">&lt;/<span class="name">h3</span>&gt;</span></span><br></pre></td></tr></table></figure></li>
</ol>
<h4 id="测试过程"><a href="#测试过程" class="headerlink" title="测试过程"></a>测试过程</h4><ol>
<li><p>生成+获取<code>Token</code></p>
<p>生成<code>key.json</code> 和 <code>key.public.json</code> </p>
<p>授权中心通过WebApi 访问，生产<code>key.json</code> 和 <code>key.public.json</code> 。<code>key.json</code> 与 <code>key.public.json</code> 是互相呼应的。</p>
<p>图一：</p>
<p><img src="https://blogimage-1255495010.cos.ap-beijing.myqcloud.com/image-20211001191326110.png" alt="image-20211001191326110"></p>
<ol>
<li>点击 <code>Tryitout</code> 按钮到 </li>
<li>输入 <code>name</code> &amp; <code>password</code></li>
<li>点击 <code>Execute</code> 按钮，生成如下内容。</li>
</ol>
<p>图二：</p>
<p><img src="https://blogimage-1255495010.cos.ap-beijing.myqcloud.com/image-20211001191428193.png" alt="image-20211001191428193"></p>
<p>Response body 内容作为备用。</p>
<p>将 <code>key.public.json</code> 文件放到访问的相对位置，本地放到</p>
<p><img src="https://blogimage-1255495010.cos.ap-beijing.myqcloud.com/image-20211001191845619.png" alt="image-20211001191845619"></p>
</li>
<li><p>启动<code>PostMan</code> 工具</p>
<p><img src="https://blogimage-1255495010.cos.ap-beijing.myqcloud.com/image-20211001195024174.png" alt="image-20211001195024174"></p>
<ol>
<li><p>输入主程序 <a target="_blank" rel="noopener" href="http://localhost:5000/Six/Index">http://localhost:5000/Six/Index</a></p>
</li>
<li><p><code>Authorization</code> 选择 <code>Bearer Token</code> 输入 图二 中 <code>Response body</code> 中 <code>Token</code> 内容.</p>
</li>
<li><p>点击 <code>Send</code>提交，则可以看到访问成功。</p>
</li>
<li><p>否则 则报 <code>401</code> 错误</p>
<p><img src="https://blogimage-1255495010.cos.ap-beijing.myqcloud.com/image-20211001195539225.png" alt="image-20211001195539225"></p>
</li>
</ol>
</li>
</ol>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">Author: </span><span class="post-copyright-info"><a href="http://example.com">Harris</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">Link: </span><span class="post-copyright-info"><a href="http://example.com/2021/10/31/Net-Core-Note/">http://example.com/2021/10/31/Net-Core-Note/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">Copyright Notice: </span><span class="post-copyright-info">All articles in this blog are licensed under <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> unless stating additionally.</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/net-core/">.net core</a><a class="post-meta__tags" href="/tags/IOC/">IOC</a><a class="post-meta__tags" href="/tags/JWT/">JWT</a></div><div class="post_share"><div class="social-share" data-image="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/gh/overtrue/share.js@master/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2021/10/31/Golang-Note/"><img class="prev-cover" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">Previous Post</div><div class="prev_info">Golang Note</div></div></a></div><div class="next-post pull-right"><a href="/2021/10/31/Docker-Note/"><img class="next-cover" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">Next Post</div><div class="next_info">Docker Note</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>Related Articles</span></div><div class="relatedPosts-list"><div><a href="/2021/10/31/Docker-Note/" title="Docker Note"><img class="cover" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2021-10-31</div><div class="title">Docker Note</div></div></a></div><div><a href="/2022/01/19/DockerCompose/" title="Docker Compose"><img class="cover" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-01-19</div><div class="title">Docker Compose</div></div></a></div><div><a href="/2022/01/19/NetCore%20Nginx%20%E5%8F%8D%E5%90%91%E4%BB%A3%E7%90%86/" title="net core web + Docker + Nginx"><img class="cover" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-01-19</div><div class="title">net core web + Docker + Nginx</div></div></a></div><div><a href="/2022/01/20/jenkins/" title="Docker+GitLab+Jenkins"><img class="cover" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-01-20</div><div class="title">Docker+GitLab+Jenkins</div></div></a></div><div><a href="/2022/01/01/%E5%BE%AE%E6%9C%8D%E5%8A%A1%E4%B9%8B%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1/" title="微服务之负载均衡示例"><img class="cover" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-01-01</div><div class="title">微服务之负载均衡示例</div></div></a></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="https://i.loli.net/2021/02/24/5O1day2nriDzjSu.png" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">Harris</div><div class="author-info__description"></div></div><div class="card-info-data site-data is-center"><a href="/archives/"><div class="headline">Articles</div><div class="length-num">50</div></a><a href="/tags/"><div class="headline">Tags</div><div class="length-num">35</div></a><a href="/categories/"><div class="headline">Categories</div><div class="length-num">13</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/xxxxxx"><i class="fab fa-github"></i><span>Follow Me</span></a></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>Announcement</span></div><div class="announcement_content">This is my Blog</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>Catalog</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#Note-Dot-Net-Core"><span class="toc-number">1.</span> <span class="toc-text">Note Dot Net Core</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8F%91%E5%B8%83"><span class="toc-number">1.1.</span> <span class="toc-text">发布</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%97%AE%E9%A2%981"><span class="toc-number">1.1.1.</span> <span class="toc-text">问题1</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%97%AE%E9%A2%982"><span class="toc-number">1.1.2.</span> <span class="toc-text">问题2</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#CMD%E5%90%AF%E5%8A%A8"><span class="toc-number">1.2.</span> <span class="toc-text">CMD启动</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%AF%BB%E5%8F%96%E9%9D%99%E6%80%81%E6%96%87%E4%BB%B6-%E9%85%8D%E7%BD%AE%E4%B8%AD%E9%97%B4%E4%BB%B6"><span class="toc-number">1.3.</span> <span class="toc-text">读取静态文件+配置中间件</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#CMD-%E5%8F%82%E6%95%B0"><span class="toc-number">1.4.</span> <span class="toc-text">CMD 参数</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%8E%A7%E5%88%B6%E5%99%A8%E8%AF%BB%E5%8F%96%E9%85%8D%E7%BD%AE"><span class="toc-number">1.5.</span> <span class="toc-text">控制器读取配置</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%96%B9%E5%BC%8F1"><span class="toc-number">1.5.1.</span> <span class="toc-text">方式1</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%96%B9%E5%BC%8F2"><span class="toc-number">1.5.2.</span> <span class="toc-text">方式2</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Razor-%E6%B7%B7%E7%BC%96"><span class="toc-number">1.6.</span> <span class="toc-text">Razor 混编</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#index-cshtml"><span class="toc-number">1.6.1.</span> <span class="toc-text">index.cshtml</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Startup"><span class="toc-number">1.6.2.</span> <span class="toc-text">Startup</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Interface-%E5%B1%82"><span class="toc-number">1.6.3.</span> <span class="toc-text">Interface 层</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Service-%E5%B1%82"><span class="toc-number">1.6.4.</span> <span class="toc-text">Service 层</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Nuget-%E5%8C%85"><span class="toc-number">1.6.5.</span> <span class="toc-text">Nuget 包</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Razor-%E5%B8%83%E5%B1%80"><span class="toc-number">1.7.</span> <span class="toc-text">Razor 布局</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%BC%80%E5%A7%8B"><span class="toc-number">1.7.1.</span> <span class="toc-text">开始</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%AF%8D%E7%89%88%E9%A1%B5"><span class="toc-number">1.7.2.</span> <span class="toc-text">母版页</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Razor-%E6%89%A9%E5%B1%95"><span class="toc-number">1.8.</span> <span class="toc-text">Razor 扩展</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%89%A9%E5%B1%95%E6%8E%A7%E4%BB%B6%EF%BC%881%EF%BC%89"><span class="toc-number">1.8.1.</span> <span class="toc-text">扩展控件（1）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%89%A9%E5%B1%95%E6%8E%A7%E4%BB%B6%EF%BC%882%EF%BC%89"><span class="toc-number">1.8.2.</span> <span class="toc-text">扩展控件（2）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%B1%80%E9%83%A8%E8%A7%86%E5%9B%BE"><span class="toc-number">1.8.3.</span> <span class="toc-text">局部视图</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%A7%86%E5%9B%BE%E7%BB%84%E4%BB%B6"><span class="toc-number">1.8.4.</span> <span class="toc-text">视图组件</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#IOC"><span class="toc-number">1.9.</span> <span class="toc-text">IOC</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#IOC%E5%87%BA%E7%8E%B0%E7%9A%84%E8%83%8C%E6%99%AF"><span class="toc-number">1.9.1.</span> <span class="toc-text">IOC出现的背景</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#IOC%E6%98%AF%E4%BB%80%E4%B9%88"><span class="toc-number">1.9.2.</span> <span class="toc-text">IOC是什么</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#IOC%E8%83%BD%E5%81%9A%E4%BB%80%E4%B9%88"><span class="toc-number">1.9.3.</span> <span class="toc-text">IOC能做什么</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#IOC%E5%92%8CDI"><span class="toc-number">1.9.4.</span> <span class="toc-text">IOC和DI</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Dl-%E6%B3%A8%E5%85%A5%E6%96%B9%E5%BC%8F"><span class="toc-number">1.9.5.</span> <span class="toc-text">Dl 注入方式</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Dl-%E4%BE%9D%E8%B5%96%E6%B3%A8%E5%85%A5"><span class="toc-number">1.9.6.</span> <span class="toc-text">Dl 依赖注入</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#IServiceCollection-%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F"><span class="toc-number">1.9.7.</span> <span class="toc-text">IServiceCollection 生命周期</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Autofac-%E5%BA%94%E7%94%A8"><span class="toc-number">1.10.</span> <span class="toc-text">Autofac 应用</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%9D%E8%AF%86-Autofac"><span class="toc-number">1.10.1.</span> <span class="toc-text">初识 Autofac</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Autofac-%E5%A4%9A%E7%A7%8D%E6%B3%A8%E5%86%8C%E6%96%B9%E5%BC%8F"><span class="toc-number">1.10.2.</span> <span class="toc-text">Autofac 多种注册方式</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Autofac-%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F"><span class="toc-number">1.10.3.</span> <span class="toc-text">Autofac 生命周期</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Autofac-%E8%AF%BB%E5%8F%96%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6%E6%B3%A8%E5%86%8C"><span class="toc-number">1.10.4.</span> <span class="toc-text">Autofac 读取配置文件注册</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Autofac-%E6%95%B4%E5%90%88%E5%88%B0MVC"><span class="toc-number">1.10.5.</span> <span class="toc-text">Autofac 整合到MVC</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Autofac-%E6%94%AF%E6%8C%81%E6%8E%A7%E5%88%B6%E5%99%A8%E5%B1%9E%E6%80%A7%E6%B3%A8%E5%85%A5"><span class="toc-number">1.10.6.</span> <span class="toc-text">Autofac 支持控制器属性注入</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Autofac-%E6%8A%BD%E8%B1%A1%E5%A4%9A%E5%AE%9E%E7%8E%B0%E7%9A%84%E9%97%AE%E9%A2%981"><span class="toc-number">1.10.7.</span> <span class="toc-text">Autofac 抽象多实现的问题1</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Autofac-%E6%94%AF%E6%8C%81-AOP"><span class="toc-number">1.10.8.</span> <span class="toc-text">Autofac 支持 AOP</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Autofac-%E6%94%AF%E6%8C%81-AOP2"><span class="toc-number">1.10.9.</span> <span class="toc-text">Autofac 支持 AOP2</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Autofac-%E6%8A%BD%E8%B1%A1%E5%A4%9A%E4%B8%AA%E5%AE%9E%E7%8E%B0%E6%9E%84%E9%80%A0%E5%87%BD%E6%95%B0%E6%B3%A8%E5%85%A5"><span class="toc-number">1.10.10.</span> <span class="toc-text">Autofac 抽象多个实现构造函数注入</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Autofac-%E6%8A%BD%E8%B1%A1%E5%A4%9A%E4%B8%AA%E5%AE%9E%E7%8E%B0%E5%B1%9E%E6%80%A7%E6%B3%A8%E5%85%A5"><span class="toc-number">1.10.11.</span> <span class="toc-text">Autofac 抽象多个实现属性注入</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Filter"><span class="toc-number">1.11.</span> <span class="toc-text">Filter</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#ActionFilter-AOP"><span class="toc-number">1.11.1.</span> <span class="toc-text">ActionFilter+AOP</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ActionFilter-%E5%A4%9A%E7%A7%8D%E5%AE%9E%E7%8E%B0"><span class="toc-number">1.11.2.</span> <span class="toc-text">ActionFilter 多种实现</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ActionFilter-%E5%81%9A%E6%97%A5%E5%BF%97"><span class="toc-number">1.11.3.</span> <span class="toc-text">ActionFilter 做日志</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Filter-%E5%A4%9A%E7%A7%8D%E6%B3%A8%E5%86%8C"><span class="toc-number">1.11.4.</span> <span class="toc-text">Filter 多种注册</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#FilterFactory-%E6%89%A9%E5%B1%95"><span class="toc-number">1.11.5.</span> <span class="toc-text">FilterFactory 扩展</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Filter-%E7%94%9F%E6%95%88%E8%8C%83%E5%9B%B4%E4%B8%8E%E6%89%A7%E8%A1%8C%E9%A1%BA%E5%BA%8F"><span class="toc-number">1.11.6.</span> <span class="toc-text">Filter 生效范围与执行顺序</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ResourceFilter-%E6%89%A9%E5%B1%95%E5%AE%9A%E5%88%B6-%E6%94%AF%E6%8C%81%E7%BC%93%E5%AD%98"><span class="toc-number">1.11.7.</span> <span class="toc-text">ResourceFilter 扩展定制-支持缓存</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Filter-%E5%8C%BF%E5%90%8D"><span class="toc-number">1.11.8.</span> <span class="toc-text">Filter 匿名</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ExceptionFilter"><span class="toc-number">1.11.9.</span> <span class="toc-text">ExceptionFilter</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ExceptionFilter-%E8%83%BD%E6%8D%95%E6%8D%89%E5%88%B0%E7%9A%84%E5%BC%82%E5%B8%B8"><span class="toc-number">1.11.10.</span> <span class="toc-text">ExceptionFilter 能捕捉到的异常</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ResultFilter"><span class="toc-number">1.11.11.</span> <span class="toc-text">ResultFilter</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%89%B4%E6%9D%83%E6%8E%88%E6%9D%83%E6%96%B9%E5%BC%8F"><span class="toc-number">1.12.</span> <span class="toc-text">鉴权授权方式</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Cookie"><span class="toc-number">1.12.1.</span> <span class="toc-text">Cookie</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#JWT"><span class="toc-number">1.12.2.</span> <span class="toc-text">JWT</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%90%AD%E5%BB%BA%E6%8E%88%E6%9D%83%E4%B8%AD%E5%BF%83%EF%BC%88WEBAPI%EF%BC%89"><span class="toc-number">1.12.2.1.</span> <span class="toc-text">搭建授权中心（WEBAPI）</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%9D%83%E9%99%90%E6%B6%88%E8%B4%B9%E7%AB%AF"><span class="toc-number">1.12.2.2.</span> <span class="toc-text">权限消费端</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%B5%8B%E8%AF%95%E8%BF%87%E7%A8%8B"><span class="toc-number">1.12.2.3.</span> <span class="toc-text">测试过程</span></a></li></ol></li></ol></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>Recent Post</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/2022/05/09/wireshark-%E4%B8%89%E6%AC%A1%E6%8F%A1%E6%89%8B%E5%9B%9B%E6%AC%A1%E6%8C%A5%E6%89%8B/" title="Wireshark-三次握手四次挥手"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Wireshark-三次握手四次挥手"/></a><div class="content"><a class="title" href="/2022/05/09/wireshark-%E4%B8%89%E6%AC%A1%E6%8F%A1%E6%89%8B%E5%9B%9B%E6%AC%A1%E6%8C%A5%E6%89%8B/" title="Wireshark-三次握手四次挥手">Wireshark-三次握手四次挥手</a><time datetime="2022-05-09T08:27:02.000Z" title="Created 2022-05-09 16:27:02">2022-05-09</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2022/05/07/%E9%9D%A2%E8%AF%95%E9%A2%98/" title="面试题"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="面试题"/></a><div class="content"><a class="title" href="/2022/05/07/%E9%9D%A2%E8%AF%95%E9%A2%98/" title="面试题">面试题</a><time datetime="2022-05-07T13:57:08.000Z" title="Created 2022-05-07 21:57:08">2022-05-07</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2022/05/06/CSharp-%E5%85%B3%E9%94%AE%E5%AD%97/" title="CSharp-关键字"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="CSharp-关键字"/></a><div class="content"><a class="title" href="/2022/05/06/CSharp-%E5%85%B3%E9%94%AE%E5%AD%97/" title="CSharp-关键字">CSharp-关键字</a><time datetime="2022-05-06T01:17:14.000Z" title="Created 2022-05-06 09:17:14">2022-05-06</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2022/05/05/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F-%E4%BB%A3%E7%90%86%E6%A8%A1%E5%BC%8F/" title="设计模式-代理模式"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="设计模式-代理模式"/></a><div class="content"><a class="title" href="/2022/05/05/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F-%E4%BB%A3%E7%90%86%E6%A8%A1%E5%BC%8F/" title="设计模式-代理模式">设计模式-代理模式</a><time datetime="2022-05-05T09:38:11.000Z" title="Created 2022-05-05 17:38:11">2022-05-05</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2022/05/05/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F-%E4%BA%AB%E5%85%83%E6%A8%A1%E5%BC%8F/" title="设计模式-享元模式"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="设计模式-享元模式"/></a><div class="content"><a class="title" href="/2022/05/05/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F-%E4%BA%AB%E5%85%83%E6%A8%A1%E5%BC%8F/" title="设计模式-享元模式">设计模式-享元模式</a><time datetime="2022-05-05T07:45:16.000Z" title="Created 2022-05-05 15:45:16">2022-05-05</time></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2022 By Harris</div><div class="framework-info"><span>Framework </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>Theme </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="Read Mode"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="Switch Between Light And Dark Mode"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="Toggle between single-column and double-column"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="Setting"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="Table Of Contents"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="Back To Top"><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.umd.js"></script><div class="js-pjax"></div><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>