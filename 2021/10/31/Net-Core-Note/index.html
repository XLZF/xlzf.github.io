

<!DOCTYPE html>
<html lang="en" data-default-color-scheme=auto>



<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/img/avatar.png">
  <link rel="icon" href="/img/avatar.png">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="description" content="把之前学习.net core的笔记同步到此博客上，慢慢完善吧。">
  <meta name="author" content="Harris">
  <meta name="keywords" content="">
  <meta name="description" content="把之前学习.net core的笔记同步到此博客上，慢慢完善吧。">
<meta property="og:type" content="article">
<meta property="og:title" content="DotNet Core Note">
<meta property="og:url" content="http://example.com/2021/10/31/Net-Core-Note/index.html">
<meta property="og:site_name" content="Harris Blog">
<meta property="og:description" content="把之前学习.net core的笔记同步到此博客上，慢慢完善吧。">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://blogimage-1255495010.cos.ap-beijing.myqcloud.com/image-20210817220618980.png">
<meta property="og:image" content="https://blogimage-1255495010.cos.ap-beijing.myqcloud.com/image-20210817220659934.png">
<meta property="og:image" content="https://blogimage-1255495010.cos.ap-beijing.myqcloud.com/image-20210817221100914.png">
<meta property="og:image" content="https://blogimage-1255495010.cos.ap-beijing.myqcloud.com/image-20210817221438691.png">
<meta property="og:image" content="https://blogimage-1255495010.cos.ap-beijing.myqcloud.com/image-20210817221551567.png">
<meta property="og:image" content="https://blogimage-1255495010.cos.ap-beijing.myqcloud.com/image-20210817221946942.png">
<meta property="og:image" content="https://blogimage-1255495010.cos.ap-beijing.myqcloud.com/image-20210817222017718.png">
<meta property="og:image" content="https://blogimage-1255495010.cos.ap-beijing.myqcloud.com/image-20210817222055216.png">
<meta property="og:image" content="https://blogimage-1255495010.cos.ap-beijing.myqcloud.com/image-20210817222624896.png">
<meta property="og:image" content="https://blogimage-1255495010.cos.ap-beijing.myqcloud.com/image-20210817224246940.png">
<meta property="og:image" content="https://blogimage-1255495010.cos.ap-beijing.myqcloud.com/image-20210817224330676.png">
<meta property="og:image" content="https://blogimage-1255495010.cos.ap-beijing.myqcloud.com/image-20210817224503747.png">
<meta property="og:image" content="https://blogimage-1255495010.cos.ap-beijing.myqcloud.com/image-20210817224712705.png">
<meta property="og:image" content="https://blogimage-1255495010.cos.ap-beijing.myqcloud.com/image-20210819222204161.png">
<meta property="og:image" content="https://blogimage-1255495010.cos.ap-beijing.myqcloud.com/image-20210819224059065.png">
<meta property="og:image" content="https://blogimage-1255495010.cos.ap-beijing.myqcloud.com/image-20210819224219428.png">
<meta property="og:image" content="https://blogimage-1255495010.cos.ap-beijing.myqcloud.com/image-20210819224316517.png">
<meta property="og:image" content="https://blogimage-1255495010.cos.ap-beijing.myqcloud.com/image-20210819230720154.png">
<meta property="og:image" content="https://blogimage-1255495010.cos.ap-beijing.myqcloud.com/image-20210819230859533.png">
<meta property="og:image" content="https://blogimage-1255495010.cos.ap-beijing.myqcloud.com/image-20210822120532857.png">
<meta property="og:image" content="https://blogimage-1255495010.cos.ap-beijing.myqcloud.com/image-20210822122832247.png">
<meta property="og:image" content="https://blogimage-1255495010.cos.ap-beijing.myqcloud.com/image-20210822120844118.png">
<meta property="og:image" content="https://blogimage-1255495010.cos.ap-beijing.myqcloud.com/image-20210822121926617.png">
<meta property="og:image" content="https://blogimage-1255495010.cos.ap-beijing.myqcloud.com/image-20210822122520500.png">
<meta property="og:image" content="https://blogimage-1255495010.cos.ap-beijing.myqcloud.com/image-20210822195432996.png">
<meta property="og:image" content="https://blogimage-1255495010.cos.ap-beijing.myqcloud.com/image-20210822195931807.png">
<meta property="og:image" content="https://blogimage-1255495010.cos.ap-beijing.myqcloud.com/image-20210822195634650.png">
<meta property="og:image" content="https://blogimage-1255495010.cos.ap-beijing.myqcloud.com/image-20210822202647528.png">
<meta property="og:image" content="https://blogimage-1255495010.cos.ap-beijing.myqcloud.com/image-20210822210047680.png">
<meta property="og:image" content="https://blogimage-1255495010.cos.ap-beijing.myqcloud.com/image-20210822210156272.png">
<meta property="og:image" content="https://blogimage-1255495010.cos.ap-beijing.myqcloud.com/image-20210822212634256.png">
<meta property="og:image" content="https://blogimage-1255495010.cos.ap-beijing.myqcloud.com/image-20210822212831324.png">
<meta property="og:image" content="https://blogimage-1255495010.cos.ap-beijing.myqcloud.com/image-20210823212950311.png">
<meta property="og:image" content="https://blogimage-1255495010.cos.ap-beijing.myqcloud.com/image-20210823213304825.png">
<meta property="og:image" content="https://blogimage-1255495010.cos.ap-beijing.myqcloud.com/image-20210824222129039.png">
<meta property="og:image" content="https://blogimage-1255495010.cos.ap-beijing.myqcloud.com/image-20210824222356654.png">
<meta property="og:image" content="https://blogimage-1255495010.cos.ap-beijing.myqcloud.com/image-20210824222521682.png">
<meta property="og:image" content="https://blogimage-1255495010.cos.ap-beijing.myqcloud.com/983950-20200828140652970-543560967.png">
<meta property="og:image" content="https://blogimage-1255495010.cos.ap-beijing.myqcloud.com/983950-20200828141239801-1102376797.png">
<meta property="og:image" content="https://blogimage-1255495010.cos.ap-beijing.myqcloud.com/image-20210828145713938.png">
<meta property="og:image" content="https://blogimage-1255495010.cos.ap-beijing.myqcloud.com/image-20210828145845491.png">
<meta property="og:image" content="https://blogimage-1255495010.cos.ap-beijing.myqcloud.com/image-20210828151007374.png">
<meta property="og:image" content="https://blogimage-1255495010.cos.ap-beijing.myqcloud.com/image-20210829154658355.png">
<meta property="og:image" content="https://blogimage-1255495010.cos.ap-beijing.myqcloud.com/image-20210829182152021.png">
<meta property="og:image" content="https://blogimage-1255495010.cos.ap-beijing.myqcloud.com/image-20210829200529269.png">
<meta property="og:image" content="https://blogimage-1255495010.cos.ap-beijing.myqcloud.com/image-20210829201047537.png">
<meta property="og:image" content="https://blogimage-1255495010.cos.ap-beijing.myqcloud.com/image-20210829200904042.png">
<meta property="og:image" content="https://blogimage-1255495010.cos.ap-beijing.myqcloud.com/image-20210830232226520.png">
<meta property="og:image" content="https://blogimage-1255495010.cos.ap-beijing.myqcloud.com/image-20210830232929753.png">
<meta property="og:image" content="https://blogimage-1255495010.cos.ap-beijing.myqcloud.com/image-20210830233558148.png">
<meta property="og:image" content="https://blogimage-1255495010.cos.ap-beijing.myqcloud.com/image-20210830234629332.png">
<meta property="og:image" content="https://blogimage-1255495010.cos.ap-beijing.myqcloud.com/image-20210901221357225.png">
<meta property="og:image" content="https://blogimage-1255495010.cos.ap-beijing.myqcloud.com/image-20210902225117135.png">
<meta property="og:image" content="https://blogimage-1255495010.cos.ap-beijing.myqcloud.com/image-20210903214211926.png">
<meta property="og:image" content="https://blogimage-1255495010.cos.ap-beijing.myqcloud.com/image-20210904135936278.png">
<meta property="og:image" content="https://blogimage-1255495010.cos.ap-beijing.myqcloud.com/image-20210904140002918.png">
<meta property="og:image" content="https://blogimage-1255495010.cos.ap-beijing.myqcloud.com/image-20210904154410691.png">
<meta property="og:image" content="https://blogimage-1255495010.cos.ap-beijing.myqcloud.com/image-20210904204835244.png">
<meta property="og:image" content="https://blogimage-1255495010.cos.ap-beijing.myqcloud.com/image-20210905121153341.png">
<meta property="og:image" content="https://blogimage-1255495010.cos.ap-beijing.myqcloud.com/image-20210905161745655.png">
<meta property="og:image" content="https://blogimage-1255495010.cos.ap-beijing.myqcloud.com/image-20210905170801999.png">
<meta property="og:image" content="https://blogimage-1255495010.cos.ap-beijing.myqcloud.com/image-20210905185056411.png">
<meta property="og:image" content="https://blogimage-1255495010.cos.ap-beijing.myqcloud.com/Token%E9%89%B4%E6%9D%83%E6%8E%88%E6%9D%83.png">
<meta property="og:image" content="https://blogimage-1255495010.cos.ap-beijing.myqcloud.com/image-20211001192934524.png">
<meta property="og:image" content="https://blogimage-1255495010.cos.ap-beijing.myqcloud.com/image-20211001191326110.png">
<meta property="og:image" content="https://blogimage-1255495010.cos.ap-beijing.myqcloud.com/image-20211001191428193.png">
<meta property="og:image" content="https://blogimage-1255495010.cos.ap-beijing.myqcloud.com/image-20211001191845619.png">
<meta property="og:image" content="https://blogimage-1255495010.cos.ap-beijing.myqcloud.com/image-20211001195024174.png">
<meta property="og:image" content="https://blogimage-1255495010.cos.ap-beijing.myqcloud.com/image-20211001195539225.png">
<meta property="article:published_time" content="2021-10-31T11:24:17.000Z">
<meta property="article:modified_time" content="2022-03-31T01:47:44.874Z">
<meta property="article:author" content="Harris">
<meta property="article:tag" content=".net core">
<meta property="article:tag" content="IOC">
<meta property="article:tag" content="JWT">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="https://blogimage-1255495010.cos.ap-beijing.myqcloud.com/image-20210817220618980.png">
  
  <title>DotNet Core Note - Harris Blog</title>

  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/css/bootstrap.min.css" />


  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/github-markdown-css@4/github-markdown.min.css" />
  <link  rel="stylesheet" href="/lib/hint/hint.min.css" />

  
    
    
      
      <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@10/styles/github-gist.min.css" />
    
  

  
    <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3/dist/jquery.fancybox.min.css" />
  


<!-- 主题依赖的图标库，不要自行修改 -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_ba1fz6golrf.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_kmeydafke9r.css">


<link  rel="stylesheet" href="/css/main.css" />

<!-- 自定义样式保持在最底部 -->

  
<link rel="stylesheet" href="//cdn.jsdelivr.net/gh/bynotes/texiao/source/css/shubiao.css">
<link rel="stylesheet" href="//cdn.jsdelivr.net/gh/bynotes/texiao/source/css/gundongtiao.css">
<link rel="stylesheet" href="//cdn.jsdelivr.net/gh/bynotes/texiao/source/css/toubudaziji.css">



  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    var CONFIG = {"hostname":"example.com","root":"/","version":"1.8.12","typing":{"enable":true,"typeSpeed":70,"cursorChar":"_","loop":false},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"right","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"copy_btn":true,"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":false,"baidu":null,"google":null,"gtag":null,"tencent":{"sid":null,"cid":null},"woyaola":null,"cnzz":null,"leancloud":{"app_id":null,"app_key":null,"server_url":null,"path":"window.location.pathname"}},"search_path":"/local-search.xml"};
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
<meta name="generator" content="Hexo 6.1.0"><link rel="alternate" href="/atom.xml" title="Harris Blog" type="application/atom+xml">
</head>


<body>
  <header style="height: 60vh;">
    <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">
      <strong>道吾</strong>
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/">
                <i class="iconfont icon-home-fill"></i>
                主页
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/">
                <i class="iconfont icon-archive-fill"></i>
                归档
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/">
                <i class="iconfont icon-category-fill"></i>
                类别
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/">
                <i class="iconfont icon-tags-fill"></i>
                标签
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/">
                <i class="iconfont icon-user-fill"></i>
                关于
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item dropdown">
              <a class="nav-link dropdown-toggle" target="_self" href="javascript:;" role="button"
                 data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                <i class="iconfont icon-books"></i>
                文档
              </a>
              <div class="dropdown-menu" aria-labelledby="navbarDropdown">
                
                  
                  
                  
                  <a class="dropdown-item" target="_blank" rel="noopener" href="https://hexo.fluid-dev.com/">
                    
                    主题博客
                  </a>
                
                  
                  
                  
                  <a class="dropdown-item" target="_blank" rel="noopener" href="https://hexo.fluid-dev.com/docs/guide/">
                    
                    配置指南
                  </a>
                
                  
                  
                  
                  <a class="dropdown-item" target="_blank" rel="noopener" href="https://hexo.fluid-dev.com/docs/icon/">
                    
                    图标用法
                  </a>
                
              </div>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">
              &nbsp;<i class="iconfont icon-search"></i>&nbsp;
            </a>
          </li>
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">&nbsp;<i
                class="iconfont icon-dark" id="color-toggle-icon"></i>&nbsp;</a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

    <div class="banner" id="banner" parallax=true
         style="background: url('https://blogimage-1255495010.cos.ap-beijing.myqcloud.com/4.png') no-repeat center center;
           background-size: cover;">
      <div class="full-bg-img">
        <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
          <div class="page-header text-center fade-in-up">
            <span class="h2" id="subtitle" title="DotNet Core Note">
              
            </span>

            
              <div class="mt-3">
  
    <span class="post-meta mr-2">
      <i class="iconfont icon-author" aria-hidden="true"></i>
      Harris
    </span>
  
  
    <span class="post-meta">
      <i class="iconfont icon-date-fill" aria-hidden="true"></i>
      <time datetime="2021-10-31 19:24" pubdate>
        October 31, 2021 pm
      </time>
    </span>
  
</div>

<div class="mt-1">
  
    <span class="post-meta mr-2">
      <i class="iconfont icon-chart"></i>
      80k 字
    </span>
  

  
    <span class="post-meta mr-2">
      <i class="iconfont icon-clock-fill"></i>
      
      
      249 分钟
    </span>
  

  
  
    
      <!-- 不蒜子统计文章PV -->
      <span id="busuanzi_container_page_pv" style="display: none">
        <i class="iconfont icon-eye" aria-hidden="true"></i>
        <span id="busuanzi_value_page_pv"></span> 次
      </span>
    
  
</div>

            
          </div>

          
        </div>
      </div>
    </div>
  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="d-none d-lg-block col-lg-2"></div>
    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div class="py-5" id="board">
          <article class="post-content mx-auto">
            <!-- SEO header -->
            <h1 style="display: none">DotNet Core Note</h1>
            
              <p class="note note-info">
                
                  本文最后更新于：25 days ago
                
              </p>
            
            <div class="markdown-body">
              <h1 id="Note-Dot-Net-Core"><a href="#Note-Dot-Net-Core" class="headerlink" title="Note Dot Net Core"></a>Note Dot Net Core</h1><h2 id="发布"><a href="#发布" class="headerlink" title="发布"></a>发布</h2><p>环境用的是Dot Net 5 SDK</p>
<h3 id="问题1"><a href="#问题1" class="headerlink" title="问题1"></a>问题1</h3><p>每次运行生成到 <code>\bin\Debug\net5.0</code> 下的文件 对比 发布之后的文件，多的一个 <code>web.config</code></p>
<p>生成文件</p>
<p><img src="https://blogimage-1255495010.cos.ap-beijing.myqcloud.com/image-20210817220618980.png" srcset="/img/loading.gif" lazyload alt="image-20210817220618980"></p>
<p><img src="https://blogimage-1255495010.cos.ap-beijing.myqcloud.com/image-20210817220659934.png" srcset="/img/loading.gif" lazyload alt="image-20210817220659934"></p>
<p>如果把<code>web.config</code>文件复制到生成文件夹中，照样可以通过<code>IIS</code>发布</p>
<h3 id="问题2"><a href="#问题2" class="headerlink" title="问题2"></a>问题2</h3><p>当<code>IIS</code> 安装完毕之后，该设置的都设置了，但是访问直接</p>
<p><img src="https://blogimage-1255495010.cos.ap-beijing.myqcloud.com/image-20210817221100914.png" srcset="/img/loading.gif" lazyload alt="image-20210817221100914"></p>
<p>如果之前玩过<code>IIS</code>的话，就会有点懵圈，我之前玩就是这么玩的，为毛现在不行了，答案是，这样真不行。</p>
<p>首先，需要访问 <a target="_blank" rel="noopener" href="https://dotnet.microsoft.com/download/dotnet">.NET Downloads (Linux, macOS, and Windows) (microsoft.com)</a></p>
<p><img src="https://blogimage-1255495010.cos.ap-beijing.myqcloud.com/image-20210817221438691.png" srcset="/img/loading.gif" lazyload alt="image-20210817221438691"></p>
<p>根据自己的环境下载对应的Host 和 SDK</p>
<p><img src="https://blogimage-1255495010.cos.ap-beijing.myqcloud.com/image-20210817221551567.png" srcset="/img/loading.gif" lazyload alt="image-20210817221551567"></p>
<p>上面这安装完毕后，重启<code>IIS</code>服务</p>
<p><img src="https://blogimage-1255495010.cos.ap-beijing.myqcloud.com/image-20210817221946942.png" srcset="/img/loading.gif" lazyload alt="image-20210817221946942"></p>
<p><img src="https://blogimage-1255495010.cos.ap-beijing.myqcloud.com/image-20210817222017718.png" srcset="/img/loading.gif" lazyload alt="image-20210817222017718"></p>
<p><img src="https://blogimage-1255495010.cos.ap-beijing.myqcloud.com/image-20210817222055216.png" srcset="/img/loading.gif" lazyload alt="image-20210817222055216"></p>
<p>在模块中多俩这玩意，没有这俩玩意的，再找资源下载，都在刚才那个网址里，然 就没有那个500的毛病了。</p>
<p>其实最主要的是依赖 <code>AspNetCoreModuleV2</code>,具体可以看问题1里说的那个<code>web.config</code>中。</p>
<p><img src="https://blogimage-1255495010.cos.ap-beijing.myqcloud.com/image-20210817222624896.png" srcset="/img/loading.gif" lazyload alt="image-20210817222624896"></p>
<p>你悟了吗？</p>
<h2 id="CMD启动"><a href="#CMD启动" class="headerlink" title="CMD启动"></a>CMD启动</h2><ol>
<li><p>通过CMD 去启动 cd 到发布目录 执行</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">dotnet DotNetCoreDemo.dll<br></code></pre></td></tr></table></figure>

<p><img src="https://blogimage-1255495010.cos.ap-beijing.myqcloud.com/image-20210817224246940.png" srcset="/img/loading.gif" lazyload alt="image-20210817224246940"></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">dotnet DotNetCoreDemo.dll --urls &quot;http://*:8888&quot;<br></code></pre></td></tr></table></figure>

<p><img src="https://blogimage-1255495010.cos.ap-beijing.myqcloud.com/image-20210817224330676.png" srcset="/img/loading.gif" lazyload alt="image-20210817224330676"></p>
</li>
</ol>
<p><img src="https://blogimage-1255495010.cos.ap-beijing.myqcloud.com/image-20210817224503747.png" srcset="/img/loading.gif" lazyload alt="image-20210817224503747"></p>
<p>由于DotNetCore 有跨平台的优势，一般生产环境基本是不用<code>IIS</code></p>
<p>执行的命令在<code>web.config</code>中可以看到，仔细观察</p>
<p><img src="https://blogimage-1255495010.cos.ap-beijing.myqcloud.com/image-20210817224712705.png" srcset="/img/loading.gif" lazyload alt="image-20210817224712705"></p>
<p>在 DotNetCore 中，<code>IIS</code> 其实充当的角色是转发请求，与之前的发布网站的用法不一样了，有点怀念之前<code>webform</code>的青涩。</p>
<h2 id="读取静态文件-配置中间件"><a href="#读取静态文件-配置中间件" class="headerlink" title="读取静态文件+配置中间件"></a>读取静态文件+配置中间件</h2><ol>
<li><p>引入命名空间</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs CSharp"><span class="hljs-keyword">using</span> Microsoft.Extensions.FileProviders;<br><span class="hljs-keyword">using</span> System.IO;<br></code></pre></td></tr></table></figure></li>
<li><p>配置读取静态文件中间件</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs CSharp"><span class="hljs-comment">//获取相对路径</span><br><span class="hljs-built_in">string</span> path = Path.Combine(Directory.GetCurrentDirectory(), <span class="hljs-string">&quot;wwwroot&quot;</span>);<br><br>app.UseStaticFiles(<span class="hljs-keyword">new</span> StaticFileOptions()<br>&#123;<br>	<span class="hljs-comment">//从物理路径指向wwwroot</span><br>	FileProvider = <span class="hljs-keyword">new</span> PhysicalFileProvider(path)<br>&#125;);<br></code></pre></td></tr></table></figure></li>
</ol>
<h2 id="CMD-参数"><a href="#CMD-参数" class="headerlink" title="CMD 参数"></a>CMD 参数</h2><ol>
<li><p>cmd 执行</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">dotnet DotNetCoreDemo.dll --urls &quot;http://*:8080&quot; -- Parame=&quot;Harris&quot; <br></code></pre></td></tr></table></figure>

<p>格式 – [参数名称] = [参数]</p>
</li>
<li><p>控制器注入</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs CSharp"><span class="hljs-keyword">using</span> Microsoft.Extensions.Configuration;<br></code></pre></td></tr></table></figure>

<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs CSharp"><span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> IConfiguration _iconfiguration;<br></code></pre></td></tr></table></figure>

<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs CSharp"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">HomeController</span>(<span class="hljs-params">ILogger&lt;HomeController&gt; logger, IConfiguration configuration</span>)</span><br>&#123;<br>    _logger = logger;<br>    _logger.LogWarning(<span class="hljs-string">&quot;HomeController 被构造..&quot;</span>);<br><br>    _iconfiguration = configuration; <span class="hljs-comment">//注入</span><br>&#125;<br></code></pre></td></tr></table></figure>

<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs CSharp"><span class="hljs-built_in">string</span> Parame = _iconfiguration[<span class="hljs-string">&quot;Parame&quot;</span>];<span class="hljs-comment">//参数名称</span><br><br><span class="hljs-keyword">base</span>.ViewBag.User1 = <span class="hljs-string">&quot;张三&quot;</span> + <span class="hljs-string">&quot; -- 参数：&quot;</span> + Parame; <span class="hljs-comment">//使用</span><br></code></pre></td></tr></table></figure>

<p><img src="https://blogimage-1255495010.cos.ap-beijing.myqcloud.com/image-20210819222204161.png" srcset="/img/loading.gif" lazyload alt="image-20210819222204161"></p>
</li>
</ol>
<h2 id="控制器读取配置"><a href="#控制器读取配置" class="headerlink" title="控制器读取配置"></a>控制器读取配置</h2><h3 id="方式1"><a href="#方式1" class="headerlink" title="方式1"></a>方式1</h3><p><img src="https://blogimage-1255495010.cos.ap-beijing.myqcloud.com/image-20210819224059065.png" srcset="/img/loading.gif" lazyload alt="image-20210819224059065"></p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs json"><span class="hljs-attr">&quot;TESTID&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;1111&quot;</span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">&quot;TESTNAME&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;HARRIS&quot;</span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">&quot;TESTAdress&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>    <span class="hljs-attr">&quot;sheng&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;SHANXI&quot;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;shi&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;XINZHOU&quot;</span><br>  <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">&quot;Family&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><br>    <span class="hljs-string">&quot;baba&quot;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-string">&quot;mama&quot;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-string">&quot;son&quot;</span><br>  <span class="hljs-punctuation">]</span><br></code></pre></td></tr></table></figure>

<p>同样需要注入:</p>
<p><img src="https://blogimage-1255495010.cos.ap-beijing.myqcloud.com/image-20210819224219428.png" srcset="/img/loading.gif" lazyload alt="image-20210819224219428"></p>
<p>应用：</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs CSharp"><br>ViewBag.Setting1 = _iconfiguration[<span class="hljs-string">&quot;TESTID&quot;</span>];<br><br>ViewBag.Setting2 = _iconfiguration[<span class="hljs-string">&quot;TESTNAME&quot;</span>];<br><br>ViewBag.Setting3 = _iconfiguration[<span class="hljs-string">&quot;TESTAdress:sheng&quot;</span>];<br><br>ViewBag.Setting4 = _iconfiguration[<span class="hljs-string">&quot;Family:1&quot;</span>];<br></code></pre></td></tr></table></figure>

<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs html"><span class="hljs-tag">&lt;<span class="hljs-name">ul</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">li</span>&gt;</span>@ViewBag.Setting1<span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">li</span>&gt;</span>@ViewBag.Setting2<span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">li</span>&gt;</span>@ViewBag.Setting3<span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">li</span>&gt;</span>@ViewBag.Setting4<span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">ul</span>&gt;</span><br></code></pre></td></tr></table></figure>

<p><img src="https://blogimage-1255495010.cos.ap-beijing.myqcloud.com/image-20210819224316517.png" srcset="/img/loading.gif" lazyload alt="image-20210819224316517"></p>
<h3 id="方式2"><a href="#方式2" class="headerlink" title="方式2"></a>方式2</h3><p>先修改一下appsetting.json</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs json"><span class="hljs-attr">&quot;TEST&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>    <span class="hljs-attr">&quot;TESTID&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;1111&quot;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;TESTNAME&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;HARRIS&quot;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;TESTAdress&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>      <span class="hljs-attr">&quot;sheng&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;SHANXI&quot;</span><span class="hljs-punctuation">,</span><br>      <span class="hljs-attr">&quot;shi&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;XINZHOU&quot;</span><br>    <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;Family&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><br>      <span class="hljs-string">&quot;baba&quot;</span><span class="hljs-punctuation">,</span><br>      <span class="hljs-string">&quot;mama&quot;</span><span class="hljs-punctuation">,</span><br>      <span class="hljs-string">&quot;son&quot;</span><br>    <span class="hljs-punctuation">]</span><br>  <span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure>

<p>实例化一个实体</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs CSharp"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">TESTMODEL</span><br>&#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-built_in">string</span> TESTID &#123; <span class="hljs-keyword">get</span>; <span class="hljs-keyword">set</span>; &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-built_in">string</span> TESTNAME &#123; <span class="hljs-keyword">get</span>; <span class="hljs-keyword">set</span>; &#125;<br><br>    <span class="hljs-keyword">public</span> TESTAdress TESTAdress &#123; <span class="hljs-keyword">get</span>; <span class="hljs-keyword">set</span>; &#125;<br><br>    <span class="hljs-keyword">public</span> List&lt;<span class="hljs-built_in">string</span>&gt; Family &#123; <span class="hljs-keyword">get</span>; <span class="hljs-keyword">set</span>; &#125;<br>&#125;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">TESTAdress</span><br>&#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-built_in">string</span> sheng &#123; <span class="hljs-keyword">get</span>; <span class="hljs-keyword">set</span>; &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-built_in">string</span> shi &#123; <span class="hljs-keyword">get</span>; <span class="hljs-keyword">set</span>; &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>让实体与需要的json节点相互对应。</p>
<p>然后 Startup.cs</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs CSharp"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">ConfigureServices</span>(<span class="hljs-params">IServiceCollection services</span>)</span><br>&#123;<br>    services.AddControllersWithViews();<br><br>    services.AddSession();<br><br>    <span class="hljs-comment">//取配置文件中的TEST节点，映射到 TESTMODEL 实体</span><br>    services.Configure&lt;TESTMODEL&gt;(Configuration.GetSection(<span class="hljs-string">&quot;TEST&quot;</span>));<br>&#125;<br></code></pre></td></tr></table></figure>

<p>接着控制器注入</p>
<p><img src="https://blogimage-1255495010.cos.ap-beijing.myqcloud.com/image-20210819230720154.png" srcset="/img/loading.gif" lazyload alt="image-20210819230720154"></p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs CSharp"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">HomeController</span>(<span class="hljs-params">ILogger&lt;HomeController&gt; logger, IConfiguration configuration,IOptions&lt;TESTMODEL&gt; options</span>)</span><br>&#123;<br>    _logger = logger;<br>    _logger.LogWarning(<span class="hljs-string">&quot;HomeController 被构造..&quot;</span>);<br><br>    _iconfiguration = configuration;<br><br>    _tESTMODEL = options.Value;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>应用：</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs CSharp"><span class="hljs-built_in">object</span> parame = Newtonsoft.Json.JsonConvert.SerializeObject(_tESTMODEL);<br><span class="hljs-comment">//然后返回给视图</span><br><span class="hljs-keyword">return</span> View(parame);<br></code></pre></td></tr></table></figure>

<p><img src="https://blogimage-1255495010.cos.ap-beijing.myqcloud.com/image-20210819230859533.png" srcset="/img/loading.gif" lazyload alt="image-20210819230859533"></p>
<h2 id="Razor-混编"><a href="#Razor-混编" class="headerlink" title="Razor 混编"></a>Razor 混编</h2><h3 id="index-cshtml"><a href="#index-cshtml" class="headerlink" title="index.cshtml"></a>index.cshtml</h3><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><code class="hljs html">@using DotNetCoreDemo.Interface;<br>@using Microsoft.AspNetCore.Authorization;<br>@&#123;<br>    ViewData[&quot;Title&quot;] = &quot;Index&quot;;<br>&#125;<br><br><span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>This is Second Index<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span><br><br>@*测试 runtimecompilation*@<br><br><span class="hljs-tag">&lt;<span class="hljs-name">h2</span>&gt;</span>Test Razor runtimecompilation!<span class="hljs-tag">&lt;/<span class="hljs-name">h2</span>&gt;</span><br><br>@*实现接口*@<br><br>@implements ICoustomInterface<br><br>@functions&#123;<br>    //实现接口<br>    public string Show()<br>    &#123;<br>        return &quot;Hello World&quot;;<br>    &#125;<br>&#125;<br><br><span class="hljs-tag">&lt;<span class="hljs-name">h2</span>&gt;</span>实现接口：@Show()<span class="hljs-tag">&lt;/<span class="hljs-name">h2</span>&gt;</span><br><br>@*服务注入*@<br><br>@inject ICoustomInterface coustomservice<br>@&#123;<br><br>    <span class="hljs-tag">&lt;<span class="hljs-name">h2</span>&gt;</span>前台服务注入：@coustomservice.Show()<span class="hljs-tag">&lt;/<span class="hljs-name">h2</span>&gt;</span><br>&#125;<br><br><span class="hljs-tag">&lt;<span class="hljs-name">h2</span>&gt;</span>后台注册服务：@base.ViewBag.ServiceText<span class="hljs-tag">&lt;/<span class="hljs-name">h2</span>&gt;</span><br><br>@*标记特性*@<br>@*给当前类新增特性，cshtml 可以把它当成一个类*@<br>@attribute [Authorize];<br><br>@functions&#123;<br>    public string GetStr()<br>    &#123;<br>        return &quot;Hello world&quot;;<br>    &#125;<br>&#125;<br><br><span class="hljs-tag">&lt;<span class="hljs-name">h2</span>&gt;</span>调用方法 : @GetStr()<span class="hljs-tag">&lt;/<span class="hljs-name">h2</span>&gt;</span><br><br>@*单行*@<br><br>@&#123; <span class="hljs-tag">&lt;<span class="hljs-name">h3</span> <span class="hljs-attr">style</span>=<span class="hljs-string">&quot;color:darkcyan&quot;</span>&gt;</span>单行输出：@GetStr()<span class="hljs-tag">&lt;/<span class="hljs-name">h3</span>&gt;</span>&#125;<br><br>@*多行*@<br>@*<span class="hljs-tag">&lt;<span class="hljs-name">text</span>&gt;</span>@i<span class="hljs-tag">&lt;/<span class="hljs-name">text</span>&gt;</span> 标识为字符串显示文本 不能像后台代码那样用加号连接*@<br><br>@&#123;<br>    for (int i = 0; i &lt; 3; i++)<br>    &#123;<br>        <span class="hljs-tag">&lt;<span class="hljs-name">h3</span> <span class="hljs-attr">style</span>=<span class="hljs-string">&quot;color:yellowgreen&quot;</span>&gt;</span>多行输出：@GetStr()<span class="hljs-tag">&lt;<span class="hljs-name">text</span>&gt;</span>@i<span class="hljs-tag">&lt;/<span class="hljs-name">text</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">h3</span>&gt;</span><br>    &#125;<br>&#125;<br><br>@*输出html标签*@<br><br><span class="hljs-tag">&lt;<span class="hljs-name">h3</span>&gt;</span>输出HTML标签：@(&quot;<span class="hljs-tag">&lt;<span class="hljs-name">strong</span>&gt;</span>输出HTML标签：Hello world <span class="hljs-tag">&lt;/<span class="hljs-name">strong</span>&gt;</span>&quot;)<span class="hljs-tag">&lt;/<span class="hljs-name">h3</span>&gt;</span><br><br>@*模板化方法*@<br><br>@&#123; <br>    void ReturnName(string name)<br>    &#123;<br>        <span class="hljs-tag">&lt;<span class="hljs-name">h3</span> <span class="hljs-attr">style</span>=<span class="hljs-string">&quot;color:brown&quot;</span>&gt;</span>模板化输出：@name<span class="hljs-tag">&lt;/<span class="hljs-name">h3</span>&gt;</span><br>    &#125;<br><br>    ReturnName(&quot;Harris&quot;);<br>&#125;<br></code></pre></td></tr></table></figure>

<h3 id="Startup"><a href="#Startup" class="headerlink" title="Startup"></a>Startup</h3><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><code class="hljs CSharp"><span class="hljs-keyword">using</span> Microsoft.AspNetCore.Builder;<br><span class="hljs-keyword">using</span> Microsoft.AspNetCore.Hosting;<br><span class="hljs-keyword">using</span> Microsoft.Extensions.Configuration;<br><span class="hljs-keyword">using</span> Microsoft.Extensions.DependencyInjection;<br><span class="hljs-keyword">using</span> Microsoft.Extensions.Hosting;<br><span class="hljs-keyword">using</span> Microsoft.Extensions.Logging;<br><span class="hljs-keyword">using</span> System;<br><span class="hljs-keyword">using</span> System.Collections.Generic;<br><span class="hljs-keyword">using</span> System.Linq;<br><span class="hljs-keyword">using</span> System.Threading.Tasks;<br><span class="hljs-keyword">using</span> Microsoft.Extensions.FileProviders;<br><span class="hljs-keyword">using</span> System.IO;<br><span class="hljs-keyword">using</span> DotNetCoreDemo.Models;<br><span class="hljs-keyword">using</span> DotNetCoreDemo.Interface;<br><span class="hljs-keyword">using</span> DotNetCoreDemo.Service;<br><br><span class="hljs-keyword">namespace</span> <span class="hljs-title">DotNetCoreDemo</span><br>&#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">Startup</span><br>    &#123;<br>        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">Startup</span>(<span class="hljs-params">IConfiguration configuration</span>)</span><br>        &#123;<br>            Configuration = configuration;<br>        &#125;<br><br>        <span class="hljs-keyword">public</span> IConfiguration Configuration &#123; <span class="hljs-keyword">get</span>; &#125;<br><br>        <span class="hljs-comment">// This method gets called by the runtime. Use this method to add services to the container.</span><br>        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">ConfigureServices</span>(<span class="hljs-params">IServiceCollection services</span>)</span><br>        &#123;<br>            services.AddControllersWithViews();<br><br>            services.AddSession();<br>			<br>            <span class="hljs-comment">//加入中间件，方便实时调试HTML</span><br>            services.AddRazorPages().AddRazorRuntimeCompilation();<br><br>            <span class="hljs-comment">//注入服务</span><br>            services.AddTransient&lt;ICoustomInterface, CoustomService&gt;();<br><br>            <span class="hljs-comment">//取配置文件中的TEST节点，映射到 TESTMODEL 实体</span><br>            services.Configure&lt;TESTMODEL&gt;(Configuration.GetSection(<span class="hljs-string">&quot;TEST&quot;</span>));<br>        &#125;<br><br>        <span class="hljs-comment">// This method gets called by the runtime. Use this method to configure the HTTP request pipeline.</span><br>        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Configure</span>(<span class="hljs-params">IApplicationBuilder app, IWebHostEnvironment env, ILoggerFactory loggerFactory</span>)</span><br>        &#123;<br>            <span class="hljs-keyword">if</span> (env.IsDevelopment())<br>            &#123;<br>                app.UseDeveloperExceptionPage();<br>            &#125;<br>            <span class="hljs-keyword">else</span><br>            &#123;<br>                app.UseExceptionHandler(<span class="hljs-string">&quot;/Home/Error&quot;</span>);<br>            &#125;<br><br>            <span class="hljs-comment">//可以参考Program 中的配置，二选一</span><br>            loggerFactory.AddLog4Net(<span class="hljs-string">&quot;CfgFile/Log4Net.Config&quot;</span>);<br><br>            <span class="hljs-comment">//app.UseStaticFiles();</span><br><br>            <span class="hljs-comment">//获取相对路径</span><br>            <span class="hljs-built_in">string</span> path = Path.Combine(Directory.GetCurrentDirectory(), <span class="hljs-string">&quot;wwwroot&quot;</span>);<br><br>            app.UseStaticFiles(<span class="hljs-keyword">new</span> StaticFileOptions()<br>            &#123;<br>                <span class="hljs-comment">//从物理路径指向wwwroot</span><br>                FileProvider = <span class="hljs-keyword">new</span> PhysicalFileProvider(path)<br>            &#125;);<br><br>            app.UseSession();<br><br>            app.UseRouting();<br><br>            app.UseAuthorization();<br><br>            app.UseEndpoints(endpoints =&gt;<br>            &#123;<br>                endpoints.MapControllerRoute(<br>                    name: <span class="hljs-string">&quot;default&quot;</span>,<br>                    pattern: <span class="hljs-string">&quot;&#123;controller=Home&#125;/&#123;action=Index&#125;/&#123;id?&#125;&quot;</span>);<br>            &#125;);<br>        &#125;<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure>

<h3 id="Interface-层"><a href="#Interface-层" class="headerlink" title="Interface 层"></a>Interface 层</h3><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs CSharp"><span class="hljs-keyword">namespace</span> <span class="hljs-title">DotNetCoreDemo.Interface</span><br>&#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title">ICoustomInterface</span><br>    &#123;<br>        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-built_in">string</span> <span class="hljs-title">Show</span>()</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h3 id="Service-层"><a href="#Service-层" class="headerlink" title="Service 层"></a>Service 层</h3><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs CSharp"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">CoustomService</span> : <span class="hljs-title">Interface.ICoustomInterface</span><br>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-built_in">string</span> <span class="hljs-title">Show</span>()</span><br>    &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;Hello world&quot;</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h3 id="Nuget-包"><a href="#Nuget-包" class="headerlink" title="Nuget 包"></a>Nuget 包</h3><p><code>Microsoft.AspNetCore.Mvc.Razor.RuntimeCompilation</code></p>
<h2 id="Razor-布局"><a href="#Razor-布局" class="headerlink" title="Razor 布局"></a>Razor 布局</h2><h3 id="开始"><a href="#开始" class="headerlink" title="开始"></a>开始</h3><ul>
<li>在<code>_ViewStart.cshtml</code> 中设置母版页；</li>
</ul>
<p><img src="https://blogimage-1255495010.cos.ap-beijing.myqcloud.com/image-20210822120532857.png" srcset="/img/loading.gif" lazyload alt="image-20210822120532857"></p>
<ul>
<li><p>如果不想要模板页，想单页面展示也可以，可以在<code>_ViewStart.cshtml</code>中 注释 layout = “_Layout”; 或者 修改 layout = null;</p>
<p><img src="https://blogimage-1255495010.cos.ap-beijing.myqcloud.com/image-20210822122832247.png" srcset="/img/loading.gif" lazyload alt="image-20210822122832247"></p>
</li>
</ul>
<h3 id="母版页"><a href="#母版页" class="headerlink" title="母版页"></a>母版页</h3><p><img src="https://blogimage-1255495010.cos.ap-beijing.myqcloud.com/image-20210822120844118.png" srcset="/img/loading.gif" lazyload alt="image-20210822120844118"></p>
<ol>
<li><p>可以设置一些测试的菜单。</p>
</li>
<li><p><code>@RenderBody()</code> 相当于一个占位符，菜单中路由的界面都会在这里进行替换。</p>
</li>
<li><p><code>@await RenderSectionAsync(&quot;Scripts&quot;,required:false)</code> 应用场景：</p>
<p>当子页面不手动引用 <code>Scripts</code>类库的时候，可以和上述这行代码配套使用。</p>
<p><img src="https://blogimage-1255495010.cos.ap-beijing.myqcloud.com/image-20210822121926617.png" srcset="/img/loading.gif" lazyload alt="image-20210822121926617"></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs javascript"><span class="hljs-comment">//这个是不行的，除非手动引入js文件</span><br>&lt;script type=<span class="hljs-string">&quot;text/javascript&quot;</span>&gt;<br>    $(<span class="hljs-variable language_">document</span>).<span class="hljs-title function_">ready</span>(<span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) &#123;<br><br>        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;Hello Harris&quot;</span>);<br><br>        <span class="hljs-title function_">alert</span>(<span class="hljs-string">&quot;Hello Harris&quot;</span>);<br>    &#125;);<br>&lt;/script&gt;<br><br><span class="hljs-comment">//这个可以，他使用的是模板页中的js文件，相当于把下述js脚本拿到模板页中，然后执行</span><br>@section <span class="hljs-title class_">Scripts</span>&#123; <br><br>    <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;text/javascript&quot;</span>&gt;</span><span class="language-javascript"></span></span><br><span class="language-javascript"><span class="language-xml">        $(<span class="hljs-variable language_">document</span>).<span class="hljs-title function_">ready</span>(<span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) &#123;</span></span><br><span class="language-javascript"><span class="language-xml"></span></span><br><span class="language-javascript"><span class="language-xml">            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;Hello Harris&quot;</span>);</span></span><br><span class="language-javascript"><span class="language-xml"></span></span><br><span class="language-javascript"><span class="language-xml">            <span class="hljs-title function_">alert</span>(<span class="hljs-string">&quot;Hello Harris&quot;</span>);</span></span><br><span class="language-javascript"><span class="language-xml">        &#125;);</span></span><br><span class="language-javascript"><span class="language-xml">    </span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span></span><br>&#125;<br></code></pre></td></tr></table></figure>

<p><img src="https://blogimage-1255495010.cos.ap-beijing.myqcloud.com/image-20210822122520500.png" srcset="/img/loading.gif" lazyload alt="image-20210822122520500"></p>
</li>
<li><p><strong>结合上一点说的，如果不使用母版页，如果注释掉或者等于null的话，使用母版页js库的代码就废了。</strong></p>
</li>
</ol>
<h2 id="Razor-扩展"><a href="#Razor-扩展" class="headerlink" title="Razor 扩展"></a>Razor 扩展</h2><h3 id="扩展控件（1）"><a href="#扩展控件（1）" class="headerlink" title="扩展控件（1）"></a>扩展控件（1）</h3><ol>
<li><p>@html.ActionLink 问题。</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs html"><br>@&#123;<br>    ViewData[&quot;Title&quot;] = &quot;RazorControl Page&quot;;<br>&#125;<br><br><br>ActionLink:@Html.ActionLink(&quot;当前控制器Index&quot;, &quot;index&quot;)<br><br>ActionLink:@Html.ActionLink(&quot;Home控制器Index&quot;, &quot;index&quot;, &quot;Home&quot;);<br><br>@&#123;<br>    TESTAdress testaddress_ = new TESTAdress();<br><br>    testaddress_.Sheng = &quot;a&quot;;<br><br>    testaddress_.Shi = &quot;b&quot;;<br><br>    TESTMODEL tESTMODEL = new TESTMODEL<br>    &#123;<br>        TESTID = &quot;1&quot;,<br>        TESTNAME = &quot;Harris&quot;,<br>        _TESTAdress = testaddress_,<br>        Family = new List<span class="hljs-tag">&lt;<span class="hljs-name">string</span>&gt;</span> &#123; &quot;1&quot;, &quot;2&quot;, &quot;3&quot; &#125;,<br>        names = new Name &#123; Xing = &quot;a&quot;,Ming = &quot;b&quot;&#125;<br>    &#125;;<br><br>&#125;<br><br>ActionLink:@Html.ActionLink(&quot;带路由信息&quot;, &quot;index&quot;, &quot;Home&quot;, tESTMODEL);<br></code></pre></td></tr></table></figure>

<p>上述方法中有个错误的地方：就是最后一行，传的实体相对复杂，导致浏览器解析不了</p>
<p><img src="https://blogimage-1255495010.cos.ap-beijing.myqcloud.com/image-20210822195432996.png" srcset="/img/loading.gif" lazyload alt="image-20210822195432996"></p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs html"><span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">href</span>=<span class="hljs-string">&quot;/?TESTID=1<span class="hljs-symbol">&amp;amp;</span>TESTNAME=Harris<span class="hljs-symbol">&amp;amp;</span>_TESTAdress=DotNetCoreDemo.Models.TESTAdress<span class="hljs-symbol">&amp;amp;</span>Family=1<span class="hljs-symbol">&amp;amp;</span>Family=2<span class="hljs-symbol">&amp;amp;</span>Family=3<span class="hljs-symbol">&amp;amp;</span>names=DotNetCoreDemo.Models.Name&quot;</span>&gt;</span>带路由信息<span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span><br></code></pre></td></tr></table></figure>

<p>再结合下图：</p>
<p><img src="https://blogimage-1255495010.cos.ap-beijing.myqcloud.com/image-20210822195931807.png" srcset="/img/loading.gif" lazyload alt="image-20210822195931807"></p>
<p><img src="https://blogimage-1255495010.cos.ap-beijing.myqcloud.com/image-20210822195634650.png" srcset="/img/loading.gif" lazyload alt="image-20210822195634650"></p>
<p><code>routeValues</code> 这个才是为了给浏览器解析作为页面参数传递的，所以这里不支持复杂实体应该是这个原因。</p>
</li>
<li><p>新建一个静态方法 </p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs CSharp"><span class="hljs-keyword">using</span> Microsoft.AspNetCore.Html;<br><span class="hljs-keyword">using</span> Microsoft.AspNetCore.Mvc.Rendering;<br><span class="hljs-keyword">using</span> System;<br><span class="hljs-keyword">using</span> System.Collections.Generic;<br><span class="hljs-keyword">using</span> System.Linq;<br><span class="hljs-keyword">using</span> System.Threading.Tasks;<br><br><span class="hljs-keyword">namespace</span> <span class="hljs-title">DotNetCoreDemo.Utility</span><br>&#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title">HtmlHelperLinkExtensions</span><br>    &#123;<br>        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> IHtmlContent <span class="hljs-title">ActionImage</span>(<span class="hljs-params"><span class="hljs-keyword">this</span> IHtmlHelper helper,<span class="hljs-built_in">string</span> src</span>)</span><br>        &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> HtmlString(<span class="hljs-string">$&quot;&lt;IMG src=&#x27;<span class="hljs-subst">&#123;src&#125;</span>&#x27; alt=&#x27;扩展控件IMAGE&#x27; style=&#x27;width:100px;height:20px&#x27;/&gt;&quot;</span>);<br>        &#125;<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure>

<p>视图</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs html">@*扩展控件*@<br>@Html.ActionImage(&quot;http://mmmp3.com/skin/default/images/logo.png&quot;)<br></code></pre></td></tr></table></figure>

<p><img src="https://blogimage-1255495010.cos.ap-beijing.myqcloud.com/image-20210822202647528.png" srcset="/img/loading.gif" lazyload alt="image-20210822202647528"></p>
</li>
</ol>
<h3 id="扩展控件（2）"><a href="#扩展控件（2）" class="headerlink" title="扩展控件（2）"></a>扩展控件（2）</h3><p>此扩展方法旨在扩展html体系中不存在得html 标签。</p>
<ol>
<li><p>新建一个类 CustomTagHelper</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs CSharp"><span class="hljs-keyword">using</span> Microsoft.AspNetCore.Razor.TagHelpers;<br><span class="hljs-keyword">using</span> System;<br><span class="hljs-keyword">using</span> System.Collections.Generic;<br><span class="hljs-keyword">using</span> System.Linq;<br><span class="hljs-keyword">using</span> System.Threading.Tasks;<br><br><span class="hljs-keyword">namespace</span> <span class="hljs-title">DotNetCoreDemo.Utility</span><br>&#123;<br>    [<span class="hljs-meta">HtmlTargetElement(<span class="hljs-string">&quot;Harris&quot;</span>)</span>]<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">CustomTagHelper</span> : <span class="hljs-title">TagHelper</span>   <span class="hljs-comment">//,ITagHelper</span><br>    &#123;<br>        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">override</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Process</span>(<span class="hljs-params">TagHelperContext context, TagHelperOutput output</span>)</span><br>        &#123;<br>            output.TagName = <span class="hljs-string">&quot;div&quot;</span>;<br>            output.Attributes.Add(<span class="hljs-string">&quot;xing&quot;</span>, <span class="hljs-string">&quot;No.1&quot;</span>);<br>            output.Attributes.Add(<span class="hljs-string">&quot;ming&quot;</span>, <span class="hljs-string">&quot;No.2&quot;</span>);<br>            output.PreContent.SetContent(<span class="hljs-string">&quot;Hello ,My name is Harris&quot;</span>);<br>            output.Attributes.Add(<span class="hljs-string">&quot;style&quot;</span>, <span class="hljs-string">&quot;color:red&quot;</span>);<br><br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<ul>
<li>标记 <code>HtmlTargeElement()</code> 特性</li>
<li>继承 <code>Taghelper</code> 或者实现 <code>ITaghelper</code> 接口</li>
<li>重写 <code>Process</code> 方法</li>
<li>定义标签</li>
<li>指定属性、内容</li>
</ul>
</li>
<li><p>声明 在 <code>_ViewImports.cshtml</code></p>
<figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs less"><span class="hljs-variable">@using</span> DotNetCoreDemo<br><span class="hljs-variable">@using</span> DotNetCoreDemo.Models<br><span class="hljs-variable">@addTagHelper</span> *, Microsoft.AspNetCore.Mvc.TagHelpers<br><span class="hljs-variable">@addTagHelper</span> *,DotNetCoreDemo <span class="hljs-comment">//* 代表当前命名空间下都可使用</span><br></code></pre></td></tr></table></figure></li>
<li><p>应用</p>
<p><img src="https://blogimage-1255495010.cos.ap-beijing.myqcloud.com/image-20210822210047680.png" srcset="/img/loading.gif" lazyload alt="image-20210822210047680"></p>
<p><img src="https://blogimage-1255495010.cos.ap-beijing.myqcloud.com/image-20210822210156272.png" srcset="/img/loading.gif" lazyload alt="image-20210822210156272"></p>
<ol start="4">
<li><p>传参</p>
<p>设置好对象</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><code class="hljs CSharp"><span class="hljs-keyword">using</span> Microsoft.AspNetCore.Razor.TagHelpers;<br><span class="hljs-keyword">using</span> System;<br><span class="hljs-keyword">using</span> System.Collections.Generic;<br><span class="hljs-keyword">using</span> System.Linq;<br><span class="hljs-keyword">using</span> System.Threading.Tasks;<br><br><span class="hljs-keyword">namespace</span> <span class="hljs-title">DotNetCoreDemo.Utility</span><br>&#123;<br>    [<span class="hljs-meta">HtmlTargetElement(<span class="hljs-string">&quot;Harris&quot;</span>)</span>]<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">CustomTagHelper</span> : <span class="hljs-title">TagHelper</span>   <span class="hljs-comment">//,ITagHelper</span><br>    &#123;<br>        <span class="hljs-keyword">public</span> <span class="hljs-built_in">string</span> Id &#123; <span class="hljs-keyword">get</span>; <span class="hljs-keyword">set</span>; &#125;<br><br>        <span class="hljs-keyword">public</span> <span class="hljs-built_in">string</span> Name &#123; <span class="hljs-keyword">get</span>; <span class="hljs-keyword">set</span>; &#125;<br><br>        <span class="hljs-keyword">public</span> <span class="hljs-built_in">string</span> Age &#123; <span class="hljs-keyword">get</span>; <span class="hljs-keyword">set</span>; &#125;<br><br>        <span class="hljs-keyword">public</span> <span class="hljs-built_in">string</span> Shengshi &#123; <span class="hljs-keyword">get</span>; <span class="hljs-keyword">set</span>; &#125;<br><br>        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">CustomTagHelper</span>()</span><br>        &#123;<br><br>        &#125;<br><br>        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">override</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Process</span>(<span class="hljs-params">TagHelperContext context, TagHelperOutput output</span>)</span><br>        &#123;<br>            <span class="hljs-comment">//接收参数</span><br>            <span class="hljs-built_in">string</span> _id = <span class="hljs-keyword">this</span>.Id;<br><br>            <span class="hljs-built_in">string</span> _name = <span class="hljs-keyword">this</span>.Name;<br><br>            <span class="hljs-built_in">string</span> _age = <span class="hljs-keyword">this</span>.Age;<br><br>            <span class="hljs-built_in">string</span> _shengshi = <span class="hljs-keyword">this</span>.Shengshi;<br><br>            output.TagName = <span class="hljs-string">&quot;div&quot;</span>;<br>            output.Attributes.Add(<span class="hljs-string">&quot;xing&quot;</span>, <span class="hljs-string">&quot;No.1&quot;</span>);<br>            output.Attributes.Add(<span class="hljs-string">&quot;ming&quot;</span>, <span class="hljs-string">&quot;No.2&quot;</span>);<br><br>            <span class="hljs-comment">//output.PreContent.SetContent(&quot;Hello ,My name is Harris&quot;);</span><br>            <span class="hljs-comment">//使用参数</span><br>            output.PreContent.SetHtmlContent(<span class="hljs-string">&quot;&lt;h2&gt;Hello ,My name is Harris&lt;/h2&gt;&lt;ul&gt;&lt;li&gt;ID:&quot;</span> + _id + <span class="hljs-string">&quot;&lt;/li&gt;&lt;li&gt;NAME:&quot;</span> + _name + <span class="hljs-string">&quot;&lt;/li&gt;&lt;li&gt;Age:&quot;</span> + _age + <span class="hljs-string">&quot;&lt;/li&gt;&lt;li&gt;Shengshi:&quot;</span> + _shengshi + <span class="hljs-string">&quot;&lt;/li&gt;&lt;/ul&gt;&quot;</span>);<br><br>            output.Attributes.Add(<span class="hljs-string">&quot;style&quot;</span>, <span class="hljs-string">&quot;color:red&quot;</span>);<br><br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>标签属性传值</p>
<p><img src="https://blogimage-1255495010.cos.ap-beijing.myqcloud.com/image-20210822212634256.png" srcset="/img/loading.gif" lazyload alt="image-20210822212634256"></p>
<p>效果</p>
<p><img src="https://blogimage-1255495010.cos.ap-beijing.myqcloud.com/image-20210822212831324.png" srcset="/img/loading.gif" lazyload alt="image-20210822212831324"></p>
</li>
</ol>
</li>
</ol>
<h3 id="局部视图"><a href="#局部视图" class="headerlink" title="局部视图"></a>局部视图</h3><ol>
<li><p>添加局部视图，其实就是在对应的view层添加一个cshtml文件</p>
<p><img src="https://blogimage-1255495010.cos.ap-beijing.myqcloud.com/image-20210823212950311.png" srcset="/img/loading.gif" lazyload alt="image-20210823212950311"></p>
</li>
<li><p>编辑 PartialView.cshtml ,相当于定义好局部视图，就长这个样子，Harris标签应用与上一节扩展控件内容。</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs html">@model string<br><br><span class="hljs-tag">&lt;<span class="hljs-name">Harris</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;@Model&quot;</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;@Model&quot;</span> <span class="hljs-attr">age</span>=<span class="hljs-string">&quot;@Model&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">Harris</span>&gt;</span><br><br><span class="hljs-tag">&lt;<span class="hljs-name">Harris</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;@Model&quot;</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;@Model&quot;</span> <span class="hljs-attr">age</span>=<span class="hljs-string">&quot;@Model&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">Harris</span>&gt;</span><br><br><span class="hljs-tag">&lt;<span class="hljs-name">Harris</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;@Model&quot;</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;@Model&quot;</span> <span class="hljs-attr">age</span>=<span class="hljs-string">&quot;@Model&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">Harris</span>&gt;</span><br></code></pre></td></tr></table></figure></li>
<li><p>应用 <code>@Html.Partial</code></p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs html">@*局部视图*@<br>@Html.Partial(&quot;PartialView&quot;, &quot;123&quot;)// 123 是参数，也就是说，在调用局部视图得时候，其实可以间接设置其内容<br></code></pre></td></tr></table></figure></li>
<li><p>呈现</p>
<p><img src="https://blogimage-1255495010.cos.ap-beijing.myqcloud.com/image-20210823213304825.png" srcset="/img/loading.gif" lazyload alt="image-20210823213304825"></p>
</li>
</ol>
<h3 id="视图组件"><a href="#视图组件" class="headerlink" title="视图组件"></a>视图组件</h3><ol>
<li><p>新建视图组件扩展类</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><code class="hljs CSharp"><span class="hljs-keyword">using</span> Microsoft.AspNetCore.Mvc;<br><span class="hljs-keyword">using</span> System;<br><span class="hljs-keyword">using</span> System.Collections.Generic;<br><span class="hljs-keyword">using</span> System.Linq;<br><span class="hljs-keyword">using</span> System.Threading.Tasks;<br><br><span class="hljs-keyword">namespace</span> <span class="hljs-title">DotNetCoreDemo.Utility</span><br>&#123;<br>    [<span class="hljs-meta">ViewComponent(Name = <span class="hljs-string">&quot;CustomList&quot;</span>)</span>]<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">ListViewComponent</span> : <span class="hljs-title">ViewComponent</span><br>    &#123;<br>        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">async</span> Task&lt;IViewComponentResult&gt; <span class="hljs-title">InvokeAsync</span>(<span class="hljs-params"><span class="hljs-built_in">string</span> SeachVal</span>)</span><br>        &#123;<br>            <span class="hljs-keyword">var</span> list = <span class="hljs-keyword">await</span> GetStudents(SeachVal);<br><br>            ViewBag.User = <span class="hljs-string">&quot;Harris&quot;</span>;<span class="hljs-comment">//可以用这个，等等...</span><br><br>            <span class="hljs-comment">//return View(list);// 默认找得是~/Views/Shared/CustomList/Default.cshtml</span><br><br>            <span class="hljs-comment">//这里可以指定视图组件的路径</span><br>            <span class="hljs-keyword">return</span> View(<span class="hljs-string">&quot;~/Views/Shared/Components/Test/DefaultTest.cshtml&quot;</span>, list);<br>        &#125;<br><br>        <span class="hljs-keyword">public</span> Task&lt;List&lt;Student&gt;&gt; GetStudents(<span class="hljs-built_in">string</span> SeachVal)<br>        &#123;<br>            <span class="hljs-keyword">return</span> Task.Run(() =&gt;<br>            &#123;<br>                <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> List&lt;Student&gt;()<br>                &#123;<br>                    <span class="hljs-keyword">new</span> Student &#123; ID=<span class="hljs-number">1</span>,NAME = <span class="hljs-string">&quot;Harris&quot;</span>&#125;,<br>                    <span class="hljs-keyword">new</span> Student &#123; ID=<span class="hljs-number">2</span>,NAME = <span class="hljs-string">&quot;Make&quot;</span>&#125;,<br>                    <span class="hljs-keyword">new</span> Student &#123; ID=<span class="hljs-number">3</span>,NAME = <span class="hljs-string">&quot;Ped&quot;</span>&#125;,<br>                    <span class="hljs-keyword">new</span> Student &#123; ID=<span class="hljs-number">4</span>,NAME = <span class="hljs-string">&quot;Henry&quot;</span>&#125;<br>                &#125;;<br>            &#125;);<br>        &#125;<br><br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">Student</span><br>    &#123;<br>        <span class="hljs-keyword">public</span> <span class="hljs-built_in">int</span> ID &#123; <span class="hljs-keyword">get</span>; <span class="hljs-keyword">set</span>; &#125;<br><br>        <span class="hljs-keyword">public</span> <span class="hljs-built_in">string</span> NAME &#123; <span class="hljs-keyword">get</span>; <span class="hljs-keyword">set</span>; &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>主要是继承 <code>ViewComponent</code></p>
</li>
<li><p>新建视图组件视图</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs html">@using DotNetCoreDemo.Utility<br><br>@model List<span class="hljs-tag">&lt;<span class="hljs-name">Student</span>&gt;</span><br><br><span class="hljs-tag">&lt;<span class="hljs-name">ul</span>&gt;</span><br>    @foreach (var item in Model)<br>    &#123;<br>        <span class="hljs-tag">&lt;<span class="hljs-name">li</span>&gt;</span>@item.NAME<span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span><br>    &#125;<br><span class="hljs-tag">&lt;/<span class="hljs-name">ul</span>&gt;</span><br></code></pre></td></tr></table></figure></li>
<li><p>应用</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs html">@*视图组件*@<br><span class="hljs-tag">&lt;<span class="hljs-name">h2</span>&gt;</span>视图组件<span class="hljs-tag">&lt;/<span class="hljs-name">h2</span>&gt;</span><br><br><span class="hljs-tag">&lt;<span class="hljs-name">table</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">tr</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">td</span>&gt;</span>@await Component.InvokeAsync(&quot;CustomList&quot;, new &#123; SeachVal = &quot;123456&quot; &#125;)<span class="hljs-tag">&lt;/<span class="hljs-name">td</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">td</span>&gt;</span>@await Component.InvokeAsync(&quot;CustomList&quot;, new &#123; SeachVal = &quot;321321&quot; &#125;)<span class="hljs-tag">&lt;/<span class="hljs-name">td</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">td</span>&gt;</span>@await Component.InvokeAsync(&quot;CustomList&quot;, new &#123; SeachVal = &quot;321321&quot; &#125;)<span class="hljs-tag">&lt;/<span class="hljs-name">td</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">td</span>&gt;</span>@await Component.InvokeAsync(&quot;CustomList&quot;, new &#123; SeachVal = &quot;321321&quot; &#125;)<span class="hljs-tag">&lt;/<span class="hljs-name">td</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">td</span>&gt;</span>@await Component.InvokeAsync(&quot;CustomList&quot;, new &#123; SeachVal = &quot;321321&quot; &#125;)<span class="hljs-tag">&lt;/<span class="hljs-name">td</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">tr</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">table</span>&gt;</span><br></code></pre></td></tr></table></figure></li>
<li><p>项目列表</p>
<p><img src="https://blogimage-1255495010.cos.ap-beijing.myqcloud.com/image-20210824222129039.png" srcset="/img/loading.gif" lazyload alt="image-20210824222129039"></p>
<ol>
<li><p><code>Components/CustomList/Default.cshtml</code> 与 <code>Components/Test/DefaultTest.cshtml</code> 中间的区别就是上面第一点中所说的，在返回View()的时候，要不要传具体路径的区别。</p>
<p><img src="https://blogimage-1255495010.cos.ap-beijing.myqcloud.com/image-20210824222356654.png" srcset="/img/loading.gif" lazyload alt="image-20210824222356654"></p>
</li>
<li><p>还得关心一下这个类里的异步结构。</p>
</li>
</ol>
</li>
<li><p>结果</p>
<p><img src="https://blogimage-1255495010.cos.ap-beijing.myqcloud.com/image-20210824222521682.png" srcset="/img/loading.gif" lazyload alt="image-20210824222521682"></p>
<ol>
<li>这地方主要是用的DefaultTest.cshtml,Harris 就是从 ViewBag.User 传过来滴。</li>
</ol>
</li>
</ol>
<h2 id="IOC"><a href="#IOC" class="headerlink" title="IOC"></a>IOC</h2><h3 id="IOC出现的背景"><a href="#IOC出现的背景" class="headerlink" title="IOC出现的背景"></a>IOC出现的背景</h3><p>我们知道，软件开发领域有句著名的论断：不要重复发明轮子！因为软件开发讲求复用，所以，对于应用频繁的需求，总是有人设计各种通用框架和类库以减轻人们的开发负担。例如，数据持久化是非常频繁的需求，于是各种ORM框架应运而生；再如，对MVC的需求催生了Struts等一批用来实现MVC的框架。</p>
<p>随着面向对象分析与设计的发展和成熟，OOA&amp;D被越来越广泛应用于各种项目中，然而，我们知道，用OO就不可能不用多态性，用多态性就不可能不用依赖注入，所以，依赖注入变成了非常频繁的需求，而如果全部手工完成，不但负担太重，而且还容易出错。再加上反射机制的发明，于是，自然有人开始设计开发各种用于依赖注入的专用框架。这些专门用于实现依赖注入功能的组件或框架，就是IoC Container。从这点看，IoC Container的出现有其历史必然性。目前，最著名的IoC也许就是Java平台上的Spring框架的IoC组件，而.NET平台上也有Spring.NET和Unity等。 </p>
<h3 id="IOC是什么"><a href="#IOC是什么" class="headerlink" title="IOC是什么"></a>IOC是什么</h3><p>IOC（Inversion of Control），即<strong>“控制反转”</strong>，不是什么技术，而是一种设计思想。在Java开发中，IOC意味着将你设计好的对象交给容器控制，而不是传统的在你的对象内部直接控制。如何理解好Ioc呢？理解好Ioc的关键是要明确“谁控制谁，控制什么，为何是反转（有反转就应该有正转了），哪些方面反转了”，那我们来深入分析一下： </p>
<ul>
<li><strong>谁控制谁，控制什么：</strong>传统Java SE程序设计，我们直接在对象内部通过new进行创建对象，是程序主动去创建依赖对象；而IOC是有专门一个容器来创建这些对象，即由IOC容器来控制对象的创建；谁控制谁？当然是IOC容器控制了对象；控制什么？那就是主要控制了外部资源获取</li>
<li><strong>为何是反转，哪些方面反转了：</strong>有反转就有正转，传统应用程序是由我们自己在对象中主动控制去直接获取依赖对象，也就是正转；而反转则是由容器来帮忙创建及注入依赖对象；为何是反转？因为由容器帮我们查找及注入依赖对象，对象只是被动的接受依赖对象，所以是反转；哪些方面反转了？依赖对象的获取被反转了。</li>
</ul>
<p><img src="https://blogimage-1255495010.cos.ap-beijing.myqcloud.com/983950-20200828140652970-543560967.png" srcset="/img/loading.gif" lazyload alt="img"></p>
<p><img src="https://blogimage-1255495010.cos.ap-beijing.myqcloud.com/983950-20200828141239801-1102376797.png" srcset="/img/loading.gif" lazyload alt="img"></p>
<h3 id="IOC能做什么"><a href="#IOC能做什么" class="headerlink" title="IOC能做什么"></a>IOC能做什么</h3><p>IoC不是一种技术，只是一种思想，一个重要的面向对象编程的法则，它能指导我们如何设计出松耦合、更优良的程序。传统应用程序都是由我们在类内部主动创建依赖对象，从而导致类与类之间高耦合，难于测试；有了IoC容器后，把创建和查找依赖对象的控制权交给了容器，由容器进行注入组合对象，所以对象与对象之间是松散耦合，这样也方便测试，利于功能复用，更重要的是使得程序的整个体系结构变得非常灵活。</p>
<p>其实IoC对编程带来的最大改变不是从代码上，而是从思想上，发生了“主从换位”的变化。应用程序原本是老大，要获取什么资源都是主动出击，但是在IoC/DI思想中，应用程序就变成被动的了，被动的等待IoC容器来创建并注入它所需要的资源了。</p>
<p>IoC很好的体现了面向对象设计法则之一—— 好莱坞法则：“别找我们，我们找你”；即由IoC容器帮对象找相应的依赖对象并注入，而不是由对象主动去找。 </p>
<h3 id="IOC和DI"><a href="#IOC和DI" class="headerlink" title="IOC和DI"></a>IOC和DI</h3><p>DI—Dependency Injection，即“依赖注入”：是组件之间依赖关系由容器在运行期决定，形象的说，即由容器动态的将某个依赖关系注入到组件之中。依赖注入的目的并非为软件系统带来更多功能，而是为了提升组件重用的频率，并为系统搭建一个灵活、可扩展的平台。通过依赖注入机制，我们只需要通过简单的配置，而无需任何代码就可指定目标需要的资源，完成自身的业务逻辑，而不需要关心具体的资源来自何处，由谁实现。 </p>
<p>理解DI的关键是：“谁依赖谁，为什么需要依赖，谁注入谁，注入了什么”，那我们来深入分析一下： </p>
<ul>
<li><strong>谁依赖于谁：</strong>当然是应用程序依赖于IoC容器</li>
<li><strong>为什么需要依赖：</strong>应用程序需要IoC容器来提供对象需要的外部资源</li>
<li><strong>谁注入谁：</strong>很明显是IoC容器注入应用程序某个对象，应用程序依赖的对象</li>
<li><strong>注入了什么：</strong>就是注入某个对象所需要的外部资源（包括对象、资源、常量数据） </li>
</ul>
<p><strong>IOC和DI有什么关系呢？</strong>其实它们是同一个概念的不同角度描述，由于控制反转概念比较含糊（可能只是理解为容器控制对象这一个层面，很难让人想到谁来维护对象关系），所以2004年大师级人物Martin Fowler又给出了一个新的名字：“依赖注入”，相对IoC 而言，<strong>“依赖注入”明确描述了“被注入对象依赖IoC容器配置依赖对象”。</strong></p>
<h3 id="Dl-注入方式"><a href="#Dl-注入方式" class="headerlink" title="Dl 注入方式"></a>Dl 注入方式</h3><p>交代一下服务和接口</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><code class="hljs CSharp"><span class="hljs-comment">//InterFace</span><br><span class="hljs-keyword">using</span> System;<br><span class="hljs-keyword">using</span> System.Collections.Generic;<br><span class="hljs-keyword">using</span> System.Linq;<br><span class="hljs-keyword">using</span> System.Text;<br><span class="hljs-keyword">using</span> System.Threading.Tasks;<br><br><span class="hljs-keyword">namespace</span> <span class="hljs-title">DotNetCoreDemo.Interface</span><br>&#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title">ITestServiceA</span><br>    &#123;<br>        <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">Show</span>()</span>;<br>    &#125;<br>&#125;<br><br><span class="hljs-comment">//Service</span><br><span class="hljs-keyword">using</span> DotNetCoreDemo.Interface;<br><span class="hljs-keyword">using</span> System;<br><span class="hljs-keyword">using</span> System.Collections.Generic;<br><span class="hljs-keyword">using</span> System.Linq;<br><span class="hljs-keyword">using</span> System.Text;<br><span class="hljs-keyword">using</span> System.Threading.Tasks;<br><br><span class="hljs-keyword">namespace</span> <span class="hljs-title">DotNetCoreDemo.Service</span><br>&#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">TestServiceA</span> : <span class="hljs-title">ITestServiceA</span><br>    &#123;<br>        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">TestServiceA</span>()</span><br>        &#123;<br>            Console.WriteLine(<span class="hljs-keyword">this</span>.GetType().Name + <span class="hljs-string">&quot;构造了&quot;</span>);<br>        &#125;<br><br>        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Show</span>()</span><br>        &#123;<br>            Console.WriteLine(<span class="hljs-keyword">this</span>.GetType().Name + <span class="hljs-string">&quot;Show&quot;</span>);<br>        &#125;<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure>



<ol>
<li><p>第一种</p>
<ol>
<li><p>在 <code>Startup</code> 中的 <code>ConfigureServices</code> 中注册。</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs CSharp">services.AddTransient&lt;ITestServiceA, TestServiceA&gt;();<br></code></pre></td></tr></table></figure></li>
<li><p>在控制器中先实例化一个私有只读的<code>ITestServiceA</code> 对象，然后新建构造函数，构造函数的入参也是<code>ITestServiceA</code> 对象。在构造函数中，将入参的<code>ITestServiceA</code>对象赋值给实例化好的<code>ITestServiceA</code> 对象，然后就可以在方法中使用。</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><code class="hljs CSharp">      <span class="hljs-keyword">using</span> DotNetCoreDemo.Interface;<br>      <span class="hljs-keyword">using</span> Microsoft.AspNetCore.Mvc;<br>      <span class="hljs-keyword">using</span> System;<br>      <span class="hljs-keyword">using</span> System.Collections.Generic;<br>      <span class="hljs-keyword">using</span> System.Linq;<br>      <span class="hljs-keyword">using</span> System.Threading.Tasks;<br>      <br>      <span class="hljs-keyword">namespace</span> <span class="hljs-title">DotNetCoreDemo.Controllers</span><br>      &#123;<br>          <span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">IOCController</span> : <span class="hljs-title">Controller</span><br>          &#123;<br>              <span class="hljs-comment">//实例化一个私有只读的`ITestServiceA` 对象</span><br>              <span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> ITestServiceA _ItestServiceA = <span class="hljs-literal">null</span>;<span class="hljs-comment">//</span><br>      		<br>              <span class="hljs-comment">//构造函数</span><br>              <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">IOCController</span>(<span class="hljs-params">ITestServiceA itestserviceA</span>)</span><br>              &#123;<br>                  _ItestServiceA = itestserviceA;<br>              &#125;<br>      <br>              <span class="hljs-function"><span class="hljs-keyword">public</span> IActionResult <span class="hljs-title">Index</span>()</span><br>              &#123;<br>                  <span class="hljs-comment">//应用</span><br>                  _ItestServiceA.Show();<br>      <br>                  <span class="hljs-keyword">return</span> View();<br>              &#125;<br>          &#125;<br>      &#125;<br><br><span class="hljs-number">2.</span> 第二种<br><br>   <span class="hljs-number">1.</span> 同第一种一样，同样也得先在Startup中注册。<br><br>   <span class="hljs-number">2.</span> 在控制器中先实例化一个私有只读的`IServiceProvider` 对象，然后新建构造函数，构造函数的入参也是`IServiceProvider` 对象。在构造函数中，将入参的`IServiceProvider`对象赋值给实例化好的`IServiceProvider` 对象。但是在使用的时候有差异。<br><br>      ``` CSharp<br>      <span class="hljs-keyword">using</span> DotNetCoreDemo.Interface;<br>      <span class="hljs-keyword">using</span> Microsoft.AspNetCore.Mvc;<br>      <span class="hljs-keyword">using</span> System;<br>      <span class="hljs-keyword">using</span> System.Collections.Generic;<br>      <span class="hljs-keyword">using</span> System.Linq;<br>      <span class="hljs-keyword">using</span> System.Threading.Tasks;<br>      <br>      <span class="hljs-keyword">namespace</span> <span class="hljs-title">DotNetCoreDemo.Controllers</span><br>      &#123;<br>          <span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">IOCController</span> : <span class="hljs-title">Controller</span><br>          &#123;<br>              <span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> ITestServiceA _ItestServiceA = <span class="hljs-literal">null</span>;<br>      <br>              <span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> IServiceProvider _serviceProvider = <span class="hljs-literal">null</span>;<br>      <br>              <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">IOCController</span>(<span class="hljs-params">ITestServiceA itestserviceA, IServiceProvider serviceProvider</span>)</span><br>              &#123;<br>                  _ItestServiceA = itestserviceA;<br>      <br>                  _serviceProvider = serviceProvider;<br>              &#125;<br>      <br>              <span class="hljs-function"><span class="hljs-keyword">public</span> IActionResult <span class="hljs-title">Index</span>()</span><br>              &#123;<br>                  _ItestServiceA.Show();<br>      <br>                  ITestServiceA testServiceA = (ITestServiceA)_serviceProvider.GetService(<span class="hljs-keyword">typeof</span>(ITestServiceA));<br>      <br>                  testServiceA.Show();<br>      <br>                  <span class="hljs-keyword">return</span> View();<br>              &#125;<br>          &#125;<br>      &#125;<br></code></pre></td></tr></table></figure></li>
</ol>
</li>
<li><p>第三种</p>
<p>在视图中注册</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs html">@inject DotNetCoreDemo.Interface.ITestServiceA testServiceA<br><br>@&#123; <br>    testServiceA.Show();<br>&#125;<br></code></pre></td></tr></table></figure></li>
</ol>
<h3 id="Dl-依赖注入"><a href="#Dl-依赖注入" class="headerlink" title="Dl 依赖注入"></a>Dl 依赖注入</h3><p>如果对象B依赖与对象A，就可以先构造A传递给B,然后得到对应得B得对象实力。</p>
<p>依赖注入可以无限层级的注入，前提是先注入服务。</p>
<p>ServiceA 层</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs CSharp"><span class="hljs-keyword">using</span> DotNetCoreDemo.Interface;<br><span class="hljs-keyword">using</span> System;<br><span class="hljs-keyword">using</span> System.Collections.Generic;<br><span class="hljs-keyword">using</span> System.Linq;<br><span class="hljs-keyword">using</span> System.Text;<br><span class="hljs-keyword">using</span> System.Threading.Tasks;<br><br><span class="hljs-keyword">namespace</span> <span class="hljs-title">DotNetCoreDemo.Service</span><br>&#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">TestServiceA</span> : <span class="hljs-title">ITestServiceA</span><br>    &#123;<br>        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">TestServiceA</span>()</span><br>        &#123;<br>            Console.WriteLine(<span class="hljs-keyword">this</span>.GetType().Name + <span class="hljs-string">&quot;构造了&quot;</span>);<br>        &#125;<br>		<br>        <span class="hljs-comment">//拓展方法</span><br>        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-built_in">string</span> <span class="hljs-title">ReturnStr</span>(<span class="hljs-params"><span class="hljs-built_in">string</span> str</span>)</span><br>        &#123;<br>            <span class="hljs-keyword">return</span> str + GetType().Name.ToString();<br>        &#125;<br><br>        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Show</span>()</span><br>        &#123;<br>            Console.WriteLine(GetType().Name + <span class="hljs-string">&quot;Show&quot;</span>);<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>InterfaceA 层</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs CSharp"><span class="hljs-keyword">namespace</span> <span class="hljs-title">DotNetCoreDemo.Interface</span><br>&#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title">ITestServiceA</span><br>    &#123;<br>        <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">Show</span>()</span>;<br><br>        <span class="hljs-function"><span class="hljs-built_in">string</span> <span class="hljs-title">ReturnStr</span>(<span class="hljs-params"><span class="hljs-built_in">string</span> str</span>)</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>ServiceB层</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><code class="hljs CSharp"><span class="hljs-keyword">using</span> DotNetCoreDemo.Interface;<br><span class="hljs-keyword">using</span> System;<br><span class="hljs-keyword">using</span> System.Collections.Generic;<br><span class="hljs-keyword">using</span> System.Linq;<br><span class="hljs-keyword">using</span> System.Text;<br><span class="hljs-keyword">using</span> System.Threading.Tasks;<br><br><span class="hljs-keyword">namespace</span> <span class="hljs-title">DotNetCoreDemo.Service</span><br>&#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">TestServiceB</span> : <span class="hljs-title">ITestServiceB</span><br>    &#123;<br>        <span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> ITestServiceA _testServiceA = <span class="hljs-literal">null</span>;<br><br>        <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;summary&gt;</span></span><br>        <span class="hljs-comment"><span class="hljs-doctag">///</span> TestServiceB 依赖于 TestServiceA</span><br>        <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;/summary&gt;</span></span><br>        <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;param name=&quot;testServiceA&quot;&gt;</span><span class="hljs-doctag">&lt;/param&gt;</span></span><br>        <span class="hljs-comment"><span class="hljs-doctag">///</span> 到这，testServiceA 已经传递过来了。这个时候，TestServiceB 的方法中就可以使用TestServerA中的内容</span><br>        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">TestServiceB</span>(<span class="hljs-params">ITestServiceA testServiceA</span>)</span><br>        &#123;<br>            _testServiceA = testServiceA;<br><br>            Console.WriteLine(<span class="hljs-keyword">this</span>.GetType().Name + <span class="hljs-string">&quot;构造了&quot;</span>);<br>        &#125;<br><br>        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Show</span>()</span><br>        &#123;<br>            _testServiceA.Show();<br><br>            Console.WriteLine(<span class="hljs-keyword">this</span>.GetType().Name + <span class="hljs-string">&quot;Show&quot;</span>);<br>        &#125;<br><br>        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-built_in">string</span> <span class="hljs-title">ReturnStr</span>()</span><br>        &#123;<br>            <span class="hljs-comment">//获取接口方法A的值</span><br>            <span class="hljs-built_in">string</span> str = _testServiceA.ReturnStr(<span class="hljs-string">&quot;123&quot;</span>);<br>			<br>            <span class="hljs-built_in">string</span> str_ = str + <span class="hljs-keyword">this</span>.GetType().Name.ToString();<br>			<span class="hljs-comment">//返回</span><br>            <span class="hljs-keyword">return</span> str_;<br>        &#125;<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure>

<p>InterfaceB层</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs CSharp"><span class="hljs-keyword">using</span> System;<br><span class="hljs-keyword">using</span> System.Collections.Generic;<br><span class="hljs-keyword">using</span> System.Linq;<br><span class="hljs-keyword">using</span> System.Text;<br><span class="hljs-keyword">using</span> System.Threading.Tasks;<br><br><span class="hljs-keyword">namespace</span> <span class="hljs-title">DotNetCoreDemo.Interface</span><br>&#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title">ITestServiceB</span><br>    &#123;<br>        <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">Show</span>()</span>;<br><br>        <span class="hljs-function"><span class="hljs-built_in">string</span> <span class="hljs-title">ReturnStr</span>()</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>Startup 注入</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs CSharp"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">ConfigureServices</span>(<span class="hljs-params">IServiceCollection services</span>)</span><br>&#123;<br>    <span class="hljs-meta">#<span class="hljs-keyword">region</span> IOC注册服务</span><br><br>    services.AddTransient&lt;ITestServiceA, TestServiceA&gt;();<br>    services.AddTransient&lt;ITestServiceB, TestServiceB&gt;();<span class="hljs-comment">//注入 TestServiceB</span><br><br>    <span class="hljs-meta">#<span class="hljs-keyword">endregion</span></span><br><br>    services.AddControllersWithViews();<br><br>    services.AddSession();<br><br>    <span class="hljs-comment">//加入中间件，方便实时调试HTML</span><br>    services.AddRazorPages().AddRazorRuntimeCompilation();<br><br>    <span class="hljs-comment">//注入服务</span><br>    services.AddTransient&lt;ICoustomInterface, CoustomService&gt;();<br><br>    <span class="hljs-comment">//取配置文件中的TEST节点，映射到 TESTMODEL 实体</span><br>    services.Configure&lt;TESTMODEL&gt;(Configuration.GetSection(<span class="hljs-string">&quot;TEST&quot;</span>));<br>&#125;<br></code></pre></td></tr></table></figure>

<pre><code>    上述，呈现出的，就是ServiceB 依赖 ServiceA ,在 ServiceB 的构造方法中，传入 ServiceA ,然后再 ServiceB 中，调用 ServiceA 的方法，构成了ServiceB ReturnStr 方法结果的呈现。应该能诠释 依赖注入的概念了，以此类推，可以衍生出 各种依赖。不怕注册的多服务，尽管上。
</code></pre>
<h3 id="IServiceCollection-生命周期"><a href="#IServiceCollection-生命周期" class="headerlink" title="IServiceCollection 生命周期"></a>IServiceCollection 生命周期</h3><ol>
<li><p>瞬时生命周期 Addtransient 注册的生命周期：每次都实例化一个新的。<strong>正常瞬时生命周期使用的多，每次一个对象</strong></p>
<p><img src="https://blogimage-1255495010.cos.ap-beijing.myqcloud.com/image-20210828145713938.png" srcset="/img/loading.gif" lazyload alt="image-20210828145713938"></p>
</li>
<li><p>单例生命周期：AddSingleton 注册的生命周期：serviceA2_1 走过一遍后，serviceA2_2 直接就过去了，所以这玩意注册，一直玩的就一个。</p>
<p><img src="https://blogimage-1255495010.cos.ap-beijing.myqcloud.com/image-20210828145845491.png" srcset="/img/loading.gif" lazyload alt="image-20210828145845491"></p>
</li>
<li><p>作用域生命周期</p>
<p>同一个IServiceCollection ，不同的ServiceProvider 实例化出来的对象，在每个ServiceProvider 内实例化的对象相当于单例，但是不同的 ServiceProvider 之间 是不一样的。</p>
<p><img src="https://blogimage-1255495010.cos.ap-beijing.myqcloud.com/image-20210828151007374.png" srcset="/img/loading.gif" lazyload alt="image-20210828151007374"></p>
</li>
<li><p>Code</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><code class="hljs CSharp"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">ConfigureServices</span>(<span class="hljs-params">IServiceCollection services</span>)</span><br>&#123;<br>            <span class="hljs-meta">#<span class="hljs-keyword">region</span> IOC注册服务</span><br><br>            services.AddTransient&lt;ITestServiceA, TestServiceA&gt;();<br>            services.AddTransient&lt;ITestServiceB, TestServiceB&gt;();<br><br>            <span class="hljs-meta">#<span class="hljs-keyword">endregion</span></span><br><br>            <span class="hljs-meta">#<span class="hljs-keyword">region</span> 服务控制器 生命周期</span><br><br>            <span class="hljs-meta">#<span class="hljs-keyword">region</span> 瞬时生命周期 每次获取的实例都是不同的实例</span><br><br>            IServiceCollection services1 = <span class="hljs-keyword">new</span> ServiceCollection();<br><br>            services1.AddTransient&lt;ITestServiceA, TestServiceA&gt;();<br><br>            ServiceProvider serviceProvider = services1.BuildServiceProvider();<br><br>            ITestServiceA serviceA1_1 = serviceProvider.GetService&lt;ITestServiceA&gt;();<br><br>            ITestServiceA serviceA1_2 = serviceProvider.GetService&lt;ITestServiceA&gt;();<br>            <span class="hljs-comment">//比较上述这俩实例是不是同一个</span><br>            <span class="hljs-built_in">bool</span> IsOk1 = <span class="hljs-built_in">object</span>.ReferenceEquals(serviceA1_1, serviceA1_2);<br><br>            <span class="hljs-meta">#<span class="hljs-keyword">endregion</span></span><br><br>            <span class="hljs-meta">#<span class="hljs-keyword">region</span> 单例生命周期 每次获取的时候都是同一个实例</span><br><br>            IServiceCollection services2 = <span class="hljs-keyword">new</span> ServiceCollection();<br><br>            services2.AddSingleton&lt;ITestServiceA, TestServiceA&gt;();<br><br>            ServiceProvider serviceProvider2 = services2.BuildServiceProvider();<br><br>            ITestServiceA serviceA2_1 = serviceProvider2.GetService&lt;ITestServiceA&gt;();<br><br>            ITestServiceA serviceA2_2 = serviceProvider2.GetService&lt;ITestServiceA&gt;();<br>            <span class="hljs-comment">//比较上述这俩实例是不是同一个</span><br>            <span class="hljs-built_in">bool</span> IsOk2 = <span class="hljs-built_in">object</span>.ReferenceEquals(serviceA2_1, serviceA2_2);<br><br>            <span class="hljs-meta">#<span class="hljs-keyword">endregion</span></span><br><br>            <span class="hljs-meta">#<span class="hljs-keyword">region</span> 作用域生命周期</span><br><br>            IServiceCollection services3 = <span class="hljs-keyword">new</span> ServiceCollection();<br><br>            services3.AddScoped&lt;ITestServiceA, TestServiceA&gt;();<br><br>            ServiceProvider serviceProvider3_1 = services3.BuildServiceProvider();<br><br>            ITestServiceA serviceA3_1 = serviceProvider3_1.GetService&lt;ITestServiceA&gt;();<br><br>            ITestServiceA serviceA3_2 = serviceProvider3_1.GetService&lt;ITestServiceA&gt;();<br>            <span class="hljs-comment">//比较上述这俩实例是不是同一个</span><br>            <span class="hljs-built_in">bool</span> IsOk3 = <span class="hljs-built_in">object</span>.ReferenceEquals(serviceA3_1, serviceA3_2);<br><br>            ServiceProvider serviceProvider3_2 = services3.BuildServiceProvider();<br><br>            ITestServiceA serviceA3_3 = serviceProvider3_2.GetService&lt;ITestServiceA&gt;();<br><br>            ITestServiceA serviceA3_4 = serviceProvider3_2.GetService&lt;ITestServiceA&gt;();<br><br>            <span class="hljs-built_in">bool</span> IsOk4 = <span class="hljs-built_in">object</span>.ReferenceEquals(serviceA3_3, serviceA3_4);<br><br>            <span class="hljs-built_in">bool</span> IsOk5 = <span class="hljs-built_in">object</span>.ReferenceEquals(serviceA3_1, serviceA3_3);<br><br>            <span class="hljs-meta">#<span class="hljs-keyword">endregion</span></span><br><br>            <span class="hljs-meta">#<span class="hljs-keyword">endregion</span></span><br><br><br><br>            services.AddControllersWithViews();<br><br>            services.AddSession();<br><br>            <span class="hljs-comment">//加入中间件，方便实时调试HTML</span><br>            services.AddRazorPages().AddRazorRuntimeCompilation();<br><br>            <span class="hljs-comment">//注入服务</span><br>            services.AddTransient&lt;ICoustomInterface, CoustomService&gt;();<br><br>            <span class="hljs-comment">//取配置文件中的TEST节点，映射到 TESTMODEL 实体</span><br>            services.Configure&lt;TESTMODEL&gt;(Configuration.GetSection(<span class="hljs-string">&quot;TEST&quot;</span>));<br>&#125;<br></code></pre></td></tr></table></figure></li>
</ol>
<h2 id="Autofac-应用"><a href="#Autofac-应用" class="headerlink" title="Autofac 应用"></a>Autofac 应用</h2><h3 id="初识-Autofac"><a href="#初识-Autofac" class="headerlink" title="初识 Autofac"></a>初识 Autofac</h3><p><strong>Autofac 是一款第三方，很流行的 IOC容器，应用方法如下：</strong></p>
<ol>
<li>Nuget 获取 Autofac 组件。</li>
<li>创建一个ContainerBuilder 对象</li>
<li>注册抽象和实现方法 格式：builder.RegisterType&lt;实现方法&gt;().As&lt;抽象接口&gt;();</li>
<li>Build 得到 container 容器</li>
<li>管 container 容器 要 ITestServiceA 服务</li>
<li>应用 要到的 ITestServiceA 服务</li>
</ol>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs CSharp"><span class="hljs-meta">#<span class="hljs-keyword">region</span> Autofac 应用</span><br><span class="hljs-comment">//1. Nuget Autofac </span><br><span class="hljs-comment">//2. 创建一个ContainerBuilder 对象 </span><br>ContainerBuilder builder = <span class="hljs-keyword">new</span> ContainerBuilder();<br><span class="hljs-comment">//3. 注册抽象和实现方法 格式：builder.RegisterType&lt;实现方法&gt;().As&lt;ITestServiceA&gt;();</span><br>builder.RegisterType&lt;TestServiceA&gt;().As&lt;ITestServiceA&gt;();<br><span class="hljs-comment">//4. Build 得到 container 容器</span><br>IContainer container = builder.Build();<br><span class="hljs-comment">//5. 管 container 容器 要 ITestServiceA 服务</span><br>ITestServiceA testServiceA = container.Resolve&lt;ITestServiceA&gt;();<span class="hljs-comment">//获取服务</span><br><span class="hljs-comment">//6. 应用 要到的 ITestServiceA 服务</span><br>testServiceA.Show();<br><span class="hljs-meta">#<span class="hljs-keyword">endregion</span></span><br></code></pre></td></tr></table></figure>

<h3 id="Autofac-多种注册方式"><a href="#Autofac-多种注册方式" class="headerlink" title="Autofac 多种注册方式"></a>Autofac 多种注册方式</h3><p><strong>第一种：构造函数注入</strong> </p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs CSharp">ContainerBuilder builder1 = <span class="hljs-keyword">new</span> ContainerBuilder();<br>builder1.RegisterType&lt;TestServiceA&gt;().As&lt;ITestServiceA&gt;();<br>builder1.RegisterType&lt;TestServiceB&gt;().As&lt;ITestServiceB&gt;();<br>builder1.RegisterType&lt;TestServiceC&gt;().As&lt;ITestServiceC&gt;();<br>IContainer container1 = builder1.Build();<br>ITestServiceC testServiceC1 = container1.Resolve&lt;ITestServiceC&gt;();<br>testServiceC1.Show();<br></code></pre></td></tr></table></figure>

<p>这没啥说的，基本操作。</p>
<p><strong>第二种：属性注入</strong></p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs CSharp">ContainerBuilder builder2 = <span class="hljs-keyword">new</span> ContainerBuilder();<br>builder2.RegisterType&lt;TestServiceA&gt;().As&lt;ITestServiceA&gt;();<br>builder2.RegisterType&lt;TestServiceB&gt;().As&lt;ITestServiceB&gt;();<br>builder2.RegisterType&lt;TestServiceC&gt;().As&lt;ITestServiceC&gt;();<br>builder2.RegisterType&lt;TestServiceD&gt;().As&lt;ITestServiceD&gt;().PropertiesAutowired();<br>IContainer container2 = builder2.Build();<br>ITestServiceD testServiceD = container2.Resolve&lt;ITestServiceD&gt;();<br>testServiceD.Show();<br></code></pre></td></tr></table></figure>

<p>关注一下<code>TestServiceD</code> 里，还有 <code>PropertiesAutowired()</code></p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs CSharp"><span class="hljs-keyword">using</span> DotNetCoreDemo.Interface;<br><span class="hljs-keyword">using</span> System;<br><span class="hljs-keyword">using</span> System.Collections.Generic;<br><span class="hljs-keyword">using</span> System.Linq;<br><span class="hljs-keyword">using</span> System.Text;<br><span class="hljs-keyword">using</span> System.Threading.Tasks;<br><br><span class="hljs-keyword">namespace</span> <span class="hljs-title">DotNetCoreDemo.Service</span><br>&#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">TestServiceD</span> : <span class="hljs-title">ITestServiceD</span><br>    &#123;<br>        <span class="hljs-keyword">public</span> ITestServiceA testServiceA &#123; <span class="hljs-keyword">get</span>; <span class="hljs-keyword">set</span>; &#125;<br>        <span class="hljs-keyword">public</span> ITestServiceB testServiceB &#123; <span class="hljs-keyword">get</span>; <span class="hljs-keyword">set</span>; &#125;<br>        <span class="hljs-keyword">public</span> ITestServiceC testServiceC &#123; <span class="hljs-keyword">get</span>; <span class="hljs-keyword">set</span>; &#125;<br><br>        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">TestServiceD</span>()</span><br>        &#123;<br>            Console.WriteLine(<span class="hljs-keyword">this</span>.GetType().Name + <span class="hljs-string">&quot;构造了&quot;</span>);<br>        &#125;<br><br>        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Show</span>()</span><br>        &#123;<br>            <span class="hljs-comment">//基于TestService ABC 都注册了，在执行下面这行代码的时候 才会去Set属性值，会挨个都执行ABC的构造函数。</span><br>            testServiceA.Show();<br>            Console.WriteLine(<span class="hljs-keyword">this</span>.GetType().Name + <span class="hljs-string">&quot;Show&quot;</span>);<br>        &#125;<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure>

<p><strong>第三种：方法注入</strong></p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs CSharp">ContainerBuilder builder3 = <span class="hljs-keyword">new</span> ContainerBuilder();<br>builder3.RegisterType&lt;TestServiceA&gt;().As&lt;ITestServiceA&gt;();<br>builder3.RegisterType&lt;TestServiceB&gt;().As&lt;ITestServiceB&gt;();<br>builder3.RegisterType&lt;TestServiceC&gt;().OnActivated(e =&gt; e.Instance.SetService(e.Context.Resolve&lt;ITestServiceA&gt;())).As&lt;ITestServiceC&gt;();<br>builder3.RegisterType&lt;TestServiceD&gt;().As&lt;ITestServiceD&gt;().PropertiesAutowired();<br>IContainer container3 = builder3.Build();<br>ITestServiceC testServiceC = container3.Resolve&lt;ITestServiceC&gt;();<br>testServiceC.Show();<br></code></pre></td></tr></table></figure>

<p>这个地方需要关注两点：</p>
<ol>
<li><p>方法注入种 <code>TestServiceC</code>的注入方式与AB注入方式的差异<code>OnActivated</code></p>
</li>
<li><p>上述不同的注册方式是需要结合下面的代码使用,注意 <code>SetService</code>方法</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs CSharp"><span class="hljs-keyword">using</span> DotNetCoreDemo.Interface;<br><span class="hljs-keyword">using</span> System;<br><span class="hljs-keyword">using</span> System.Collections.Generic;<br><span class="hljs-keyword">using</span> System.Linq;<br><span class="hljs-keyword">using</span> System.Text;<br><span class="hljs-keyword">using</span> System.Threading.Tasks;<br><br><span class="hljs-keyword">namespace</span> <span class="hljs-title">DotNetCoreDemo.Service</span><br>&#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">TestServiceC</span> : <span class="hljs-title">ITestServiceC</span><br>    &#123;<br>        <span class="hljs-keyword">private</span> ITestServiceA _testServiceA = <span class="hljs-literal">null</span>;<br><br>        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">SetService</span>(<span class="hljs-params">ITestServiceA testServiceA</span>)</span><br>        &#123;<br>            _testServiceA = testServiceA;<br>        &#125;<br>        <br>        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">TestServiceC</span>(<span class="hljs-params">ITestServiceA serviceA</span>)</span><br>        &#123;<br>            _testServiceA = serviceA;<br><br>            Console.WriteLine(<span class="hljs-keyword">this</span>.GetType().Name + <span class="hljs-string">&quot;构造了&quot;</span>);<br>        &#125;<br><br>        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Show</span>()</span><br>        &#123;<br>            _testServiceA.Show();<br><br>            Console.WriteLine(<span class="hljs-keyword">this</span>.GetType().Name + <span class="hljs-string">&quot;Show&quot;</span>);<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure></li>
</ol>
<h3 id="Autofac-生命周期"><a href="#Autofac-生命周期" class="headerlink" title="Autofac 生命周期"></a>Autofac 生命周期</h3><p>第一种：瞬时生命周期（InstancePerDependency）</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs CSharp"><span class="hljs-meta">#<span class="hljs-keyword">region</span> 瞬时生命周期 (InstancePerDependency)</span><br>&#123;<br>    ContainerBuilder builder4 = <span class="hljs-keyword">new</span> ContainerBuilder();<br><br>    builder4.RegisterType&lt;TestServiceA&gt;().As&lt;ITestServiceA&gt;().InstancePerDependency();<br><br>    IContainer container4 = builder4.Build();<br><br>    ITestServiceA testServiceA1 = container4.Resolve&lt;ITestServiceA&gt;();<br>    ITestServiceA testServiceA2 = container4.Resolve&lt;ITestServiceA&gt;();<br><br>    Console.WriteLine(<span class="hljs-string">&quot;Autofac 生命周期-瞬时：&quot;</span> + <span class="hljs-built_in">object</span>.ReferenceEquals(testServiceA1, testServiceA2));<br>&#125;<br><span class="hljs-meta">#<span class="hljs-keyword">endregion</span></span><br></code></pre></td></tr></table></figure>

<p>第二种：单例生命周期（SingleInstance）</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs CSharp"><span class="hljs-meta">#<span class="hljs-keyword">region</span> 单例生命周期（SingleInstance）</span><br>&#123;<br>    ContainerBuilder builder4 = <span class="hljs-keyword">new</span> ContainerBuilder();<br><br>    builder4.RegisterType&lt;TestServiceA&gt;().As&lt;ITestServiceA&gt;().SingleInstance();<br><br>    IContainer container4 = builder4.Build();<br><br>    ITestServiceA testServiceA1 = container4.Resolve&lt;ITestServiceA&gt;();<br>    ITestServiceA testServiceA2 = container4.Resolve&lt;ITestServiceA&gt;();<br><br>    Console.WriteLine(<span class="hljs-string">&quot;Autofac 生命周期-单例：&quot;</span> + <span class="hljs-built_in">object</span>.ReferenceEquals(testServiceA1, testServiceA2));<br>&#125;<br><span class="hljs-meta">#<span class="hljs-keyword">endregion</span></span><br></code></pre></td></tr></table></figure>

<p>第三种：作用域生命周期（InstancePerLifetimeScope）</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><code class="hljs CSharp"><span class="hljs-meta">#<span class="hljs-keyword">region</span> 作用域生命周期（InstancePerLifetimeScope）</span><br>&#123;<br>    ContainerBuilder builder4 = <span class="hljs-keyword">new</span> ContainerBuilder();<br><br>    builder4.RegisterType&lt;TestServiceA&gt;().As&lt;ITestServiceA&gt;().InstancePerLifetimeScope();<br><br>    IContainer container4 = builder4.Build();<br><br>    ITestServiceA testServiceA5 = <span class="hljs-literal">null</span>;<br><br>    ITestServiceA testServiceA6 = <span class="hljs-literal">null</span>;<br><br>    <span class="hljs-keyword">using</span> (<span class="hljs-keyword">var</span> Scope = container4.BeginLifetimeScope())<br>    &#123;<br>        ITestServiceA testServiceA1 = Scope.Resolve&lt;ITestServiceA&gt;();<br><br>        ITestServiceA testServiceA2 = Scope.Resolve&lt;ITestServiceA&gt;();<br><br>        Console.WriteLine(<span class="hljs-string">&quot;Autofac 生命周期-作用域1-1：&quot;</span> + <span class="hljs-built_in">object</span>.ReferenceEquals(testServiceA1, testServiceA2));<span class="hljs-comment">//True</span><br><br>        testServiceA5 = testServiceA2;<br>    &#125;<br><br>    <span class="hljs-keyword">using</span> (<span class="hljs-keyword">var</span> Scope = container4.BeginLifetimeScope())<br>    &#123;<br>        ITestServiceA testServiceA3 = Scope.Resolve&lt;ITestServiceA&gt;();<br><br>        ITestServiceA testServiceA4 = Scope.Resolve&lt;ITestServiceA&gt;();<br><br>        Console.WriteLine(<span class="hljs-string">&quot;Autofac 生命周期-作用域2-2：&quot;</span> + <span class="hljs-built_in">object</span>.ReferenceEquals(testServiceA3, testServiceA4));<span class="hljs-comment">//True</span><br><br>        testServiceA6 = testServiceA4;<br>    &#125;<br><br>    Console.WriteLine(<span class="hljs-string">&quot;Autofac 生命周期-作用域1-2：&quot;</span> + <span class="hljs-built_in">object</span>.ReferenceEquals(testServiceA5, testServiceA6));<span class="hljs-comment">//False</span><br>&#125;<br><span class="hljs-meta">#<span class="hljs-keyword">endregion</span></span><br></code></pre></td></tr></table></figure>

<p>第三种扩展：加参数标记 </p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><code class="hljs CSharp"><span class="hljs-meta">#<span class="hljs-keyword">region</span> 作用域生命周期-扩展（InstancePerLifetimeScope+参数标记）</span><br>&#123;<br>    ContainerBuilder builder4 = <span class="hljs-keyword">new</span> ContainerBuilder();<br><br>    builder4.RegisterType&lt;TestServiceA&gt;().As&lt;ITestServiceA&gt;().InstancePerLifetimeScope();<br><br>    IContainer container4 = builder4.Build();<br><br>    ITestServiceA testServiceA5 = <span class="hljs-literal">null</span>;<br><br>    ITestServiceA testServiceA6 = <span class="hljs-literal">null</span>;<br><br>    <span class="hljs-keyword">using</span> (<span class="hljs-keyword">var</span> Scope = container4.BeginLifetimeScope(<span class="hljs-string">&quot;Harris&quot;</span>))<br>    &#123;<br>        ITestServiceA testServiceA1 = Scope.Resolve&lt;ITestServiceA&gt;();<br><br>        <span class="hljs-keyword">using</span> (<span class="hljs-keyword">var</span> Scope1 = container4.BeginLifetimeScope())<br>        &#123;<br>            ITestServiceA testServiceA2 = Scope.Resolve&lt;ITestServiceA&gt;();<br><br>            Console.WriteLine(<span class="hljs-string">&quot;Autofac 生命周期-作用域扩展1：&quot;</span> + <span class="hljs-built_in">object</span>.ReferenceEquals(testServiceA1, testServiceA2));<br>        &#125;<br><br>        testServiceA5 = testServiceA1;<br>    &#125;<br><br>    <span class="hljs-keyword">using</span> (<span class="hljs-keyword">var</span> Scope = container4.BeginLifetimeScope(<span class="hljs-string">&quot;Harris&quot;</span>))<br>    &#123;<br>        ITestServiceA testServiceA1 = Scope.Resolve&lt;ITestServiceA&gt;();<br><br>        <span class="hljs-keyword">using</span> (<span class="hljs-keyword">var</span> Scope1 = container4.BeginLifetimeScope())<br>        &#123;<br>            ITestServiceA testServiceA2 = Scope.Resolve&lt;ITestServiceA&gt;();<br><br>            Console.WriteLine(<span class="hljs-string">&quot;Autofac 生命周期-作用域扩展2：&quot;</span> + <span class="hljs-built_in">object</span>.ReferenceEquals(testServiceA1, testServiceA2));<br>        &#125;<br><br>        testServiceA6 = testServiceA1;<br>    &#125;<br><br>    Console.WriteLine(<span class="hljs-string">&quot;Autofac 生命周期-作用域扩展3：&quot;</span> + <span class="hljs-built_in">object</span>.ReferenceEquals(testServiceA5, testServiceA6));<br>&#125;<br><span class="hljs-meta">#<span class="hljs-keyword">endregion</span></span><br></code></pre></td></tr></table></figure>

<p><img src="https://blogimage-1255495010.cos.ap-beijing.myqcloud.com/image-20210829154658355.png" srcset="/img/loading.gif" lazyload alt="image-20210829154658355"></p>
<h3 id="Autofac-读取配置文件注册"><a href="#Autofac-读取配置文件注册" class="headerlink" title="Autofac 读取配置文件注册"></a>Autofac 读取配置文件注册</h3><ol>
<li><p>Nuget 获取</p>
<ul>
<li>Autofac.Extensions.DependencyInjection</li>
<li>Autofac.Configuration</li>
</ul>
</li>
<li><p>准备配置文件</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><code class="hljs json"><span class="hljs-punctuation">&#123;</span><br>  <span class="hljs-attr">&quot;components&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><br>    <span class="hljs-punctuation">&#123;</span><br>      <span class="hljs-attr">&quot;type&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;DotNetCoreDemo.Service.TestServiceA,DotNetCoreDemo.Service&quot;</span><span class="hljs-punctuation">,</span><br>      <span class="hljs-attr">&quot;services&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><br>        <span class="hljs-punctuation">&#123;</span><br>          <span class="hljs-attr">&quot;type&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;DotNetCoreDemo.Interface.ITestServiceA,DotNetCoreDemo.Interface&quot;</span><br>        <span class="hljs-punctuation">&#125;</span><br>      <span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span><br>      <span class="hljs-attr">&quot;instanceScope&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;single-instance&quot;</span><span class="hljs-punctuation">,</span> <span class="hljs-comment">//生命周期</span><br>      <span class="hljs-attr">&quot;injectProperties&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-keyword">true</span> <span class="hljs-comment">// 是否支持属性注入</span><br>    <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-punctuation">&#123;</span><br>      <span class="hljs-attr">&quot;type&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;DotNetCoreDemo.Service.TestServiceB,DotNetCoreDemo.Service&quot;</span><span class="hljs-punctuation">,</span><br>      <span class="hljs-attr">&quot;services&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><br>        <span class="hljs-punctuation">&#123;</span><br>          <span class="hljs-attr">&quot;type&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;DotNetCoreDemo.Interface.ITestServiceB,DotNetCoreDemo.Interface&quot;</span><br>        <span class="hljs-punctuation">&#125;</span><br>      <span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span><br>      <span class="hljs-attr">&quot;instanceScope&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;single-instance&quot;</span><span class="hljs-punctuation">,</span> <span class="hljs-comment">//生命周期</span><br>      <span class="hljs-attr">&quot;injectProperties&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-keyword">true</span> <span class="hljs-comment">// 是否支持属性注入</span><br>    <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-punctuation">&#123;</span><br>      <span class="hljs-attr">&quot;type&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;DotNetCoreDemo.Service.TestServiceC,DotNetCoreDemo.Service&quot;</span><span class="hljs-punctuation">,</span><br>      <span class="hljs-attr">&quot;services&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><br>        <span class="hljs-punctuation">&#123;</span><br>          <span class="hljs-attr">&quot;type&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;DotNetCoreDemo.Interface.ITestServiceC,DotNetCoreDemo.Interface&quot;</span><br>        <span class="hljs-punctuation">&#125;</span><br>      <span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span><br>      <span class="hljs-attr">&quot;instanceScope&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;single-instance&quot;</span><span class="hljs-punctuation">,</span> <span class="hljs-comment">//生命周期</span><br>      <span class="hljs-attr">&quot;injectProperties&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-keyword">true</span> <span class="hljs-comment">// 是否支持属性注入</span><br>    <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-punctuation">&#123;</span><br>      <span class="hljs-attr">&quot;type&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;DotNetCoreDemo.Service.TestServiceD,DotNetCoreDemo.Service&quot;</span><span class="hljs-punctuation">,</span><br>      <span class="hljs-attr">&quot;services&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><br>        <span class="hljs-punctuation">&#123;</span><br>          <span class="hljs-attr">&quot;type&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;DotNetCoreDemo.Interface.ITestServiceD,DotNetCoreDemo.Interface&quot;</span><br>        <span class="hljs-punctuation">&#125;</span><br>      <span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span><br>      <span class="hljs-attr">&quot;instanceScope&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;single-instance&quot;</span><span class="hljs-punctuation">,</span> <span class="hljs-comment">//生命周期</span><br>      <span class="hljs-attr">&quot;injectProperties&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-keyword">true</span> <span class="hljs-comment">// 是否支持属性注入</span><br>    <span class="hljs-punctuation">&#125;</span><br>  <span class="hljs-punctuation">]</span><br><span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure></li>
<li><p>读取配置文件，通过Autofac 配置文件实现注册抽象服务和具体方法。</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs CSharp"><span class="hljs-meta">#<span class="hljs-keyword">region</span> Autofac 读取配置文件注册服务</span><br>&#123;<br>    ContainerBuilder builder = <span class="hljs-keyword">new</span> ContainerBuilder();<br><br>    IConfigurationBuilder config = <span class="hljs-keyword">new</span> ConfigurationBuilder();<br><br>    IConfigurationSource source = <span class="hljs-keyword">new</span> JsonConfigurationSource()<br>    &#123;<br>        Path = <span class="hljs-string">&quot;CfgFile/Autofac.json&quot;</span>,<br>        Optional = <span class="hljs-literal">false</span>,<span class="hljs-comment">//默认是false ,可以不写</span><br>        ReloadOnChange = <span class="hljs-literal">true</span><span class="hljs-comment">//默认是true，可不写</span><br>    &#125;;<br><br>    config.Add(source);<br><br>    ConfigurationModule module = <span class="hljs-keyword">new</span> ConfigurationModule(config.Build());<br><br>    builder.RegisterModule(module);<br><br>    IContainer container = builder.Build();<br><br>    ITestServiceA testServiceA = container.Resolve&lt;ITestServiceA&gt;();<br><br>    testServiceA.Show();<br><br>    ITestServiceD testServiceD = container.Resolve&lt;ITestServiceD&gt;();<br><br>    testServiceD.Show();<br>&#125;<br><br><span class="hljs-meta">#<span class="hljs-keyword">endregion</span></span><br></code></pre></td></tr></table></figure></li>
<li><p>有了Autofac 配置文件就可以灵活的调整服务（interface）与服务本身（Service）中的关系。</p>
<p>举个例子：如果现在有个<code>TestServiceE</code>,依赖于<code>ItestServiceA</code></p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs CSharp"><span class="hljs-keyword">using</span> DotNetCoreDemo.Interface;<br><span class="hljs-keyword">using</span> System;<br><span class="hljs-keyword">using</span> System.Collections.Generic;<br><span class="hljs-keyword">using</span> System.Linq;<br><span class="hljs-keyword">using</span> System.Text;<br><span class="hljs-keyword">using</span> System.Threading.Tasks;<br><br><span class="hljs-keyword">namespace</span> <span class="hljs-title">DotNetCoreDemo.Service</span><br>&#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">TestServiceE</span> : <span class="hljs-title">ITestServiceA</span><br>    &#123;<br>        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">TestServiceE</span>()</span><br>        &#123;<br>            Console.WriteLine(<span class="hljs-keyword">this</span>.GetType().Name + <span class="hljs-string">&quot;构造了&quot;</span>);<br>        &#125;<br><br>        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-built_in">string</span> <span class="hljs-title">ReturnStr</span>(<span class="hljs-params"><span class="hljs-built_in">string</span> str</span>)</span><br>        &#123;<br>            <span class="hljs-keyword">return</span> str + GetType().Name.ToString();<br>        &#125;<br><br>        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Show</span>()</span><br>        &#123;<br>            Console.WriteLine(GetType().Name + <span class="hljs-string">&quot;Show&quot;</span>);<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>然后刚才实现读取配置的代码中，ItestServiceA 想用的是 TestServiceE 的实现方法。只需要修改配置文件即可。</p>
<p>修改前：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs json"><span class="hljs-punctuation">&#123;</span><br>      <span class="hljs-attr">&quot;type&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;DotNetCoreDemo.Service.TestServiceA,DotNetCoreDemo.Service&quot;</span><span class="hljs-punctuation">,</span><br>      <span class="hljs-attr">&quot;services&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><br>        <span class="hljs-punctuation">&#123;</span><br>          <span class="hljs-attr">&quot;type&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;DotNetCoreDemo.Interface.ITestServiceA,DotNetCoreDemo.Interface&quot;</span><br>        <span class="hljs-punctuation">&#125;</span><br>      <span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span><br>      <span class="hljs-attr">&quot;instanceScope&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;single-instance&quot;</span><span class="hljs-punctuation">,</span> <span class="hljs-comment">//生命周期</span><br>      <span class="hljs-attr">&quot;injectProperties&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-keyword">true</span> <span class="hljs-comment">// 是否支持属性注入</span><br><span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br></code></pre></td></tr></table></figure>

<p>修改后：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs json"><span class="hljs-punctuation">&#123;</span><br>      <span class="hljs-attr">&quot;type&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;DotNetCoreDemo.Service.TestServiceE,DotNetCoreDemo.Service&quot;</span><span class="hljs-punctuation">,</span><br>      <span class="hljs-attr">&quot;services&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><br>        <span class="hljs-punctuation">&#123;</span><br>          <span class="hljs-attr">&quot;type&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;DotNetCoreDemo.Interface.ITestServiceA,DotNetCoreDemo.Interface&quot;</span><br>        <span class="hljs-punctuation">&#125;</span><br>      <span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span><br>      <span class="hljs-attr">&quot;instanceScope&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;single-instance&quot;</span><span class="hljs-punctuation">,</span> <span class="hljs-comment">//生命周期</span><br>      <span class="hljs-attr">&quot;injectProperties&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-keyword">true</span> <span class="hljs-comment">// 是否支持属性注入</span><br><span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br></code></pre></td></tr></table></figure>

<p><img src="https://blogimage-1255495010.cos.ap-beijing.myqcloud.com/image-20210829182152021.png" srcset="/img/loading.gif" lazyload alt="image-20210829182152021"></p>
</li>
</ol>
<h3 id="Autofac-整合到MVC"><a href="#Autofac-整合到MVC" class="headerlink" title="Autofac 整合到MVC"></a>Autofac 整合到MVC</h3><ol>
<li><p>Autofac 是一个第三方容器，需要在Program 中告诉框架，要是使用哪个IOC工厂。(AutofacServiceProviderFactory)</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs CSharp"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> IHostBuilder <span class="hljs-title">CreateHostBuilder</span>(<span class="hljs-params"><span class="hljs-built_in">string</span>[] args</span>)</span> =&gt;<br>            Host.CreateDefaultBuilder(args)<br>            .ConfigureWebHostDefaults(webBuilder =&gt;<br>            &#123;<br>                webBuilder.UseStartup&lt;Startup&gt;();<br>            &#125;)<br>            .UseServiceProviderFactory(<span class="hljs-keyword">new</span> AutofacServiceProviderFactory());<br></code></pre></td></tr></table></figure></li>
<li><p>Startup 文件中新增方法，这个方法被 Autofac 承包了，是个默认执行的方法</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs CSharp"><span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;summary&gt;</span></span><br><span class="hljs-comment"><span class="hljs-doctag">///</span> Autofac 此方法会在加载的时候默认执行</span><br><span class="hljs-comment"><span class="hljs-doctag">///</span> </span><br><span class="hljs-comment"><span class="hljs-doctag">///</span> 有了此方法，不意味着原生的注册方法不灵了，原生的注册方法照样好使</span><br><span class="hljs-comment"><span class="hljs-doctag">///</span> </span><br><span class="hljs-comment"><span class="hljs-doctag">///</span> 注意：在Autofac注册的时候，会将原生的注册方法都接管过来。</span><br><span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;/summary&gt;</span></span><br><span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;param name=&quot;container&quot;&gt;</span><span class="hljs-doctag">&lt;/param&gt;</span></span><br><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">ConfigureContainer</span>(<span class="hljs-params">ContainerBuilder container</span>)</span><br>&#123;<br>    <span class="hljs-comment">//前三个注册服务交给原生注册方法</span><br>    <span class="hljs-comment">//container.RegisterType&lt;TestServiceA&gt;().As&lt;ITestServiceA&gt;();</span><br>    <span class="hljs-comment">//container.RegisterType&lt;TestServiceB&gt;().As&lt;ITestServiceB&gt;();</span><br>    <span class="hljs-comment">//container.RegisterType&lt;TestServiceC&gt;().As&lt;ITestServiceC&gt;();</span><br>    <span class="hljs-comment">//这个给Autofac注册，关注AutofaCollection 知否正常执行</span><br>    container.RegisterType&lt;TestServiceD&gt;().As&lt;ITestServiceD&gt;().PropertiesAutowired();<br>&#125;<br></code></pre></td></tr></table></figure></li>
<li><p>需要注意：</p>
<ol>
<li>ConfigureContainer() 方法是默认执行的；</li>
<li>有了此方法，不意味着原生的注册方法不灵了，原生的注册方法照样好使；</li>
<li>在Autofac注册的时候，会将原生的注册方法都接管过来，这样在使用时候就连贯了。</li>
</ol>
</li>
</ol>
<h3 id="Autofac-支持控制器属性注入"><a href="#Autofac-支持控制器属性注入" class="headerlink" title="Autofac 支持控制器属性注入"></a>Autofac 支持控制器属性注入</h3><ol>
<li><p>指定控制器的实例让容器来创建 – Startup ConfigureServices()</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs CSharp"><span class="hljs-meta">#<span class="hljs-keyword">region</span> 指定控制器的实例让容器来创建,告诉框架，要使用Autofac容器来创建控制器的实例。</span><br><br>services.Replace(ServiceDescriptor.Transient&lt;IControllerActivator, ServiceBasedControllerActivator&gt;());<br><br><span class="hljs-meta">#<span class="hljs-keyword">endregion</span></span><br></code></pre></td></tr></table></figure></li>
<li><p>注册所有控制器的关系+控制器实例化所需要的所有组件 – Startup ConfigureContainer()</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs CSharp"><span class="hljs-meta">#<span class="hljs-keyword">region</span> 注册所有控制器的关系+控制器实例化所需要的所有组件</span><br><br>Type[] controllerTypesInAssmbly = <span class="hljs-keyword">typeof</span>(Startup).Assembly.GetExportedTypes().Where(type =&gt; <span class="hljs-keyword">typeof</span>(ControllerBase).IsAssignableFrom(type)).ToArray();<br><br><span class="hljs-comment">//注册属性，具体注册哪些属性，交给 CustomPropertySelector()</span><br><span class="hljs-comment">//CustomPropertySelector()方法会通过CustomPropertyAttribute这个特性去查找、返回</span><br>container.RegisterTypes(controllerTypesInAssmbly).PropertiesAutowired(<span class="hljs-keyword">new</span> CustomPropertySelector());<br></code></pre></td></tr></table></figure></li>
<li><p><code>CustomPropertySelector</code> 帮助框架去查找符合条件的属性</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs CSharp"><span class="hljs-keyword">using</span> Autofac.Core;<br><span class="hljs-keyword">using</span> System;<br><span class="hljs-keyword">using</span> System.Collections.Generic;<br><span class="hljs-keyword">using</span> System.Linq;<br><span class="hljs-keyword">using</span> System.Reflection;<br><span class="hljs-keyword">using</span> System.Threading.Tasks;<br><br><span class="hljs-keyword">namespace</span> <span class="hljs-title">DotNetCoreDemo.Utility</span><br>&#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">CustomPropertySelector</span> : <span class="hljs-title">IPropertySelector</span><br>    &#123;<br>        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-built_in">bool</span> <span class="hljs-title">InjectProperty</span>(<span class="hljs-params">PropertyInfo propertyInfo, <span class="hljs-built_in">object</span> instance</span>)</span><br>        &#123;<br>            <span class="hljs-comment">//需要一个判断维度,只有满足属性是CustomPropertyAttribute的才能返回 true</span><br>            <span class="hljs-keyword">return</span> propertyInfo.CustomAttributes.Any(it =&gt; it.AttributeType == <span class="hljs-keyword">typeof</span>(CustomPropertyAttribute));<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure></li>
<li><p><code>CustomPropertyAttribute</code> 自定义特性</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs CSharp"><span class="hljs-keyword">using</span> System;<br><span class="hljs-keyword">using</span> System.Collections.Generic;<br><span class="hljs-keyword">using</span> System.Linq;<br><span class="hljs-keyword">using</span> System.Threading.Tasks;<br><br><span class="hljs-keyword">namespace</span> <span class="hljs-title">DotNetCoreDemo.Utility</span><br>&#123;<br>    <span class="hljs-comment">//添加特性类，并且标注这个是专门用在属性上的</span><br>    [<span class="hljs-meta">AttributeUsage(AttributeTargets.Property)</span>]<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">CustomPropertyAttribute</span> : <span class="hljs-title">Attribute</span><br>    &#123;<br><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure></li>
<li><p>监控判断属性</p>
<p><img src="https://blogimage-1255495010.cos.ap-beijing.myqcloud.com/image-20210829200529269.png" srcset="/img/loading.gif" lazyload alt="image-20210829200529269"></p>
<p>判断 _ItestServiceAA 结果为 true ，因为它标注属性了</p>
<p><img src="https://blogimage-1255495010.cos.ap-beijing.myqcloud.com/image-20210829201047537.png" srcset="/img/loading.gif" lazyload alt="image-20210829201047537"></p>
<p>反之 _ItestServiceBB 返回 false </p>
<p><img src="https://blogimage-1255495010.cos.ap-beijing.myqcloud.com/image-20210829200904042.png" srcset="/img/loading.gif" lazyload alt="image-20210829200904042"></p>
</li>
</ol>
<h3 id="Autofac-抽象多实现的问题1"><a href="#Autofac-抽象多实现的问题1" class="headerlink" title="Autofac 抽象多实现的问题1"></a>Autofac 抽象多实现的问题1</h3><p>例如：一个Interface 多个服务实现 ，一对多。</p>
<p><img src="https://blogimage-1255495010.cos.ap-beijing.myqcloud.com/image-20210830232226520.png" srcset="/img/loading.gif" lazyload alt="image-20210830232226520"></p>
<p>遇到这种情况，在注册的时候就会有问题，尤其是在注册完应用的时候。</p>
<p><strong>第一种：</strong></p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs CSharp"><span class="hljs-meta">#<span class="hljs-keyword">region</span> 抽象多实现问题</span><br><br>container.RegisterType&lt;TestServiceA&gt;().As&lt;ITestServiceA&gt;();<br>container.RegisterType&lt;TestServiceE&gt;().As&lt;ITestServiceA&gt;();<br><br><span class="hljs-meta">#<span class="hljs-keyword">endregion</span></span><br></code></pre></td></tr></table></figure>

<p>结果就是</p>
<p><img src="https://blogimage-1255495010.cos.ap-beijing.myqcloud.com/image-20210830232929753.png" srcset="/img/loading.gif" lazyload alt="image-20210830232929753"></p>
<p>结论就是：</p>
<p>在同一个接口下多个对象的时候，最后注册的那个对象才会生效。</p>
<p><strong>第二种：</strong></p>
<p>使用 <code>IEnumerable&lt;ITestServiceA&gt;</code> 方式，返回多个。</p>
<p><img src="https://blogimage-1255495010.cos.ap-beijing.myqcloud.com/image-20210830233558148.png" srcset="/img/loading.gif" lazyload alt="image-20210830233558148"></p>
<p><strong>第三种：</strong></p>
<p>Startup 中注册所有与<code>ItestServiceA</code>相关的对象</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs CSharp">container.RegisterSource(<span class="hljs-keyword">new</span> AnyConcreteTypeNotAlreadyRegisteredSource(t =&gt; t.IsAssignableTo&lt;ITestServiceA&gt;()));<br></code></pre></td></tr></table></figure>

<p>然后如下图：直接实例化对象（不是Interface），然后通过构造函数接下来使用。</p>
<p><img src="https://blogimage-1255495010.cos.ap-beijing.myqcloud.com/image-20210830234629332.png" srcset="/img/loading.gif" lazyload alt="image-20210830234629332"></p>
<p>扩展一下：</p>
<p>新建 AutofacModule.cs</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs CSharp"><span class="hljs-keyword">using</span> Autofac;<br><span class="hljs-keyword">using</span> Autofac.Features.ResolveAnything;<br><span class="hljs-keyword">using</span> DotNetCoreDemo.Interface;<br><span class="hljs-keyword">using</span> System;<br><span class="hljs-keyword">using</span> System.Collections.Generic;<br><span class="hljs-keyword">using</span> System.Linq;<br><span class="hljs-keyword">using</span> System.Threading.Tasks;<br><br><span class="hljs-keyword">namespace</span> <span class="hljs-title">DotNetCoreDemo.Utility</span><br>&#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">AutofacModule</span> : <span class="hljs-title">Module</span><br>    &#123;<br>        <span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">override</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Load</span>(<span class="hljs-params">ContainerBuilder builder</span>)</span><br>        &#123;<br>            builder.RegisterSource(<span class="hljs-keyword">new</span> AnyConcreteTypeNotAlreadyRegisteredSource(t =&gt; t.IsAssignableTo&lt;ITestServiceA&gt;()));<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>然后修改 Startup <code>container.RegisterModule(new AutofacModule());</code></p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs CSharp"><span class="hljs-meta">#<span class="hljs-keyword">region</span> 抽象多实现问题</span><br><br><span class="hljs-comment"><span class="hljs-doctag">///</span>/1. 正常操作 在同一个接口下多个对象的时候，最后注册的那个对象才会生效。</span><br>container.RegisterType&lt;TestServiceA&gt;().As&lt;ITestServiceA&gt;();<br>container.RegisterType&lt;TestServiceE&gt;().As&lt;ITestServiceA&gt;();<br><br><span class="hljs-comment"><span class="hljs-doctag">///</span>/2. 使用 `IEnumerable<span class="hljs-doctag">&lt;ITestServiceA&gt;</span>` 方式，返回多个。</span><br><br><span class="hljs-comment"><span class="hljs-doctag">///</span>/3. 第三种方式如下，需要在控制器中构造函数承接对象。</span><br><span class="hljs-comment">//container.RegisterSource(new AnyConcreteTypeNotAlreadyRegisteredSource(t =&gt; t.IsAssignableTo&lt;ITestServiceA&gt;()));</span><br><br>container.RegisterModule(<span class="hljs-keyword">new</span> AutofacModule());<br><br><span class="hljs-meta">#<span class="hljs-keyword">endregion</span></span><br></code></pre></td></tr></table></figure>

<p>这样的好处，就是可以分模块注册服务。</p>
<h3 id="Autofac-支持-AOP"><a href="#Autofac-支持-AOP" class="headerlink" title="Autofac 支持 AOP"></a>Autofac 支持 AOP</h3><p><strong>AOP 面向切片编程：在不修改原来代码逻辑的基础上，可以动态的在某个动作之前或者之后执行某些方法。</strong></p>
<ol>
<li><p>主程序 Nugget 引入 <code>Castle.Core</code>  and  <code>Castle.DynamicProxy</code></p>
</li>
<li><p>新建AutoAop 扩展类，建议这个类不要新建在主程序中，可能会引起服务互相依赖的后果。</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs CSharp"><span class="hljs-keyword">using</span> Castle.DynamicProxy;<br><span class="hljs-keyword">using</span> System;<br><span class="hljs-keyword">using</span> System.Collections.Generic;<br><span class="hljs-keyword">using</span> System.Linq;<br><span class="hljs-keyword">using</span> System.Text;<br><span class="hljs-keyword">using</span> System.Threading.Tasks;<br><br><span class="hljs-keyword">namespace</span> <span class="hljs-title">DotNetCoreDemo.Common.AutofacExtension</span><br>&#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">CustomAutofacAOP</span> : <span class="hljs-title">IInterceptor</span><br>    &#123;<br>        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Intercept</span>(<span class="hljs-params">IInvocation invocation</span>)</span><br>        &#123;<br>            Console.WriteLine(<span class="hljs-string">&quot;执行Show前干点事&quot;</span>);<br><br>            invocation.Proceed();<br><br>            Console.WriteLine(<span class="hljs-string">&quot;执行Show后干点事&quot;</span>);<br><br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure></li>
<li><p>在Interface 层想管的类上添加特性 <code>[Intercept(typeof(CustomAutofacAOP))]</code>，为了AOP能在当前接口生效。<em>也得引入 Castle.DynamicProxy</em></p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs CSharp"><span class="hljs-keyword">using</span> Autofac.Extras.DynamicProxy;<br><span class="hljs-keyword">using</span> DotNetCoreDemo.Common.AutofacExtension;<br><span class="hljs-keyword">using</span> System;<br><span class="hljs-keyword">using</span> System.Collections.Generic;<br><span class="hljs-keyword">using</span> System.Linq;<br><span class="hljs-keyword">using</span> System.Text;<br><span class="hljs-keyword">using</span> System.Threading.Tasks;<br><br><span class="hljs-keyword">namespace</span> <span class="hljs-title">DotNetCoreDemo.Interface</span><br>&#123;<br>    [<span class="hljs-meta">Intercept(typeof(CustomAutofacAOP))</span>]<span class="hljs-comment">//为了AOP能在当前接口生效</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title">ITestServiceA</span><br>    &#123;<br>        <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">Show</span>()</span>;<br><br>        <span class="hljs-function"><span class="hljs-built_in">string</span> <span class="hljs-title">ReturnStr</span>(<span class="hljs-params"><span class="hljs-built_in">string</span> str</span>)</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure></li>
<li><p>需要在 Startup.cs 中注册 <code>container.RegisterType(typeof(CustomAutofacAOP));</code></p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs CSharp"><span class="hljs-meta">#<span class="hljs-keyword">region</span> Autofac 支持 AOP</span><br>container.RegisterType(<span class="hljs-keyword">typeof</span>(CustomAutofacAOP));<span class="hljs-comment">//注册</span><br><span class="hljs-comment">//EnableInterfaceInterceptors() 告诉框架这个要支持AOP</span><br>container.RegisterType&lt;TestServiceA&gt;().As&lt;ITestServiceA&gt;().EnableInterfaceInterceptors();<span class="hljs-comment">//接口式支持AOP</span><br><span class="hljs-meta">#<span class="hljs-keyword">endregion</span></span><br></code></pre></td></tr></table></figure></li>
<li><p>应用</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs CSharp"><span class="hljs-keyword">using</span> DotNetCoreDemo.Interface;<br><span class="hljs-keyword">using</span> DotNetCoreDemo.Utility;<br><span class="hljs-keyword">using</span> Microsoft.AspNetCore.Mvc;<br><span class="hljs-keyword">using</span> System;<br><span class="hljs-keyword">using</span> System.Collections.Generic;<br><span class="hljs-keyword">using</span> System.Linq;<br><span class="hljs-keyword">using</span> System.Threading.Tasks;<br><br><span class="hljs-keyword">namespace</span> <span class="hljs-title">DotNetCoreDemo.Controllers</span><br>&#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">FourController</span> : <span class="hljs-title">Controller</span><br>    &#123;<br>        [<span class="hljs-meta">CustomProperty</span>]<br>        <span class="hljs-keyword">private</span> ITestServiceA _ItestServiceAA &#123; <span class="hljs-keyword">get</span>; <span class="hljs-keyword">set</span>; &#125;<br><br>        <span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> ITestServiceA _ItestServiceA = <span class="hljs-literal">null</span>;<br><br>        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">FourController</span>(<span class="hljs-params">ITestServiceA ItestServiceA, ITestServiceA testServiceA</span>)</span><br>        &#123;<br>            _ItestServiceAA = testServiceA;<br><br>            _ItestServiceA = ItestServiceA;<br>        &#125;<br><br>        <span class="hljs-function"><span class="hljs-keyword">public</span> IActionResult <span class="hljs-title">Index</span>()</span><br>        &#123;<br>            _ItestServiceAA.Show();<br><br>            _ItestServiceA.Show();<br><br>            <span class="hljs-keyword">return</span> View();<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure></li>
<li><p>结果</p>
<p><img src="https://blogimage-1255495010.cos.ap-beijing.myqcloud.com/image-20210901221357225.png" srcset="/img/loading.gif" lazyload alt="image-20210901221357225"></p>
</li>
</ol>
<h3 id="Autofac-支持-AOP2"><a href="#Autofac-支持-AOP2" class="headerlink" title="Autofac 支持 AOP2"></a>Autofac 支持 AOP2</h3><p><code>EnableInterfaceInterceptors</code> 支持 <code>Interface</code>中标记<code>[Intercept(typeof(CustomAutofacAOP))]</code>，只要实现这个就可以实现AOP</p>
<p><code>EnableClassInterceptors</code> 支持 <code>Service</code> 中标记 <code>[Intercept(typeof(CustomAutofacAOP))]</code> ,只有标记这个特性，才能支持AOP。</p>
<p><code>EnableClassInterceptors</code>  还需要 设置 虚方法 <code>virtual</code></p>
<p>注意：如果同时使用<code>EnableInterfaceInterceptors</code> 就会重复执行AOP.</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs CSharp"><span class="hljs-keyword">using</span> Autofac.Extras.DynamicProxy;<br><span class="hljs-keyword">using</span> DotNetCoreDemo.Common.AutofacExtension;<br><span class="hljs-keyword">using</span> DotNetCoreDemo.Interface;<br><span class="hljs-keyword">using</span> System;<br><span class="hljs-keyword">using</span> System.Collections.Generic;<br><span class="hljs-keyword">using</span> System.Linq;<br><span class="hljs-keyword">using</span> System.Text;<br><span class="hljs-keyword">using</span> System.Threading.Tasks;<br><br><span class="hljs-keyword">namespace</span> <span class="hljs-title">DotNetCoreDemo.Service</span><br>&#123;<br>    <span class="hljs-comment">//标记特性</span><br>    [<span class="hljs-meta">Intercept(typeof(CustomAutofacAOP))</span>]<span class="hljs-comment">//为了AOP能在当前接口生效</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">TestServiceA</span> : <span class="hljs-title">ITestServiceA</span><br>    &#123;<br>        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">TestServiceA</span>()</span><br>        &#123;<br>            Console.WriteLine(<span class="hljs-keyword">this</span>.GetType().Name + <span class="hljs-string">&quot;构造了&quot;</span>);<br>        &#125;<br><br>        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-built_in">string</span> <span class="hljs-title">ReturnStr</span>(<span class="hljs-params"><span class="hljs-built_in">string</span> str</span>)</span><br>        &#123;<br>            <span class="hljs-keyword">return</span> str + GetType().Name.ToString();<br>        &#125;<br><br>        <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;summary&gt;</span></span><br>        <span class="hljs-comment"><span class="hljs-doctag">///</span> 标记虚方法</span><br>        <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;/summary&gt;</span></span><br>        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">virtual</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Show</span>()</span><br>        &#123;<br>            Console.WriteLine(GetType().Name + <span class="hljs-string">&quot;Show&quot;</span>);<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p><img src="https://blogimage-1255495010.cos.ap-beijing.myqcloud.com/image-20210902225117135.png" srcset="/img/loading.gif" lazyload alt="image-20210902225117135"></p>
<h3 id="Autofac-抽象多个实现构造函数注入"><a href="#Autofac-抽象多个实现构造函数注入" class="headerlink" title="Autofac 抽象多个实现构造函数注入"></a>Autofac 抽象多个实现构造函数注入</h3><ol>
<li><p>先上一波传统手艺</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs CSharp"><span class="hljs-comment">//在 方法 ：ConfigureServices 中</span><br><span class="hljs-meta">#<span class="hljs-keyword">region</span> 一抽象多个实现问题</span><br>&#123;<br>    ContainerBuilder builder = <span class="hljs-keyword">new</span> ContainerBuilder();<br><br>    builder.RegisterType&lt;TestServiceA&gt;().Named&lt;ITestServiceA&gt;(<span class="hljs-string">&quot;TestServiceA&quot;</span>);<br>    builder.RegisterType&lt;TestServiceE&gt;().Named&lt;ITestServiceA&gt;(<span class="hljs-string">&quot;TestServiceE&quot;</span>);<br><br>    IContainer container = builder.Build();<br><br>    ITestServiceA testServiceA1 = container.ResolveKeyed&lt;ITestServiceA&gt;(<span class="hljs-string">&quot;TestServiceA&quot;</span>);<br>    ITestServiceA testServiceA2 = container.ResolveKeyed&lt;ITestServiceA&gt;(<span class="hljs-string">&quot;TestServiceE&quot;</span>);<br><br>    Console.WriteLine(<span class="hljs-string">&quot;一抽象多个实现问题：&quot;</span> + <span class="hljs-built_in">object</span>.ReferenceEquals(testServiceA1, testServiceA2));<br>&#125;<br></code></pre></td></tr></table></figure>

<p><strong>注意 <code>Named</code> 和 <code>ResolveKeyed</code> 搭配使用更丝滑。</strong></p>
<p><img src="https://blogimage-1255495010.cos.ap-beijing.myqcloud.com/image-20210903214211926.png" srcset="/img/loading.gif" lazyload alt="image-20210903214211926"></p>
</li>
<li><p>在通过AutofacIOC 实现一波</p>
<p>Startup.cs  - ConfigureContainer 注册 ，注意 <code>Named</code> ，同时实现AOP</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs CSharp"><span class="hljs-meta">#<span class="hljs-keyword">region</span> 一抽象多实现问题2</span><br>&#123;<br>container.RegisterType&lt;TestServiceA&gt;().Named&lt;ITestServiceA&gt;(<span class="hljs-string">&quot;TestServiceA&quot;</span>).EnableClassInterceptors();<br>container.RegisterType&lt;TestServiceE&gt;().Named&lt;ITestServiceA&gt;(<span class="hljs-string">&quot;TestServiceE&quot;</span>).EnableClassInterceptors();<br>&#125;<br></code></pre></td></tr></table></figure>

<p>应用：</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs CSharp">ITestServiceA obja = _componentContext.ResolveNamed&lt;ITestServiceA&gt;(<span class="hljs-string">&quot;TestServiceA&quot;</span>);<br>ITestServiceA objb = _componentContext.ResolveNamed&lt;ITestServiceA&gt;(<span class="hljs-string">&quot;TestServiceE&quot;</span>);<br></code></pre></td></tr></table></figure>

<p>全文：需要注意注册 Autofac 上下文</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><code class="hljs CSharp"><span class="hljs-keyword">using</span> Autofac;<br><span class="hljs-keyword">using</span> DotNetCoreDemo.Interface;<br><span class="hljs-keyword">using</span> DotNetCoreDemo.Utility;<br><span class="hljs-keyword">using</span> Microsoft.AspNetCore.Mvc;<br><span class="hljs-keyword">using</span> System;<br><span class="hljs-keyword">using</span> System.Collections.Generic;<br><span class="hljs-keyword">using</span> System.Linq;<br><span class="hljs-keyword">using</span> System.Threading.Tasks;<br><br><span class="hljs-keyword">namespace</span> <span class="hljs-title">DotNetCoreDemo.Controllers</span><br>&#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">FourController</span> : <span class="hljs-title">Controller</span><br>    &#123;<br>        [<span class="hljs-meta">CustomProperty</span>]<br>        <span class="hljs-keyword">private</span> ITestServiceA _ItestServiceAA &#123; <span class="hljs-keyword">get</span>; <span class="hljs-keyword">set</span>; &#125;<br><br>        <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;summary&gt;</span></span><br>        <span class="hljs-comment"><span class="hljs-doctag">///</span> Autofac 上下文</span><br>        <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;/summary&gt;</span></span><br>        <span class="hljs-keyword">private</span> IComponentContext _componentContext = <span class="hljs-literal">null</span>;<br><br>        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">FourController</span>(<span class="hljs-params">IComponentContext componentContext</span>)</span><br>        &#123;<br>            _componentContext = componentContext;<br>        &#125;<br><br>        <span class="hljs-function"><span class="hljs-keyword">public</span> IActionResult <span class="hljs-title">Index</span>()</span><br>        &#123;<br>            <span class="hljs-keyword">if</span> (_ItestServiceAA != <span class="hljs-literal">null</span>)<br>            &#123;<br>                _ItestServiceAA.Show();<br>            &#125;<br>           <br>            ITestServiceA obja = _componentContext.ResolveNamed&lt;ITestServiceA&gt;(<span class="hljs-string">&quot;TestServiceA&quot;</span>);<br>            ITestServiceA objb = _componentContext.ResolveNamed&lt;ITestServiceA&gt;(<span class="hljs-string">&quot;TestServiceE&quot;</span>);<br><br>            obja.Show();<br>            objb.Show();<br><br>            <span class="hljs-keyword">return</span> View();<br>        &#125;<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure>



<p><img src="https://blogimage-1255495010.cos.ap-beijing.myqcloud.com/image-20210904135936278.png" srcset="/img/loading.gif" lazyload alt="image-20210904135936278"></p>
<p><img src="https://blogimage-1255495010.cos.ap-beijing.myqcloud.com/image-20210904140002918.png" srcset="/img/loading.gif" lazyload alt="image-20210904140002918"></p>
</li>
</ol>
<h3 id="Autofac-抽象多个实现属性注入"><a href="#Autofac-抽象多个实现属性注入" class="headerlink" title="Autofac 抽象多个实现属性注入"></a>Autofac 抽象多个实现属性注入</h3><p>其他与一个抽象多个实现构造函数注入一样</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs CSharp"><span class="hljs-comment">//首先，把属性注入</span><br>[<span class="hljs-meta">CustomProperty</span>]<br><span class="hljs-keyword">private</span> IComponentContext componentContextprop &#123; <span class="hljs-keyword">get</span>; <span class="hljs-keyword">set</span>; &#125;<br><br>ITestServiceA objc = componentContextprop.ResolveNamed&lt;ITestServiceA&gt;(<span class="hljs-string">&quot;TestServiceA&quot;</span>);<br>ITestServiceA objd = componentContextprop.ResolveNamed&lt;ITestServiceA&gt;(<span class="hljs-string">&quot;TestServiceE&quot;</span>);<br></code></pre></td></tr></table></figure>

<p>全文：</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><code class="hljs CSharp"><span class="hljs-keyword">using</span> Autofac;<br><span class="hljs-keyword">using</span> DotNetCoreDemo.Interface;<br><span class="hljs-keyword">using</span> DotNetCoreDemo.Utility;<br><span class="hljs-keyword">using</span> Microsoft.AspNetCore.Mvc;<br><span class="hljs-keyword">using</span> System;<br><span class="hljs-keyword">using</span> System.Collections.Generic;<br><span class="hljs-keyword">using</span> System.Linq;<br><span class="hljs-keyword">using</span> System.Threading.Tasks;<br><br><span class="hljs-keyword">namespace</span> <span class="hljs-title">DotNetCoreDemo.Controllers</span><br>&#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">FourController</span> : <span class="hljs-title">Controller</span><br>    &#123;<br>        [<span class="hljs-meta">CustomProperty</span>]<br>        <span class="hljs-keyword">private</span> ITestServiceA _ItestServiceAA &#123; <span class="hljs-keyword">get</span>; <span class="hljs-keyword">set</span>; &#125;<br><br>        [<span class="hljs-meta">CustomProperty</span>]<br>        <span class="hljs-keyword">private</span> IComponentContext componentContextprop &#123; <span class="hljs-keyword">get</span>; <span class="hljs-keyword">set</span>; &#125;<br><br>        <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;summary&gt;</span></span><br>        <span class="hljs-comment"><span class="hljs-doctag">///</span> Autofac 上下文</span><br>        <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;/summary&gt;</span></span><br>        <span class="hljs-keyword">private</span> IComponentContext _componentContext = <span class="hljs-literal">null</span>;<br><br>        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">FourController</span>(<span class="hljs-params">IComponentContext componentContext</span>)</span><br>        &#123;<br>            _componentContext = componentContext;<br>        &#125;<br><br>        <span class="hljs-function"><span class="hljs-keyword">public</span> IActionResult <span class="hljs-title">Index</span>()</span><br>        &#123;<br>            <span class="hljs-keyword">if</span> (_ItestServiceAA != <span class="hljs-literal">null</span>)<br>            &#123;<br>                _ItestServiceAA.Show();<br>            &#125;<br>            <br>            ITestServiceA obja = _componentContext.ResolveNamed&lt;ITestServiceA&gt;(<span class="hljs-string">&quot;TestServiceA&quot;</span>);<br>            ITestServiceA objb = _componentContext.ResolveNamed&lt;ITestServiceA&gt;(<span class="hljs-string">&quot;TestServiceE&quot;</span>);<br><br>            obja.Show();<br>            objb.Show();<br><br>            ITestServiceA objc = componentContextprop.ResolveNamed&lt;ITestServiceA&gt;(<span class="hljs-string">&quot;TestServiceA&quot;</span>);<br>            ITestServiceA objd = componentContextprop.ResolveNamed&lt;ITestServiceA&gt;(<span class="hljs-string">&quot;TestServiceE&quot;</span>);<br><br>            objc.Show();<br>            objd.Show();<br><br>            <span class="hljs-keyword">return</span> View();<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h2 id="Filter"><a href="#Filter" class="headerlink" title="Filter"></a>Filter</h2><p>AOP ：可以在不修改之前的代码的情况下动态增加新的功能。</p>
<p>Filter : 过滤器 ActionFilter 即动作过滤器</p>
<h3 id="ActionFilter-AOP"><a href="#ActionFilter-AOP" class="headerlink" title="ActionFilter+AOP"></a>ActionFilter+AOP</h3><ol>
<li><p>新建 CustomActionFilterAttrubute.cs <strong>特性</strong>，并且继承 IActionFilter 接口 和实现 IActionFilter 接口</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs CSharp"><span class="hljs-keyword">using</span> Microsoft.AspNetCore.Mvc.Filters;<br><span class="hljs-keyword">using</span> System;<br><span class="hljs-keyword">using</span> System.Collections.Generic;<br><span class="hljs-keyword">using</span> System.Linq;<br><span class="hljs-keyword">using</span> System.Threading.Tasks;<br><br><span class="hljs-keyword">namespace</span> <span class="hljs-title">DotNetCoreDemo.Utility</span><br>&#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">CustomActionFilterAttribute</span> : <span class="hljs-title">Attribute</span>, <span class="hljs-title">IActionFilter</span><br>    &#123;<br><br>        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">OnActionExecuting</span>(<span class="hljs-params">ActionExecutingContext context</span>)</span><br>        &#123;<br>            Console.WriteLine(<span class="hljs-string">&quot;OnActionExecuting 执行&quot;</span>);<br>        &#125;<br><br><br>        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">OnActionExecuted</span>(<span class="hljs-params">ActionExecutedContext context</span>)</span><br>        &#123;<br>            Console.WriteLine(<span class="hljs-string">&quot;OnActionExecuted 执行&quot;</span>);<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure></li>
<li><p>控制器类 需要在对应的Action 方法上标记 <code>[CustomActionFilterAttribute]</code>特性</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs CSharp"><span class="hljs-keyword">using</span> DotNetCoreDemo.Utility;<br><span class="hljs-keyword">using</span> Microsoft.AspNetCore.Mvc;<br><span class="hljs-keyword">using</span> System;<br><span class="hljs-keyword">using</span> System.Collections.Generic;<br><span class="hljs-keyword">using</span> System.Linq;<br><span class="hljs-keyword">using</span> System.Threading.Tasks;<br><br><span class="hljs-keyword">namespace</span> <span class="hljs-title">DotNetCoreDemo.Controllers</span><br>&#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">FiveController</span> : <span class="hljs-title">Controller</span><br>    &#123;<br>        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">FiveController</span>()</span><br>        &#123;<br>            Console.WriteLine(<span class="hljs-string">&quot;FiveController 被构造&quot;</span>);<br>        &#125;<br><br>        [<span class="hljs-meta">CustomActionFilterAttribute</span>]<br>        <span class="hljs-function"><span class="hljs-keyword">public</span> IActionResult <span class="hljs-title">Index</span>()</span><br>        &#123;<br>            <span class="hljs-keyword">return</span> View();<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>如下图，执行顺序为：</p>
<ol>
<li>CustomActionFilterAttribute - OnActionExecuting</li>
<li>Action</li>
<li>CustomActionFilterAttribute - OnActionExecuted</li>
</ol>
<p><img src="https://blogimage-1255495010.cos.ap-beijing.myqcloud.com/image-20210904154410691.png" srcset="/img/loading.gif" lazyload alt="image-20210904154410691"></p>
</li>
</ol>
<h3 id="ActionFilter-多种实现"><a href="#ActionFilter-多种实现" class="headerlink" title="ActionFilter 多种实现"></a>ActionFilter 多种实现</h3><ol>
<li>通过继承 <code>IActionFilter</code> 实现接口来实现具体前后的功能。</li>
<li>通过继承 <code>ActionFilterAttribute</code> 通过override 重写方法。（系统框架提供）</li>
<li>通过继承 <code>IAnsyncActionFilter</code> 实现接口实现，此为异步版本。</li>
</ol>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><code class="hljs CSharp"><span class="hljs-keyword">using</span> Microsoft.AspNetCore.Mvc.Filters;<br><span class="hljs-keyword">using</span> System;<br><span class="hljs-keyword">using</span> System.Collections.Generic;<br><span class="hljs-keyword">using</span> System.Linq;<br><span class="hljs-keyword">using</span> System.Threading.Tasks;<br><br><span class="hljs-keyword">namespace</span> <span class="hljs-title">DotNetCoreDemo.Utility</span><br>&#123;<br>    <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;summary&gt;</span></span><br>    <span class="hljs-comment"><span class="hljs-doctag">///</span> 自定义版本</span><br>    <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;/summary&gt;</span></span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">CustomActionFilterAttribute</span> : <span class="hljs-title">Attribute</span>, <span class="hljs-title">IActionFilter</span><br>    &#123;<br>        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">OnActionExecuting</span>(<span class="hljs-params">ActionExecutingContext context</span>)</span><br>        &#123;<br>            Console.WriteLine(<span class="hljs-string">&quot;OnActionExecuting 执行&quot;</span>);<br>        &#125;<br><br>        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">OnActionExecuted</span>(<span class="hljs-params">ActionExecutedContext context</span>)</span><br>        &#123;<br>            Console.WriteLine(<span class="hljs-string">&quot;OnActionExecuted 执行&quot;</span>);<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;summary&gt;</span></span><br>    <span class="hljs-comment"><span class="hljs-doctag">///</span> 提供提供版本</span><br>    <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;/summary&gt;</span></span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">CustomActionFilterChildeAttribute</span> : <span class="hljs-title">ActionFilterAttribute</span><br>    &#123;<br>        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">override</span> <span class="hljs-keyword">void</span> <span class="hljs-title">OnActionExecuting</span>(<span class="hljs-params">ActionExecutingContext context</span>)</span><br>        &#123;<br>            Console.WriteLine(<span class="hljs-string">&quot; OnActionExecuting 执行&quot;</span>);<br>        &#125;<br><br>        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">override</span> <span class="hljs-keyword">void</span> <span class="hljs-title">OnActionExecuted</span>(<span class="hljs-params">ActionExecutedContext context</span>)</span><br>        &#123;<br>            Console.WriteLine(<span class="hljs-string">&quot;OnActionExecuted 执行&quot;</span>);<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;summary&gt;</span></span><br>    <span class="hljs-comment"><span class="hljs-doctag">///</span> 异步版本 这个后面再研究</span><br>    <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;/summary&gt;</span></span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">CustomActionFilterAsyncAttribute</span> : <span class="hljs-title">IAsyncActionFilter</span><br>    &#123;<br>        <span class="hljs-function"><span class="hljs-keyword">public</span> Task <span class="hljs-title">OnActionExecutionAsync</span>(<span class="hljs-params">ActionExecutingContext context, ActionExecutionDelegate next</span>)</span><br>        &#123;<br>            <span class="hljs-keyword">return</span> Task.Run(() =&gt;<br>            &#123;<br><br>            &#125;);<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h3 id="ActionFilter-做日志"><a href="#ActionFilter-做日志" class="headerlink" title="ActionFilter 做日志"></a>ActionFilter 做日志</h3><ol>
<li><p>先上结果。</p>
<ol>
<li>先写构造方法</li>
<li>执行Action-Index 之前执行操作</li>
<li>执行Action-Index</li>
<li>执行Action-Index 之后执行操作</li>
</ol>
<p><img src="https://blogimage-1255495010.cos.ap-beijing.myqcloud.com/image-20210904204835244.png" srcset="/img/loading.gif" lazyload alt="image-20210904204835244"></p>
</li>
<li><p>自定义版本中写的，需要注意Ilogger 的注册，还有就是context的各种扩展功能。</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs CSharp"><span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;summary&gt;</span></span><br><span class="hljs-comment"><span class="hljs-doctag">///</span> 自定义版本</span><br><span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;/summary&gt;</span></span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">CustomActionFilterAttribute</span> : <span class="hljs-title">Attribute</span>, <span class="hljs-title">IActionFilter</span><br>&#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">readonly</span> ILogger&lt;CustomActionFilterAttribute&gt; _logger = <span class="hljs-literal">null</span>;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">CustomActionFilterAttribute</span>(<span class="hljs-params">ILogger&lt;CustomActionFilterAttribute&gt; logger</span>)</span><br>    &#123;<br>        Console.WriteLine(<span class="hljs-string">&quot;CustomActionFilterAttribute 构造&quot;</span>);<br><br>        _logger = logger;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">OnActionExecuting</span>(<span class="hljs-params">ActionExecutingContext context</span>)</span><br>    &#123;<br>        _logger.LogInformation(<span class="hljs-string">&quot;OnActionExecuting 开始&quot;</span>);<br><br>  _logger.LogInformation(Newtonsoft.Json.JsonConvert.SerializeObject(context.HttpContext.Request.Query));<br><br>        _logger.LogInformation(<span class="hljs-string">&quot;OnActionExecuting 结束&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">OnActionExecuted</span>(<span class="hljs-params">ActionExecutedContext context</span>)</span><br>    &#123;<br>        _logger.LogInformation(<span class="hljs-string">&quot;OnActionExecuted 开始&quot;</span>);<br><br>        _logger.LogInformation(Newtonsoft.Json.JsonConvert.SerializeObject(context.Result));<br><br>        _logger.LogInformation(<span class="hljs-string">&quot;OnActionExecuted 结束&quot;</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure></li>
<li><p>控制器代码</p>
<p>这里需要注意的是，由于修改了上述的代码，导致给Action特性<code>[CustomActionFilterAttribute]</code>会报错，所以将Action特性修改为<code>[TypeFilter(typeof(CustomActionFilterAttribute))]</code> 为的是让<code>CustomActionFilterAttribute</code> 可以支持依赖注入。</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs CSharp"><span class="hljs-keyword">using</span> DotNetCoreDemo.Utility;<br><span class="hljs-keyword">using</span> Microsoft.AspNetCore.Mvc;<br><span class="hljs-keyword">using</span> Microsoft.Extensions.Logging;<br><span class="hljs-keyword">using</span> System;<br><span class="hljs-keyword">using</span> System.Collections.Generic;<br><span class="hljs-keyword">using</span> System.Linq;<br><span class="hljs-keyword">using</span> System.Threading.Tasks;<br><br><span class="hljs-keyword">namespace</span> <span class="hljs-title">DotNetCoreDemo.Controllers</span><br>&#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">FiveController</span> : <span class="hljs-title">Controller</span><br>    &#123;<br>        <span class="hljs-keyword">private</span> ILogger&lt;FiveController&gt; _ilogger = <span class="hljs-literal">null</span>;<br><br>        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">FiveController</span>(<span class="hljs-params">ILogger&lt;FiveController&gt; logger</span>)</span><br>        &#123;<br>            _ilogger = logger;<br><br>            _ilogger.LogInformation(<span class="hljs-string">&quot;FiveController 被构造&quot;</span>);<br>        &#125;<br><br>        <span class="hljs-comment">//[CustomActionFilterAttribute]</span><br>        <span class="hljs-comment">//[CustomActionFilterChildeAttribute]</span><br><br>        [<span class="hljs-meta">TypeFilter(typeof(CustomActionFilterAttribute))</span>]<br>        <span class="hljs-function"><span class="hljs-keyword">public</span> IActionResult <span class="hljs-title">Index</span>()</span><br>        &#123;<br>            _ilogger.LogInformation(<span class="hljs-string">&quot;执行FiveController Index Action&quot;</span>);<br><br>            <span class="hljs-keyword">return</span> View();<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure></li>
</ol>
<h3 id="Filter-多种注册"><a href="#Filter-多种注册" class="headerlink" title="Filter 多种注册"></a>Filter 多种注册</h3><ol>
<li><p>CustomActionFilterAttribute]  必须是无参构造函数才行，可以结合上一节内容</p>
</li>
<li><p>[TypeFilter(typeof(CustomActionFilterAttribute))] 可以无参构造函数，可以支持依赖注入</p>
</li>
<li><p>[ServiceFilter(typeof(CustomActionFilterAttribute))] 可以无参构造函数，可以支持依赖注入，但是必须注册服务</p>
<p>Startup.cs</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs CSharp"><span class="hljs-comment">//注册自定义Filter扩展，且支持属性注入（PropertiesAutowired）</span><br>container.RegisterType(<span class="hljs-keyword">typeof</span>(CustomActionFilterAttribute)).PropertiesAutowired();<br></code></pre></td></tr></table></figure>

<p>CustomActionFilterAttribute</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs CSharp"><span class="hljs-comment">//属性</span><br><span class="hljs-keyword">public</span> ILogger&lt;CustomActionFilterAttribute&gt; loggerProp &#123; <span class="hljs-keyword">get</span>; <span class="hljs-keyword">set</span>; &#125;<br><br><span class="hljs-comment">//应用，别写在构造函数里</span><br>loggerProp.LogInformation(<span class="hljs-string">&quot;CustomActionFilterAttribute 支持属性注入&quot;</span>);<br></code></pre></td></tr></table></figure></li>
</ol>
<h3 id="FilterFactory-扩展"><a href="#FilterFactory-扩展" class="headerlink" title="FilterFactory 扩展"></a>FilterFactory 扩展</h3><p>本节相当于是对 Filter 多种注册中 TypeFilter 与 ServiceFilter 为什么可以支持依赖注册的递进理解，因为一定是IOC在后面站台。</p>
<p>把 TypeFilter 与 ServiceFilter 后面的大哥 <code>IFilterFactory</code> 提溜出来盘盘。</p>
<ol>
<li><p>首先先创建一个自定义的类 <code>CustomActionFilterFactory</code>, 继承<code>Attribute</code> 实现 <code>IFilterFactory</code> 接口</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs CSharp"><span class="hljs-keyword">using</span> Microsoft.AspNetCore.Mvc.Filters;<br><span class="hljs-keyword">using</span> System;<br><span class="hljs-keyword">using</span> System.Collections.Generic;<br><span class="hljs-keyword">using</span> System.Linq;<br><span class="hljs-keyword">using</span> System.Threading.Tasks;<br><br><span class="hljs-keyword">namespace</span> <span class="hljs-title">DotNetCoreDemo.Utility.Filter</span><br>&#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">CustomActionFilterFactory</span> : <span class="hljs-title">Attribute</span>, <span class="hljs-title">IFilterFactory</span><br>    &#123;<br>        <span class="hljs-keyword">public</span> <span class="hljs-keyword">readonly</span> Type _type = <span class="hljs-literal">null</span>;<br><br>        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">CustomActionFilterFactory</span>(<span class="hljs-params">Type type</span>)</span><br>        &#123;<br>            _type = type;<br>        &#125;<br><br>        <span class="hljs-keyword">public</span> <span class="hljs-built_in">bool</span> IsReusable =&gt; <span class="hljs-literal">true</span>;<br><br>        <span class="hljs-function"><span class="hljs-keyword">public</span> IFilterMetadata <span class="hljs-title">CreateInstance</span>(<span class="hljs-params">IServiceProvider serviceProvider</span>)</span><br>        &#123;<br>            <span class="hljs-built_in">object</span> oInstance = serviceProvider.GetService(_type);<br><br>            <span class="hljs-keyword">return</span> (IFilterMetadata)oInstance;<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure></li>
<li><p>然后，替换 TypeFilter 和 ServiceFilter 的地位，将 <code>CustomActionFilterFactory</code> 特性用上。</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><code class="hljs CSharp"><span class="hljs-keyword">using</span> DotNetCoreDemo.Utility;<br><span class="hljs-keyword">using</span> DotNetCoreDemo.Utility.Filter;<br><span class="hljs-keyword">using</span> Microsoft.AspNetCore.Mvc;<br><span class="hljs-keyword">using</span> Microsoft.Extensions.Logging;<br><span class="hljs-keyword">using</span> System;<br><span class="hljs-keyword">using</span> System.Collections.Generic;<br><span class="hljs-keyword">using</span> System.Linq;<br><span class="hljs-keyword">using</span> System.Threading.Tasks;<br><br><span class="hljs-keyword">namespace</span> <span class="hljs-title">DotNetCoreDemo.Controllers</span><br>&#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">FiveController</span> : <span class="hljs-title">Controller</span><br>    &#123;<br>        <br>        <span class="hljs-keyword">private</span> ILogger&lt;FiveController&gt; _ilogger = <span class="hljs-literal">null</span>;<br><br>        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">FiveController</span>(<span class="hljs-params">ILogger&lt;FiveController&gt; logger</span>)</span><br>        &#123;<br>            _ilogger = logger;<br><br>            _ilogger.LogInformation(<span class="hljs-string">&quot;FiveController 被构造&quot;</span>);<br>        &#125;<br><br>        <span class="hljs-comment">//[CustomActionFilterAttribute]</span><br>        <span class="hljs-comment">//[CustomActionFilterChildeAttribute]</span><br>        <span class="hljs-comment">//[TypeFilter(typeof(CustomActionFilterAttribute))]</span><br>        <span class="hljs-comment">//[ServiceFilter(typeof(CustomActionFilterAttribute))]</span><br>        [<span class="hljs-meta">CustomActionFilterFactory(typeof(CustomActionFilterAttribute))</span>]<br>        <span class="hljs-function"><span class="hljs-keyword">public</span> IActionResult <span class="hljs-title">Index</span>()</span><br>        &#123;<br>            _ilogger.LogInformation(<span class="hljs-string">&quot;执行FiveController Index Action&quot;</span>);<br><br>            <span class="hljs-keyword">return</span> View();<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure></li>
<li><p>结果完美，复盘一下就是CustomActionFilterFactory 实现了 IFilterFactory 接口的功。</p>
</li>
</ol>
<h3 id="Filter-生效范围与执行顺序"><a href="#Filter-生效范围与执行顺序" class="headerlink" title="Filter 生效范围与执行顺序"></a>Filter 生效范围与执行顺序</h3><pre><code>`[CustomActionFilterFactory(typeof(CustomActionFilterAttribute))]`
</code></pre>
<ol>
<li><p>标记在Action 上只对当前 Action 生效</p>
</li>
<li><p>标记在Controller 上，对 当前Controller 中所有Action 生效</p>
</li>
<li><p>全局注册，对当前整个项目所有 Action生效。</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs CSharp"><span class="hljs-comment">// Startup.cs - ConfigureServices</span><br><span class="hljs-meta">#<span class="hljs-keyword">region</span> 全局注册 Filter </span><br><br>    services.AddMvc(option =&gt;<br>    &#123;<br>        option.Filters.Add&lt;CustomActionFilterAttribute&gt;();<br>    &#125;);<br><br><span class="hljs-meta">#<span class="hljs-keyword">endregion</span></span><br></code></pre></td></tr></table></figure></li>
<li><p>如果有三个Filter注册在全局、标记在Controller、标记在 Action 上，执行顺序</p>
<p>如果按照默认（不注入Order的前提）</p>
<ol>
<li>全局 OnActionExecuting</li>
<li>控制器 OnActionExecuting</li>
<li>Action OnActionExecuting</li>
<li>正方法</li>
<li>Action OnActionExecuted</li>
<li>控制器  OnActionExecuted</li>
<li>全局 OnActionExecuted</li>
</ol>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><code class="hljs CSharp"><span class="hljs-keyword">using</span> Microsoft.AspNetCore.Mvc.Filters;<br><span class="hljs-keyword">using</span> System;<br><span class="hljs-keyword">using</span> System.Collections.Generic;<br><span class="hljs-keyword">using</span> System.Linq;<br><span class="hljs-keyword">using</span> System.Threading.Tasks;<br><br><span class="hljs-keyword">namespace</span> <span class="hljs-title">DotNetCoreDemo.Utility.Filter</span><br>&#123;<br>    <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;summary&gt;</span></span><br>    <span class="hljs-comment"><span class="hljs-doctag">///</span> 用来注册全局的</span><br>    <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;/summary&gt;</span></span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">TestGlobalActionFilterAttribute</span> : <span class="hljs-title">ActionFilterAttribute</span><br>    &#123;<br>        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">override</span> <span class="hljs-keyword">void</span> <span class="hljs-title">OnActionExecuting</span>(<span class="hljs-params">ActionExecutingContext context</span>)</span><br>        &#123;<br>            Console.WriteLine(<span class="hljs-string">&quot;TestGlobalActionFilterAttribute OnActionExecuting&quot;</span>);<br>        &#125;<br><br>        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">override</span> <span class="hljs-keyword">void</span> <span class="hljs-title">OnActionExecuted</span>(<span class="hljs-params">ActionExecutedContext context</span>)</span><br>        &#123;<br>            Console.WriteLine(<span class="hljs-string">&quot;TestGlobalActionFilterAttribute OnActionExecuted&quot;</span>);<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;summary&gt;</span></span><br>    <span class="hljs-comment"><span class="hljs-doctag">///</span> 用来标记控制器的</span><br>    <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;/summary&gt;</span></span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">TestControllerActionFilterAttribute</span> : <span class="hljs-title">ActionFilterAttribute</span><br>    &#123;<br>        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">override</span> <span class="hljs-keyword">void</span> <span class="hljs-title">OnActionExecuting</span>(<span class="hljs-params">ActionExecutingContext context</span>)</span><br>        &#123;<br>            Console.WriteLine(<span class="hljs-string">&quot;TestControllerActionFilterAttribute OnActionExecuting&quot;</span>);<br>        &#125;<br><br>        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">override</span> <span class="hljs-keyword">void</span> <span class="hljs-title">OnActionExecuted</span>(<span class="hljs-params">ActionExecutedContext context</span>)</span><br>        &#123;<br>            Console.WriteLine(<span class="hljs-string">&quot;TestControllerActionFilterAttribute OnActionExecuted&quot;</span>);<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;summary&gt;</span></span><br>    <span class="hljs-comment"><span class="hljs-doctag">///</span> 用来标记Action的</span><br>    <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;/summary&gt;</span></span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">TestAction_ActionFilterAttribute</span> : <span class="hljs-title">ActionFilterAttribute</span><br>    &#123;<br>        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">override</span> <span class="hljs-keyword">void</span> <span class="hljs-title">OnActionExecuting</span>(<span class="hljs-params">ActionExecutingContext context</span>)</span><br>        &#123;<br>            Console.WriteLine(<span class="hljs-string">&quot;TestAction_ActionFilterAttribute OnActionExecuting&quot;</span>);<br>        &#125;<br><br>        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">override</span> <span class="hljs-keyword">void</span> <span class="hljs-title">OnActionExecuted</span>(<span class="hljs-params">ActionExecutedContext context</span>)</span><br>        &#123;<br>            Console.WriteLine(<span class="hljs-string">&quot;TestAction_ActionFilterAttribute OnActionExecuted&quot;</span>);<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>如果想修改执行顺序</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><code class="hljs CSharp"><span class="hljs-keyword">using</span> DotNetCoreDemo.Utility;<br><span class="hljs-keyword">using</span> DotNetCoreDemo.Utility.Filter;<br><span class="hljs-keyword">using</span> Microsoft.AspNetCore.Mvc;<br><span class="hljs-keyword">using</span> Microsoft.Extensions.Logging;<br><span class="hljs-keyword">using</span> System;<br><span class="hljs-keyword">using</span> System.Collections.Generic;<br><span class="hljs-keyword">using</span> System.Linq;<br><span class="hljs-keyword">using</span> System.Threading.Tasks;<br><br><span class="hljs-keyword">namespace</span> <span class="hljs-title">DotNetCoreDemo.Controllers</span><br>&#123;<br>    <span class="hljs-comment">//标记测试Filter</span><br>    [<span class="hljs-meta">TestControllerActionFilterAttribute(Order =-1)</span>]<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">FiveController</span> : <span class="hljs-title">Controller</span><br>    &#123;<br><br>        <span class="hljs-keyword">private</span> ILogger&lt;FiveController&gt; _ilogger = <span class="hljs-literal">null</span>;<br><br>        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">FiveController</span>(<span class="hljs-params">ILogger&lt;FiveController&gt; logger</span>)</span><br>        &#123;<br>            _ilogger = logger;<br><br>            _ilogger.LogInformation(<span class="hljs-string">&quot;FiveController 被构造&quot;</span>);<br>        &#125;<br><br>        <span class="hljs-comment">//[CustomActionFilterAttribute]</span><br>        <span class="hljs-comment">//[CustomActionFilterChildeAttribute]</span><br>        <span class="hljs-comment">//[TypeFilter(typeof(CustomActionFilterAttribute))]</span><br>        <span class="hljs-comment">//[ServiceFilter(typeof(CustomActionFilterAttribute))]</span><br>        <span class="hljs-comment">//[CustomActionFilterFactory(typeof(CustomActionFilterAttribute))]</span><br>        <span class="hljs-comment">//标记测试Filter</span><br>        [<span class="hljs-meta">TestAction_ActionFilterAttribute(Order =-2)</span>]<br>        <span class="hljs-function"><span class="hljs-keyword">public</span> IActionResult <span class="hljs-title">Index</span>()</span><br>        &#123;<br>            _ilogger.LogInformation(<span class="hljs-string">&quot;执行FiveController Index Action&quot;</span>);<br><br>            <span class="hljs-keyword">return</span> View();<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>上述代码得出的执行顺序就是</p>
<ol>
<li>Action OnActionExecuting</li>
<li>控制器 OnActionExecuting</li>
<li>全局 OnActionExecuting</li>
<li>正方法</li>
<li>全局 OnActionExecuted</li>
<li>控制器  OnActionExecuted</li>
<li>Action OnActionExecuted</li>
</ol>
</li>
</ol>
<h3 id="ResourceFilter-扩展定制-支持缓存"><a href="#ResourceFilter-扩展定制-支持缓存" class="headerlink" title="ResourceFilter 扩展定制-支持缓存"></a>ResourceFilter 扩展定制-支持缓存</h3><p>新建自定义ResourceFilter 扩展类</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs CSharp"><span class="hljs-keyword">using</span> Microsoft.AspNetCore.Mvc;<br><span class="hljs-keyword">using</span> Microsoft.AspNetCore.Mvc.Filters;<br><span class="hljs-keyword">using</span> System;<br><span class="hljs-keyword">using</span> System.Collections.Generic;<br><span class="hljs-keyword">using</span> System.Linq;<br><span class="hljs-keyword">using</span> System.Threading.Tasks;<br><br><span class="hljs-keyword">namespace</span> <span class="hljs-title">DotNetCoreDemo.Utility.Filter</span><br>&#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">CustomResourceFilterAttribute</span> : <span class="hljs-title">Attribute</span>, <span class="hljs-title">IResourceFilter</span><br>    &#123;<br>        <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Dictionary&lt;<span class="hljs-built_in">string</span>, <span class="hljs-built_in">object</span>&gt; CacheDic = <span class="hljs-keyword">new</span> Dictionary&lt;<span class="hljs-built_in">string</span>, <span class="hljs-built_in">object</span>&gt;();<br><br>        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">OnResourceExecuting</span>(<span class="hljs-params">ResourceExecutingContext context</span>)</span><br>        &#123;<br>            <span class="hljs-keyword">var</span> key = context.HttpContext.Request.Path;<br><br>            <span class="hljs-keyword">if</span> (CacheDic.Any(item =&gt; item.Key == key))<br>            &#123;<br>                context.Result = CacheDic[key] <span class="hljs-keyword">as</span> IActionResult;<br>            &#125;<br>        &#125;<br><br>        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">OnResourceExecuted</span>(<span class="hljs-params">ResourceExecutedContext context</span>)</span><br>        &#123;<br>            <span class="hljs-keyword">var</span> key = context.HttpContext.Request.Path;<br><br>            CacheDic[key] = context.Result;<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>控制器应用</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs CSharp">[<span class="hljs-meta">CustomResourceFilterAttribute</span>]<br><span class="hljs-function"><span class="hljs-keyword">public</span> IActionResult <span class="hljs-title">IndexTestResource</span>()</span><br>&#123;<br>    ViewBag.Date = DateTime.Now;<br><br>    <span class="hljs-keyword">return</span> View();<br>&#125;<br></code></pre></td></tr></table></figure>

<p>IndexTestResource.cshtml</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs CSharp"><br>@&#123;<br>    ViewData[<span class="hljs-string">&quot;Title&quot;</span>] = <span class="hljs-string">&quot;IndexTestResource&quot;</span>;<br>&#125;<br><br>&lt;h1&gt;IndexTestResource&lt;/h1&gt;<br><br>&lt;h3&gt;缓存时间：@ViewBag.Date&lt;/h3&gt;<br><br>&lt;h3&gt;页面时间：@DateTime.Now&lt;/h3&gt;<br></code></pre></td></tr></table></figure>

<p>上述主要功能是：新建ResourceFilter扩展特性类，并且在控制器FiveController 中 <code>IndexTestResource</code> Action 标记应用。应用扩展标记的作用是为了建立缓存。相比较ActionFilter ，<strong>ResourceFilter 更适合做缓存</strong>，参考下图</p>
<img src="https://blogimage-1255495010.cos.ap-beijing.myqcloud.com/image-20210905121153341.png" srcset="/img/loading.gif" lazyload alt="image-20210905121153341" style="zoom: 40%;" />

<h3 id="Filter-匿名"><a href="#Filter-匿名" class="headerlink" title="Filter 匿名"></a>Filter 匿名</h3><p>结合 Filter 生效范围与执行顺序来看，如果全局注册 Filter 的话，那么所有Action都会生效，如果这个时候，不想某个Action被生效，那么匿名的作用就来咯。</p>
<p>现在全局注册：<code> TestGlobalActionFilterAttribute</code> </p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs CSharp"><span class="hljs-meta">#<span class="hljs-keyword">region</span> 全局注册 Filter </span><br>services.AddMvc(option =&gt;<br>                    &#123;<br>                        <span class="hljs-comment">//option.Filters.Add&lt;CustomActionFilterAttribute&gt;();</span><br>                        <span class="hljs-comment">//注册全局 测试执行顺序</span><br>                        option.Filters.Add&lt;TestGlobalActionFilterAttribute&gt;();<br>                    &#125;);<br><span class="hljs-meta">#<span class="hljs-keyword">endregion</span></span><br></code></pre></td></tr></table></figure>

<p>现在需要跳过的Action上标注特性：<code>[AllowAnonymousAttribute]</code></p>
<p>然后再去 <code> TestGlobalActionFilterAttribute</code> 添加判断就OK了，不走这玩意<code>TestGlobalActionFilterAttribute</code>了。</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs CSharp"><span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;summary&gt;</span></span><br><span class="hljs-comment"><span class="hljs-doctag">///</span> 用来注册全局的</span><br><span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;/summary&gt;</span></span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">TestGlobalActionFilterAttribute</span> : <span class="hljs-title">ActionFilterAttribute</span><br>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">override</span> <span class="hljs-keyword">void</span> <span class="hljs-title">OnActionExecuting</span>(<span class="hljs-params">ActionExecutingContext context</span>)</span><br>    &#123;<br>        <span class="hljs-comment">//判断执行到这的Action有没有标记AllowAnonymousAttribute 特性</span><br>        <span class="hljs-keyword">if</span> (context.ActionDescriptor.EndpointMetadata.Any(item =&gt; item.GetType() == <span class="hljs-keyword">typeof</span>(AllowAnonymousAttribute)))<br>        &#123;<br>            <span class="hljs-keyword">return</span>;<br>        &#125;<br><br>        Console.WriteLine(<span class="hljs-string">&quot;TestGlobalActionFilterAttribute OnActionExecuting&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">override</span> <span class="hljs-keyword">void</span> <span class="hljs-title">OnActionExecuted</span>(<span class="hljs-params">ActionExecutedContext context</span>)</span><br>    &#123;<br>        <span class="hljs-comment"><span class="hljs-doctag">///</span>/判断执行到这的Action有没有标记AllowAnonymousAttribute 特性</span><br>        <span class="hljs-keyword">if</span> (context.ActionDescriptor.EndpointMetadata.Any(item =&gt; item.GetType() == <span class="hljs-keyword">typeof</span>(AllowAnonymousAttribute)))<br>        &#123;<br>            <span class="hljs-keyword">return</span>;<br>        &#125;<br><br>        Console.WriteLine(<span class="hljs-string">&quot;TestGlobalActionFilterAttribute OnActionExecuted&quot;</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>上面这这个 AllowAnonymousAttribute 也可以自定写个特性，到时候在Action和判断中替换一下特性名称即可。</p>
<p>通过查询资料，这个匿名一般用于授权<code>AuthorizeAttribute</code>。</p>
<h3 id="ExceptionFilter"><a href="#ExceptionFilter" class="headerlink" title="ExceptionFilter"></a>ExceptionFilter</h3><p>这个过滤器就是为了处理异常。</p>
<ol>
<li>首先创建<code>CustomExceptionFilterAttribute</code> 特性，实现<code>IExceptionFilter</code>接口</li>
<li>实现方法中需要判断执行到这的异常有没有被处理</li>
<li>如果没有被处理，那么需要判断异常的源头，如果是<code>ajax</code>请求的异常，返回 Jsonresult，否则，跳转到Error页面显示异常信息。</li>
<li>上述如果没有毛病的话，那就进行全局注册</li>
</ol>
<p><img src="https://blogimage-1255495010.cos.ap-beijing.myqcloud.com/image-20210905161745655.png" srcset="/img/loading.gif" lazyload alt="image-20210905161745655"></p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><code class="hljs CSharp"><span class="hljs-keyword">using</span> Microsoft.AspNetCore.Http;<br><span class="hljs-keyword">using</span> Microsoft.AspNetCore.Mvc;<br><span class="hljs-keyword">using</span> Microsoft.AspNetCore.Mvc.Filters;<br><span class="hljs-keyword">using</span> Microsoft.AspNetCore.Mvc.ModelBinding;<br><span class="hljs-keyword">using</span> Microsoft.AspNetCore.Mvc.ViewFeatures;<br><span class="hljs-keyword">using</span> System;<br><span class="hljs-keyword">using</span> System.Collections.Generic;<br><span class="hljs-keyword">using</span> System.Linq;<br><span class="hljs-keyword">using</span> System.Threading.Tasks;<br><br><span class="hljs-keyword">namespace</span> <span class="hljs-title">DotNetCoreDemo.Utility.Filter</span><br>&#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">CustomExceptionFilterAttribute</span> : <span class="hljs-title">Attribute</span>, <span class="hljs-title">IExceptionFilter</span><br>    &#123;<br>        <span class="hljs-keyword">private</span> IModelMetadataProvider _modelmetadataProvider = <span class="hljs-literal">null</span>;<br><br>        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">CustomExceptionFilterAttribute</span>(<span class="hljs-params">IModelMetadataProvider modelmetadataProvider</span>)</span><br>        &#123;<br>            _modelmetadataProvider = modelmetadataProvider;<br>        &#125;<br><br>        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">OnException</span>(<span class="hljs-params">ExceptionContext context</span>)</span><br>        &#123;<br>            <span class="hljs-keyword">if</span> (!context.ExceptionHandled)<span class="hljs-comment">//如果有异常未被处理</span><br>            &#123;<br>                <span class="hljs-keyword">if</span> (IsAjaxRequest(context.HttpContext.Request))<br>                &#123;<br>                    context.Result = <span class="hljs-keyword">new</span> JsonResult(<span class="hljs-keyword">new</span> &#123; Result = <span class="hljs-literal">false</span>, Msg = context.Exception.Message &#125;);<br>                &#125;<br>                <span class="hljs-keyword">else</span><br>                &#123;<br>                    <span class="hljs-keyword">var</span> result = <span class="hljs-keyword">new</span> ViewResult &#123; ViewName = <span class="hljs-string">&quot;~/Views/Shared/Error.cshtml&quot;</span> &#125;;<br><br>                    result.ViewData = <span class="hljs-keyword">new</span> ViewDataDictionary(_modelmetadataProvider, context.ModelState);<br><br>                    result.ViewData.Add(<span class="hljs-string">&quot;Exception&quot;</span>, context.Exception);<br><br>                    context.Result = result;<span class="hljs-comment">//断路器</span><br>                &#125;<br><br>                <span class="hljs-comment">//处理完给个True</span><br>                context.ExceptionHandled = <span class="hljs-literal">true</span>;<br>            &#125;<br>        &#125;<br><br>        <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-built_in">bool</span> <span class="hljs-title">IsAjaxRequest</span>(<span class="hljs-params">HttpRequest request</span>)</span><br>        &#123;<br>            <span class="hljs-built_in">string</span> header = request.Headers[<span class="hljs-string">&quot;X-Requested-With&quot;</span>];<br><br>            <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;XMLHttpRequest&quot;</span>.Equals(header);<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>Controller </p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs CSharp">[<span class="hljs-meta">TypeFilter(typeof(CustomExceptionFilterAttribute))</span>] <span class="hljs-comment">// 带参的就得这么标记哦</span><br><span class="hljs-function"><span class="hljs-keyword">public</span> IActionResult <span class="hljs-title">IndexException</span>()</span><br>&#123;<br>    <span class="hljs-built_in">int</span> i = <span class="hljs-number">0</span>;<br><br>    <span class="hljs-built_in">int</span> j = <span class="hljs-number">5</span>;<br><br>    <span class="hljs-built_in">int</span> k = j / i;<br><br>    <span class="hljs-keyword">return</span> View();<br>&#125;<br></code></pre></td></tr></table></figure>

<p>Error.cshtml</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs CSharp">@&#123; <br>    ViewData[<span class="hljs-string">&quot;Title&quot;</span>] = <span class="hljs-string">&quot;Error&quot;</span>;<br>    Exception exception = <span class="hljs-keyword">base</span>.ViewData[<span class="hljs-string">&quot;Exception&quot;</span>] <span class="hljs-keyword">as</span> Exception;<br>&#125;<br><br>&lt;h1 <span class="hljs-keyword">class</span>=<span class="hljs-string">&quot;text-danger&quot;</span>&gt;Error.&lt;/h1&gt;<br>&lt;h2 <span class="hljs-keyword">class</span>=<span class="hljs-string">&quot;text-danger&quot;</span>&gt;An error occurred <span class="hljs-keyword">while</span> processing your request.&lt;/h2&gt;<br><br>&lt;h3&gt;Context Exception : @exception.Message&lt;/h3&gt;<br><br></code></pre></td></tr></table></figure>

<p>上述是在Action上标记CustomExceptionFilterAttribute ,最后，再加上全局注册。</p>
<h3 id="ExceptionFilter-能捕捉到的异常"><a href="#ExceptionFilter-能捕捉到的异常" class="headerlink" title="ExceptionFilter 能捕捉到的异常"></a>ExceptionFilter 能捕捉到的异常</h3><table>
<thead>
<tr>
<th>异常分类</th>
<th>可否捕捉</th>
</tr>
</thead>
<tbody><tr>
<td>控制器实例化异常</td>
<td>true</td>
</tr>
<tr>
<td>异常发生在Try Cache中</td>
<td>false（TryCache默认是已经处理过的异常）</td>
</tr>
<tr>
<td>在视图中发生异常</td>
<td>false（会直接体现在页面上）</td>
</tr>
<tr>
<td>Service层发生异常</td>
<td>true</td>
</tr>
<tr>
<td>在Action 中发生异常</td>
<td>true</td>
</tr>
<tr>
<td>请求路径错误异常</td>
<td>true （需要中间件来完成）</td>
</tr>
</tbody></table>
<p>主要阐述下 如果请求路径错误异常需要如何处理</p>
<ol>
<li><p>Startup.cs 中的 Configure 方法中添加中间件，记得放前面点，放最后不管用。</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs CSharp"><span class="hljs-meta">#<span class="hljs-keyword">region</span> 捕捉异常补充</span><br><br>app.UseStatusCodePagesWithReExecute(<span class="hljs-string">&quot;/Home/Error/&#123;0&#125;&quot;</span>);<span class="hljs-comment">//只要不是状态200的请求，都能进来</span><br><br>app.UseExceptionHandler(errorapp =&gt;<br>&#123;<br>      errorapp.Run(<span class="hljs-keyword">async</span> context =&gt;<br>      &#123;<br>          context.Response.StatusCode = <span class="hljs-number">200</span>;<br>          context.Response.ContentType = <span class="hljs-string">&quot;text/html&quot;</span>;<br>          <span class="hljs-keyword">await</span> context.Response.WriteAsync(<span class="hljs-string">&quot;&lt;html lang=\&quot;en\&quot;&gt;&lt;body&gt;\r\n&quot;</span>);<br>          <span class="hljs-keyword">await</span> context.Response.WriteAsync(<span class="hljs-string">&quot;Error! &lt;br&gt;&lt;br&gt;\r\n&quot;</span>);<br>          <span class="hljs-keyword">var</span> exceptionHandlePathFeature = context.Features.Get&lt;IExceptionHandlerPathFeature&gt;();<br>                                             				                                                       Console.WriteLine(<span class="hljs-string">&quot;**********************************************&quot;</span>);            <br>          Console.WriteLine(<span class="hljs-string">$&quot;<span class="hljs-subst">&#123; exceptionHandlePathFeature?.Error.Message&#125;</span>&quot;</span>);<br>          Console.WriteLine(<span class="hljs-string">&quot;**********************************************&quot;</span>);<br><br>          <span class="hljs-keyword">if</span> (exceptionHandlePathFeature?.Error <span class="hljs-keyword">is</span> FileNotFoundException)<br>          &#123;<br>               <span class="hljs-keyword">await</span> context.Response.WriteAsync(<span class="hljs-string">&quot;File Error throw! &lt;br&gt;&lt;br&gt;\r\n&quot;</span>);<br>          &#125;<br><br>          <span class="hljs-keyword">await</span> context.Response.WriteAsync(<span class="hljs-string">&quot;&lt;a href =\&quot;Home/Index\&quot;&gt;Home&lt;/a&gt;&lt;br&gt;&lt;br&gt;\r\n&quot;</span>);<br>          <span class="hljs-keyword">await</span> context.Response.WriteAsync(<span class="hljs-string">&quot;&lt;/body&gt;&lt;/html&gt;&lt;br&gt;&lt;br&gt;\r\n&quot;</span>);<br>          <span class="hljs-keyword">await</span> context.Response.WriteAsync(<span class="hljs-keyword">new</span> <span class="hljs-built_in">string</span>(<span class="hljs-string">&#x27; &#x27;</span>, <span class="hljs-number">512</span>));<br>       &#125;);<br>&#125;);<br><br><span class="hljs-meta">#<span class="hljs-keyword">endregion</span></span><br></code></pre></td></tr></table></figure>

<img src="https://blogimage-1255495010.cos.ap-beijing.myqcloud.com/image-20210905170801999.png" srcset="/img/loading.gif" lazyload alt="image-20210905170801999" style="zoom:50%;" /></li>
</ol>
<h3 id="ResultFilter"><a href="#ResultFilter" class="headerlink" title="ResultFilter"></a>ResultFilter</h3><p>这个过滤器是为了Action 方法里 return view() 服务的，类似AOP这种写法。</p>
<p>下面代码综合之前的Filter的磨砺，路子都差不多，新建一个自定义特性类，继承 Attribute 实现 IResultFilter 方法。</p>
<ol>
<li>IModeIMetadataProvider 是为了接受参数的</li>
<li>通过接收的参数在Controller 标记 <code>[TypeFilter(typeof(CustomResultFilterAttribute))] </code> Action 方法中，在return View() 这个操作时，判断参数跳转不同的cshtml页。</li>
</ol>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><code class="hljs CSharp"><span class="hljs-keyword">using</span> Microsoft.AspNetCore.Mvc;<br><span class="hljs-keyword">using</span> Microsoft.AspNetCore.Mvc.Filters;<br><span class="hljs-keyword">using</span> Microsoft.AspNetCore.Mvc.ModelBinding;<br><span class="hljs-keyword">using</span> Microsoft.AspNetCore.Mvc.ViewFeatures;<br><span class="hljs-keyword">using</span> System;<br><span class="hljs-keyword">using</span> System.Collections.Generic;<br><span class="hljs-keyword">using</span> System.Linq;<br><span class="hljs-keyword">using</span> System.Threading.Tasks;<br><br><span class="hljs-keyword">namespace</span> <span class="hljs-title">DotNetCoreDemo.Utility.Filter</span><br>&#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">CustomResultFilterAttribute</span> : <span class="hljs-title">Attribute</span>, <span class="hljs-title">IResultFilter</span><br>    &#123;<br>        <span class="hljs-keyword">private</span> IModelMetadataProvider _modelmetadataProvider = <span class="hljs-literal">null</span>;<br><br>        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">CustomResultFilterAttribute</span>(<span class="hljs-params">IModelMetadataProvider modelmetadataProvider</span>)</span><br>        &#123;<br>            _modelmetadataProvider = modelmetadataProvider;<br>        &#125;<br><br>        <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;summary&gt;</span></span><br>        <span class="hljs-comment"><span class="hljs-doctag">///</span> 执行视图之前</span><br>        <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;/summary&gt;</span></span><br>        <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;param name=&quot;context&quot;&gt;</span><span class="hljs-doctag">&lt;/param&gt;</span></span><br>        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">OnResultExecuting</span>(<span class="hljs-params">ResultExecutingContext context</span>)</span><br>        &#123;<br>            Console.WriteLine(<span class="hljs-string">&quot;执行视图之前&quot;</span>);<br><br>            <span class="hljs-keyword">var</span> view = context.HttpContext.Request.Query[<span class="hljs-string">&quot;View&quot;</span>];<br><br>            <span class="hljs-keyword">if</span> (view == <span class="hljs-string">&quot;1&quot;</span>)<br>            &#123;<br>                <span class="hljs-keyword">var</span> result = <span class="hljs-keyword">new</span> ViewResult &#123; ViewName = <span class="hljs-string">&quot;~/Views/Five/IndexResult.cshtml&quot;</span> &#125;;<br>                result.ViewData = <span class="hljs-keyword">new</span> ViewDataDictionary(_modelmetadataProvider, context.ModelState);<br>                context.Result = result;<br>            &#125;<br>            <span class="hljs-keyword">else</span><br>            &#123;<br>                <span class="hljs-keyword">var</span> result = <span class="hljs-keyword">new</span> ViewResult &#123; ViewName = <span class="hljs-string">&quot;~/Views/Five/IndexResult_EN.cshtml&quot;</span> &#125;;<br>                result.ViewData = <span class="hljs-keyword">new</span> ViewDataDictionary(_modelmetadataProvider, context.ModelState);<br>                context.Result = result;<br>            &#125;<br>        &#125;<br><br>        <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;summary&gt;</span></span><br>        <span class="hljs-comment"><span class="hljs-doctag">///</span> 执行视图之后</span><br>        <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;/summary&gt;</span></span><br>        <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;param name=&quot;context&quot;&gt;</span><span class="hljs-doctag">&lt;/param&gt;</span></span><br>        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">OnResultExecuted</span>(<span class="hljs-params">ResultExecutedContext context</span>)</span><br>        &#123;<br>            Console.WriteLine(<span class="hljs-string">&quot;执行视图之后&quot;</span>);<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p><img src="https://blogimage-1255495010.cos.ap-beijing.myqcloud.com/image-20210905185056411.png" srcset="/img/loading.gif" lazyload alt="image-20210905185056411"></p>
<h2 id="鉴权授权方式"><a href="#鉴权授权方式" class="headerlink" title="鉴权授权方式"></a>鉴权授权方式</h2><h3 id="Cookie"><a href="#Cookie" class="headerlink" title="Cookie"></a><strong>Cookie</strong></h3><p>代码：<code>SevenController</code></p>
<p>基础授权</p>
<ol>
<li><p>使用鉴权 <code>app.UseAuthentication()</code> 必须放在 <code>app.UseRouting();</code> 后面</p>
</li>
<li><p>Startup.cs - ConfigureServices</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs CSharp"><span class="hljs-meta">#<span class="hljs-keyword">region</span> Auth-cookie-验证</span><br><br>services.AddAuthentication(<span class="hljs-string">&quot;Cookies&quot;</span>).AddCookie(option =&gt;<br>&#123;<br>    option.LoginPath = <span class="hljs-keyword">new</span> Microsoft.AspNetCore.Http.PathString(<span class="hljs-string">&quot;/Seven/LoginOut&quot;</span>);<br>&#125;);<br><br><span class="hljs-meta">#<span class="hljs-keyword">endregion</span></span><br></code></pre></td></tr></table></figure></li>
<li><p>正文</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><code class="hljs CSharp"><span class="hljs-keyword">using</span> Microsoft.AspNetCore.Authentication;<br><span class="hljs-keyword">using</span> Microsoft.AspNetCore.Authorization;<br><span class="hljs-keyword">using</span> Microsoft.AspNetCore.Mvc;<br><span class="hljs-keyword">using</span> System;<br><span class="hljs-keyword">using</span> System.Collections.Generic;<br><span class="hljs-keyword">using</span> System.Linq;<br><span class="hljs-keyword">using</span> System.Security.Claims;<br><span class="hljs-keyword">using</span> System.Threading.Tasks;<br><br><span class="hljs-keyword">namespace</span> <span class="hljs-title">DotNetCoreDemo.Controllers</span><br>&#123;<br>    <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;summary&gt;</span></span><br>    <span class="hljs-comment"><span class="hljs-doctag">///</span> Auth Cookie</span><br>    <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;/summary&gt;</span></span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">SevenController</span> : <span class="hljs-title">Controller</span><br>    &#123;<br>        [<span class="hljs-meta">Authorize</span>]<br>        <span class="hljs-function"><span class="hljs-keyword">public</span> IActionResult <span class="hljs-title">Index</span>()</span><br>        &#123;<br>            <span class="hljs-keyword">return</span> View();<br>        &#125;<br><br>        <span class="hljs-function"><span class="hljs-keyword">public</span> IActionResult <span class="hljs-title">Login</span>()</span><br>        &#123;<br>            List&lt;Claim&gt; Claims = <span class="hljs-keyword">new</span> List&lt;Claim&gt;<br>            &#123;<br>                <span class="hljs-keyword">new</span> Claim(ClaimTypes.Name,<span class="hljs-string">&quot;Harris&quot;</span>),<br>                <span class="hljs-keyword">new</span> Claim(ClaimTypes.Email,<span class="hljs-string">&quot;hou3125378@126.com&quot;</span>),<br>                <span class="hljs-keyword">new</span> Claim(<span class="hljs-string">&quot;Xing&quot;</span>,<span class="hljs-string">&quot;Hou&quot;</span>)<br>            &#125;;<br><br>            ClaimsIdentity identity = <span class="hljs-keyword">new</span> ClaimsIdentity(Claims, <span class="hljs-string">&quot;HarrisIdentity&quot;</span>);<br><br>            HttpContext.SignInAsync(<span class="hljs-keyword">new</span> ClaimsPrincipal(identity));<br><br>            <span class="hljs-keyword">return</span> View();<br>        &#125;<br><br>        <span class="hljs-function"><span class="hljs-keyword">public</span> IActionResult <span class="hljs-title">LoginOut</span>()</span><br>        &#123;<br>            HttpContext.SignOutAsync();<br><br>            <span class="hljs-keyword">return</span> View();<br>        &#125;<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure>

<p>上述代码：可以打开F12，Application-Cookie，观察Cookie的变化。</p>
<p>如果没有Cookie 去访问Index的时候，就会自动跳转到LoginOut，这时候访问Login，记录下Cookie之后，再访问Index就可以了，最后，访问LoginOut,清除Cookie.</p>
</li>
</ol>
<h3 id="JWT"><a href="#JWT" class="headerlink" title="JWT"></a><strong>JWT</strong></h3><p><img src="https://blogimage-1255495010.cos.ap-beijing.myqcloud.com/Token%E9%89%B4%E6%9D%83%E6%8E%88%E6%9D%83.png" srcset="/img/loading.gif" lazyload alt="Token鉴权授权"></p>
<p>上图是访问的过程。</p>
<h4 id="搭建授权中心（WEBAPI）"><a href="#搭建授权中心（WEBAPI）" class="headerlink" title="搭建授权中心（WEBAPI）"></a>搭建授权中心（<code>WEBAPI</code>）</h4><ol>
<li><p>Nugget</p>
<p><img src="https://blogimage-1255495010.cos.ap-beijing.myqcloud.com/image-20211001192934524.png" srcset="/img/loading.gif" lazyload alt="image-20211001192934524"></p>
</li>
<li><p><code>appsettings.json</code> 主要关注 <code>JWTTokenOptions</code></p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs json"><span class="hljs-punctuation">&#123;</span><br>  <span class="hljs-attr">&quot;Logging&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>    <span class="hljs-attr">&quot;LogLevel&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>      <span class="hljs-attr">&quot;Default&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;Information&quot;</span><span class="hljs-punctuation">,</span><br>      <span class="hljs-attr">&quot;Microsoft&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;Warning&quot;</span><span class="hljs-punctuation">,</span><br>      <span class="hljs-attr">&quot;Microsoft.Hosting.Lifetime&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;Information&quot;</span><br>    <span class="hljs-punctuation">&#125;</span><br>  <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">&quot;AllowedHosts&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;*&quot;</span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">&quot;JWTTokenOptions&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>    <span class="hljs-attr">&quot;Audience&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;http://localhost:5200&quot;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;Issuer&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;http://localhost:5200&quot;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;SecurityKey&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;MIGfMA0GCSqGSIb3DQEBAQUAA4GNADCBiQKBgQDI2a2EJ7m872v0afyoSDJT2o1+SitIeJSWtLJU8/Wz2m7gStexajkeD+Lka6DSTy8gt9UwfgVQo6uKjVLG5Ex7PiGOODVqAEghBuS7JzIYU5RvI543nNDAPfnJsas96mSA7L/mD7RTE2drj6hf3oZjJpMPZUQI/B1Qjb5H3K3PNwIDAQAB&quot;</span><br>  <span class="hljs-punctuation">&#125;</span><br><span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure></li>
<li><p>注册</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><code class="hljs CSharp"><span class="hljs-keyword">using</span> DotNetCoreDemo.AuthenticationCenter.Utility;<br><span class="hljs-keyword">using</span> Microsoft.AspNetCore.Builder;<br><span class="hljs-keyword">using</span> Microsoft.AspNetCore.Hosting;<br><span class="hljs-keyword">using</span> Microsoft.AspNetCore.HttpsPolicy;<br><span class="hljs-keyword">using</span> Microsoft.AspNetCore.Mvc;<br><span class="hljs-keyword">using</span> Microsoft.Extensions.Configuration;<br><span class="hljs-keyword">using</span> Microsoft.Extensions.DependencyInjection;<br><span class="hljs-keyword">using</span> Microsoft.Extensions.Hosting;<br><span class="hljs-keyword">using</span> Microsoft.Extensions.Logging;<br><span class="hljs-keyword">using</span> Microsoft.OpenApi.Models;<br><span class="hljs-keyword">using</span> System;<br><span class="hljs-keyword">using</span> System.Collections.Generic;<br><span class="hljs-keyword">using</span> System.Linq;<br><span class="hljs-keyword">using</span> System.Threading.Tasks;<br><br><span class="hljs-keyword">namespace</span> <span class="hljs-title">DotNetCoreDemo.AuthenticationCenter</span><br>&#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">Startup</span><br>    &#123;<br>        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">Startup</span>(<span class="hljs-params">IConfiguration configuration</span>)</span><br>        &#123;<br>            Configuration = configuration;<br>        &#125;<br><br>        <span class="hljs-keyword">public</span> IConfiguration Configuration &#123; <span class="hljs-keyword">get</span>; &#125;<br><br>        <span class="hljs-comment">// This method gets called by the runtime. Use this method to add services to the container.</span><br>        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">ConfigureServices</span>(<span class="hljs-params">IServiceCollection services</span>)</span><br>        &#123;<br>            <span class="hljs-comment">//HS加密方式</span><br>            <span class="hljs-comment">//services.AddTransient&lt;ICustomJWTService, CustomHSJWTService&gt;();</span><br>            <span class="hljs-comment">//RSS加密方式</span><br>            services.AddTransient&lt;ICustomJWTService, CustomRSSJWTervice&gt;();<br>            services.Configure&lt;JWTTokenOptions&gt;(<span class="hljs-keyword">this</span>.Configuration.GetSection(<span class="hljs-string">&quot;JWTTokenOptions&quot;</span>));<br>            services.AddControllers();<br>            services.AddSwaggerGen(c =&gt;<br>            &#123;<br>                c.SwaggerDoc(<span class="hljs-string">&quot;v1&quot;</span>, <span class="hljs-keyword">new</span> OpenApiInfo &#123; Title = <span class="hljs-string">&quot;DotNetCoreDemo.AuthenticationCenter&quot;</span>, Version = <span class="hljs-string">&quot;v1&quot;</span> &#125;);<br>            &#125;);<br>        &#125;<br><br>        <span class="hljs-comment">// This method gets called by the runtime. Use this method to configure the HTTP request pipeline.</span><br>        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Configure</span>(<span class="hljs-params">IApplicationBuilder app, IWebHostEnvironment env</span>)</span><br>        &#123;<br>            <span class="hljs-keyword">if</span> (env.IsDevelopment())<br>            &#123;<br>                app.UseDeveloperExceptionPage();<br>                app.UseSwagger();<br>                app.UseSwaggerUI(c =&gt; c.SwaggerEndpoint(<span class="hljs-string">&quot;/swagger/v1/swagger.json&quot;</span>, <span class="hljs-string">&quot;DotNetCoreDemo.AuthenticationCenter v1&quot;</span>));<br>            &#125;<br><br>            app.UseHttpsRedirection();<br><br>            app.UseRouting();<br><br>            app.UseAuthorization();<br><br>            app.UseEndpoints(endpoints =&gt;<br>            &#123;<br>                endpoints.MapControllers();<br>            &#125;);<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure></li>
<li><p>入口</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><code class="hljs CSharp"><span class="hljs-keyword">using</span> DotNetCoreDemo.AuthenticationCenter.Utility;<br><span class="hljs-keyword">using</span> Microsoft.AspNetCore.Mvc;<br><span class="hljs-keyword">using</span> Newtonsoft.Json;<br><span class="hljs-keyword">using</span> System;<br><span class="hljs-keyword">using</span> System.Collections.Generic;<br><span class="hljs-keyword">using</span> System.Linq;<br><span class="hljs-keyword">using</span> System.Threading.Tasks;<br><br><span class="hljs-keyword">namespace</span> <span class="hljs-title">DotNetCoreDemo.AuthenticationCenter.Controllers</span><br>&#123;<br>    [<span class="hljs-meta">Route(<span class="hljs-string">&quot;api/[controller]&quot;</span>)</span>]<br>    [<span class="hljs-meta">ApiController</span>]<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">AuthenticationController</span> : <span class="hljs-title">Controller</span><br>    &#123;<br>        <span class="hljs-comment">//构造函数注入</span><br>        <span class="hljs-keyword">private</span> ICustomJWTService _iJWTService = <span class="hljs-literal">null</span>;<br>        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">AuthenticationController</span>(<span class="hljs-params">ICustomJWTService customJWTService</span>)</span><br>        &#123;<br>            _iJWTService = customJWTService;<br>        &#125;<br><br>        <span class="hljs-comment">//[Route(&quot;Get&quot;)]</span><br>        <span class="hljs-comment">//[HttpGet]</span><br>        <span class="hljs-comment">//public IEnumerable&lt;int&gt; Get()</span><br>        <span class="hljs-comment">//&#123;</span><br>        <span class="hljs-comment">//    return new List&lt;int&gt;() &#123; 1, 2, 3, 4, 6, 7 &#125;;</span><br>        <span class="hljs-comment">//&#125;</span><br><br>        [<span class="hljs-meta">Route(<span class="hljs-string">&quot;Login&quot;</span>)</span>]<br>        [<span class="hljs-meta">HttpPost</span>]<br>        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-built_in">string</span> <span class="hljs-title">Login</span>(<span class="hljs-params"><span class="hljs-built_in">string</span> name, <span class="hljs-built_in">string</span> password</span>)</span><br>        &#123;<br>            <span class="hljs-comment">//在这里需要去数据库中做数据验证</span><br>            <span class="hljs-keyword">if</span> (<span class="hljs-string">&quot;Harris&quot;</span>.Equals(name) &amp;&amp; <span class="hljs-string">&quot;123456&quot;</span>.Equals(password))<br>            &#123;<br>                <span class="hljs-comment">//就应该生成Token </span><br>                <span class="hljs-built_in">string</span> token = <span class="hljs-keyword">this</span>._iJWTService.GetToken(name, password);<br>                <span class="hljs-keyword">return</span> JsonConvert.SerializeObject(<span class="hljs-keyword">new</span><br>                &#123;<br>                    result = <span class="hljs-literal">true</span>,<br>                    token<br>                &#125;);<br>            &#125;<br>            <span class="hljs-keyword">else</span><br>            &#123;<br>                <span class="hljs-keyword">return</span> JsonConvert.SerializeObject(<span class="hljs-keyword">new</span><br>                &#123;<br>                    result = <span class="hljs-literal">false</span>,<br>                    token = <span class="hljs-string">&quot;&quot;</span><br>                &#125;);<br>            &#125;<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure></li>
<li><p>抽象类</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs CSharp"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title">ICustomJWTService</span><br>&#123;<br>    <span class="hljs-function"><span class="hljs-built_in">string</span> <span class="hljs-title">GetToken</span>(<span class="hljs-params"><span class="hljs-built_in">string</span> UserName, <span class="hljs-built_in">string</span> password</span>)</span>;<br>&#125;<br></code></pre></td></tr></table></figure></li>
<li><p>HS JWT</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><code class="hljs CSharp"><span class="hljs-keyword">using</span> Microsoft.Extensions.Options;<br><span class="hljs-keyword">using</span> Microsoft.IdentityModel.Tokens;<br><span class="hljs-keyword">using</span> System;<br><span class="hljs-keyword">using</span> System.Collections.Generic;<br><span class="hljs-keyword">using</span> System.IdentityModel.Tokens.Jwt;<br><span class="hljs-keyword">using</span> System.Linq;<br><span class="hljs-keyword">using</span> System.Security.Claims;<br><span class="hljs-keyword">using</span> System.Text;<br><span class="hljs-keyword">using</span> System.Threading.Tasks;<br><br><span class="hljs-keyword">namespace</span> <span class="hljs-title">DotNetCoreDemo.AuthenticationCenter.Utility</span><br>&#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">CustomHSJWTService</span> : <span class="hljs-title">ICustomJWTService</span><br>    &#123;<br>        <span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> JWTTokenOptions _JWTTokenOptions;<br>        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">CustomHSJWTService</span>(<span class="hljs-params">IOptionsMonitor&lt;JWTTokenOptions&gt; jwtTokenOptions</span>)</span><br>        &#123;<br>            <span class="hljs-keyword">this</span>._JWTTokenOptions = jwtTokenOptions.CurrentValue;<br>        &#125;<br><br>        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-built_in">string</span> <span class="hljs-title">GetToken</span>(<span class="hljs-params"><span class="hljs-built_in">string</span> UserName, <span class="hljs-built_in">string</span> password</span>)</span><br>        &#123;<br>            <span class="hljs-meta">#<span class="hljs-keyword">region</span> 有效载荷，大家可以自己写，爱写多少写多少；尽量避免敏感信息</span><br>            <span class="hljs-keyword">var</span> claims = <span class="hljs-keyword">new</span>[]<br>            &#123;<br>               <span class="hljs-keyword">new</span> Claim(ClaimTypes.Name, UserName),<br>               <span class="hljs-keyword">new</span> Claim(<span class="hljs-string">&quot;NickName&quot;</span>,UserName),<br>               <span class="hljs-keyword">new</span> Claim(<span class="hljs-string">&quot;Role&quot;</span>,<span class="hljs-string">&quot;Administrator&quot;</span>),<span class="hljs-comment">//传递其他信息   </span><br>               <span class="hljs-keyword">new</span> Claim(<span class="hljs-string">&quot;ABCC&quot;</span>,<span class="hljs-string">&quot;ABCC&quot;</span>),<br>               <span class="hljs-keyword">new</span> Claim(<span class="hljs-string">&quot;Student&quot;</span>,<span class="hljs-string">&quot;甜酱油&quot;</span>)<br>            &#125;;<br><br>            <span class="hljs-comment">//需要加密：需要加密key:</span><br>            <span class="hljs-comment">//Nuget引入：Microsoft.IdentityModel.Tokens</span><br>            SymmetricSecurityKey key = <span class="hljs-keyword">new</span> SymmetricSecurityKey(Encoding.UTF8.GetBytes(_JWTTokenOptions.SecurityKey));<br><br>            SigningCredentials creds = <span class="hljs-keyword">new</span> SigningCredentials(key, SecurityAlgorithms.HmacSha256);<br><br>            <span class="hljs-comment">//Nuget引入：System.IdentityModel.Tokens.Jwt</span><br>            JwtSecurityToken token = <span class="hljs-keyword">new</span> JwtSecurityToken(<br>             issuer: _JWTTokenOptions.Issuer,<br>             audience: _JWTTokenOptions.Audience,<br>             claims: claims,<br>             expires: DateTime.Now.AddMinutes(<span class="hljs-number">5</span>),<span class="hljs-comment">//5分钟有效期</span><br>             signingCredentials: creds);<br><br>            <span class="hljs-built_in">string</span> returnToken = <span class="hljs-keyword">new</span> JwtSecurityTokenHandler().WriteToken(token);<br>            <span class="hljs-keyword">return</span> returnToken;<br>            <span class="hljs-meta">#<span class="hljs-keyword">endregion</span></span><br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure></li>
<li><p>RSA JWT</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><code class="hljs CSharp"><span class="hljs-keyword">using</span> Microsoft.Extensions.Options;<br><span class="hljs-keyword">using</span> Microsoft.IdentityModel.Tokens;<br><span class="hljs-keyword">using</span> System;<br><span class="hljs-keyword">using</span> System.Collections.Generic;<br><span class="hljs-keyword">using</span> System.IdentityModel.Tokens.Jwt;<br><span class="hljs-keyword">using</span> System.IO;<br><span class="hljs-keyword">using</span> System.Linq;<br><span class="hljs-keyword">using</span> System.Security.Claims;<br><span class="hljs-keyword">using</span> System.Security.Cryptography;<br><span class="hljs-keyword">using</span> System.Threading.Tasks;<br><br><span class="hljs-keyword">namespace</span> <span class="hljs-title">DotNetCoreDemo.AuthenticationCenter.Utility</span><br>&#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">CustomRSSJWTervice</span> : <span class="hljs-title">ICustomJWTService</span><br>    &#123;<br>        <span class="hljs-meta">#<span class="hljs-keyword">region</span> Option注入</span><br>        <span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> JWTTokenOptions _JWTTokenOptions;<br>        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">CustomRSSJWTervice</span>(<span class="hljs-params">IOptionsMonitor&lt;JWTTokenOptions&gt; jwtTokenOptions</span>)</span><br>        &#123;<br>            _JWTTokenOptions = jwtTokenOptions.CurrentValue;<br>        &#125;<br>        <span class="hljs-meta">#<span class="hljs-keyword">endregion</span></span><br><br>        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-built_in">string</span> <span class="hljs-title">GetToken</span>(<span class="hljs-params"><span class="hljs-built_in">string</span> UserName, <span class="hljs-built_in">string</span> password</span>)</span><br>        &#123;<br>            <span class="hljs-meta">#<span class="hljs-keyword">region</span> 使用加密解密Key  非对称 </span><br>            <span class="hljs-built_in">string</span> keyDir = Directory.GetCurrentDirectory();<br>            <span class="hljs-keyword">if</span> (RSAHelper.TryGetKeyParameters(keyDir, <span class="hljs-literal">true</span>, <span class="hljs-keyword">out</span> RSAParameters keyParams) == <span class="hljs-literal">false</span>)<br>            &#123;<br>                keyParams = RSAHelper.GenerateAndSaveKey(keyDir);<br>            &#125;<br>            <span class="hljs-meta">#<span class="hljs-keyword">endregion</span></span><br><br>            <span class="hljs-comment">//string jtiCustom = Guid.NewGuid().ToString();//用来标识 Token</span><br>            Claim[] claims = <span class="hljs-keyword">new</span>[]<br>            &#123;<br>                   <span class="hljs-keyword">new</span> Claim(ClaimTypes.Name, UserName),<br>                   <span class="hljs-keyword">new</span> Claim(ClaimTypes.Role,<span class="hljs-string">&quot;admin&quot;</span>),<br>                   <span class="hljs-keyword">new</span> Claim(<span class="hljs-string">&quot;password&quot;</span>,password)<br>            &#125;;<br><br>            SigningCredentials credentials = <span class="hljs-keyword">new</span> SigningCredentials(<span class="hljs-keyword">new</span> RsaSecurityKey(keyParams), SecurityAlgorithms.RsaSha256Signature);<br><br>            <span class="hljs-keyword">var</span> token = <span class="hljs-keyword">new</span> JwtSecurityToken(<br>               issuer: <span class="hljs-keyword">this</span>._JWTTokenOptions.Issuer,<br>               audience: <span class="hljs-keyword">this</span>._JWTTokenOptions.Audience,<br>               claims: claims,<br>               expires: DateTime.Now.AddMinutes(<span class="hljs-number">60</span>),<span class="hljs-comment">//5分钟有效期</span><br>               signingCredentials: credentials);<br><br>            <span class="hljs-keyword">var</span> handler = <span class="hljs-keyword">new</span> JwtSecurityTokenHandler();<br>            <span class="hljs-built_in">string</span> tokenString = handler.WriteToken(token);<br>            <span class="hljs-keyword">return</span> tokenString;<br>        &#125;<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure></li>
<li><p><code>JWTTokenOptions</code></p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs CSharp"><span class="hljs-keyword">using</span> System;<br><span class="hljs-keyword">using</span> System.Collections.Generic;<br><span class="hljs-keyword">using</span> System.Linq;<br><span class="hljs-keyword">using</span> System.Threading.Tasks;<br><br><span class="hljs-keyword">namespace</span> <span class="hljs-title">DotNetCoreDemo.AuthenticationCenter.Utility</span><br>&#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">JWTTokenOptions</span><br>    &#123;<br>        <span class="hljs-keyword">public</span> <span class="hljs-built_in">string</span> Audience<br>        &#123;<br>            <span class="hljs-keyword">get</span>;<br>            <span class="hljs-keyword">set</span>;<br>        &#125;<br>        <span class="hljs-keyword">public</span> <span class="hljs-built_in">string</span> SecurityKey<br>        &#123;<br>            <span class="hljs-keyword">get</span>;<br>            <span class="hljs-keyword">set</span>;<br>        &#125;<br>        <span class="hljs-comment">//public SigningCredentials Credentials</span><br>        <span class="hljs-comment">//&#123;</span><br>        <span class="hljs-comment">//    get;</span><br>        <span class="hljs-comment">//    set;</span><br>        <span class="hljs-comment">//&#125;</span><br>        <span class="hljs-keyword">public</span> <span class="hljs-built_in">string</span> Issuer<br>        &#123;<br>            <span class="hljs-keyword">get</span>;<br>            <span class="hljs-keyword">set</span>;<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure></li>
<li><p>RSA Helper</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><code class="hljs CSharp"><span class="hljs-keyword">using</span> Newtonsoft.Json;<br><span class="hljs-keyword">using</span> System;<br><span class="hljs-keyword">using</span> System.Collections.Generic;<br><span class="hljs-keyword">using</span> System.IO;<br><span class="hljs-keyword">using</span> System.Linq;<br><span class="hljs-keyword">using</span> System.Security.Cryptography;<br><span class="hljs-keyword">using</span> System.Threading.Tasks;<br><br><span class="hljs-keyword">namespace</span> <span class="hljs-title">DotNetCoreDemo.AuthenticationCenter.Utility</span><br>&#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">RSAHelper</span><br>    &#123;<br>        <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;summary&gt;</span></span><br>        <span class="hljs-comment"><span class="hljs-doctag">///</span> 从本地文件中读取用来签发 Token 的 RSA Key</span><br>        <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;/summary&gt;</span></span><br>        <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;param name=&quot;filePath&quot;&gt;</span>存放密钥的文件夹路径<span class="hljs-doctag">&lt;/param&gt;</span></span><br>        <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;param name=&quot;withPrivate&quot;&gt;</span><span class="hljs-doctag">&lt;/param&gt;</span></span><br>        <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;param name=&quot;keyParameters&quot;&gt;</span><span class="hljs-doctag">&lt;/param&gt;</span></span><br>        <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;returns&gt;</span><span class="hljs-doctag">&lt;/returns&gt;</span></span><br>        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-built_in">bool</span> <span class="hljs-title">TryGetKeyParameters</span>(<span class="hljs-params"><span class="hljs-built_in">string</span> filePath, <span class="hljs-built_in">bool</span> withPrivate, <span class="hljs-keyword">out</span> RSAParameters keyParameters</span>)</span><br>        &#123;<br>            <span class="hljs-built_in">string</span> filename = withPrivate ? <span class="hljs-string">&quot;key.json&quot;</span> : <span class="hljs-string">&quot;key.public.json&quot;</span>;<br>            <span class="hljs-built_in">string</span> fileTotalPath = Path.Combine(filePath, filename);<br>            keyParameters = <span class="hljs-literal">default</span>(RSAParameters);<br>            <span class="hljs-keyword">if</span> (!File.Exists(fileTotalPath))<br>            &#123;<br>                <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>            &#125;<br>            <span class="hljs-keyword">else</span><br>            &#123;<br>                keyParameters = JsonConvert.DeserializeObject&lt;RSAParameters&gt;(File.ReadAllText(fileTotalPath));<br>                <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>            &#125;<br>        &#125;<br>        <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;summary&gt;</span></span><br>        <span class="hljs-comment"><span class="hljs-doctag">///</span> 生成并保存 RSA 公钥与私钥</span><br>        <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;/summary&gt;</span></span><br>        <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;param name=&quot;filePath&quot;&gt;</span>存放密钥的文件夹路径<span class="hljs-doctag">&lt;/param&gt;</span></span><br>        <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;returns&gt;</span><span class="hljs-doctag">&lt;/returns&gt;</span></span><br>        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> RSAParameters <span class="hljs-title">GenerateAndSaveKey</span>(<span class="hljs-params"><span class="hljs-built_in">string</span> filePath, <span class="hljs-built_in">bool</span> withPrivate = <span class="hljs-literal">true</span></span>)</span><br>        &#123;<br>            RSAParameters publicKeys, privateKeys;<br>            <span class="hljs-keyword">using</span> (<span class="hljs-keyword">var</span> rsa = <span class="hljs-keyword">new</span> RSACryptoServiceProvider(<span class="hljs-number">2048</span>))<span class="hljs-comment">//即时生成</span><br>            &#123;<br>                <span class="hljs-keyword">try</span><br>                &#123;<br>                    privateKeys = rsa.ExportParameters(<span class="hljs-literal">true</span>);<br>                    publicKeys = rsa.ExportParameters(<span class="hljs-literal">false</span>);<br>                &#125;<br>                <span class="hljs-keyword">finally</span><br>                &#123;<br>                    rsa.PersistKeyInCsp = <span class="hljs-literal">false</span>;<br>                &#125;<br>            &#125;<br>            File.WriteAllText(Path.Combine(filePath, <span class="hljs-string">&quot;key.json&quot;</span>), JsonConvert.SerializeObject(privateKeys));<br>            File.WriteAllText(Path.Combine(filePath, <span class="hljs-string">&quot;key.public.json&quot;</span>), JsonConvert.SerializeObject(publicKeys));<br>            <span class="hljs-keyword">return</span> withPrivate ? privateKeys : publicKeys;<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure></li>
</ol>
<h4 id="权限消费端"><a href="#权限消费端" class="headerlink" title="权限消费端"></a>权限消费端</h4><ol>
<li><p><code>appsetting.json</code>  主要关注 <code>JWTTokenOptions</code></p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs json"><span class="hljs-punctuation">&#123;</span><br>  <span class="hljs-attr">&quot;Logging&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>    <span class="hljs-attr">&quot;LogLevel&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>      <span class="hljs-attr">&quot;Default&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;Information&quot;</span><span class="hljs-punctuation">,</span><br>      <span class="hljs-attr">&quot;Microsoft&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;Warning&quot;</span><span class="hljs-punctuation">,</span><br>      <span class="hljs-attr">&quot;Microsoft.Hosting.Lifetime&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;Information&quot;</span><br>    <span class="hljs-punctuation">&#125;</span><br>  <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">&quot;AllowedHosts&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;*&quot;</span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">&quot;TEST&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>    <span class="hljs-attr">&quot;TESTID&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;1111&quot;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;TESTNAME&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;HARRIS&quot;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;_TESTAdress&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>      <span class="hljs-attr">&quot;Sheng&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;SHANXI&quot;</span><span class="hljs-punctuation">,</span><br>      <span class="hljs-attr">&quot;Shi&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;XINZHOU&quot;</span><br>    <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;Family&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><br>      <span class="hljs-string">&quot;baba&quot;</span><span class="hljs-punctuation">,</span><br>      <span class="hljs-string">&quot;mama&quot;</span><span class="hljs-punctuation">,</span><br>      <span class="hljs-string">&quot;son&quot;</span><br>    <span class="hljs-punctuation">]</span><br>  <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">&quot;JWTTokenOptions&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>    <span class="hljs-attr">&quot;Audience&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;http://localhost:5200&quot;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;Issuer&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;http://localhost:5200&quot;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;SecurityKey&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;MIGfMA0GCSqGSIb3DQEBAQUAA4GNADCBiQKBgQDI2a2EJ7m872v0afyoSDJT2o1+SitIeJSWtLJU8/Wz2m7gStexajkeD+Lka6DSTy8gt9UwfgVQo6uKjVLG5Ex7PiGOODVqAEghBuS7JzIYU5RvI543nNDAPfnJsas96mSA7L/mD7RTE2drj6hf3oZjJpMPZUQI/B1Qjb5H3K3PNwIDAQAB&quot;</span><br>  <span class="hljs-punctuation">&#125;</span><br><span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure></li>
<li><p><code>Startup.cs</code>  中 <code>ConfigureServices</code> 方法，先把之前测试<code>Cookie</code>的方法注释掉。</p>
 <figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><code class="hljs CSharp"><span class="hljs-meta">#<span class="hljs-keyword">region</span> RSA</span><br>&#123;<br>    <span class="hljs-comment">// 读取公钥</span><br>    <span class="hljs-built_in">string</span> path = Path.Combine(Directory.GetCurrentDirectory(), <span class="hljs-string">&quot;key.public.json&quot;</span>);<br>    <span class="hljs-built_in">string</span> key = File.ReadAllText(path);<span class="hljs-comment">//this.Configuration[&quot;SecurityKey&quot;];</span><br>    Console.WriteLine(<span class="hljs-string">$&quot;KeyPath:<span class="hljs-subst">&#123;path&#125;</span>&quot;</span>);<br>    <span class="hljs-keyword">var</span> keyParams = JsonConvert.DeserializeObject&lt;RSAParameters&gt;(key);<br>    <span class="hljs-comment">//SigningCredentials credentials = new SigningCredentials(new RsaSecurityKey(keyParams), SecurityAlgorithms.RsaSha256Signature);</span><br><br>    JWTTokenOptions tokenOptions = <span class="hljs-keyword">new</span> JWTTokenOptions();<br>    Configuration.Bind(<span class="hljs-string">&quot;JWTTokenOptions&quot;</span>, tokenOptions);<br><br>    services.AddAuthentication(JwtBearerDefaults.AuthenticationScheme)<br>        .AddJwtBearer(options =&gt;<br>                      &#123;<br>                          options.TokenValidationParameters = <span class="hljs-keyword">new</span> TokenValidationParameters<br>                          &#123;<br>                              ValidateIssuer = <span class="hljs-literal">true</span>,<span class="hljs-comment">//是否验证Issuer</span><br>                              ValidateAudience = <span class="hljs-literal">true</span>,<span class="hljs-comment">//是否验证Audience</span><br>                              ValidateLifetime = <span class="hljs-literal">true</span>,<span class="hljs-comment">//是否验证失效时间</span><br>                              ValidateIssuerSigningKey = <span class="hljs-literal">true</span>,<span class="hljs-comment">//是否验证SecurityKey</span><br>                              ValidAudience = tokenOptions.Audience,<span class="hljs-comment">//Audience</span><br>                              ValidIssuer = tokenOptions.Issuer,<span class="hljs-comment">//Issuer，这两项和前面签发jwt的设置一致</span><br>                              IssuerSigningKey = <span class="hljs-keyword">new</span> RsaSecurityKey(keyParams),<br>                              <span class="hljs-comment">//IssuerSigningKeyValidator = (m, n, z) =&gt;</span><br>                              <span class="hljs-comment">// &#123;</span><br>                              <span class="hljs-comment">//     Console.WriteLine(&quot;This is IssuerValidator&quot;);</span><br>                              <span class="hljs-comment">//     return true;</span><br>                              <span class="hljs-comment">// &#125;,</span><br>                              <span class="hljs-comment">//IssuerValidator = (m, n, z) =&gt;</span><br>                              <span class="hljs-comment">// &#123;</span><br>                              <span class="hljs-comment">//     Console.WriteLine(&quot;This is IssuerValidator&quot;);</span><br>                              <span class="hljs-comment">//     return &quot;http://localhost:5726&quot;;</span><br>                              <span class="hljs-comment">// &#125;,</span><br>                              <span class="hljs-comment">//AudienceValidator = (m, n, z) =&gt;</span><br>                              <span class="hljs-comment">//&#123;</span><br>                              <span class="hljs-comment">//    Console.WriteLine(&quot;This is AudienceValidator&quot;);</span><br>                              <span class="hljs-comment">//    return true;</span><br>                              <span class="hljs-comment">//    //return m != null &amp;&amp; m.FirstOrDefault().Equals(this.Configuration[&quot;Audience&quot;]);</span><br>                              <span class="hljs-comment">//&#125;,//自定义校验规则，可以新登录后将之前的无效</span><br>                          &#125;;<br>                      &#125;);<br>&#125;<br><span class="hljs-meta">#<span class="hljs-keyword">endregion</span></span><br><br><span class="hljs-number">3.</span> 具体入口 `SixController` 特性 `[Authorize]`<br><br>   ``` CSharp<br>   <span class="hljs-keyword">using</span> Microsoft.AspNetCore.Authorization;<br>   <span class="hljs-keyword">using</span> Microsoft.AspNetCore.Mvc;<br>   <span class="hljs-keyword">using</span> System;<br>   <span class="hljs-keyword">using</span> System.Collections.Generic;<br>   <span class="hljs-keyword">using</span> System.Linq;<br>   <span class="hljs-keyword">using</span> System.Threading.Tasks;<br>   <br>   <span class="hljs-keyword">namespace</span> <span class="hljs-title">DotNetCoreDemo.Controllers</span><br>   &#123;<br>       <span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">SixController</span> : <span class="hljs-title">Controller</span><br>       &#123;<br>           [<span class="hljs-meta">Authorize</span>] <span class="hljs-comment">//2.第二部：标记特性，表示Privacy 可以支持验证</span><br>           <span class="hljs-function"><span class="hljs-keyword">public</span> IActionResult <span class="hljs-title">Index</span>()</span><br>           &#123;<br>               <span class="hljs-keyword">var</span> user = HttpContext.User;<br>   <br>               <span class="hljs-keyword">return</span> View();<br>           &#125;<br>   <br>           <span class="hljs-function"><span class="hljs-keyword">public</span> IActionResult <span class="hljs-title">Login</span>()</span><br>           &#123;<br>               <span class="hljs-keyword">return</span> View();<br>           &#125;<br>       &#125;<br>   &#125;<br></code></pre></td></tr></table></figure></li>
<li><p>View</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs Html"><br>@&#123;<br>    ViewData[&quot;Title&quot;] = &quot;Index&quot;;<br>&#125;<br><br><span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>Six Index<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span><br><br><span class="hljs-tag">&lt;<span class="hljs-name">h3</span>&gt;</span>HS 授权完毕<span class="hljs-tag">&lt;/<span class="hljs-name">h3</span>&gt;</span><br></code></pre></td></tr></table></figure></li>
</ol>
<h4 id="测试过程"><a href="#测试过程" class="headerlink" title="测试过程"></a>测试过程</h4><ol>
<li><p>生成+获取<code>Token</code></p>
<p>生成<code>key.json</code> 和 <code>key.public.json</code> </p>
<p>授权中心通过WebApi 访问，生产<code>key.json</code> 和 <code>key.public.json</code> 。<code>key.json</code> 与 <code>key.public.json</code> 是互相呼应的。</p>
<p>图一：</p>
<p><img src="https://blogimage-1255495010.cos.ap-beijing.myqcloud.com/image-20211001191326110.png" srcset="/img/loading.gif" lazyload alt="image-20211001191326110"></p>
<ol>
<li>点击 <code>Tryitout</code> 按钮到 </li>
<li>输入 <code>name</code> &amp; <code>password</code></li>
<li>点击 <code>Execute</code> 按钮，生成如下内容。</li>
</ol>
<p>图二：</p>
<p><img src="https://blogimage-1255495010.cos.ap-beijing.myqcloud.com/image-20211001191428193.png" srcset="/img/loading.gif" lazyload alt="image-20211001191428193"></p>
<p>Response body 内容作为备用。</p>
<p>将 <code>key.public.json</code> 文件放到访问的相对位置，本地放到</p>
<p><img src="https://blogimage-1255495010.cos.ap-beijing.myqcloud.com/image-20211001191845619.png" srcset="/img/loading.gif" lazyload alt="image-20211001191845619"></p>
</li>
<li><p>启动<code>PostMan</code> 工具</p>
<p><img src="https://blogimage-1255495010.cos.ap-beijing.myqcloud.com/image-20211001195024174.png" srcset="/img/loading.gif" lazyload alt="image-20211001195024174"></p>
<ol>
<li><p>输入主程序 <a target="_blank" rel="noopener" href="http://localhost:5000/Six/Index">http://localhost:5000/Six/Index</a></p>
</li>
<li><p><code>Authorization</code> 选择 <code>Bearer Token</code> 输入 图二 中 <code>Response body</code> 中 <code>Token</code> 内容.</p>
</li>
<li><p>点击 <code>Send</code>提交，则可以看到访问成功。</p>
</li>
<li><p>否则 则报 <code>401</code> 错误</p>
<p><img src="https://blogimage-1255495010.cos.ap-beijing.myqcloud.com/image-20211001195539225.png" srcset="/img/loading.gif" lazyload alt="image-20211001195539225"></p>
</li>
</ol>
</li>
</ol>

            </div>
            <hr>
            <div>
              <div class="post-metas mb-3">
                
                  <div class="post-meta mr-3">
                    <i class="iconfont icon-category"></i>
                    
                      <a class="hover-with-bg" href="/categories/C/">C#</a>
                    
                  </div>
                
                
                  <div class="post-meta">
                    <i class="iconfont icon-tags"></i>
                    
                      <a class="hover-with-bg" href="/tags/net-core/">.net core</a>
                    
                      <a class="hover-with-bg" href="/tags/IOC/">IOC</a>
                    
                      <a class="hover-with-bg" href="/tags/JWT/">JWT</a>
                    
                  </div>
                
              </div>
              
                <p class="note note-warning">
                  
                    本博客所有文章除特别声明外，均采用 <a target="_blank" href="https://creativecommons.org/licenses/by-sa/4.0/deed.zh" rel="nofollow noopener noopener">CC BY-SA 4.0 协议</a> ，转载请注明出处！
                  
                </p>
              
              
                <div class="post-prevnext">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/2021/10/31/Golang-Note/">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">Golang Note</span>
                        <span class="visible-mobile">Previous</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2021/10/31/Docker-Note/">
                        <span class="hidden-mobile">Docker Note</span>
                        <span class="visible-mobile">Next</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
              <!-- Comments -->
              <article class="comments" id="comments" lazyload>
                
                  
                
                
  <div id="valine"></div>
  <script type="text/javascript">
    Fluid.utils.loadComments('#valine', function() {
      Fluid.utils.createScript('https://cdn.jsdelivr.net/npm/valine@1/dist/Valine.min.js', function() {
        var options = Object.assign(
          {"appId":"q3pc0gbhQF3puHJQ3XjiByyg-gzGzoHsz","appKey":"yIsNaqJVWRbpKxcC4phLbjXt","path":"window.location.pathname","placeholder":"吐槽","avatar":"retro","meta":["nick","mail","link"],"requiredFields":[],"pageSize":10,"lang":"zh-CN","highlight":true,"recordIP":true,"serverURLs":"https://q3pc0gbh.lc-cn-n1-shared.com","emojiCDN":null,"emojiMaps":null,"enableQQ":false},
          {
            el: "#valine",
            path: window.location.pathname
          }
        )
        new Valine(options);
        Fluid.utils.waitElementVisible('#valine .vcontent', () => {
          Fluid.plugins.initFancyBox('#valine .vcontent img:not(.vemoji)');
        })
      });
    });
  </script>
  <noscript>Please enable JavaScript to view the comments</noscript>


              </article>
            
          </article>
        </div>
      </div>
    </div>
    
      <div class="d-none d-lg-block col-lg-2 toc-container" id="toc-ctn">
        <div id="toc">
  <p class="toc-header"><i class="iconfont icon-list"></i>&nbsp;TOC</p>
  <div class="toc-body" id="toc-body"></div>
</div>

      </div>
    
  </div>
</div>

<!-- Custom -->

  <div class="col-lg-7 mx-auto nopadding-x-md">
    <div class="container custom post-custom mx-auto">
      <img src="https://blogimage-1255495010.cos.ap-beijing.myqcloud.com/gongzhonghao2.jpg" srcset="/img/loading.gif" lazyload class="rounded mx-auto d-block mt-5" style="width:150px; height:150px;">
    </div>
  </div>


    

    
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">Search</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v"
                 for="local-search-input">keyword</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>
    

    
  </main>

  <footer class="text-center mt-5 py-3">
  <div class="footer-content">
     <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a> 
  </div>
  
  <div class="statistics">
    
    

    
      
        <!-- 不蒜子统计PV -->
        <span id="busuanzi_container_site_pv" style="display: none">
            总访问量 
            <span id="busuanzi_value_site_pv"></span>
             次
          </span>
      
      
        <!-- 不蒜子统计UV -->
        <span id="busuanzi_container_site_uv" style="display: none">
            总访客数 
            <span id="busuanzi_value_site_uv"></span>
             人
          </span>
      
    
  </div>


  
  <!-- 备案信息 -->
  <div class="beian">
    <span>
      <a href="http://beian.miit.gov.cn/" target="_blank" rel="nofollow noopener">
        京ICP证18023705号
      </a>
    </span>
    
  </div>


  
</footer>


  <!-- SCRIPTS -->
  
  <script  src="https://cdn.jsdelivr.net/npm/nprogress@0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/nprogress@0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js" ></script>
<script  src="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>

<!-- Plugins -->


  <script  src="/js/local-search.js" ></script>



  
    <script  src="/js/img-lazyload.js" ></script>
  



  



  
    <script  src="https://cdn.jsdelivr.net/npm/tocbot@4/dist/tocbot.min.js" ></script>
  
  
    <script  src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3/dist/jquery.fancybox.min.js" ></script>
  
  
    <script  src="https://cdn.jsdelivr.net/npm/anchor-js@4/anchor.min.js" ></script>
  
  
    <script defer src="https://cdn.jsdelivr.net/npm/clipboard@2/dist/clipboard.min.js" ></script>
  



  <script defer src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" ></script>




  <script  src="https://cdn.jsdelivr.net/npm/typed.js@2/lib/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var title = document.getElementById('subtitle').title;
      
      typing(title)
      
    })(window, document);
  </script>














  
<script src="//cdn.jsdelivr.net/gh/bynotes/texiao/source/js/caidai.js"></script>
<script src="//cdn.jsdelivr.net/gh/bynotes/texiao/source/js/dianjichuzi.js"></script>
<script src="//cdn.jsdelivr.net/gh/bynotes/texiao/source/js/timeDate.js"></script>



<!-- 主题的启动项 保持在最底部 -->
<script  src="/js/boot.js" ></script>


</body>
</html>
